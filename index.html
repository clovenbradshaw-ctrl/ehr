<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="expires" content="0">
    <title>Personal Health Vault - Secure Medical Record</title>
    <style>
        @page {
            size: letter;
            margin: 0.5in;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #1e293b;
            background: white;
            padding: 20px;
            padding-top: 105px;
        }
        
        .unlock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .unlock-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .unlock-container h2 {
            margin-bottom: 10px;
            color: #1e293b;
        }
        
        .unlock-container p {
            color: #64748b;
            margin-bottom: 20px;
            font-size: 10pt;
        }
        
        .unlock-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 11pt;
        }
        
        .unlock-container button {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11pt;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .unlock-container button:hover {
            background: #2563eb;
        }
        
        .welcome-screen {
            max-width: 600px;
            margin: 50px auto;
            text-align: center;
        }
        
        .welcome-screen h1 {
            color: #3b82f6;
            margin-bottom: 20px;
            font-size: 28pt;
        }
        
        .welcome-screen p {
            color: #64748b;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .welcome-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .welcome-actions button {
            padding: 15px 30px;
            font-size: 12pt;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-start {
            background: #3b82f6;
            color: white;
        }
        
        .btn-start:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        .security-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            color: white;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 8px;
            min-height: 48px;
        }
        
        .save-status {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 9pt;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
            margin: 0 10px;
        }
        
        .save-status.never-saved {
            background: #dc2626;
            color: white;
        }
        
        .save-status.unsaved {
            background: #f59e0b;
            color: white;
        }
        
        .save-status.saved {
            background: #22c55e;
            color: white;
        }
        
        .security-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11pt;
            flex-shrink: 0;
        }
        
        .status-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .status-icon::after {
            content: "✓";
            color: white;
            font-size: 9pt;
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            flex-grow: 0;
            flex-shrink: 0;
        }
        
        .btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            font-size: 9pt;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-save {
            background: #dc2626;
            color: white;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        .btn-save.saved {
            background: #22c55e;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-lock {
            background: #059669;
            color: white;
        }
        
        .btn-lock:hover {
            background: #047857;
        }
        
        .btn-locked {
            background: #dc2626;
            color: white;
        }
        
        .nav-tabs {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            z-index: 999;
            overflow-x: auto;
            white-space: nowrap;
            padding: 0 20px;
            scrollbar-width: thin;
        }
        
        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .nav-tabs::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        .tab {
            display: inline-block;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-size: 10pt;
            font-weight: 500;
            color: #64748b;
        }
        
        .tab:hover {
            color: #1e293b;
            background: #f1f5f9;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab.module-tab {
            background: #fef3c7;
            border-radius: 4px 4px 0 0;
            margin-left: 10px;
        }
        
        .main-content {
            margin-top: 20px;
        }
        
        /* Medical Chart Header Styling */
        .chart-header {
            background: white;
            border: 2px solid #2c3e50;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .chart-header-top {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-header-top h1 {
            font-size: 18pt;
            font-weight: 600;
            margin: 0;
        }
        
        .chart-header-info {
            font-size: 10pt;
            opacity: 0.9;
        }
        
        .patient-demographics {
            padding: 20px 24px;
            background: #eef2ff;
        }

        .patient-summary {
            display: grid;
            grid-template-columns: minmax(240px, 280px) minmax(0, 1fr);
            gap: 24px;
            align-items: start;
        }

        .patient-profile,
        .patient-core {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
        }

        .patient-profile {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .patient-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .patient-overview {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .patient-display-name {
            font-size: 16pt;
            font-weight: 700;
            color: #1e293b;
        }

        .patient-display-meta {
            font-size: 10pt;
            color: #64748b;
        }

        .name-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 80px;
            gap: 10px;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px 18px;
        }

        .field-block {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-block label {
            font-size: 9.5pt;
            font-weight: 600;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .field-block input,
        .field-block select,
        .field-block textarea {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 9px 12px;
            font-family: inherit;
            font-size: 10.5pt;
            color: #1e293b;
            background: #f8fafc;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .field-block input:focus,
        .field-block select:focus,
        .field-block textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: white;
        }

        .field-block.full {
            grid-column: 1 / -1;
        }

        @media (max-width: 900px) {
            .patient-summary {
                grid-template-columns: 1fr;
            }

            .patient-avatar {
                width: 60px;
                height: 60px;
                font-size: 22px;
            }

            .name-grid {
                grid-template-columns: 1fr 1fr;
            }

            .name-grid input:last-child {
                grid-column: 1 / -1;
                max-width: 120px;
            }
        }
        
        /* Vital Signs Card */
        .vitals-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .vitals-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 12pt;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 5px;
        }
        
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .vital-item {
            text-align: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 4px;
        }
        
        .vital-label {
            font-size: 9pt;
            color: #64748b;
            margin-bottom: 2px;
        }
        
        .vital-value {
            font-size: 14pt;
            font-weight: 600;
            color: #1e293b;
        }
        
        .section {
            margin-bottom: 20px;
            page-break-inside: avoid;
            scroll-margin-top: 125px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8fafc;
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header.emergency {
            background: #fee2e2;
            border-bottom-color: #fca5a5;
        }
        
        .section-header.module {
            background: #f3f0ff;
            border-bottom-color: #ddd6fe;
        }
        
        .section-header h2 {
            font-size: 14pt;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }
        
        .section-content {
            padding: 15px;
            transition: all 0.3s;
        }
        
        .section-content.locked {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
            opacity: 0.5;
        }
        
        .field-group {
            margin-bottom: 15px;
        }
        
        .field-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .field {
            flex: 1;
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            font-weight: 600;
            font-size: 10pt;
            color: #334155;
            margin-bottom: 3px;
        }
        
        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="tel"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 10pt;
            background: white;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 5px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .info-box {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 9pt;
        }
        
        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 9pt;
        }
        
        .danger-box {
            background: #fee2e2;
            border: 1px solid #dc2626;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-size: 10pt;
            font-weight: 600;
            text-align: center;
        }
        
        .list-item {
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8fafc;
            position: relative;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 9pt;
            cursor: pointer;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .add-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 14px;
            font-size: 9pt;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .add-btn:hover {
            background: #2563eb;
        }
        
        /* Medication Search Styles */
        .med-search-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .med-search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            font-size: 11pt;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .med-search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .med-search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            pointer-events: none;
        }
        
        .med-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .med-dropdown.active {
            display: block;
        }
        
        .med-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .med-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .med-dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .med-dropdown-item.selected {
            background-color: #3b82f6;
            color: white;
        }
        
        .drug-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .drug-details {
            font-size: 10pt;
            color: #666;
        }
        
        .med-dropdown-item.selected .drug-details {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .med-loading {
            padding: 20px;
            text-align: center;
            color: #999;
        }
        
        .med-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            font-size: 18pt;
            color: #1e293b;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .password-strength {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .strength-bar {
            flex: 1;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
        }
        
        .strength-bar.active {
            background: #22c55e;
        }
        
        .strength-bar.weak {
            background: #dc2626;
        }
        
        .strength-bar.medium {
            background: #f59e0b;
        }
        
        .settings-grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        
        .settings-section {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
        }
        
        .settings-section h4 {
            margin-bottom: 10px;
            color: #1e293b;
        }
        
        .module-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .module-info {
            flex: 1;
        }
        
        .module-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        .module-desc {
            font-size: 9pt;
            color: #64748b;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #cbd5e1;
            border-radius: 24px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        input:checked + .toggle-slider {
            background: #3b82f6;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .qr-section {
            border: 2px solid #dc2626;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #fef2f2;
        }
        
        .qr-generator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .qr-config {
            padding: 15px;
            background: white;
            border-radius: 6px;
        }
        
        .qr-preview {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #qr-canvas {
            margin: 15px auto;
            border: 1px solid #e2e8f0;
            padding: 10px;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .qr-preview-text {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            font-family: monospace;
            font-size: 9pt;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .qr-warning {
            color: #dc2626;
            font-size: 9pt;
            text-align: left;
        }
        
        #qr-canvas canvas,
        #qr-canvas img,
        #qr-canvas table {
            margin: 0 auto;
        }
        
        .qr-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        @media (max-width: 900px) {
            body {
                padding: 15px;
                padding-top: 150px;
                font-size: 10.5pt;
            }

            .unlock-container {
                padding: 28px 24px;
                max-width: 320px;
            }

            .welcome-screen {
                margin: 30px auto;
                padding: 0 10px;
            }

            .welcome-screen h1 {
                font-size: 22pt;
            }

            .welcome-actions {
                flex-direction: column;
                width: 100%;
                gap: 12px;
            }

            .welcome-actions button {
                width: 100%;
            }

            .security-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 10px 12px;
            }

            .security-status,
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }

            .action-buttons {
                flex-wrap: wrap;
                gap: 6px;
            }

            .save-status {
                width: 100%;
                justify-content: center;
                margin: 0;
            }

            .action-buttons .btn {
                flex: 1 1 45%;
                min-width: 140px;
            }

            .nav-tabs {
                top: 68px;
                padding: 0 12px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 9pt;
            }

            .chart-header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .chart-header-top h1 {
                font-size: 16pt;
            }

            .patient-demographics {
                padding: 12px 16px;
            }

            .demo-row {
                flex-direction: column;
                margin-bottom: 12px;
            }

            .demo-field {
                margin-right: 0;
                width: 100%;
            }

            .qr-generator {
                grid-template-columns: 1fr;
            }

            .qr-actions {
                flex-direction: column;
            }

            .qr-actions .btn {
                min-width: unset;
                width: 100%;
            }

            .modal-content {
                margin: 40px 16px;
                padding: 20px;
                width: calc(100% - 32px);
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions button {
                width: 100%;
            }

            .settings-columns {
                grid-template-columns: 1fr;
            }

            .module-toggle {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
                padding-top: 170px;
            }

            .unlock-container {
                width: 100%;
            }

            .security-bar {
                gap: 12px;
            }

            .security-status {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .action-buttons {
                gap: 8px;
            }

            .action-buttons .btn {
                flex: 1 1 100%;
                min-width: 0;
            }

            .main-content {
                margin-top: 10px;
            }

            .vitals-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .qr-section {
                padding: 16px;
            }

            .qr-preview,
            .qr-config {
                padding: 12px;
            }

            .modal-header h2 {
                font-size: 16pt;
            }

            .modal {
                align-items: flex-start;
            }
        }
        
        .totp-setup {
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .totp-qr {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            display: inline-block;
        }
        
        .backup-codes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: #fef3c7;
            border-radius: 6px;
        }
        
        .backup-code {
            font-family: monospace;
            font-size: 11pt;
            padding: 5px 10px;
            background: white;
            border-radius: 4px;
            text-align: center;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .summary-card h4 {
            color: #64748b;
            font-size: 10pt;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            color: #1e293b;
            font-size: 14pt;
            font-weight: 600;
        }

        #printArea {
            display: none;
        }

        .print-wrapper {
            padding: 40px 30px;
            color: #0f172a;
        }

        .print-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .print-header h1 {
            font-size: 24pt;
            letter-spacing: 0.08em;
        }

        .print-meta {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px 24px;
            margin-top: 12px;
            font-size: 10pt;
            color: #334155;
        }

        .print-section {
            margin-top: 25px;
        }

        .print-section h2 {
            font-size: 16pt;
            color: #1e293b;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 6px;
            margin-bottom: 12px;
        }

        .print-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .print-grid-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            min-height: 70px;
        }

        .print-label {
            display: block;
            font-size: 8.5pt;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
            margin-bottom: 6px;
        }

        .print-value {
            font-size: 11pt;
            font-weight: 600;
            color: #0f172a;
            line-height: 1.4;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .print-table th,
        .print-table td {
            border: 1px solid #cbd5e1;
            padding: 8px 10px;
            text-align: left;
            font-size: 10pt;
            vertical-align: top;
        }

        .print-table th {
            background: #e2e8f0;
            color: #1e293b;
            font-weight: 600;
        }

        .print-list {
            margin: 0;
            padding-left: 20px;
            color: #1e293b;
        }

        .print-note {
            margin-bottom: 10px;
            font-size: 10.5pt;
            line-height: 1.5;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .export-note {
            font-size: 9pt;
            color: #64748b;
            line-height: 1.4;
        }

        @media print {
            body {
                padding: 0;
            }

            .security-bar,
            .nav-tabs,
            .no-print,
            .unlock-screen,
            .modal {
                display: none !important;
            }

            .section-content.locked {
                display: none !important;
            }

            #mainContent,
            #welcomeScreen,
            #unlockScreen {
                display: none !important;
            }

            #printArea {
                display: block !important;
            }
        }
        
        @media (max-width: 768px) {
            .grid-2,
            .grid-3,
            .qr-generator {
                grid-template-columns: 1fr;
            }
            
            .field-row {
                flex-direction: column;
                gap: 0;
            }
            
            body {
                padding: 10px;
                padding-top: 140px;
            }
            
            .nav-tabs {
                padding: 0 10px;
                top: 100px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 9pt;
            }
            
            .demo-field {
                min-width: 100%;
            }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="unlock-screen" id="unlockScreen" style="display: none;">
        <div class="unlock-container">
            <h2>🔒 Health Vault Locked</h2>
            <p>This file contains encrypted medical records</p>
            <input type="password" id="unlock-password" placeholder="Enter password">
            <div id="totpField" style="display: none;">
                <input type="text" id="totp-code" placeholder="6-digit code" maxlength="6">
            </div>
            <button onclick="app.attemptUnlock()">Unlock Vault</button>
            <p style="margin-top: 15px; font-size: 9pt; color: #94a3b8;">
                This HTML file contains your encrypted data.
                Save it after making changes.
            </p>
        </div>
    </div>

    <div class="security-bar no-print">
        <div class="security-status">
            <div class="status-icon"></div>
            <span id="securityText">Always Encrypted</span>
            <span id="lockTimer"></span>
        </div>
        <div class="save-status never-saved" id="saveStatus">
            ⚠️ Not Initialized - Create Your Vault
        </div>
        <div class="action-buttons">
            <button class="btn btn-secondary" id="settingsBtn">⚙️ Settings</button>
            <button class="btn btn-secondary" id="emergencyQRBtn">🚨 Emergency QR</button>
            <button class="btn btn-lock" id="lockBtn" style="display: none;">🔓 Lock</button>
            <button class="btn btn-secondary" id="exportBtn">Export/Print</button>
            <button class="btn btn-save" id="saveBtn">Create Encrypted Vault</button>
        </div>
    </div>

    <div class="nav-tabs no-print" id="navTabs" style="display: none;">
        <div class="tab active" data-section="demographics">📋 Demographics</div>
        <div class="tab" data-section="emergency">🆘 Emergency</div>
        <div class="tab" data-section="medications">💊 Medications</div>
        <div class="tab" data-section="history">🩺 History</div>
        <div class="tab" data-section="vitals">❤️ Vitals</div>
        <div class="tab" data-section="immunizations">💉 Vaccines</div>
        <div class="tab" data-section="labs">🔬 Lab Results</div>
        <div class="tab" data-section="providers">👩‍⚕️ Providers</div>
        <div class="tab" data-section="insurance">🏥 Insurance</div>
        <div class="tab" data-section="notes">📝 Notes</div>
        <!-- Module tabs added dynamically -->
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ Settings & Modules</h3>
            </div>
            <div class="modal-body">
                <div class="settings-grid">
                    <div class="settings-section">
                        <h4>Optional Modules</h4>
                        <p style="font-size: 9pt; color: #64748b; margin-bottom: 15px;">
                            Enable specialized tracking modules as needed
                        </p>
                        
                        <div class="module-toggle">
                            <div class="module-info">
                                <div class="module-name">Extended Identity</div>
                                <div class="module-desc">Pronouns, chosen names, context-specific usage</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="module-identity">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="module-toggle">
                            <div class="module-info">
                                <div class="module-name">Gender Affirming Care</div>
                                <div class="module-desc">HRT tracking, surgeries, specialized providers</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="module-gac">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="module-toggle">
                            <div class="module-info">
                                <div class="module-name">Mental Health</div>
                                <div class="module-desc">Mood tracking, therapy notes, crisis resources</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="module-mental">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="module-toggle">
                            <div class="module-info">
                                <div class="module-name">Chronic Disease</div>
                                <div class="module-desc">Diabetes, hypertension, pain management</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="module-chronic">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="totpSettings">
                        <h4>🔐 Two-Factor Authentication Status</h4>
                        <p style="font-size: 9pt; color: #64748b; margin-bottom: 15px;">
                            Enhanced security using time-based codes
                        </p>
                        <div id="totpStatus" style="padding: 15px; background: #f8fafc; border-radius: 6px;">
                            <!-- Status will be updated dynamically -->
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Privacy Levels</h4>
                        <select id="privacyLevel" class="form-data" data-field="privacyLevel">
                            <option value="1">Level 1: Full Information</option>
                            <option value="2">Level 2: Hide Sensitive Sections</option>
                            <option value="3">Level 3: Emergency Only</option>
                            <option value="4">Level 4: Custom</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- TOTP Setup Modal -->
    <div class="modal" id="totpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔐 Setup Two-Factor Authentication</h3>
            </div>
            <div class="modal-body">
                <div class="totp-setup">
                    <p>Scan this QR code with your authenticator app:</p>
                    <div class="totp-qr" id="totpQR"></div>
                    <p style="margin-top: 10px;">Or enter this secret manually:</p>
                    <code id="totpSecret" style="font-size: 12pt; background: #f0f0f0; padding: 8px; border-radius: 4px;"></code>
                    
                    <div style="margin-top: 20px;">
                        <label>Verify code from your app:</label>
                        <input type="text" id="verifyTOTP" placeholder="000000" maxlength="6" style="width: 150px; text-align: center; font-size: 14pt;">
                    </div>
                    
                    <div class="warning-box" style="margin-top: 20px;">
                        <strong>Backup Codes (Save These!):</strong>
                        <div class="backup-codes" id="backupCodes"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.cancelTOTP()">Cancel</button>
                <button class="btn btn-primary" onclick="app.verifyTOTP()">Verify & Enable</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Set Encryption Password</h3>
            </div>
            <div class="modal-body">
                <div class="field">
                    <label>Password</label>
                    <input type="password" id="modalPassword" placeholder="Enter password">
                    <div class="password-strength" id="passwordStrength" style="display: none;">
                        <div class="strength-bar" id="strength1"></div>
                        <div class="strength-bar" id="strength2"></div>
                        <div class="strength-bar" id="strength3"></div>
                        <div class="strength-bar" id="strength4"></div>
                    </div>
                </div>
                <div class="field" id="confirmPasswordField">
                    <label>Confirm Password</label>
                    <input type="password" id="modalConfirmPassword" placeholder="Confirm password">
                </div>
                <div class="warning-box">
                    <strong>Important:</strong> This HTML file will contain your encrypted data. 
                    Always download and save the updated file after making changes.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modalCancel">Cancel</button>
                <button class="btn btn-primary" id="modalSubmit">Continue</button>
            </div>
        </div>
    </div>

    <!-- Emergency QR Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🆘 Emergency QR Code Generator</h3>
            </div>
            <div class="modal-body">
                <div class="qr-generator">
                    <div class="qr-config">
                        <h4>Emergency Contact Details</h4>
                        <p style="font-size: 10pt; color: #64748b; margin: 10px 0 0;">
                            The QR code now includes only the names, relationships, and phone numbers from your emergency contacts.
                            Any blank fields are automatically skipped.
                        </p>
                        <button class="btn btn-primary" onclick="app.generateQR()" style="margin-top: 20px;">Generate QR</button>
                    </div>
                    <div class="qr-preview">
                        <div id="qr-canvas"></div>
                        <pre class="qr-preview-text" id="qrPreviewText"></pre>
                        <div class="qr-warning" id="qrWarning"></div>
                        <div class="qr-actions">
                            <button class="btn btn-secondary" onclick="app.downloadQR('wallet')">Wallet Card</button>
                            <button class="btn btn-secondary" onclick="app.downloadQR('bracelet')">Bracelet</button>
                            <button class="btn btn-secondary" onclick="app.downloadQR('sticker')">Sticker</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeQRModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📄 Export &amp; Share</h3>
            </div>
            <div class="modal-body">
                <p>Select how you'd like to share or archive this record.</p>
                <div class="export-options">
                    <button class="btn btn-primary" id="printSummaryBtn">🖨️ Printable Care Summary</button>
                </div>
                <p class="export-note">
                    The printable summary reformats your record into an easy-to-read care handoff that can be printed or saved as a PDF for sharing.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="exportCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Welcome Screen (shown for new files) -->
    <div class="welcome-screen" id="welcomeScreen" style="display: none;">
        <h1>🏥 Personal Health Vault</h1>
        <p>
            Welcome to your secure, self-contained medical record system. 
            This single HTML file will become your encrypted health vault.
        </p>
        <div class="info-box" style="text-align: left;">
            <strong>How it works:</strong>
            <ul style="margin-top: 10px; margin-left: 20px;">
                <li>All data is encrypted with your password</li>
                <li>This HTML file contains everything - no separate data files</li>
                <li>Works offline, no internet required</li>
                <li>Your data never leaves your device</li>
            </ul>
        </div>
        <div class="welcome-actions">
            <button class="btn-start" onclick="app.startSetup()">
                Get Started
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent" style="display: none;">
        <!-- Medical Chart Header -->
        <div class="chart-header" id="demographics-section">
            <div class="chart-header-top">
                <h1>PATIENT HEALTH RECORD</h1>
                <div class="chart-header-info">
                    <span id="lastUpdatedHeader">Last Updated: Never</span>
                </div>
            </div>
            <div class="patient-demographics">
                <div class="patient-summary">
                    <div class="patient-profile">
                        <div class="patient-avatar" id="patientAvatar">👤</div>
                        <div class="patient-overview">
                            <div class="patient-display-name" id="patientDisplayName">Enter patient name</div>
                            <div class="patient-display-meta" id="patientDisplayMeta">Add DOB, sex, and MRN for quick reference.</div>
                        </div>
                        <div class="field-block">
                            <label>Patient Name</label>
                            <div class="name-grid">
                                <input type="text" class="form-data" data-field="lastName" placeholder="Last name"/>
                                <input type="text" class="form-data" data-field="firstName" placeholder="First name"/>
                                <input type="text" class="form-data" data-field="middleInitial" placeholder="MI"/>
                            </div>
                        </div>
                        <div class="contact-grid">
                            <div class="field-block">
                                <label>Primary Phone</label>
                                <input type="tel" class="form-data" data-field="phone" placeholder="(555) 000-0000"/>
                            </div>
                            <div class="field-block">
                                <label>Email</label>
                                <input type="email" class="form-data" data-field="email" placeholder="email@example.com"/>
                            </div>
                        </div>
                    </div>
                    <div class="patient-core">
                        <div class="patient-info-grid">
                            <div class="field-block">
                                <label>Medical Record #</label>
                                <input type="text" class="form-data" data-field="mrn" placeholder="MR-2025-00000"/>
                            </div>
                            <div class="field-block">
                                <label>Date of Birth</label>
                                <input type="date" class="form-data" data-field="dateOfBirth"/>
                            </div>
                            <div class="field-block">
                                <label>Biological Sex</label>
                                <select class="form-data" data-field="biologicalSex">
                                    <option value="">Select...</option>
                                    <option>Female</option>
                                    <option>Male</option>
                                    <option>Intersex</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div class="field-block">
                                <label>Social Security #</label>
                                <input type="text" class="form-data" data-field="ssn" placeholder="XXX-XX-XXXX"/>
                            </div>
                            <div class="field-block full">
                                <label>Home Address</label>
                                <input type="text" class="form-data" data-field="address" placeholder="Street address, City, State ZIP"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vital Signs Card -->
        <div class="vitals-card">
            <div class="vitals-header">VITAL SIGNS (Most Recent)</div>
            <div class="vitals-grid">
                <div class="vital-item">
                    <div class="vital-label">Blood Pressure</div>
                    <input type="text" class="form-data vital-value" data-field="lastBP" placeholder="120/80" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Pulse</div>
                    <input type="number" class="form-data vital-value" data-field="lastPulse" placeholder="72" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Temp (°F)</div>
                    <input type="text" class="form-data vital-value" data-field="lastTemp" placeholder="98.6" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Resp Rate</div>
                    <input type="number" class="form-data vital-value" data-field="lastResp" placeholder="16" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">O2 Sat (%)</div>
                    <input type="number" class="form-data vital-value" data-field="lastO2" placeholder="98" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Weight</div>
                    <input type="text" class="form-data vital-value" data-field="weight" placeholder="150 lbs" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Height</div>
                    <input type="text" class="form-data vital-value" data-field="height" placeholder="5'8&quot;" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">BMI</div>
                    <input type="text" class="form-data vital-value" data-field="bmi" placeholder="22.5" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
            </div>
        </div>

        <!-- Emergency Information Section -->
        <div class="section" id="emergency-section">
            <div class="section-header emergency">
                <h2>🆘 Emergency Information</h2>
            </div>
            <div class="section-content">
                <div class="danger-box">
                    <strong>⚠️ CRITICAL MEDICAL INFORMATION</strong><br>
                    Blood Type: <input type="text" class="form-data" data-field="bloodType" style="display: inline; width: 80px;" placeholder="O+" />
                    Allergies: <input type="text" class="form-data" data-field="criticalAllergies" style="display: inline; width: 200px;" placeholder="Penicillin, Peanuts" />
                </div>
                
                <h3>Emergency Contacts</h3>
                <div id="emergency-contacts-container"></div>
                <button class="add-btn no-print" id="addEmergencyBtn">+ Add Emergency Contact</button>
                
                <h3>Critical Medical Conditions</h3>
                <div class="field">
                    <textarea rows="3" class="form-data" data-field="criticalConditions" placeholder="Diabetes Type 1, Epilepsy, Heart Condition..."></textarea>
                </div>
                
                <h3>Do NOT Give These Medications</h3>
                <div class="field">
                    <textarea rows="2" class="form-data" data-field="medicationContraindications" placeholder="NSAIDs (kidney disease), Aspirin (bleeding disorder)..."></textarea>
                </div>
                
                <div class="grid-2">
                    <div class="field">
                        <label>Preferred Hospital</label>
                        <input type="text" class="form-data" data-field="preferredHospital" />
                    </div>
                    <div class="field">
                        <label>Medical Power of Attorney</label>
                        <input type="text" class="form-data" data-field="medicalPOA" />
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="field">
                        <label>Advance Directive</label>
                        <select class="form-data" data-field="advanceDirective">
                            <option value="">Not Specified</option>
                            <option>Full Code</option>
                            <option>DNR</option>
                            <option>DNI</option>
                            <option>Limited Intervention</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Organ Donor</label>
                        <select class="form-data" data-field="organDonor">
                            <option value="">Not Specified</option>
                            <option>Yes</option>
                            <option>No</option>
                            <option>Family Decision</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medications Section with FDA Search -->
        <div class="section" id="medications-section">
            <div class="section-header">
                <h2>💊 Medications & Allergies</h2>
            </div>
            
            <div class="section-content">
                <h3>Current Medications</h3>
                <div id="medications-container"></div>
                <button class="add-btn no-print" id="addMedicationBtn">+ Add Medication</button>
                
                <h3>Allergies & Reactions</h3>
                <div class="field">
                    <label>Medication Allergies</label>
                    <textarea rows="3" class="form-data" data-field="medicationAllergies" placeholder="Penicillin - rash, Sulfa - anaphylaxis..."></textarea>
                </div>
                <div class="field">
                    <label>Food Allergies</label>
                    <textarea rows="2" class="form-data" data-field="foodAllergies" placeholder="Peanuts, Shellfish, Dairy..."></textarea>
                </div>
                <div class="field">
                    <label>Environmental Allergies</label>
                    <textarea rows="2" class="form-data" data-field="environmentalAllergies" placeholder="Pollen, Dust, Pet dander..."></textarea>
                </div>
            </div>
        </div>

        <!-- Medical History Section -->
        <div class="section" id="history-section">
            <div class="section-header">
                <h2>🩺 Medical History</h2>
            </div>
            <div class="section-content">
                <h3>Current Conditions</h3>
                <div id="conditions-container"></div>
                <button class="add-btn no-print" id="addConditionBtn">+ Add Condition</button>
                
                <h3>Past Surgeries</h3>
                <div id="surgeries-container"></div>
                <button class="add-btn no-print" id="addSurgeryBtn">+ Add Surgery</button>
                
                <h3>Family History</h3>
                <div class="field">
                    <textarea rows="4" class="form-data" data-field="familyHistory" placeholder="Mother: Diabetes Type 2, Hypertension&#10;Father: Heart Disease&#10;Siblings: ..."></textarea>
                </div>
                
                <h3>Social History</h3>
                <div class="grid-3">
                    <div class="field">
                        <label>Smoking Status</label>
                        <select class="form-data" data-field="smokingStatus">
                            <option value="">Select...</option>
                            <option>Never</option>
                            <option>Former</option>
                            <option>Current</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Alcohol Use</label>
                        <select class="form-data" data-field="alcoholUse">
                            <option value="">Select...</option>
                            <option>None</option>
                            <option>Occasional</option>
                            <option>Moderate</option>
                            <option>Heavy</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Exercise</label>
                        <select class="form-data" data-field="exerciseFrequency">
                            <option value="">Select...</option>
                            <option>None</option>
                            <option>1-2 times/week</option>
                            <option>3-4 times/week</option>
                            <option>5+ times/week</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vitals Section -->
        <div class="section" id="vitals-section">
            <div class="section-header">
                <h2>❤️ Vital Signs History</h2>
            </div>
            <div class="section-content">
                <div id="vitals-history-container"></div>
                <button class="add-btn no-print" id="addVitalBtn">+ Add Vital Signs</button>
            </div>
        </div>

        <!-- Immunizations Section -->
        <div class="section" id="immunizations-section">
            <div class="section-header">
                <h2>💉 Immunizations</h2>
            </div>
            <div class="section-content">
                <h3>COVID-19 Vaccines</h3>
                <div id="covid-vaccines-container"></div>
                <button class="add-btn no-print" id="addCovidVaccineBtn">+ Add COVID Vaccine</button>
                
                <h3>Standard Vaccines</h3>
                <div class="grid-2">
                    <div class="field">
                        <label>Flu Shot (Last)</label>
                        <input type="date" class="form-data" data-field="lastFluShot" />
                    </div>
                    <div class="field">
                        <label>Tetanus (Tdap)</label>
                        <input type="date" class="form-data" data-field="lastTetanus" />
                    </div>
                </div>
                
                <h3>Other Vaccines</h3>
                <div id="vaccines-container"></div>
                <button class="add-btn no-print" id="addVaccineBtn">+ Add Vaccine</button>
            </div>
        </div>

        <!-- Lab Results Section -->
        <div class="section" id="labs-section">
            <div class="section-header">
                <h2>🔬 Lab Results</h2>
            </div>
            <div class="section-content">
                <div id="labs-container"></div>
                <button class="add-btn no-print" id="addLabBtn">+ Add Lab Result</button>
            </div>
        </div>

        <!-- Healthcare Providers Section -->
        <div class="section" id="providers-section">
            <div class="section-header">
                <h2>👩‍⚕️ Healthcare Providers</h2>
            </div>
            <div class="section-content">
                <h3>Primary Care Provider</h3>
                <div class="grid-3">
                    <div class="field">
                        <label>Provider Name</label>
                        <input type="text" class="form-data" data-field="pcpName" />
                    </div>
                    <div class="field">
                        <label>Phone</label>
                        <input type="tel" class="form-data" data-field="pcpPhone" />
                    </div>
                    <div class="field">
                        <label>Last Visit</label>
                        <input type="date" class="form-data" data-field="pcpLastVisit" />
                    </div>
                </div>
                
                <h3>Specialists</h3>
                <div id="providers-container"></div>
                <button class="add-btn no-print" id="addProviderBtn">+ Add Provider</button>
            </div>
        </div>

        <!-- Insurance Section -->
        <div class="section" id="insurance-section">
            <div class="section-header">
                <h2>🏥 Insurance Information</h2>
            </div>
            
            <div class="section-content">
                <h3>Primary Insurance</h3>
                <div class="grid-3">
                    <div class="field">
                        <label>Insurance Company</label>
                        <input type="text" class="form-data" data-field="insuranceCompany" />
                    </div>
                    <div class="field">
                        <label>Member ID</label>
                        <input type="text" class="form-data" data-field="memberId" />
                    </div>
                    <div class="field">
                        <label>Group Number</label>
                        <input type="text" class="form-data" data-field="groupNumber" />
                    </div>
                </div>
                
                <div class="grid-3">
                    <div class="field">
                        <label>Policy Holder</label>
                        <input type="text" class="form-data" data-field="policyHolder" />
                    </div>
                    <div class="field">
                        <label>Relationship</label>
                        <select class="form-data" data-field="policyRelationship">
                            <option value="">Select...</option>
                            <option>Self</option>
                            <option>Spouse</option>
                            <option>Child</option>
                            <option>Parent</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Insurance Phone</label>
                        <input type="tel" class="form-data" data-field="insurancePhone" />
                    </div>
                </div>
                
                <h4>Coverage Details</h4>
                <div class="grid-3">
                    <div class="field">
                        <label>Deductible</label>
                        <input type="text" class="form-data" data-field="deductible" placeholder="$1,500" />
                    </div>
                    <div class="field">
                        <label>Out-of-Pocket Max</label>
                        <input type="text" class="form-data" data-field="oopMax" placeholder="$6,000" />
                    </div>
                    <div class="field">
                        <label>Copay (Primary)</label>
                        <input type="text" class="form-data" data-field="coPayPrimary" placeholder="$25" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="section" id="notes-section">
            <div class="section-header">
                <h2>📝 Health Notes & Journal</h2>
            </div>
            <div class="section-content">
                <div id="notes-container"></div>
                <button class="add-btn no-print" id="addNoteBtn">+ Add Note</button>
            </div>
        </div>

        <!-- Extended Identity Module (Hidden by default) -->
        <div class="section module-section" id="identity-section" style="display: none;">
            <div class="section-header module">
                <h2>👤 Extended Identity Management</h2>
            </div>
            <div class="section-content">
                <div class="info-box">
                    This section helps manage name and pronoun usage across different contexts.
                </div>
                
                <div class="field-row">
                    <div class="field">
                        <label>Chosen Name (Daily Use)</label>
                        <input type="text" class="form-data" data-field="chosenName" />
                    </div>
                    <div class="field">
                        <label>Pronouns</label>
                        <input type="text" class="form-data" data-field="pronouns" placeholder="she/her, they/them, he/him" />
                    </div>
                </div>
                
                <h3>Context-Specific Usage</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="different-contexts" class="form-data" data-field="differentContexts">
                    <label for="different-contexts">I use different names/pronouns in different situations</label>
                </div>
                
                <div id="contextFields" style="display: none; margin-top: 15px;">
                    <div class="field">
                        <label>Situations requiring legal name:</label>
                        <textarea rows="2" class="form-data" data-field="legalNameSituations"></textarea>
                    </div>
                    <div class="field">
                        <label>Safe to use chosen name with:</label>
                        <textarea rows="2" class="form-data" data-field="safeForChosenName"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gender Affirming Care Module (Hidden by default) -->
        <div class="section module-section" id="gac-section" style="display: none;">
            <div class="section-header module">
                <h2>🏳️‍⚧️ Gender Affirming Care</h2>
            </div>
            <div class="section-content">
                <h3>Hormone Therapy</h3>
                <div class="grid-2">
                    <div class="field">
                        <label>HRT Status</label>
                        <select class="form-data" data-field="hrtStatus">
                            <option value="">Select...</option>
                            <option>Not Started</option>
                            <option>Active</option>
                            <option>Paused</option>
                            <option>Discontinued</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>HRT Start Date</label>
                        <input type="date" class="form-data" data-field="hrtStartDate" />
                    </div>
                </div>
                
                <div class="field">
                    <label>Current Hormone Regimen</label>
                    <textarea rows="3" class="form-data" data-field="hormoneRegimen"></textarea>
                </div>
                
                <h3>Gender-Affirming Procedures</h3>
                <div id="gac-procedures-container"></div>
                <button class="add-btn no-print" id="addGACProcedureBtn">+ Add Procedure</button>
            </div>
        </div>

        <!-- Mental Health Module (Hidden by default) -->
        <div class="section module-section" id="mental-section" style="display: none;">
            <div class="section-header module">
                <h2>🧠 Mental Health</h2>
            </div>
            
            <div class="section-content">
                <h3>Current Mental Health</h3>
                <div class="field">
                    <label>Diagnoses</label>
                    <textarea rows="2" class="form-data" data-field="mentalDiagnoses"></textarea>
                </div>
                
                <div class="grid-2">
                    <div class="field">
                        <label>Therapist/Counselor</label>
                        <input type="text" class="form-data" data-field="therapist" />
                    </div>
                    <div class="field">
                        <label>Psychiatrist</label>
                        <input type="text" class="form-data" data-field="psychiatrist" />
                    </div>
                </div>
                
                <h3>Crisis Resources</h3>
                <div class="field">
                    <label>Crisis Contacts</label>
                    <textarea rows="3" class="form-data" data-field="crisisContacts" placeholder="988 Suicide & Crisis Lifeline&#10;Crisis text line: Text HOME to 741741"></textarea>
                </div>
                
                <div class="field">
                    <label>Safety Plan</label>
                    <textarea rows="4" class="form-data" data-field="safetyPlan"></textarea>
                </div>
            </div>
        </div>

        <!-- Chronic Disease Module (Hidden by default) -->
        <div class="section module-section" id="chronic-section" style="display: none;">
            <div class="section-header module">
                <h2>📊 Chronic Disease Management</h2>
            </div>
            <div class="section-content">
                <h3>Diabetes Management</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="has-diabetes" class="form-data" data-field="hasDiabetes">
                    <label for="has-diabetes">I have diabetes</label>
                </div>
                
                <div id="diabetesFields" style="display: none; margin-top: 15px;">
                    <div class="grid-3">
                        <div class="field">
                            <label>Type</label>
                            <select class="form-data" data-field="diabetesType">
                                <option value="">Select...</option>
                                <option>Type 1</option>
                                <option>Type 2</option>
                                <option>Gestational</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Last A1C</label>
                            <input type="text" class="form-data" data-field="lastA1c" placeholder="7.2" />
                        </div>
                        <div class="field">
                            <label>A1C Date</label>
                            <input type="date" class="form-data" data-field="a1cDate" />
                        </div>
                    </div>
                </div>
                
                <h3>Blood Pressure Management</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="has-hypertension" class="form-data" data-field="hasHypertension">
                    <label for="has-hypertension">I have hypertension</label>
                </div>
                
                <div id="hypertensionFields" style="display: none; margin-top: 15px;">
                    <div class="field">
                        <label>Target Blood Pressure</label>
                        <input type="text" class="form-data" data-field="targetBP" placeholder="< 130/80" />
                    </div>
                </div>
            </div>
        </div>

    <div class="info-box" style="margin-top: 30px;">
        <strong>Important:</strong> This HTML file contains all your encrypted medical data.
        After making changes, click "Download Updated Vault" to save the new file.
        Replace your old file with the new one. Keep backups in secure locations.
    </div>
    </div>

    <div id="printArea"></div>

    <!-- Embedded Data Script (Added by save function) -->
    <script id="embedded-vault-data" type="application/json">
    </script>

    <!-- Embedded QR Code Generator (no external dependencies) -->
    <script>
        // Minimal QR Code generator implementation - Same as before
        var QRCode;
        (function(){
            function QR8bitByte(data){this.mode=4;this.data=data;}
            QR8bitByte.prototype={getLength:function(){return this.data.length;},write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8);}}};
            function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[];}
            QRCodeModel.prototype={addData:function(data){var newData=new QR8bitByte(data);this.dataList.push(newData);this.dataCache=null;},isDark:function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col){throw new Error(row+","+col);}return this.modules[row][col];},getModuleCount:function(){return this.moduleCount;},make:function(){this.makeImpl(false,this.getBestMaskPattern());},makeImpl:function(test,maskPattern){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++){this.modules[row][col]=null;}}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.setupTypeInfo(test,maskPattern);if(this.typeNumber>=7){this.setupTypeNumber(test);}if(this.dataCache==null){this.dataCache=QRCodeModel.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);}this.mapData(this.dataCache,maskPattern);},setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)){this.modules[row+r][col+c]=true;}else{this.modules[row+r][col+c]=false;}}}},getBestMaskPattern:function(){var minLostPoint=0;var pattern=0;for(var i=0;i<8;i++){this.makeImpl(true,i);var lostPoint=QRUtil.getLostPoint(this);if(i==0||minLostPoint>lostPoint){minLostPoint=lostPoint;pattern=i;}}return pattern;},setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++){if(this.modules[r][6]!=null){continue;}this.modules[r][6]=(r%2==0);}for(var c=8;c<this.moduleCount-8;c++){if(this.modules[6][c]!=null){continue;}this.modules[6][c]=(c%2==0);}},setupPositionAdjustPattern:function(){var pos=QRUtil.getPatternPosition(this.typeNumber);for(var i=0;i<pos.length;i++){for(var j=0;j<pos.length;j++){var row=pos[i];var col=pos[j];if(this.modules[row][col]!=null){continue;}for(var r=-2;r<=2;r++){for(var c=-2;c<=2;c++){if(r==-2||r==2||c==-2||c==2||(r==0&&c==0)){this.modules[row+r][col+c]=true;}else{this.modules[row+r][col+c]=false;}}}}}},setupTypeNumber:function(test){var bits=QRUtil.getBCHTypeNumber(this.typeNumber);for(var i=0;i<18;i++){var mod=(!test&&((bits>>i)&1)==1);this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=mod;}for(var i=0;i<18;i++){var mod=(!test&&((bits>>i)&1)==1);this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=mod;}},setupTypeInfo:function(test,maskPattern){var data=(this.errorCorrectLevel<<3)|maskPattern;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var mod=(!test&&((bits>>i)&1)==1);if(i<6){this.modules[i][8]=mod;}else if(i<8){this.modules[i+1][8]=mod;}else{this.modules[this.moduleCount-15+i][8]=mod;}}for(var i=0;i<15;i++){var mod=(!test&&((bits>>i)&1)==1);if(i<8){this.modules[8][this.moduleCount-i-1]=mod;}else if(i<9){this.modules[8][15-i-1+1]=mod;}else{this.modules[8][15-i-1]=mod;}}this.modules[this.moduleCount-8][8]=(!test);},mapData:function(data,maskPattern){var inc=-1;var row=this.moduleCount-1;var bitIndex=7;var byteIndex=0;for(var col=this.moduleCount-1;col>0;col-=2){if(col==6)col--;while(true){for(var c=0;c<2;c++){if(this.modules[row][col-c]==null){var dark=false;if(byteIndex<data.length){dark=(((data[byteIndex]>>>bitIndex)&1)==1);}var mask=QRUtil.getMask(maskPattern,row,col-c);if(mask){dark=!dark;}this.modules[row][col-c]=dark;bitIndex--;if(bitIndex==-1){byteIndex++;bitIndex=7;}}}row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break;}}}}};QRCodeModel.PAD0=0xEC;QRCodeModel.PAD1=0x11;QRCodeModel.createData=function(typeNumber,errorCorrectLevel,dataList){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel);var buffer=new QRBitBuffer();for(var i=0;i<dataList.length;i++){var data=dataList[i];buffer.put(data.mode,4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.mode,typeNumber));data.write(buffer);}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i++){totalDataCount+=rsBlocks[i].dataCount;}if(buffer.getLengthInBits()>totalDataCount*8){throw new Error("code length overflow. ("+buffer.getLengthInBits()+">"+totalDataCount*8+")");}if(buffer.getLengthInBits()+4<=totalDataCount*8){buffer.put(0,4);}while(buffer.getLengthInBits()%8!=0){buffer.putBit(false);}while(true){if(buffer.getLengthInBits()>=totalDataCount*8){break;}buffer.put(QRCodeModel.PAD0,8);if(buffer.getLengthInBits()>=totalDataCount*8){break;}buffer.put(QRCodeModel.PAD1,8);}return QRCodeModel.createBytes(buffer,rsBlocks);};QRCodeModel.createBytes=function(buffer,rsBlocks){var offset=0;var maxDcCount=0;var maxEcCount=0;var dcdata=new Array(rsBlocks.length);var ecdata=new Array(rsBlocks.length);for(var r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount;var ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount);maxEcCount=Math.max(maxEcCount,ecCount);dcdata[r]=new Array(dcCount);for(var i=0;i<dcdata[r].length;i++){dcdata[r][i]=0xff&buffer.buffer[i+offset];}offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);var rawPoly=new QRPolynomial(dcdata[r],rsPoly.getLength()-1);var modPoly=rawPoly.mod(rsPoly);ecdata[r]=new Array(rsPoly.getLength()-1);for(var i=0;i<ecdata[r].length;i++){var modIndex=i+modPoly.getLength()-ecdata[r].length;ecdata[r][i]=(modIndex>=0)?modPoly.get(modIndex):0;}}var totalCodeCount=0;for(var i=0;i<rsBlocks.length;i++){totalCodeCount+=rsBlocks[i].totalCount;}var data=new Array(totalCodeCount);var index=0;for(var i=0;i<maxDcCount;i++){for(var r=0;r<rsBlocks.length;r++){if(i<dcdata[r].length){data[index++]=dcdata[r][i];}}}for(var i=0;i<maxEcCount;i++){for(var r=0;r<rsBlocks.length;r++){if(i<ecdata[r].length){data[index++]=ecdata[r][i];}}}return data;};var QRMode={MODE_NUMBER:1<<0,MODE_ALPHA_NUM:1<<1,MODE_8BIT_BYTE:1<<2,MODE_KANJI:1<<3};var QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1<<0),G18:(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1<<0),G15_MASK:(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1),getBCHTypeInfo:function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0){d^=(QRUtil.G15<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)));}return((data<<10)|d)^QRUtil.G15_MASK;},getBCHTypeNumber:function(data){var d=data<<12;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0){d^=(QRUtil.G18<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)));}return(data<<12)|d;},getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit;},getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber-1];},getMask:function(maskPattern,i,j){switch(maskPattern){case QRMaskPattern.PATTERN000:return(i+j)%2==0;case QRMaskPattern.PATTERN001:return i%2==0;case QRMaskPattern.PATTERN010:return j%3==0;case QRMaskPattern.PATTERN011:return(i+j)%3==0;case QRMaskPattern.PATTERN100:return(Math.floor(i/2)+Math.floor(j/3))%2==0;case QRMaskPattern.PATTERN101:return(i*j)%2+(i*j)%3==0;case QRMaskPattern.PATTERN110:return((i*j)%2+(i*j)%3)%2==0;case QRMaskPattern.PATTERN111:return((i*j)%3+(i+j)%2)%2==0;default:throw new Error("bad maskPattern:"+maskPattern);}},getErrorCorrectPolynomial:function(errorCorrectLength){var a=new QRPolynomial([1],0);for(var i=0;i<errorCorrectLength;i++){a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));}return a;},getLengthInBits:function(mode,type){if(1<=type&&type<10){switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:return 8;case QRMode.MODE_KANJI:return 8;default:throw new Error("mode:"+mode);}}else if(type<27){switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw new Error("mode:"+mode);}}else if(type<41){switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw new Error("mode:"+mode);}}else{throw new Error("type:"+type);}},getLostPoint:function(qrCode){var moduleCount=qrCode.getModuleCount();var lostPoint=0;for(var row=0;row<moduleCount;row++){for(var col=0;col<moduleCount;col++){var sameCount=0;var dark=qrCode.isDark(row,col);for(var r=-1;r<=1;r++){if(row+r<0||moduleCount<=row+r){continue;}for(var c=-1;c<=1;c++){if(col+c<0||moduleCount<=col+c){continue;}if(r==0&&c==0){continue;}if(dark==qrCode.isDark(row+r,col+c)){sameCount++;}}}if(sameCount>5){lostPoint+=(3+sameCount-5);}}}for(var row=0;row<moduleCount-1;row++){for(var col=0;col<moduleCount-1;col++){var count=0;if(qrCode.isDark(row,col))count++;if(qrCode.isDark(row+1,col))count++;if(qrCode.isDark(row,col+1))count++;if(qrCode.isDark(row+1,col+1))count++;if(count==0||count==4){lostPoint+=3;}}}for(var row=0;row<moduleCount;row++){for(var col=0;col<moduleCount-6;col++){if(qrCode.isDark(row,col)&&!qrCode.isDark(row,col+1)&&qrCode.isDark(row,col+2)&&qrCode.isDark(row,col+3)&&qrCode.isDark(row,col+4)&&!qrCode.isDark(row,col+5)&&qrCode.isDark(row,col+6)){lostPoint+=40;}}}for(var col=0;col<moduleCount;col++){for(var row=0;row<moduleCount-6;row++){if(qrCode.isDark(row,col)&&!qrCode.isDark(row+1,col)&&qrCode.isDark(row+2,col)&&qrCode.isDark(row+3,col)&&qrCode.isDark(row+4,col)&&!qrCode.isDark(row+5,col)&&qrCode.isDark(row+6,col)){lostPoint+=40;}}}var darkCount=0;for(var col=0;col<moduleCount;col++){for(var row=0;row<moduleCount;row++){if(qrCode.isDark(row,col)){darkCount++;}}}var ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5;lostPoint+=ratio*10;return lostPoint;}};var QRMath={glog:function(n){if(n<1){throw new Error("glog("+n+")");}return QRMath.LOG_TABLE[n];},gexp:function(n){while(n<0){n+=255;}while(n>=256){n-=255;}return QRMath.EXP_TABLE[n];},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};for(var i=0;i<8;i++){QRMath.EXP_TABLE[i]=1<<i;}for(var i=8;i<256;i++){QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];}for(var i=0;i<255;i++){QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;}function QRPolynomial(num,shift){if(num.length==undefined){throw new Error(num.length+"/"+shift);}var offset=0;while(offset<num.length&&num[offset]==0){offset++;}this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++){this.num[i]=num[i+offset];}}QRPolynomial.prototype={get:function(index){return this.num[index];},getLength:function(){return this.num.length;},multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++){for(var j=0;j<e.getLength();j++){num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));}}return new QRPolynomial(num,0);},mod:function(e){if(this.getLength()-e.getLength()<0){return this;}var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++){num[i]=this.get(i);}for(var i=0;i<e.getLength();i++){num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);}return new QRPolynomial(num,0).mod(e);}};function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}QRRSBlock.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){var rsBlock=QRRSBlock.getRsBlockTable(typeNumber,errorCorrectLevel);if(rsBlock==undefined){throw new Error("bad rs block @ typeNumber:"+typeNumber+"/errorCorrectLevel:"+errorCorrectLevel);}var length=rsBlock.length/3;var list=[];for(var i=0;i<length;i++){var count=rsBlock[i*3+0];var totalCount=rsBlock[i*3+1];var dataCount=rsBlock[i*3+2];for(var j=0;j<count;j++){list.push(new QRRSBlock(totalCount,dataCount));}}return list;};QRRSBlock.getRsBlockTable=function(typeNumber,errorCorrectLevel){switch(errorCorrectLevel){case QRErrorCorrectLevel.L:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+0];case QRErrorCorrectLevel.M:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+1];case QRErrorCorrectLevel.Q:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+2];case QRErrorCorrectLevel.H:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+3];default:return undefined;}};function QRBitBuffer(){this.buffer=[];this.length=0;}QRBitBuffer.prototype={get:function(index){var bufIndex=Math.floor(index/8);return((this.buffer[bufIndex]>>>(7-index%8))&1)==1;},put:function(num,length){for(var i=0;i<length;i++){this.putBit(((num>>>(length-i-1))&1)==1);}},getLengthInBits:function(){return this.length;},putBit:function(bit){var bufIndex=Math.floor(this.length/8);if(this.buffer.length<=bufIndex){this.buffer.push(0);}if(bit){this.buffer[bufIndex]|=(0x80>>>(this.length%8));}this.length++;}};var QRCodeLimitLength=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]];
            function _isSupportCanvas(){return typeof CanvasRenderingContext2D!="undefined";}
            function _getTypeNumber(sText,nCorrectLevel){var nType=1;var length=_getUTF8Length(sText);for(var i=0,len=QRCodeLimitLength.length;i<=len;i++){var nLimit=0;switch(nCorrectLevel){case QRErrorCorrectLevel.L:nLimit=QRCodeLimitLength[i][0];break;case QRErrorCorrectLevel.M:nLimit=QRCodeLimitLength[i][1];break;case QRErrorCorrectLevel.Q:nLimit=QRCodeLimitLength[i][2];break;case QRErrorCorrectLevel.H:nLimit=QRCodeLimitLength[i][3];break;}if(length<=nLimit){break;}else{nType++;}}if(nType>QRCodeLimitLength.length){throw new Error("Too long data");}return nType;}
            function _getUTF8Length(sText){var replacedText=encodeURI(sText).toString().replace(/\%[0-9a-fA-F]{2}/g,'a');return replacedText.length+(replacedText.length!=sText?3:0);}
            QRCode=function(el,vOption){this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRErrorCorrectLevel.H};if(typeof vOption==='string'){vOption={text:vOption};}if(vOption){for(var i in vOption){this._htOption[i]=vOption[i];}}if(typeof el=="string"){el=document.getElementById(el);}if(this._htOption.useSVG){Drawing=svgDrawer;}this._el=el;this._oQRCode=null;this._oDrawing=new Drawing(this._el,this._htOption);if(this._htOption.text){this.makeCode(this._htOption.text);}};
            QRCode.prototype.makeCode=function(sText){this._oQRCode=new QRCodeModel(_getTypeNumber(sText,this._htOption.correctLevel),this._htOption.correctLevel);this._oQRCode.addData(sText);this._oQRCode.make();this._el.title=sText;this._oDrawing.draw(this._oQRCode);this.makeImage();};
            QRCode.prototype.makeImage=function(){if(typeof this._oDrawing.makeImage=="function"&&(!this._android||this._android>=3)){this._oDrawing.makeImage();}};
            QRCode.prototype.clear=function(){this._oDrawing.clear();};
            QRCode.CorrectLevel=QRErrorCorrectLevel;
            function Drawing(el,htOption){this._el=el;this._htOption=htOption;}
            Drawing.prototype.draw=function(oQRCode){var _htOption=this._htOption;var nCount=oQRCode.getModuleCount();var nWidth=Math.floor(_htOption.width/nCount);var nHeight=Math.floor(_htOption.height/nCount);this.clear();var aHTML=['<table style="border:0;border-collapse:collapse;">'];for(var row=0;row<nCount;row++){aHTML.push('<tr>');for(var col=0;col<nCount;col++){aHTML.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:'+nWidth+'px;height:'+nHeight+'px;background-color:'+(oQRCode.isDark(row,col)?_htOption.colorDark:_htOption.colorLight)+';"></td>');}aHTML.push('</tr>');}aHTML.push('</table>');this._el.innerHTML=aHTML.join('');var elTable=this._el.childNodes[0];var nLeftMarginTable=(_htOption.width-elTable.offsetWidth)/2;var nTopMarginTable=(_htOption.height-elTable.offsetHeight)/2;if(nLeftMarginTable>0&&nTopMarginTable>0){elTable.style.margin=nTopMarginTable+"px "+nLeftMarginTable+"px";}};
            Drawing.prototype.clear=function(){this._el.innerHTML='';};
        })();
        
        // TOTP implementation for authenticator apps
        class TOTP {
            static base32ToHex(base32) {
                const base32chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
                let bits = "";
                let hex = "";
                
                for(let i = 0; i < base32.length; i++) {
                    const val = base32chars.indexOf(base32.charAt(i).toUpperCase());
                    if(val === -1) continue;
                    bits += val.toString(2).padStart(5, '0');
                }
                
                for(let i = 0; i + 4 <= bits.length; i += 4) {
                    const chunk = bits.substr(i, 4);
                    hex += parseInt(chunk, 2).toString(16);
                }
                
                return hex;
            }
            
            static async generateTOTP(secret, timeStep = 30) {
                const hexSecret = TOTP.base32ToHex(secret);
                const counter = Math.floor(Date.now() / 1000 / timeStep);
                const counterHex = counter.toString(16).padStart(16, '0');
                
                // Convert hex to bytes
                const secretBytes = new Uint8Array(hexSecret.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                const counterBytes = new Uint8Array(counterHex.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                
                // Import key for HMAC
                const key = await crypto.subtle.importKey(
                    'raw',
                    secretBytes,
                    { name: 'HMAC', hash: 'SHA-1' },
                    false,
                    ['sign']
                );
                
                // Generate HMAC
                const signature = await crypto.subtle.sign('HMAC', key, counterBytes);
                const signatureArray = new Uint8Array(signature);
                
                // Dynamic truncation
                const offset = signatureArray[signatureArray.length - 1] & 0xf;
                const code = (
                    ((signatureArray[offset] & 0x7f) << 24) |
                    ((signatureArray[offset + 1] & 0xff) << 16) |
                    ((signatureArray[offset + 2] & 0xff) << 8) |
                    (signatureArray[offset + 3] & 0xff)
                ) % 1000000;
                
                return code.toString().padStart(6, '0');
            }
            
            static async verifyTOTP(secret, code, window = 1) {
                const currentCode = await TOTP.generateTOTP(secret);
                if(currentCode === code) return true;
                
                // Check previous and next time windows
                for(let i = 1; i <= window; i++) {
                    const prevCode = await TOTP.generateTOTP(secret, 30, -i);
                    const nextCode = await TOTP.generateTOTP(secret, 30, i);
                    if(prevCode === code || nextCode === code) return true;
                }
                
                return false;
            }
        }
        
        // QR Code wrapper for emergency medical data
        const QRGenerator = {
            generate: function(data, container, size = { width: 256, height: 256 }) {
                // Clear any existing content
                container.innerHTML = '';

                // Create QR code with text data and specified size
                new QRCode(container, {
                    text: typeof data === 'object' ? JSON.stringify(data) : data,
                    width: size.width,
                    height: size.height,
                    correctLevel: QRCode.CorrectLevel.L
                });
            },
            
            generateOTPAuth: function(secret, label, issuer, container) {
                const uri = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(label)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}`;
                
                // Clear container
                container.innerHTML = '';
                
                // Generate QR code
                try {
                    new QRCode(container, {
                        text: uri,
                        width: 256,
                        height: 256,
                        correctLevel: QRCode.CorrectLevel.M
                    });
                } catch (e) {
                    console.error('TOTP QR generation failed:', e);
                }
            }
        };
    </script>

    <!-- Main Application Script -->
    <script>
        // Medication API Search Module
        const MedicationSearch = {
            searchTimeout: null,
            selectedIndex: -1,
            searchResults: [],
            
            async searchMedications(query, dropdown) {
                try {
                    // Using OpenFDA API - searching in the drug labels endpoint
                    const url = `https://api.fda.gov/drug/label.json?search=openfda.brand_name:"${query}"+OR+openfda.generic_name:"${query}"&limit=20`;
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            dropdown.innerHTML = '<div class="med-dropdown-item">No medications found - Type manually</div>';
                            return;
                        }
                        throw new Error('API request failed');
                    }
                    
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        this.displayResults(data.results, dropdown);
                    } else {
                        dropdown.innerHTML = '<div class="med-dropdown-item">No medications found - Type manually</div>';
                    }
                } catch (error) {
                    console.error('Error searching medications:', error);
                    
                    // Try a simpler search as fallback
                    try {
                        const fallbackUrl = `https://api.fda.gov/drug/label.json?search=${encodeURIComponent(query)}&limit=15`;
                        const fallbackResponse = await fetch(fallbackUrl);
                        
                        if (fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            if (fallbackData.results && fallbackData.results.length > 0) {
                                this.displayResults(fallbackData.results, dropdown);
                                return;
                            }
                        }
                    } catch (fallbackError) {
                        console.error('Fallback search also failed:', fallbackError);
                    }
                    
                    dropdown.innerHTML = '<div class="med-dropdown-item">Offline mode - Type medication manually</div>';
                }
            },
            
            displayResults(results, dropdown) {
                this.searchResults = [];
                dropdown.innerHTML = '';
                this.selectedIndex = -1;
                
                // Create a Set to avoid duplicates
                const seen = new Set();
                
                results.forEach((result) => {
                    if (result.openfda) {
                        const brandNames = result.openfda.brand_name || [];
                        const genericNames = result.openfda.generic_name || [];
                        const manufacturer = result.openfda.manufacturer_name ? result.openfda.manufacturer_name[0] : 'Unknown';
                        const routes = result.openfda.route || ['Oral'];
                        const dosageForms = result.openfda.dosage_form || ['Tablet'];
                        
                        // Process brand names
                        brandNames.forEach(brandName => {
                            const key = brandName.toLowerCase();
                            if (!seen.has(key)) {
                                seen.add(key);
                                const medication = {
                                    brandName: brandName,
                                    genericName: genericNames[0] || 'N/A',
                                    manufacturer: manufacturer,
                                    route: routes[0],
                                    dosageForm: dosageForms[0],
                                    isBrand: true
                                };
                                this.searchResults.push(medication);
                            }
                        });
                        
                        // Process generic names
                        genericNames.forEach(genericName => {
                            const key = genericName.toLowerCase();
                            if (!seen.has(key)) {
                                seen.add(key);
                                const medication = {
                                    brandName: brandNames[0] || genericName,
                                    genericName: genericName,
                                    manufacturer: manufacturer,
                                    route: routes[0],
                                    dosageForm: dosageForms[0],
                                    isBrand: false
                                };
                                this.searchResults.push(medication);
                            }
                        });
                    }
                });
                
                // Limit to 10 results for better UX
                this.searchResults = this.searchResults.slice(0, 10);
                
                this.searchResults.forEach((medication, index) => {
                    const item = document.createElement('div');
                    item.className = 'med-dropdown-item';
                    item.dataset.index = index;
                    
                    item.innerHTML = `
                        <div class="drug-name">
                            ${medication.brandName}
                        </div>
                        <div class="drug-details">
                            ${medication.genericName !== medication.brandName ? `Generic: ${medication.genericName}<br>` : ''}
                            ${medication.dosageForm} • ${medication.route}
                        </div>
                    `;
                    
                    dropdown.appendChild(item);
                });
                
                if (this.searchResults.length === 0) {
                    dropdown.innerHTML = '<div class="med-dropdown-item">No medications found - Type manually</div>';
                }
            }
        };
        
        // Main Application Class
        class HealthVaultApp {
            constructor() {
                // Vault identity word lists - expanded for 1M+ combinations
                this.adjectives = [
                    'gentle', 'crystal', 'golden', 'silver', 'cosmic', 'serene',
                    'mystic', 'eternal', 'tranquil', 'radiant', 'peaceful', 'stellar',
                    'azure', 'crimson', 'emerald', 'violet', 'ancient', 'sacred',
                    'bright', 'calm', 'noble', 'pure', 'wise', 'brave',
                    'swift', 'clear', 'grand', 'royal', 'proud', 'bold',
                    'vivid', 'prime', 'keen', 'fair', 'true', 'warm',
                    'amber', 'jade', 'ruby', 'pearl', 'opal', 'coral',
                    'lunar', 'solar', 'astral', 'primal', 'vital', 'nexus',
                    'alpha', 'omega', 'zenith', 'vertex', 'apex', 'prime',
                    'quantum', 'cyber', 'echo', 'nova', 'flux', 'spark'
                ];
                
                this.nouns = [
                    'mountain', 'ocean', 'forest', 'valley', 'sunrise', 'cascade', 
                    'meadow', 'horizon', 'sanctuary', 'constellation', 'lighthouse', 'glacier',
                    'phoenix', 'compass', 'harbor', 'garden', 'bridge', 'fountain',
                    'river', 'summit', 'canyon', 'prairie', 'tundra', 'reef',
                    'temple', 'citadel', 'beacon', 'atlas', 'nexus', 'prism',
                    'shield', 'guardian', 'sentinel', 'keeper', 'watcher', 'guide',
                    'storm', 'thunder', 'lightning', 'aurora', 'comet', 'nebula',
                    'spirit', 'essence', 'cipher', 'enigma', 'oracle', 'rune',
                    'dragon', 'griffin', 'falcon', 'eagle', 'wolf', 'lion',
                    'crystal', 'diamond', 'sapphire', 'element', 'force', 'wave'
                ];
                
                // Generate initial vault identity
                this.vaultIdentity = this.generateVaultName();
                
                // Check for embedded data
                this.checkInitialization();
                
                // Initialize state
                this.hasUnsavedChanges = false;
                this.sessionPassword = null;
                this.currentTOTPSecret = null;
                this.requires2FA = false;
                this.isLocked = false;
                this.modules = {
                    identity: false,
                    gac: false,
                    mental: false,
                    chronic: false
                };
                this.sectionLocks = {};

                // Emergency QR helpers
                this.QR_BYTE_LIMIT = 1500;
                this.QR_TEXT_LIMIT = 900;
                this.truncationNotice = '\n\n⚠️ Additional emergency details omitted. See vault for full record.';
                this._textEncoder = new TextEncoder();

                // Initialize
                this.init();
            }
            
            generateVaultName() {
                const adj = this.adjectives[Math.floor(Math.random() * this.adjectives.length)];
                const noun = this.nouns[Math.floor(Math.random() * this.nouns.length)];
                const num = Math.floor(Math.random() * 1000);
                return `${adj}-${noun}-${num}`;
            }
            
            checkInitialization() {
                const embeddedData = document.getElementById('embedded-vault-data');
                const dataContent = embeddedData?.textContent?.trim();
                
                if (dataContent && dataContent !== '') {
                    try {
                        const vaultData = JSON.parse(dataContent);
                        this.isInitialized = vaultData.initialized;
                        this.encryptedData = vaultData.data;
                        this.savedModules = vaultData.modules;
                        this.requires2FA = vaultData.requires2FA || false;
                        this.vaultIdentity = vaultData.vaultIdentity;
                        this.lastSaved = vaultData.savedDate;
                        
                        // Update unlock screen with vault info
                        const unlockScreen = document.getElementById('unlockScreen');
                        const unlockContainer = unlockScreen.querySelector('.unlock-container');
                        
                        const vaultInfoHTML = `
                            <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                                <h3 style="margin: 0; color: #3b82f6; font-size: 16pt;">🔷 ${this.vaultIdentity}</h3>
                                <p style="margin: 5px 0 0 0; color: #64748b; font-size: 9pt;">
                                    Last saved: ${new Date(this.lastSaved).toLocaleString()}
                                </p>
                            </div>
                        `;
                        
                        unlockContainer.querySelector('h2').insertAdjacentHTML('afterend', vaultInfoHTML);
                        
                        // Show unlock screen
                        document.getElementById('welcomeScreen').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'none';
                        unlockScreen.style.display = 'flex';
                        
                        if (this.requires2FA) {
                            document.getElementById('totpField').style.display = 'block';
                        }
                    } catch (e) {
                        this.isInitialized = false;
                    }
                } else {
                    this.isInitialized = false;
                    // Show welcome screen
                    document.getElementById('welcomeScreen').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                    document.getElementById('unlockScreen').style.display = 'none';
                }
            }
            
            init() {
                this.setupEventListeners();
                this.updateSaveStatus();
                
                // Clear any cached data
                localStorage.clear();
                sessionStorage.clear();
            }
            
            setupEventListeners() {
                // Main buttons
                document.getElementById('saveBtn').addEventListener('click', () => this.saveVault());
                document.getElementById('settingsBtn').addEventListener('click', () => this.openSettings());
                document.getElementById('emergencyQRBtn').addEventListener('click', () => this.openQRGenerator());
                document.getElementById('exportBtn').addEventListener('click', () => this.openExportOptions());
                document.getElementById('lockBtn')?.addEventListener('click', () => this.toggleLock());

                document.getElementById('printSummaryBtn')?.addEventListener('click', () => {
                    this.closeExportOptions();
                    this.printSummary();
                });

                document.getElementById('exportCloseBtn')?.addEventListener('click', () => this.closeExportOptions());
                
                // Navigation
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.navigateToSection(e));
                });
                
                // Module toggles
                ['identity', 'gac', 'mental', 'chronic'].forEach(module => {
                    const toggle = document.getElementById(`module-${module}`);
                    if (toggle) {
                        toggle.addEventListener('change', () => this.toggleModule(module));
                    }
                });
                
                // Add buttons
                document.getElementById('addEmergencyBtn')?.addEventListener('click', () => this.addEmergencyContact());
                document.getElementById('addMedicationBtn')?.addEventListener('click', () => this.addMedication());
                document.getElementById('addConditionBtn')?.addEventListener('click', () => this.addCondition());
                document.getElementById('addSurgeryBtn')?.addEventListener('click', () => this.addSurgery());
                document.getElementById('addProviderBtn')?.addEventListener('click', () => this.addProvider());
                document.getElementById('addNoteBtn')?.addEventListener('click', () => this.addNote());
                document.getElementById('addVitalBtn')?.addEventListener('click', () => this.addVitalSign());
                document.getElementById('addLabBtn')?.addEventListener('click', () => this.addLabResult());
                document.getElementById('addCovidVaccineBtn')?.addEventListener('click', () => this.addCovidVaccine());
                document.getElementById('addVaccineBtn')?.addEventListener('click', () => this.addVaccine());
                
                // Track changes
                const identityFields = new Set(['firstName', 'lastName', 'middleInitial', 'mrn', 'biologicalSex', 'dateOfBirth']);

                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('form-data')) {
                        this.markAsChanged();

                        if (identityFields.has(e.target.dataset.field)) {
                            this.updatePatientSummaryDisplay();
                        }
                    }
                });

                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('form-data') && identityFields.has(e.target.dataset.field)) {
                        this.updatePatientSummaryDisplay();
                    }
                });
                
                // Password modal
                document.getElementById('modalSubmit').addEventListener('click', () => this.handlePasswordSubmit());
                document.getElementById('modalCancel').addEventListener('click', () => this.closePasswordModal());
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        this.saveVault();
                    }
                });
                this.updatePatientSummaryDisplay();
            }
            
            startSetup() {
                const identityHTML = `
                    <div style="margin: 20px 0; padding: 20px; background: #eff6ff; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; color: #1e293b;">Your Vault Identity</h3>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <h2 id="vaultName" style="color: #3b82f6; margin: 0;">🔷 ${this.vaultIdentity}</h2>
                            <button onclick="app.regenerateVaultName()" style="padding: 8px 12px; background: #e0e7ff; border: none; border-radius: 6px; cursor: pointer; font-size: 16pt;">🎲</button>
                        </div>
                        <p style="margin: 10px 0 0 0; color: #64748b; font-size: 9pt;">
                            This unique name identifies your vault across all saves.<br>
                            Write it down to recognize your vault in the future.
                        </p>
                    </div>
                `;
                
                document.getElementById('welcomeScreen').style.display = 'none';
                
                const modal = document.getElementById('passwordModal');
                modal.classList.add('active');
                document.getElementById('modalTitle').textContent = 'Create Your Health Vault';
                
                const modalBody = modal.querySelector('.modal-body');
                const firstField = modalBody.querySelector('.field');
                firstField.insertAdjacentHTML('beforebegin', identityHTML);
                
                const twoFAHTML = `
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 6px;">
                        <div class="checkbox-item">
                            <input type="checkbox" id="enable2FA">
                            <label for="enable2FA"><strong>Enable Two-Factor Authentication (Optional)</strong></label>
                        </div>
                        <p style="margin: 10px 0 0 20px; font-size: 9pt; color: #64748b;">
                            <strong>Optional security enhancement:</strong> Adds an extra layer using an authenticator app.<br>
                            You can skip this and use password-only protection if you prefer.<br>
                            If enabled, you'll need both password AND 6-digit code to unlock.
                        </p>
                    </div>
                `;
                
                const confirmField = document.getElementById('confirmPasswordField');
                confirmField.insertAdjacentHTML('afterend', twoFAHTML);
            }
            
            regenerateVaultName() {
                this.vaultIdentity = this.generateVaultName();
                document.getElementById('vaultName').innerHTML = `🔷 ${this.vaultIdentity}`;
            }
            
            attemptUnlock() {
                const password = document.getElementById('unlock-password').value;
                const totpCode = document.getElementById('totp-code')?.value;
                
                if (!password) {
                    alert('Please enter your password');
                    return;
                }
                
                if (this.requires2FA && !totpCode) {
                    alert('Please enter your 6-digit authentication code');
                    return;
                }
                
                this.crypto.decrypt(this.encryptedData, password).then(async (decrypted) => {
                    if (this.requires2FA && decrypted.totpSecret) {
                        const isValidTOTP = await TOTP.verifyTOTP(decrypted.totpSecret, totpCode);
                        
                        if (!isValidTOTP) {
                            alert('Invalid authentication code. Please check your authenticator app for the current code.');
                            return;
                        }
                    }
                    
                    this.sessionPassword = password;
                    this.totpSecret = decrypted.totpSecret;
                    this.loadFormData(decrypted);
                    this.modules = this.savedModules || this.modules;
                    
                    this.updateModuleVisibility();
                    document.getElementById('unlockScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('navTabs').style.display = 'block';
                    document.getElementById('lockBtn').style.display = 'inline-block';
                    
                    this.hasUnsavedChanges = false;
                    this.updateSaveStatus();
                    
                }).catch(error => {
                    if (this.requires2FA) {
                        alert('Invalid password or authentication code.\n\nMake sure you are using the current 6-digit code from your authenticator app.');
                    } else {
                        alert('Incorrect password');
                    }
                });
            }
            
            navigateToSection(e) {
                const sectionId = e.target.dataset.section;
                const section = document.getElementById(`${sectionId}-section`);
                if (section) {
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            
            toggleModule(moduleName) {
                this.modules[moduleName] = document.getElementById(`module-${moduleName}`).checked;
                this.updateModuleVisibility();
                this.markAsChanged();
            }
            
            updateModuleVisibility() {
                const identitySection = document.getElementById('identity-section');
                const gacSection = document.getElementById('gac-section');
                const mentalSection = document.getElementById('mental-section');
                const chronicSection = document.getElementById('chronic-section');
                
                identitySection.style.display = this.modules.identity ? 'block' : 'none';
                gacSection.style.display = this.modules.gac ? 'block' : 'none';
                mentalSection.style.display = this.modules.mental ? 'block' : 'none';
                chronicSection.style.display = this.modules.chronic ? 'block' : 'none';
                
                if (this.modules.identity || this.modules.gac) {
                    const mainContent = document.getElementById('mainContent');
                    const emergencySection = document.getElementById('emergency-section');
                    const coreSection = document.getElementById('core-section');
                    
                    if (this.modules.identity && identitySection) {
                        emergencySection.after(identitySection);
                    }
                    
                    if (this.modules.gac && gacSection) {
                        if (this.modules.identity && identitySection) {
                            identitySection.after(gacSection);
                        } else {
                            emergencySection.after(gacSection);
                        }
                    }
                }
                
                this.updateNavigationTabs();
            }
            
            updateNavigationTabs() {
                const navTabs = document.getElementById('navTabs');
                const existingModuleTabs = navTabs.querySelectorAll('.module-tab');
                existingModuleTabs.forEach(tab => tab.remove());
                
                const demographicsTab = navTabs.querySelector('[data-section="demographics"]');
                
                if (this.modules.identity) {
                    const identityTab = document.createElement('div');
                    identityTab.className = 'tab module-tab';
                    identityTab.setAttribute('data-section', 'identity');
                    identityTab.innerHTML = '👤 Identity';
                    demographicsTab.after(identityTab);
                }
                
                if (this.modules.gac) {
                    const gacTab = document.createElement('div');
                    gacTab.className = 'tab module-tab';
                    gacTab.setAttribute('data-section', 'gac');
                    gacTab.innerHTML = '🏳️‍⚧️ GAC';
                    const insertAfter = this.modules.identity ? 
                        navTabs.querySelector('[data-section="identity"]') : 
                        demographicsTab;
                    insertAfter.after(gacTab);
                }
                
                if (this.modules.mental) {
                    navTabs.insertAdjacentHTML('beforeend', '<div class="tab module-tab" data-section="mental">🧠 Mental Health</div>');
                }
                if (this.modules.chronic) {
                    navTabs.insertAdjacentHTML('beforeend', '<div class="tab module-tab" data-section="chronic">📊 Chronic</div>');
                }
                
                navTabs.querySelectorAll('.module-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.navigateToSection(e));
                });
            }
            
            markAsChanged() {
                this.hasUnsavedChanges = true;
                this.updateSaveStatus();
            }
            
            updateSaveStatus() {
                const statusEl = document.getElementById('saveStatus');
                const saveBtn = document.getElementById('saveBtn');
                
                if (!this.isInitialized) {
                    statusEl.className = 'save-status never-saved';
                    statusEl.innerHTML = '⚠️ Not Initialized - Create Your Vault';
                    saveBtn.innerHTML = 'Create Encrypted Vault';
                    saveBtn.className = 'btn btn-save';
                } else if (this.hasUnsavedChanges) {
                    statusEl.className = 'save-status unsaved';
                    statusEl.innerHTML = '⚠️ Unsaved Changes - Download Updated HTML';
                    saveBtn.innerHTML = 'Download Updated Vault';
                    saveBtn.className = 'btn btn-save';
                } else {
                    statusEl.className = 'save-status saved';
                    statusEl.innerHTML = '✓ Data Encrypted in This File';
                    saveBtn.innerHTML = 'Download Current Vault';
                    saveBtn.className = 'btn btn-save saved';
                }
            }
            
            async saveVault() {
                if (!this.sessionPassword) {
                    this.showPasswordModal();
                } else {
                    await this.performSave(this.sessionPassword);
                }
            }
            
            showPasswordModal() {
                const modal = document.getElementById('passwordModal');
                modal.classList.add('active');
                document.getElementById('modalPassword').focus();
            }
            
            closePasswordModal() {
                document.getElementById('passwordModal').classList.remove('active');
                document.getElementById('modalPassword').value = '';
                document.getElementById('modalConfirmPassword').value = '';
            }
            
            async handlePasswordSubmit() {
                const password = document.getElementById('modalPassword').value;
                const confirmPassword = document.getElementById('modalConfirmPassword').value;
                const enable2FA = document.getElementById('enable2FA')?.checked;
                
                if (!password) {
                    alert('Please enter a password');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                if (password.length < 8) {
                    alert('Password must be at least 8 characters');
                    return;
                }
                
                this.sessionPassword = password;
                this.closePasswordModal();
                
                if (enable2FA) {
                    this.requires2FA = true;
                    this.setupTOTP();
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('navTabs').style.display = 'block';
                    
                    this.isInitialized = true;
                    this.hasUnsavedChanges = true;
                    this.updateSaveStatus();
                    
                    alert(`✅ Vault created!\n\n` +
                          `Your vault "${this.vaultIdentity}" is ready to use.\n\n` +
                          `• Enter your medical information\n` +
                          `• Click "Download Encrypted Vault" when ready to save\n` +
                          `• Keep your password safe - there's no recovery without it`);
                }
            }
            
            async performSave(password) {
                const formData = this.collectFormData();
                const timestamp = new Date().toLocaleString();
                
                document.getElementById('lastUpdatedHeader').textContent = `Last Updated: ${timestamp}`;
                formData.lastUpdated = timestamp;
                
                const encrypted = await this.crypto.encrypt(formData, password);
                
                const htmlDoc = document.documentElement.cloneNode(true);
                
                const existingData = htmlDoc.querySelector('#embedded-vault-data');
                if (existingData) {
                    existingData.textContent = '';
                }
                
                const dataScript = htmlDoc.querySelector('#embedded-vault-data');
                dataScript.textContent = JSON.stringify({
                    initialized: true,
                    encrypted: true,
                    version: '2.0',
                    savedDate: new Date().toISOString(),
                    data: encrypted,
                    modules: this.modules,
                    requires2FA: this.requires2FA,
                    vaultIdentity: this.vaultIdentity
                }, null, 2);
                
                const htmlString = '<!DOCTYPE html>\n' + htmlDoc.outerHTML;
                
                const blob = new Blob([htmlString], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `health_vault_${this.vaultIdentity}_${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.hasUnsavedChanges = false;
                this.isInitialized = true;
                this.updateSaveStatus();
                
                const isFirstSave = !this.hasShownSaveInstructions;
                this.hasShownSaveInstructions = true;
                
                if (isFirstSave) {
                    alert('✅ Your health vault has been saved!\n\n' +
                          '📁 IMPORTANT INSTRUCTIONS:\n' +
                          '1. The downloaded HTML file contains all your encrypted data\n' +
                          '2. Store this file in a safe location\n' +
                          '3. Make backups on different devices or cloud storage\n' +
                          '4. You can open this file in any web browser\n\n' +
                          '🔐 Remember:\n' +
                          '• Your password is NOT recoverable if lost\n' +
                          '• Each save creates a new file - replace the old one\n' +
                          '• The file works completely offline');
                } else {
                    alert('✅ Vault updated and downloaded!\n\n' +
                          'Replace your previous vault file with this new version.');
                }
            }
            
            collectFormData() {
                const formData = {};
                const inputs = document.querySelectorAll('.form-data');
                
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (input.type === 'checkbox') {
                        formData[field] = input.checked;
                    } else {
                        formData[field] = input.value;
                    }
                });
                
                if (this.requires2FA && this.totpSecret) {
                    formData.totpSecret = this.totpSecret;
                }
                
                return formData;
            }
            
            loadFormData(data) {
                const inputs = document.querySelectorAll('.form-data');

                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (data.hasOwnProperty(field)) {
                        if (input.type === 'checkbox') {
                            input.checked = data[field];
                        } else {
                            input.value = data[field];
                        }
                    }
                });

                document.getElementById('lastUpdatedHeader').textContent = `Last Updated: ${data.lastUpdated || 'Never'}`;
                this.updatePatientSummaryDisplay();
            }

            calculateAge(dobString) {
                if (!dobString) return null;

                const dob = new Date(`${dobString}T00:00:00`);
                if (Number.isNaN(dob.getTime())) {
                    return null;
                }

                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }

                return age >= 0 ? age : null;
            }

            updatePatientSummaryDisplay() {
                const avatarEl = document.getElementById('patientAvatar');
                const nameEl = document.getElementById('patientDisplayName');
                const metaEl = document.getElementById('patientDisplayMeta');

                if (!avatarEl || !nameEl || !metaEl) {
                    return;
                }

                const firstName = document.querySelector('[data-field="firstName"]')?.value.trim() || '';
                const lastName = document.querySelector('[data-field="lastName"]')?.value.trim() || '';
                const middleInitial = document.querySelector('[data-field="middleInitial"]')?.value.trim() || '';
                const mrn = document.querySelector('[data-field="mrn"]')?.value.trim() || '';
                const dob = document.querySelector('[data-field="dateOfBirth"]')?.value || '';
                const sex = document.querySelector('[data-field="biologicalSex"]')?.value || '';

                const displayNameParts = [];
                if (firstName) displayNameParts.push(firstName);
                if (middleInitial) displayNameParts.push(`${middleInitial.replace(/\./g, '')}.`);
                if (lastName) displayNameParts.push(lastName);

                const displayName = displayNameParts.join(' ').trim();
                nameEl.textContent = displayName || 'Enter patient name';

                const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.trim().toUpperCase();
                avatarEl.textContent = initials || (firstName.charAt(0).toUpperCase() || lastName.charAt(0).toUpperCase() || '👤');

                const metaParts = [];
                if (dob) {
                    const dobDate = new Date(`${dob}T00:00:00`);
                    if (!Number.isNaN(dobDate.getTime())) {
                        const formattedDOB = dobDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                        const age = this.calculateAge(dob);
                        metaParts.push(`DOB ${formattedDOB}${age !== null ? ` (${age} yrs)` : ''}`);
                    }
                }

                if (sex) {
                    metaParts.push(sex);
                }

                if (mrn) {
                    metaParts.push(`MRN ${mrn}`);
                }

                metaEl.textContent = metaParts.length ? metaParts.join(' • ') : 'Add DOB, sex, and MRN for quick reference.';
            }
            
            openSettings() {
                const modal = document.getElementById('settingsModal');
                modal.classList.add('active');
                
                document.getElementById('module-identity').checked = this.modules.identity;
                document.getElementById('module-gac').checked = this.modules.gac;
                document.getElementById('module-mental').checked = this.modules.mental;
                document.getElementById('module-chronic').checked = this.modules.chronic;
                
                const statusDiv = document.getElementById('totpStatus');
                if (this.requires2FA) {
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20pt;">✅</span>
                            <div>
                                <strong style="color: #22c55e;">Two-Factor Authentication Enabled</strong><br>
                                <span style="font-size: 9pt; color: #64748b;">
                                    Your vault requires password + authenticator code
                                </span>
                            </div>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20pt;">🔓</span>
                            <div>
                                <strong>Two-Factor Authentication Disabled</strong><br>
                                <span style="font-size: 9pt; color: #64748b;">
                                    Your vault is protected by password only
                                </span>
                            </div>
                        </div>
                        <p style="margin-top: 10px; font-size: 9pt; color: #94a3b8;">
                            To enable 2FA, create a new vault with the option selected.
                        </p>
                    `;
                }
            }
            
            closeSettings() {
                document.getElementById('settingsModal').classList.remove('active');
            }
            
            saveSettings() {
                this.closeSettings();
            }
            
            setupTOTP() {
                const secret = this.generateTOTPSecret();
                this.currentTOTPSecret = secret;
                
                const modal = document.getElementById('totpModal');
                modal.classList.add('active');
                
                document.getElementById('totpSecret').textContent = this.formatSecret(secret);
                
                const issuer = 'HealthVault';
                const label = this.vaultIdentity;
                
                const qrContainer = document.getElementById('totpQR');
                qrContainer.innerHTML = '';
                
                QRGenerator.generateOTPAuth(secret, label, issuer, qrContainer);
                
                const backupNote = `
                    <div class="warning-box">
                        <strong>⚠️ Important Security Notice:</strong><br>
                        Your authenticator code becomes part of your encryption key.<br>
                        You will need BOTH your password AND a valid code to unlock your vault.<br><br>
                        <strong>Make sure to:</strong><br>
                        • Save this secret in multiple authenticator apps<br>
                        • Write down the secret key shown above<br>
                        • Test that your code works before saving<br><br>
                        <strong>Compatible with:</strong> Google Authenticator, Microsoft Authenticator, Authy, 1Password, etc.
                    </div>
                `;
                document.getElementById('backupCodes').parentElement.innerHTML = backupNote;
            }
            
            generateTOTPSecret() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                let secret = '';
                for (let i = 0; i < 16; i++) {
                    secret += chars[Math.floor(Math.random() * chars.length)];
                }
                return secret;
            }
            
            formatSecret(secret) {
                return secret.match(/.{1,4}/g).join(' ');
            }
            
            async verifyTOTP() {
                const code = document.getElementById('verifyTOTP').value;
                
                if (code.length !== 6 || !/^\d{6}$/.test(code)) {
                    alert('Please enter a 6-digit code from your authenticator app');
                    return;
                }
                
                const isValid = await TOTP.verifyTOTP(this.currentTOTPSecret, code);
                
                if (!isValid) {
                    alert('Invalid code. Please make sure you\'ve added the secret to your authenticator app and try the current code shown.');
                    return;
                }
                
                this.totpSecret = this.currentTOTPSecret;
                
                document.getElementById('totpModal').classList.remove('active');
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('navTabs').style.display = 'block';
                
                this.isInitialized = true;
                this.hasUnsavedChanges = true;
                this.updateSaveStatus();
                
                alert(`✅ Two-factor authentication enabled!\n\n` +
                      `Your vault "${this.vaultIdentity}" is ready to use.\n\n` +
                      `• Enter your medical information\n` +
                      `• Click "Download Encrypted Vault" when ready to save\n` +
                      `• You'll need both password AND authenticator code to unlock`);
                
                this.currentTOTPSecret = null;
            }
            
            cancelTOTP() {
                this.currentTOTPSecret = null;
                document.getElementById('totpModal').classList.remove('active');
                
                if (!this.isInitialized) {
                    this.requires2FA = false;
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('navTabs').style.display = 'block';
                    
                    this.isInitialized = true;
                    this.hasUnsavedChanges = true;
                    this.updateSaveStatus();
                    
                    alert(`✅ Vault created without 2FA!\n\n` +
                          `Your vault "${this.vaultIdentity}" is ready to use.\n\n` +
                          `• Enter your medical information\n` +
                          `• Click "Download Encrypted Vault" when ready to save\n` +
                          `• Keep your password safe - there's no recovery without it`);
                }
            }
            
            openQRGenerator() {
                document.getElementById('qrModal').classList.add('active');
            }

            generateQR() {
                const container = document.getElementById('qr-canvas');
                const previewEl = document.getElementById('qrPreviewText');
                const warningEl = document.getElementById('qrWarning');

                container.innerHTML = '';
                if (previewEl) previewEl.textContent = '';
                if (warningEl) warningEl.textContent = '';

                const { text: summaryText, hasDetails } = this.buildEmergencySummary();
                let maxTextBytes = this.QR_TEXT_LIMIT;
                let { text: qrText, truncated } = this.fitTextForQR(summaryText, maxTextBytes);
                let dataUrl = this.buildEmergencyDataUrl(qrText);
                let encodedLength = this._textEncoder.encode(dataUrl).length;

                while (encodedLength > this.QR_BYTE_LIMIT && maxTextBytes > 200) {
                    maxTextBytes = Math.floor(maxTextBytes * 0.85);
                    ({ text: qrText, truncated } = this.fitTextForQR(summaryText, maxTextBytes));
                    dataUrl = this.buildEmergencyDataUrl(qrText);
                    encodedLength = this._textEncoder.encode(dataUrl).length;
                    truncated = true;
                }

                if (encodedLength > this.QR_BYTE_LIMIT) {
                    qrText = 'EMERGENCY MEDICAL INFO\nSummary exceeds QR capacity. Access vault for full record.';
                    dataUrl = this.buildEmergencyDataUrl(qrText);
                    encodedLength = this._textEncoder.encode(dataUrl).length;
                    truncated = true;
                }

                if (previewEl) {
                    previewEl.textContent = qrText;
                    previewEl.scrollTop = 0;
                }

                if (warningEl) {
                    if (!hasDetails) {
                        warningEl.textContent = 'Add emergency details to include more information in the QR code.';
                    } else {
                        const messages = ['Scan with your phone to open this summary in a browser window.'];
                        if (truncated) {
                            messages.push('Emergency summary shortened to fit inside the QR code. Review the preview for omitted details.');
                        }
                        warningEl.textContent = messages.join(' ');
                    }
                }

                try {
                    QRGenerator.generate(dataUrl, container, { width: 200, height: 200 });
                    console.log('QR generated with data URL:', dataUrl);
                } catch (e) {
                    console.error('QR generation failed:', e);
                    this.createFallbackDisplay(container, qrText);
                    if (warningEl) {
                        warningEl.textContent = 'Unable to render QR code. Emergency summary shown below for quick reference.';
                    }
                }
            }

            buildEmergencyHtml(text) {
                const escaped = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                return `<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Emergency Medical Info</title><style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;background:#0f172a;color:#f8fafc;margin:0;padding:24px;}main{max-width:600px;margin:0 auto;background:#1e293b;padding:24px;border-radius:12px;box-shadow:0 20px 60px rgba(15,23,42,0.45);}h1{margin-top:0;font-size:20pt;color:#38bdf8;text-align:center;}p.notice{color:#e2e8f0;font-size:10pt;text-align:center;margin-bottom:20px;}pre{background:#0f172a;border-radius:8px;padding:16px;white-space:pre-wrap;word-break:break-word;font-size:11pt;line-height:1.5;color:#f8fafc;border:1px solid rgba(148,163,184,0.3);}</style></head><body><main><h1>Emergency Medical Info</h1><p class="notice">Provided from your Personal Health Vault QR code.</p><pre>${escaped}</pre></main></body></html>`;
            }

            buildEmergencyDataUrl(text) {
                const html = this.buildEmergencyHtml(text);
                return `data:text/html;charset=utf-8,${encodeURIComponent(html)}`;
            }

            buildEmergencySummary() {
                const lines = [
                    'EMERGENCY CONTACTS',
                    `Generated: ${new Date().toLocaleDateString()}`,
                    '═══════════════════'
                ];

                let hasDetails = false;

                const contacts = Array.from(document.querySelectorAll('#emergency-contacts-container .list-item'));

                contacts.forEach(container => {
                    const name = container.querySelector('[data-field$="_name"]')?.value.trim() || '';
                    const relationship = container.querySelector('[data-field$="_relationship"]')?.value.trim() || '';
                    const phone = container.querySelector('[data-field$="_phone"]')?.value.trim() || '';
                    const altPhone = container.querySelector('[data-field$="_altPhone"]')?.value.trim() || '';

                    const entryLines = [];

                    if (name && relationship) {
                        entryLines.push(`${name} (${relationship})`);
                    } else if (name) {
                        entryLines.push(name);
                    } else if (relationship) {
                        entryLines.push(relationship);
                    }

                    if (phone) {
                        entryLines.push(`Primary: ${phone}`);
                    }

                    if (altPhone) {
                        entryLines.push(`Alternate: ${altPhone}`);
                    }

                    if (entryLines.length > 0) {
                        if (lines[lines.length - 1] !== '') {
                            lines.push('');
                        }
                        lines.push(...entryLines);
                        hasDetails = true;
                    }
                });

                while (lines.length > 0 && lines[lines.length - 1] === '') {
                    lines.pop();
                }

                const text = lines.join('\n');
                return { text, hasDetails };
            }

            prepareListFromValue(value) {
                if (!value) return [];
                const trimmed = value.trim();
                if (!trimmed) return [];
                if (trimmed.includes('\n')) {
                    return trimmed.split(/\r?\n+/).map(item => item.trim()).filter(Boolean);
                }
                return trimmed.split(/[,;]+/).map(item => item.trim()).filter(Boolean);
            }

            fitTextForQR(text, maxBytes = this.QR_BYTE_LIMIT) {
                const encoder = this._textEncoder;
                const bytes = encoder.encode(text);

                if (bytes.length <= maxBytes) {
                    return { text, truncated: false };
                }

                const noticeBytes = encoder.encode(this.truncationNotice).length;
                const allowance = Math.max(0, maxBytes - noticeBytes);

                let truncatedText = '';
                let used = 0;

                for (const char of text) {
                    const charBytes = encoder.encode(char);
                    if (used + charBytes.length > allowance) break;
                    truncatedText += char;
                    used += charBytes.length;
                }

                truncatedText = truncatedText.trimEnd();
                const lastBreak = truncatedText.lastIndexOf('\n');
                if (lastBreak > 0 && truncatedText.length - lastBreak < 10) {
                    truncatedText = truncatedText.slice(0, lastBreak).trimEnd();
                }

                if (!truncatedText) {
                    truncatedText = text.slice(0, Math.max(0, allowance));
                }

                const finalText = `${truncatedText}${this.truncationNotice}`;
                return { text: finalText, truncated: true };
            }
            
            createFallbackDisplay(container, text) {
                container.innerHTML = `
                    <div style="border: 2px solid #dc2626; padding: 15px; background: white; max-width: 300px; margin: 0 auto;">
                        <h4 style="color: #dc2626; margin: 0 0 10px 0;">⚠️ QR Generation Issue</h4>
                        <p style="font-size: 10pt; color: #64748b;">Unable to generate QR code. Emergency data shown below:</p>
                        <pre style="font-size: 8pt; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 10px;">${text}</pre>
                        <p style="font-size: 9pt; color: #3b82f6; margin-top: 10px;">
                            You can copy this text or take a photo of it for emergency use.
                        </p>
                    </div>
                `;
            }
            
            downloadQR(format) {
                const container = document.getElementById('qr-canvas');
                const img = container.querySelector('img');
                if (!img) {
                    alert('Please generate a QR code first');
                    return;
                }
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set proper aspect ratios for different formats
                let width = 400;
                let height = 250; // Better wallet card ratio
                
                if (format === 'wallet') {
                    width = 400;
                    height = 250; // Credit card aspect ratio
                } else if (format === 'bracelet') {
                    width = 600;
                    height = 150; // Thin bracelet ratio
                } else if (format === 'sticker') {
                    width = 300;
                    height = 300; // Square sticker
                }
                
                canvas.width = width;
                canvas.height = height;
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, width, height);
                
                // Emergency header
                ctx.fillStyle = '#dc2626';
                ctx.fillRect(0, 0, width, 30);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('🚨 EMERGENCY MEDICAL INFO 🚨', width / 2, 20);
                
                const qrImg = new Image();
                qrImg.onload = function() {
                    // Calculate QR position for proper aspect ratio
                    const qrSize = Math.min(width - 40, height - 50);
                    const qrX = (width - qrSize) / 2;
                    const qrY = format === 'bracelet' ? 35 : 40;
                    
                    ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);
                    
                    // Add footer text
                    ctx.fillStyle = '#1e293b';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    
                    if (format === 'wallet') {
                        ctx.fillText('Scan for medical information', width / 2, height - 10);
                    }
                    
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `emergency_medical_qr_${format}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                };
                qrImg.src = img.src;
            }
            
            closeQRModal() {
                document.getElementById('qrModal').classList.remove('active');
            }
            
            // Enhanced medication addition with search
            addMedication() {
                const container = document.getElementById('medications-container');
                const id = `med_${Date.now()}`;
                
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="field">
                            <label>Search or Type Medication Name</label>
                            <div class="med-search-container">
                                <input type="text" 
                                       class="form-data med-search-input" 
                                       data-field="${id}_name" 
                                       placeholder="Start typing medication name..."
                                       id="search_${id}" />
                                <svg class="med-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                                <div class="med-dropdown" id="dropdown_${id}"></div>
                            </div>
                        </div>
                        <div class="grid-3">
                            <div class="field">
                                <label>Dose</label>
                                <input type="text" class="form-data" data-field="${id}_dose" />
                            </div>
                            <div class="field">
                                <label>Frequency</label>
                                <input type="text" class="form-data" data-field="${id}_frequency" placeholder="e.g., Twice daily" />
                            </div>
                            <div class="field">
                                <label>Route</label>
                                <select class="form-data" data-field="${id}_route">
                                    <option>Oral</option>
                                    <option>Injection</option>
                                    <option>Topical</option>
                                    <option>Inhaled</option>
                                    <option>Sublingual</option>
                                    <option>Rectal</option>
                                    <option>IV</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid-3">
                            <div class="field">
                                <label>Prescribed For</label>
                                <input type="text" class="form-data" data-field="${id}_purpose" />
                            </div>
                            <div class="field">
                                <label>Prescriber</label>
                                <input type="text" class="form-data" data-field="${id}_prescriber" />
                            </div>
                            <div class="field">
                                <label>Pharmacy</label>
                                <input type="text" class="form-data" data-field="${id}_pharmacy" />
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
                
                // Set up medication search
                const searchInput = document.getElementById(`search_${id}`);
                const dropdown = document.getElementById(`dropdown_${id}`);
                
                searchInput.addEventListener('input', function() {
                    clearTimeout(MedicationSearch.searchTimeout);
                    const query = this.value.trim();
                    
                    if (query.length < 2) {
                        dropdown.classList.remove('active');
                        return;
                    }
                    
                    dropdown.innerHTML = '<div class="med-loading"><div class="med-spinner"></div>Searching...</div>';
                    dropdown.classList.add('active');
                    
                    MedicationSearch.searchTimeout = setTimeout(() => {
                        MedicationSearch.searchMedications(query, dropdown);
                    }, 300);
                });
                
                // Handle selection
                dropdown.addEventListener('click', function(e) {
                    const item = e.target.closest('.med-dropdown-item');
                    if (item && item.dataset.index) {
                        const med = MedicationSearch.searchResults[parseInt(item.dataset.index)];
                        searchInput.value = med.brandName;
                        dropdown.classList.remove('active');
                        app.markAsChanged();
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest(`#search_${id}`) && !e.target.closest(`#dropdown_${id}`)) {
                        dropdown.classList.remove('active');
                    }
                });
            }
            
            // Other add methods
            addEmergencyContact() {
                const container = document.getElementById('emergency-contacts-container');
                const id = `contact_${Date.now()}`;
                
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="grid-2">
                            <div class="field">
                                <label>Contact Name</label>
                                <input type="text" class="form-data" data-field="${id}_name" />
                            </div>
                            <div class="field">
                                <label>Relationship</label>
                                <input type="text" class="form-data" data-field="${id}_relationship" />
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="field">
                                <label>Phone</label>
                                <input type="tel" class="form-data" data-field="${id}_phone" />
                            </div>
                            <div class="field">
                                <label>Alternate Phone</label>
                                <input type="tel" class="form-data" data-field="${id}_altPhone" />
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
            }
            
            addVitalSign() {
                const container = document.getElementById('vitals-history-container');
                const id = `vital_${Date.now()}`;
                
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="grid-3">
                            <div class="field">
                                <label>Date</label>
                                <input type="date" class="form-data" data-field="${id}_date" />
                            </div>
                            <div class="field">
                                <label>Blood Pressure</label>
                                <input type="text" class="form-data" data-field="${id}_bp" placeholder="120/80" />
                            </div>
                            <div class="field">
                                <label>Pulse</label>
                                <input type="number" class="form-data" data-field="${id}_pulse" />
                            </div>
                        </div>
                        <div class="grid-3">
                            <div class="field">
                                <label>Temperature</label>
                                <input type="text" class="form-data" data-field="${id}_temp" placeholder="98.6" />
                            </div>
                            <div class="field">
                                <label>O2 Sat</label>
                                <input type="number" class="form-data" data-field="${id}_o2" placeholder="98" />
                            </div>
                            <div class="field">
                                <label>Weight</label>
                                <input type="text" class="form-data" data-field="${id}_weight" />
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
            }
            
            addLabResult() {
                const container = document.getElementById('labs-container');
                const id = `lab_${Date.now()}`;
                
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="grid-3">
                            <div class="field">
                                <label>Test Name</label>
                                <input type="text" class="form-data" data-field="${id}_test" />
                            </div>
                            <div class="field">
                                <label>Date</label>
                                <input type="date" class="form-data" data-field="${id}_date" />
                            </div>
                            <div class="field">
                                <label>Result</label>
                                <input type="text" class="form-data" data-field="${id}_result" />
                            </div>
                        </div>
                        <div class="field">
                            <label>Normal Range</label>
                            <input type="text" class="form-data" data-field="${id}_range" placeholder="e.g., 4.5-11.0" />
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
            }
            
            addCondition() { this.addGenericItem('conditions-container', 'condition', 'Enter condition (e.g., Type 2 Diabetes - 2023)'); }
            addSurgery() { this.addGenericItem('surgeries-container', 'surgery', 'Enter surgery (e.g., Appendectomy - 2020)'); }
            addProvider() { this.addGenericItem('providers-container', 'provider', 'Enter provider (Name, Specialty, Phone)'); }
            addNote() { this.addGenericItem('notes-container', 'note', 'Enter health note'); }
            addCovidVaccine() { this.addGenericItem('covid-vaccines-container', 'covid', 'Enter vaccine (e.g., Pfizer Booster - 10/2024)'); }
            addVaccine() { this.addGenericItem('vaccines-container', 'vaccine', 'Enter vaccine (e.g., Shingles - 05/2024)'); }
            
            addGenericItem(containerId, prefix, placeholder) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const id = `${prefix}_${Date.now()}`;
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="field">
                            <input type="text" class="form-data" data-field="${id}_value" 
                                   placeholder="${placeholder || 'Enter ' + prefix + ' information'}" />
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
            }
            
            removeItem(id) {
                const item = document.querySelector(`[data-item-id="${id}"]`);
                if (item && confirm('Remove this item?')) {
                    item.remove();
                    this.markAsChanged();
                }
            }
            
            exportPDF() {
                this.openExportOptions();
            }

            openExportOptions() {
                document.getElementById('exportModal')?.classList.add('active');
            }

            closeExportOptions() {
                document.getElementById('exportModal')?.classList.remove('active');
            }

            printSummary() {
                const printArea = document.getElementById('printArea');
                if (!printArea) {
                    window.print();
                    return;
                }

                this.buildPrintSummary(printArea);

                requestAnimationFrame(() => {
                    window.print();
                });

                const cleanup = () => {
                    printArea.innerHTML = '';
                    window.removeEventListener('afterprint', cleanup);
                };

                window.addEventListener('afterprint', cleanup, { once: true });
            }

            buildPrintSummary(printArea) {
                const formData = this.collectFormData();
                const lastUpdatedText = document.getElementById('lastUpdatedHeader')?.textContent?.replace('Last Updated: ', '') || 'Never';
                const fullNameParts = [formData.firstName, formData.middleInitial, formData.lastName].filter(Boolean);
                const fullName = fullNameParts.length ? fullNameParts.join(' ') : '—';

                const overviewGrid = this.buildKeyValueGrid([
                    { label: 'Date of Birth', value: this.formatDate(formData.dateOfBirth) },
                    { label: 'Medical Record #', value: this.formatValue(formData.mrn) },
                    { label: 'Sex Assigned at Birth', value: this.formatValue(formData.biologicalSex) },
                    { label: 'Phone', value: this.formatValue(formData.phone) },
                    { label: 'Email', value: this.formatValue(formData.email) },
                    { label: 'Address', allowHTML: true, value: this.formatTextBlock(formData.address) }
                ]);

                const emergencyGrid = this.buildKeyValueGrid([
                    { label: 'Blood Type', value: this.formatValue(formData.bloodType) },
                    { label: 'Advance Directive', value: this.formatValue(formData.advanceDirective) },
                    { label: 'Organ Donor', value: this.formatValue(formData.organDonor) },
                    { label: 'Critical Allergies', allowHTML: true, value: this.formatTextBlock(formData.criticalAllergies) },
                    { label: 'Critical Conditions', allowHTML: true, value: this.formatTextBlock(formData.criticalConditions) },
                    { label: 'Medication Contraindications', allowHTML: true, value: this.formatTextBlock(formData.medicationContraindications) },
                    { label: 'Preferred Hospital', value: this.formatValue(formData.preferredHospital) },
                    { label: 'Medical Power of Attorney', value: this.formatValue(formData.medicalPOA) }
                ]);

                const latestVitalsGrid = this.buildKeyValueGrid([
                    { label: 'Blood Pressure', value: this.formatValue(formData.lastBP) },
                    { label: 'Pulse', value: this.formatValue(formData.lastPulse) },
                    { label: 'Temperature', value: this.formatValue(formData.lastTemp) },
                    { label: 'Respirations', value: this.formatValue(formData.lastResp) },
                    { label: 'O₂ Saturation', value: this.formatValue(formData.lastO2) },
                    { label: 'Weight', value: this.formatValue(formData.weight) },
                    { label: 'Height', value: this.formatValue(formData.height) },
                    { label: 'BMI', value: this.formatValue(formData.bmi) }
                ]);

                const emergencyContacts = this.collectListData('emergency-contacts-container');
                const medications = this.collectListData('medications-container');
                const vitalsHistory = this.collectListData('vitals-history-container');
                const labs = this.collectListData('labs-container');
                const conditions = this.collectListData('conditions-container').map(item => item.value).filter(Boolean);
                const surgeries = this.collectListData('surgeries-container').map(item => item.value).filter(Boolean);
                const providers = this.collectListData('providers-container').map(item => item.value).filter(Boolean);
                const notes = this.collectListData('notes-container').map(item => item.value).filter(Boolean);
                const covidVaccines = this.collectListData('covid-vaccines-container').map(item => item.value).filter(Boolean);
                const otherVaccines = this.collectListData('vaccines-container').map(item => item.value).filter(Boolean);

                const medicationRows = medications
                    .filter(med => Object.values(med).some(value => value))
                    .map(med => ({
                        name: this.formatValue(med.name),
                        instructions: [med.dose, med.frequency, med.route].filter(Boolean).map(v => this.escapeHTML(v)).join('<br>') || '—',
                        indication: this.formatValue(med.purpose),
                        prescriber: this.formatValue(med.prescriber),
                        pharmacy: this.formatValue(med.pharmacy)
                    }));

                const emergencyContactRows = emergencyContacts
                    .filter(contact => Object.values(contact).some(value => value))
                    .map(contact => ({
                        name: this.formatValue(contact.name),
                        relationship: this.formatValue(contact.relationship),
                        phones: [contact.phone, contact.altPhone].filter(Boolean).map(v => this.escapeHTML(v)).join('<br>') || '—'
                    }));

                const vitalRows = vitalsHistory
                    .filter(vital => Object.values(vital).some(value => value))
                    .map(vital => ({
                        date: this.formatDate(vital.date),
                        bp: this.formatValue(vital.bp),
                        pulse: this.formatValue(vital.pulse),
                        temp: this.formatValue(vital.temp),
                        o2: this.formatValue(vital.o2),
                        weight: this.formatValue(vital.weight)
                    }));

                const labRows = labs
                    .filter(lab => Object.values(lab).some(value => value))
                    .map(lab => ({
                        test: this.formatValue(lab.test),
                        date: this.formatDate(lab.date),
                        result: this.formatValue(lab.result),
                        range: this.formatValue(lab.range)
                    }));

                const medicationAllergies = this.splitToList(formData.medicationAllergies);
                const foodAllergies = this.splitToList(formData.foodAllergies);
                const environmentalAllergies = this.splitToList(formData.environmentalAllergies);

                const allergySectionParts = [];
                if (medicationAllergies.length) {
                    allergySectionParts.push(`<div class="print-note"><strong>Medication:</strong><ul class="print-list">${medicationAllergies.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>`);
                }
                if (foodAllergies.length) {
                    allergySectionParts.push(`<div class="print-note"><strong>Food:</strong><ul class="print-list">${foodAllergies.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>`);
                }
                if (environmentalAllergies.length) {
                    allergySectionParts.push(`<div class="print-note"><strong>Environmental:</strong><ul class="print-list">${environmentalAllergies.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>`);
                }

                if (!allergySectionParts.length) {
                    allergySectionParts.push('<p class="print-note">—</p>');
                }

                const socialHistory = this.buildKeyValueGrid([
                    { label: 'Smoking Status', value: this.formatValue(formData.smokingStatus) },
                    { label: 'Alcohol Use', value: this.formatValue(formData.alcoholUse) },
                    { label: 'Exercise Frequency', value: this.formatValue(formData.exerciseFrequency) }
                ]);

                const providerGrid = this.buildKeyValueGrid([
                    { label: 'Primary Care Provider', value: this.formatValue(formData.pcpName) },
                    { label: 'PCP Phone', value: this.formatValue(formData.pcpPhone) },
                    { label: 'Last Visit', value: this.formatDate(formData.pcpLastVisit) }
                ]);

                const insuranceGrid = this.buildKeyValueGrid([
                    { label: 'Insurance Company', value: this.formatValue(formData.insuranceCompany) },
                    { label: 'Member ID', value: this.formatValue(formData.memberId) },
                    { label: 'Group Number', value: this.formatValue(formData.groupNumber) },
                    { label: 'Policy Holder', value: this.formatValue(formData.policyHolder) },
                    { label: 'Relationship', value: this.formatValue(formData.policyRelationship) },
                    { label: 'Insurance Phone', value: this.formatValue(formData.insurancePhone) },
                    { label: 'Deductible', value: this.formatValue(formData.deductible) },
                    { label: 'Out-of-Pocket Max', value: this.formatValue(formData.oopMax) },
                    { label: 'Primary Care Copay', value: this.formatValue(formData.coPayPrimary) }
                ]);

                const vaccineLists = [];
                if (formData.lastFluShot) {
                    vaccineLists.push(`<div class="print-grid-item"><span class="print-label">Flu Shot</span><span class="print-value">${this.formatDate(formData.lastFluShot)}</span></div>`);
                }
                if (formData.lastTetanus) {
                    vaccineLists.push(`<div class="print-grid-item"><span class="print-label">Tetanus (Tdap)</span><span class="print-value">${this.formatDate(formData.lastTetanus)}</span></div>`);
                }

                const covidList = covidVaccines.length ? `<div class="print-note"><strong>COVID-19:</strong><ul class="print-list">${covidVaccines.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>` : '';
                const otherVaccineList = otherVaccines.length ? `<div class="print-note"><strong>Other Vaccines:</strong><ul class="print-list">${otherVaccines.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>` : '';

                const html = `
                    <div class="print-wrapper">
                        <div class="print-header">
                            <h1>Patient Care Summary</h1>
                            <div class="print-meta">
                                <span><strong>Patient:</strong> ${this.escapeHTML(fullName)}</span>
                                <span><strong>Date of Birth:</strong> ${this.formatDate(formData.dateOfBirth)}</span>
                                <span><strong>Last Updated:</strong> ${this.escapeHTML(lastUpdatedText)}</span>
                            </div>
                        </div>
                        <section class="print-section">
                            <h2>Patient Overview</h2>
                            ${overviewGrid}
                        </section>
                        <section class="print-section">
                            <h2>Emergency Readiness</h2>
                            ${emergencyGrid}
                        </section>
                        <section class="print-section">
                            <h2>Latest Vital Snapshot</h2>
                            ${latestVitalsGrid}
                        </section>
                        ${this.buildTableSection('Emergency Contacts', [
                            { key: 'name', label: 'Name' },
                            { key: 'relationship', label: 'Relationship' },
                            { key: 'phones', label: 'Phone(s)', allowHTML: true }
                        ], emergencyContactRows)}
                        ${this.buildTableSection('Current Medications', [
                            { key: 'name', label: 'Medication' },
                            { key: 'instructions', label: 'Instructions', allowHTML: true },
                            { key: 'indication', label: 'Indication' },
                            { key: 'prescriber', label: 'Prescriber' },
                            { key: 'pharmacy', label: 'Pharmacy' }
                        ], medicationRows)}
                        <section class="print-section">
                            <h2>Allergies</h2>
                            ${allergySectionParts.join('')}
                        </section>
                        ${this.buildListSection('Medical Conditions', conditions)}
                        ${this.buildListSection('Surgical History', surgeries)}
                        <section class="print-section">
                            <h2>Family &amp; Social History</h2>
                            <div class="print-grid">
                                <div class="print-grid-item">
                                    <span class="print-label">Family History</span>
                                    <span class="print-value">${this.formatTextBlock(formData.familyHistory)}</span>
                                </div>
                            </div>
                            ${socialHistory}
                        </section>
                        ${this.buildTableSection('Vital Signs Trend', [
                            { key: 'date', label: 'Date' },
                            { key: 'bp', label: 'Blood Pressure' },
                            { key: 'pulse', label: 'Pulse' },
                            { key: 'temp', label: 'Temperature' },
                            { key: 'o2', label: 'O₂ Saturation' },
                            { key: 'weight', label: 'Weight' }
                        ], vitalRows)}
                        ${this.buildTableSection('Laboratory Results', [
                            { key: 'test', label: 'Test' },
                            { key: 'date', label: 'Date' },
                            { key: 'result', label: 'Result' },
                            { key: 'range', label: 'Reference Range' }
                        ], labRows)}
                        <section class="print-section">
                            <h2>Care Team</h2>
                            ${providerGrid}
                            ${providers.length ? `<ul class="print-list">${providers.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul>` : '<p class="print-note">—</p>'}
                        </section>
                        <section class="print-section">
                            <h2>Insurance Coverage</h2>
                            ${insuranceGrid}
                        </section>
                        <section class="print-section">
                            <h2>Immunizations</h2>
                            ${vaccineLists.length ? `<div class="print-grid">${vaccineLists.join('')}</div>` : ''}
                            ${covidList || otherVaccineList || '<p class="print-note">—</p>'}
                        </section>
                        <section class="print-section">
                            <h2>Care Notes</h2>
                            ${notes.length ? notes.map(note => `<div class="print-note">${this.formatTextBlock(note)}</div>`).join('') : '<p class="print-note">—</p>'}
                        </section>
                    </div>
                `;

                printArea.innerHTML = html;
            }

            buildKeyValueGrid(pairs = []) {
                if (!pairs.length) {
                    return '<p class="print-note">—</p>';
                }

                return `
                    <div class="print-grid">
                        ${pairs.map(pair => {
                            const value = pair.allowHTML ? (pair.value || '—') : this.formatValue(pair.value);
                            return `
                                <div class="print-grid-item">
                                    <span class="print-label">${this.escapeHTML(pair.label)}</span>
                                    <span class="print-value">${value}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            buildTableSection(title, columns, rows = []) {
                if (!rows.length) {
                    return '';
                }

                const header = columns.map(col => `<th>${this.escapeHTML(col.label)}</th>`).join('');
                const body = rows.map(row => `<tr>${columns.map(col => {
                    const value = col.allowHTML ? (row[col.key] || '—') : this.formatValue(row[col.key]);
                    return `<td>${value}</td>`;
                }).join('')}</tr>`).join('');

                return `
                    <section class="print-section">
                        <h2>${this.escapeHTML(title)}</h2>
                        <table class="print-table">
                            <thead><tr>${header}</tr></thead>
                            <tbody>${body}</tbody>
                        </table>
                    </section>
                `;
            }

            buildListSection(title, items = []) {
                if (!items.length) {
                    return `
                        <section class="print-section">
                            <h2>${this.escapeHTML(title)}</h2>
                            <p class="print-note">—</p>
                        </section>
                    `;
                }

                return `
                    <section class="print-section">
                        <h2>${this.escapeHTML(title)}</h2>
                        <ul class="print-list">
                            ${items.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}
                        </ul>
                    </section>
                `;
            }

            collectListData(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return [];

                return Array.from(container.querySelectorAll('.list-item')).map(item => {
                    const entry = {};
                    item.querySelectorAll('.form-data').forEach(input => {
                        const fieldKey = input.dataset.field || '';
                        const key = fieldKey.includes('_') ? fieldKey.substring(fieldKey.lastIndexOf('_') + 1) : fieldKey;
                        const value = input.type === 'checkbox' ? input.checked : input.value;
                        entry[key] = value;
                    });
                    return entry;
                });
            }

            formatValue(value) {
                if (value === undefined || value === null || value === '') {
                    return '—';
                }

                if (typeof value === 'boolean') {
                    return value ? 'Yes' : 'No';
                }

                return this.escapeHTML(value);
            }

            formatDate(value) {
                if (!value) return '—';
                const date = new Date(value);
                if (!isNaN(date)) {
                    return this.escapeHTML(date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }));
                }

                return this.escapeHTML(value);
            }

            formatTextBlock(value) {
                if (!value) return '—';
                return this.escapeHTML(value).replace(/\n/g, '<br>');
            }

            splitToList(text) {
                if (!text) return [];
                return text
                    .split(/\r?\n|,/)
                    .map(item => item.trim())
                    .filter(Boolean);
            }

            escapeHTML(value) {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            generateFHIRBundle() {
                const formData = this.collectFormData();
                const patientId = this.generateFHIRId('patient');
                const patientReference = `urn:uuid:${patientId}`;

                const bundle = {
                    resourceType: 'Bundle',
                    type: 'collection',
                    timestamp: new Date().toISOString(),
                    entry: []
                };

                const patientResource = {
                    resourceType: 'Patient',
                    id: patientId,
                    identifier: [],
                    name: [],
                    telecom: [],
                    address: [],
                    communication: []
                };

                const name = {
                    use: 'official',
                    family: formData.lastName || undefined,
                    given: [formData.firstName, formData.middleInitial].filter(Boolean)
                };

                if (name.family || name.given.length) {
                    patientResource.name.push(name);
                }

                if (formData.mrn) {
                    patientResource.identifier.push({
                        system: 'urn:healthvault:mrn',
                        value: formData.mrn
                    });
                }

                if (formData.ssn) {
                    patientResource.identifier.push({
                        system: 'http://hl7.org/fhir/sid/us-ssn',
                        value: formData.ssn
                    });
                }

                if (formData.phone) {
                    patientResource.telecom.push({ system: 'phone', value: formData.phone, use: 'mobile' });
                }

                if (formData.email) {
                    patientResource.telecom.push({ system: 'email', value: formData.email, use: 'home' });
                }

                if (formData.address) {
                    patientResource.address.push({
                        text: formData.address
                    });
                }

                if (formData.primaryLanguage) {
                    patientResource.communication.push({
                        language: { text: formData.primaryLanguage }
                    });
                }

                if (formData.biologicalSex) {
                    const genderMap = {
                        Female: 'female',
                        Male: 'male',
                        Intersex: 'other',
                        Other: 'other'
                    };
                    patientResource.gender = genderMap[formData.biologicalSex] || 'unknown';
                }

                if (formData.dateOfBirth) {
                    patientResource.birthDate = formData.dateOfBirth;
                }

                bundle.entry.push({
                    fullUrl: patientReference,
                    resource: patientResource
                });

                const emergencyContacts = this.collectListData('emergency-contacts-container');
                emergencyContacts.forEach(contact => {
                    if (!contact.name) return;
                    const relatedId = this.generateFHIRId('related-person');
                    const relatedResource = {
                        resourceType: 'RelatedPerson',
                        id: relatedId,
                        patient: { reference: patientReference },
                        relationship: contact.relationship ? [{ text: contact.relationship }] : undefined,
                        name: [{ text: contact.name }],
                        telecom: []
                    };

                    if (contact.phone) {
                        relatedResource.telecom.push({ system: 'phone', value: contact.phone, use: 'mobile' });
                    }

                    if (contact.altPhone) {
                        relatedResource.telecom.push({ system: 'phone', value: contact.altPhone, use: 'home' });
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${relatedId}`,
                        resource: relatedResource
                    });
                });

                const conditionTexts = [
                    ...this.collectListData('conditions-container').map(item => item.value).filter(Boolean),
                    ...this.splitToList(formData.criticalConditions)
                ];

                conditionTexts.forEach(text => {
                    const conditionId = this.generateFHIRId('condition');
                    bundle.entry.push({
                        fullUrl: `urn:uuid:${conditionId}`,
                        resource: {
                            resourceType: 'Condition',
                            id: conditionId,
                            clinicalStatus: {
                                coding: [{ system: 'http://terminology.hl7.org/CodeSystem/condition-clinical', code: 'active' }]
                            },
                            code: { text },
                            subject: { reference: patientReference }
                        }
                    });
                });

                const surgeries = this.collectListData('surgeries-container').map(item => item.value).filter(Boolean);
                surgeries.forEach(text => {
                    const procedureId = this.generateFHIRId('procedure');
                    bundle.entry.push({
                        fullUrl: `urn:uuid:${procedureId}`,
                        resource: {
                            resourceType: 'Procedure',
                            id: procedureId,
                            status: 'completed',
                            code: { text },
                            subject: { reference: patientReference }
                        }
                    });
                });

                const medications = this.collectListData('medications-container');
                medications.forEach(med => {
                    if (!med.name) return;
                    const medId = this.generateFHIRId('medicationstatement');
                    const dosageText = [med.dose, med.frequency, med.route].filter(Boolean).join(', ');

                    const resource = {
                        resourceType: 'MedicationStatement',
                        id: medId,
                        status: 'active',
                        subject: { reference: patientReference },
                        medicationCodeableConcept: { text: med.name },
                        dosage: []
                    };

                    if (dosageText) {
                        resource.dosage.push({ text: dosageText });
                    }

                    if (med.purpose) {
                        resource.reasonReference = [{ display: med.purpose }];
                    }

                    if (med.prescriber) {
                        resource.informationSource = { display: med.prescriber };
                    }

                    if (med.pharmacy) {
                        resource.note = [{ text: `Dispensed at: ${med.pharmacy}` }];
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${medId}`,
                        resource
                    });
                });

                const allergyCategories = [
                    { items: this.splitToList(formData.medicationAllergies), category: 'medication', criticality: 'low' },
                    { items: this.splitToList(formData.foodAllergies), category: 'food', criticality: 'low' },
                    { items: this.splitToList(formData.environmentalAllergies), category: 'environment', criticality: 'low' },
                    { items: this.splitToList(formData.criticalAllergies), category: 'medication', criticality: 'high' }
                ];

                allergyCategories.forEach(group => {
                    group.items.forEach(entry => {
                        const [substance, reaction] = entry.split(/[-–:]/).map(part => part.trim());
                        if (!substance) return;
                        const allergyId = this.generateFHIRId('allergy');
                        const resource = {
                            resourceType: 'AllergyIntolerance',
                            id: allergyId,
                            clinicalStatus: {
                                coding: [{ system: 'http://terminology.hl7.org/CodeSystem/allergyintolerance-clinical', code: 'active' }]
                            },
                            verificationStatus: {
                                coding: [{ system: 'http://terminology.hl7.org/CodeSystem/allergyintolerance-verification', code: 'confirmed' }]
                            },
                            category: [group.category],
                            criticality: group.criticality === 'high' ? 'high' : 'low',
                            code: { text: substance },
                            patient: { reference: patientReference }
                        };

                        if (reaction) {
                            resource.reaction = [{ description: reaction }];
                        }

                        bundle.entry.push({
                            fullUrl: `urn:uuid:${allergyId}`,
                            resource
                        });
                    });
                });

                const vitals = this.collectListData('vitals-history-container');
                vitals.forEach(vital => {
                    const hasData = ['bp', 'pulse', 'temp', 'o2', 'weight'].some(key => vital[key]);
                    if (!hasData && !vital.date) return;

                    const observationId = this.generateFHIRId('observation');
                    const resource = {
                        resourceType: 'Observation',
                        id: observationId,
                        status: 'final',
                        category: [{
                            coding: [{ system: 'http://terminology.hl7.org/CodeSystem/observation-category', code: 'vital-signs', display: 'Vital Signs' }]
                        }],
                        code: { text: 'Vital signs panel' },
                        subject: { reference: patientReference },
                        component: []
                    };

                    if (vital.date) {
                        resource.effectiveDateTime = vital.date;
                    }

                    if (vital.bp) {
                        resource.component.push({ code: { text: 'Blood Pressure' }, valueString: vital.bp });
                    }
                    if (vital.pulse) {
                        resource.component.push({ code: { text: 'Pulse' }, valueString: `${vital.pulse} bpm` });
                    }
                    if (vital.temp) {
                        resource.component.push({ code: { text: 'Temperature' }, valueString: vital.temp });
                    }
                    if (vital.o2) {
                        resource.component.push({ code: { text: 'Oxygen Saturation' }, valueString: `${vital.o2}%` });
                    }
                    if (vital.weight) {
                        resource.component.push({ code: { text: 'Weight' }, valueString: vital.weight });
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${observationId}`,
                        resource
                    });
                });

                const labs = this.collectListData('labs-container');
                labs.forEach(lab => {
                    if (!lab.test) return;
                    const labId = this.generateFHIRId('observation');
                    const resource = {
                        resourceType: 'Observation',
                        id: labId,
                        status: 'final',
                        category: [{
                            coding: [{ system: 'http://terminology.hl7.org/CodeSystem/observation-category', code: 'laboratory', display: 'Laboratory' }]
                        }],
                        code: { text: lab.test },
                        subject: { reference: patientReference }
                    };

                    if (lab.date) {
                        resource.effectiveDateTime = lab.date;
                    }

                    if (lab.result) {
                        resource.valueString = lab.result;
                    }

                    if (lab.range) {
                        resource.referenceRange = [{ text: lab.range }];
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${labId}`,
                        resource
                    });
                });

                const immunizations = [
                    formData.lastFluShot ? { code: 'Influenza', date: formData.lastFluShot } : null,
                    formData.lastTetanus ? { code: 'Tetanus (Tdap)', date: formData.lastTetanus } : null
                ].filter(Boolean);

                const covidVaccines = this.collectListData('covid-vaccines-container').map(item => item.value).filter(Boolean);
                covidVaccines.forEach(text => {
                    immunizations.push({ code: text });
                });

                const otherVaccines = this.collectListData('vaccines-container').map(item => item.value).filter(Boolean);
                otherVaccines.forEach(text => {
                    immunizations.push({ code: text });
                });

                immunizations.forEach(vaccine => {
                    const immId = this.generateFHIRId('immunization');
                    const resource = {
                        resourceType: 'Immunization',
                        id: immId,
                        status: 'completed',
                        vaccineCode: { text: vaccine.code },
                        patient: { reference: patientReference }
                    };

                    if (vaccine.date) {
                        resource.occurrenceDateTime = vaccine.date;
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${immId}`,
                        resource
                    });
                });

                if (formData.insuranceCompany || formData.memberId) {
                    const coverageId = this.generateFHIRId('coverage');
                    const resource = {
                        resourceType: 'Coverage',
                        id: coverageId,
                        status: 'active',
                        beneficiary: { reference: patientReference },
                        payor: formData.insuranceCompany ? [{ display: formData.insuranceCompany }] : undefined,
                        subscriberId: formData.memberId || undefined,
                        class: []
                    };

                    if (formData.groupNumber) {
                        resource.class.push({ type: { text: 'Group' }, value: formData.groupNumber });
                    }

                    if (formData.policyHolder) {
                        resource.policyHolder = { display: formData.policyHolder };
                    }

                    if (formData.policyRelationship) {
                        resource.relationship = { text: formData.policyRelationship };
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${coverageId}`,
                        resource
                    });
                }

                return bundle;
            }

            generateFHIRId(prefix) {
                if (window.crypto?.randomUUID) {
                    return `${prefix}-${window.crypto.randomUUID()}`;
                }

                return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            }
            
            toggleLock() {
                if (this.isLocked) {
                    this.unlock();
                } else {
                    this.lock();
                }
            }
            
            lock() {
                this.isLocked = true;
                document.getElementById('lockBtn').innerHTML = '🔒 Unlock';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('unlockScreen').style.display = 'flex';
            }
            
            unlock() {
                this.isLocked = false;
                document.getElementById('lockBtn').innerHTML = '🔓 Lock';
            }
            
            // Crypto utilities
            crypto = {
                async deriveKey(password, salt) {
                    const encoder = new TextEncoder();
                    const keyMaterial = await crypto.subtle.importKey(
                        'raw',
                        encoder.encode(password),
                        'PBKDF2',
                        false,
                        ['deriveBits', 'deriveKey']
                    );
                    
                    return await crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: salt,
                            iterations: 100000,
                            hash: 'SHA-256'
                        },
                        keyMaterial,
                        { name: 'AES-GCM', length: 256 },
                        true,
                        ['encrypt', 'decrypt']
                    );
                },
                
                async encrypt(data, password) {
                    const encoder = new TextEncoder();
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const key = await this.deriveKey(password, salt);
                    
                    const encrypted = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        encoder.encode(JSON.stringify(data))
                    );
                    
                    return {
                        salt: Array.from(salt),
                        iv: Array.from(iv),
                        data: Array.from(new Uint8Array(encrypted))
                    };
                },
                
                async decrypt(encryptedData, password) {
                    const salt = new Uint8Array(encryptedData.salt);
                    const iv = new Uint8Array(encryptedData.iv);
                    const data = new Uint8Array(encryptedData.data);
                    const key = await this.deriveKey(password, salt);
                    
                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        data
                    );
                    
                    const decoder = new TextDecoder();
                    return JSON.parse(decoder.decode(decrypted));
                }
            };
        }
        
        // Initialize app
        const app = new HealthVaultApp();
    </script>
</body>
</html>
