<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="expires" content="0">
    <link rel="icon" type="image/x-icon" href="https://storage.googleapis.com/intelechia-content/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js" integrity="sha512-g2TeAWw5GPnX7z0Kn8nFbYfeHcvAu/tx6d6mrLe/90mkCxO+RcptyYpksUz35EO337F83bZwcmUyHiHamspkfg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        if (!window.pako) {
            const script = document.createElement('script');
            script.src = 'pako.min.js';
            script.referrerPolicy = 'no-referrer';
            script.onerror = () => console.warn('Local pako fallback failed to load.');
            document.head.appendChild(script);
        }
    </script>
    <script src="jszip.min.js"></script>
    <title>Personal Health Vault - Secure Medical Record</title>
    <style>
        @page {
            size: letter;
            margin: 0.5in;
        }

        :root {
            --layout-max-width: 1600px;
            --layout-gutter: clamp(16px, 2vw, 32px);
            --header-bg: #0f172a;
            --font-scale: 1;
            --base-font-size: 11pt;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }

        html {
            font-size: calc(var(--base-font-size) * var(--font-scale));
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.5;
            color: #1e293b;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            min-width: 100vw;
            width: 100vw;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Skip to Content Link */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 10000;
            border-radius: 0 0 4px 0;
        }

        .skip-to-content:focus {
            top: 0;
        }

        /* Accessibility Controls Widget */
        .a11y-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .a11y-toggle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .a11y-toggle:hover {
            background: #2563eb;
            transform: scale(1.15);
        }

        .a11y-toggle img {
            width: 26px;
            height: 26px;
            display: block;
        }

        .a11y-toggle:focus {
            outline: 3px solid #fbbf24;
            outline-offset: 2px;
        }

        .a11y-panel {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .a11y-panel[hidden] {
            display: none;
        }

        .a11y-panel-title {
            margin: 0 0 20px 0;
            font-size: 16pt;
            color: #0f172a;
            font-weight: 700;
        }

        .a11y-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .a11y-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .a11y-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            font-size: 11pt;
        }

        .a11y-current {
            color: #3b82f6;
            font-size: 10pt;
        }

        .a11y-button-group {
            display: flex;
            gap: 8px;
        }

        .a11y-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #1e293b;
            border-radius: 6px;
            font-size: 14pt;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .a11y-btn:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
        }

        .a11y-btn:focus {
            outline: 3px solid #fbbf24;
            outline-offset: 2px;
        }

        .a11y-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #1e293b;
            font-size: 11pt;
        }

        .a11y-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .a11y-description {
            margin: 8px 0 0 30px;
            font-size: 9pt;
            color: #64748b;
            line-height: 1.5;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .a11y-controls {
                bottom: 10px;
                right: 10px;
            }

            .a11y-panel {
                width: calc(100vw - 40px);
                right: -10px;
            }
        }

        /* Font scale classes */
        .font-scale-80 {
            --font-scale: 0.8;
        }

        .font-scale-90 {
            --font-scale: 0.9;
        }

        .font-scale-100 {
            --font-scale: 1;
        }

        .font-scale-110 {
            --font-scale: 1.1;
        }

        .font-scale-120 {
            --font-scale: 1.2;
        }

        .font-scale-130 {
            --font-scale: 1.3;
        }

        .font-scale-140 {
            --font-scale: 1.4;
        }

        .font-scale-150 {
            --font-scale: 1.5;
        }

        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.25rem; }
        h5 { font-size: 1.1rem; }
        h6 { font-size: 1rem; }

        /* High Contrast Theme */
        .high-contrast {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --border-color: #ffffff;
            --link-color: #ffff00;
            --button-bg: #ffffff;
            --button-text: #000000;
            --focus-color: #ffff00;
        }

        .high-contrast body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .high-contrast .page-shell {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
        }

        .high-contrast .site-header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border-color);
        }

        .high-contrast a {
            color: var(--link-color);
            text-decoration: underline;
        }

        .high-contrast button,
        .high-contrast .btn {
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--border-color);
        }

        .high-contrast input,
        .high-contrast select,
        .high-contrast textarea {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .high-contrast .section {
            border: 2px solid var(--border-color);
        }

        .high-contrast .section-header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border-color);
        }

        /* High contrast focus indicators */
        .high-contrast *:focus {
            outline: 3px solid var(--focus-color);
            outline-offset: 2px;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        .reduced-motion *,
        .reduced-motion *::before,
        .reduced-motion *::after {
            animation: none !important;
            transition: none !important;
        }

        .reduced-motion {
            scroll-behavior: auto !important;
        }

        /* Focus styles */
        *:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .enhanced-focus *:focus {
            outline: 4px solid #fbbf24;
            outline-offset: 4px;
            box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.2);
        }

        .enhanced-focus button:focus,
        .enhanced-focus .btn:focus {
            outline: 4px solid #fbbf24;
            outline-offset: 4px;
        }

        .enhanced-focus a:focus {
            background: rgba(251, 191, 36, 0.2);
            outline: 4px solid #fbbf24;
            outline-offset: 2px;
        }

        .underline-links a {
            text-decoration: underline !important;
        }

        .underline-links a:hover {
            text-decoration: underline !important;
            text-decoration-thickness: 2px !important;
        }

        /* Contrast adjustments */
        .text-slate-400 {
            color: #64748b;
        }

        .text-slate-300 {
            color: #94a3b8;
        }

        a {
            color: #2563eb;
        }

        ::placeholder {
            color: #6b7280;
            opacity: 1;
        }

        .page-shell {
            position: relative;
            z-index: 1;
            width: min(100%, calc(var(--layout-max-width) + (var(--layout-gutter) * 2)));
            margin: 0 auto;
            padding: 0 var(--layout-gutter) 48px;
            background: #f8fafc;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.3);
            min-height: 100vh;
        }

        body:not(:has(#mainContent[style*="display: block"])) .page-shell {
            padding-top: 212px;
        }

        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--header-bg);
            color: white;
            z-index: 1100;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.18);
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        /* Hide site header when viewing EHR content */
        #mainContent[style*="display: block"] ~ .site-header,
        body:has(#mainContent[style*="display: block"]) .site-header {
            display: none;
        }
        
        .unlock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .unlock-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .unlock-container h2 {
            margin-bottom: 10px;
            color: #1e293b;
        }
        
        .unlock-container p {
            color: #64748b;
            margin-bottom: 20px;
            font-size: 10pt;
        }

        .recovery-key-note {
            font-size: 9pt;
            color: #94a3b8;
            margin-top: 6px;
            text-align: left;
        }

        .recovery-key-value {
            display: inline-block;
            padding: 10px 14px;
            background: #0f172a;
            color: #f8fafc;
            border-radius: 6px;
            letter-spacing: 1px;
            font-size: 13pt;
            font-weight: 600;
            word-break: break-word;
        }
        
        .unlock-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 11pt;
        }
        
        .unlock-container button {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11pt;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .unlock-container button:hover {
            background: #2563eb;
        }

        .emergency-access-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3001;
            overflow-y: auto;
            padding: 20px;
        }

        .emergency-banner-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
        }

        .emergency-banner-content h2 {
            color: #dc2626;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24pt;
        }

        .emergency-data-display {
            margin: 20px 0;
        }

        .emergency-data-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            border-radius: 4px;
        }

        .emergency-data-item strong {
            display: block;
            color: #991b1b;
            margin-bottom: 5px;
            font-size: 11pt;
        }

        .emergency-contact-card {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #fca5a5;
        }
        
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 100;
            text-align: center;
            background: transparent;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        #landingRoot,
        #landingRoot > div {
            width: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 100% !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        
        .welcome-screen h1 {
            color: #3b82f6;
            margin-bottom: 20px;
            font-size: 28pt;
        }
        
        .welcome-screen p {
            color: #64748b;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .offline-download {
            margin-top: 20px;
            padding: 12px 16px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            font-size: 10pt;
            color: #1e3a8a;
            text-align: left;
        }

        .offline-download button.offline-download-trigger {
            margin-top: 8px;
            padding: 8px 14px;
            background: #1d4ed8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 10pt;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .offline-download button.offline-download-trigger:hover:not(:disabled) {
            background: #1e40af;
        }

        .offline-download button.offline-download-trigger:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: #1e3a8a;
        }

        .offline-download-status {
            margin-top: 8px;
            font-size: 9pt;
            color: #1e3a8a;
        }

        .offline-download-status.error {
            color: #b91c1c;
        }

        .welcome-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .welcome-actions button {
            padding: 15px 30px;
            font-size: 12pt;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-start {
            background: #3b82f6;
            color: white;
        }

        .btn-start:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn-import {
            background: #f8fafc;
            color: #1e293b;
            border: 1px solid #cbd5f5;
        }

        .btn-import:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        #vaultFileInput {
            opacity: 0;
            position: absolute;
            width: 0;
            height: 0;
            pointer-events: none;
        }
        
        .security-bar {
            width: min(100%, var(--layout-max-width));
            margin: 0 auto;
            padding: 20px var(--layout-gutter) 16px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .site-header__brand {
            display: flex;
            align-items: center;
            gap: 14px;
            min-width: 260px;
            flex: 1 1 320px;
        }

        .site-header__title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .site-header__title h1 {
            font-size: 16pt;
            margin: 0;
        }

        .site-header__title p {
            margin: 0;
            font-size: 10pt;
            color: rgba(226, 232, 240, 0.75);
        }

        .logo-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .logo-container img {
            height: 36px;
            width: auto;
        }

        .site-header__status {
            flex: 1 1 100%;
            display: flex;
            justify-content: center;
            margin-top: 4px;
        }

        .save-status {
            padding: 6px 18px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 9.5pt;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: normal;
            text-align: center;
            justify-content: center;
            min-width: 260px;
        }
        
        .save-status.never-saved {
            background: #dc2626;
            color: white;
        }
        
        .save-status.unsaved {
            background: #f59e0b;
            color: white;
        }
        
        .save-status.saved {
            background: #22c55e;
            color: white;
        }
        
        #lockTimer {
            margin-left: 4px;
            font-size: 10pt;
            font-weight: 600;
            color: #38bdf8;
        }

        #lockTimer.locked {
            color: #f87171;
        }

        .status-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .status-icon::after {
            content: "âœ“";
            color: white;
            font-size: 9pt;
            font-weight: bold;
        }
        
        .site-header__actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 16px;
            flex-wrap: wrap;
            flex: 1 1 320px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .language-selector {
            display: flex;
            flex-direction: column;
            gap: 6px;
            color: #e2e8f0;
            min-width: 180px;
            flex: 1 1 200px;
        }

        .language-selector label {
            font-size: 9pt;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            color: rgba(226, 232, 240, 0.85);
        }

        .language-selector select {
            padding: 8px 10px;
            border: 1px solid rgba(226, 232, 240, 0.4);
            border-radius: 8px;
            font-size: 10pt;
            background: white;
            color: #0f172a;
            width: 100%;
        }

        .language-selector:focus-within select {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .unlock-language {
            text-align: left;
            margin-bottom: 15px;
        }

        .unlock-language label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #1e293b;
        }

        .unlock-language select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 10pt;
        }

        .unlock-language small {
            display: block;
            margin-top: 6px;
            font-size: 9pt;
            color: #64748b;
        }

        .btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            font-size: 9pt;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-save {
            background: #dc2626;
            color: white;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        .btn-save.saved {
            background: #22c55e;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .btn-secondary {
            background: #475569;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: #334155;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-lock {
            background: #059669;
            color: white;
        }
        
        .btn-lock:hover {
            background: #047857;
        }
        
        .btn-locked {
            background: #dc2626;
            color: white;
        }
        
        .nav-tabs {
            position: sticky;
            top: 0;
            background: rgba(248, 250, 252, 0.95);
            border-bottom: 1px solid #e2e8f0;
            z-index: 900;
            display: flex;
            flex-wrap: wrap;
            gap: 4px 12px;
            padding: 12px 0;
            margin: 0 auto 28px;
            width: 100%;
            backdrop-filter: blur(8px);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .nav-tabs::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        .tab {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-size: 10pt;
            font-weight: 500;
            color: #64748b;
            flex: 0 1 auto;
            min-width: 0;
        }
        
        .tab:hover {
            color: #1e293b;
            background: #f1f5f9;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab.module-tab {
            background: #fef3c7;
            border-radius: 4px 4px 0 0;
            margin-left: 10px;
        }
        
        .main-content {
            margin-top: 20px;
        }
        
        /* Medical Chart Header Styling */
        .chart-header {
            background: white;
            border: 2px solid #2c3e50;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .chart-header-top {
            background: #2c3e50;
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .chart-branding {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1 1 auto;
        }

        .chart-title-group h1 {
            font-size: 18pt;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .chart-header-info {
            font-size: 9pt;
            opacity: 0.9;
        }

        .vault-manager-screen {
            position: fixed;
            inset: 0;
            padding: clamp(32px, 6vw, 72px) clamp(16px, 6vw, 80px);
            overflow-y: auto;
            display: none;
            z-index: 200;
        }

        .vault-manager-container {
            max-width: 1100px;
            margin: 0 auto;
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 24px;
            padding: clamp(24px, 4vw, 48px);
            color: #e2e8f0;
            box-shadow: 0 25px 80px rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(14px);
        }

        .vault-manager-header {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (min-width: 768px) {
            .vault-manager-header {
                flex-direction: row;
                align-items: flex-end;
                justify-content: space-between;
            }
        }

        .vault-manager-title h2 {
            margin: 0;
            font-size: clamp(1.75rem, 3vw, 2.25rem);
            color: #38bdf8;
        }

        .vault-manager-title p {
            margin: 8px 0 0;
            color: #cbd5f5;
        }

        .vault-manager-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: flex-start;
        }

        .vault-manager-search {
            flex: 1 1 220px;
            min-width: 200px;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            transition: border 0.2s, box-shadow 0.2s;
        }

        .vault-manager-search:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }

        .vault-manager-search::placeholder {
            color: #94a3b8;
        }

        .vault-manager-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            border-radius: 12px;
            padding: 12px 18px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s, color 0.2s;
            text-decoration: none;
        }

        .vault-manager-button[data-variant="primary"] {
            background: linear-gradient(135deg, #38bdf8, #6366f1);
            color: #0f172a;
            box-shadow: 0 12px 25px rgba(56, 189, 248, 0.25);
        }

        .vault-manager-button[data-variant="primary"]:hover {
            transform: translateY(-1px);
            background: linear-gradient(135deg, #0ea5e9, #4f46e5);
            box-shadow: 0 18px 32px rgba(14, 165, 233, 0.28);
        }

        .vault-manager-button[data-variant="secondary"] {
            background: rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
        }

        .vault-manager-button[data-variant="secondary"]:hover {
            background: rgba(148, 163, 184, 0.3);
            transform: translateY(-1px);
        }

        .vault-manager-button:focus-visible {
            outline: 3px solid #fbbf24;
            outline-offset: 2px;
        }

        .vault-manager-status {
            margin-bottom: 16px;
            font-size: 0.95rem;
            display: none;
        }

        .vault-manager-status.is-visible {
            display: block;
        }

        .vault-manager-status.is-error {
            color: #f87171;
        }

        .vault-manager-status:not(.is-error) {
            color: #facc15;
        }

        .vault-manager-empty {
            text-align: center;
            padding: clamp(40px, 8vw, 72px) clamp(24px, 6vw, 48px);
            border: 1px dashed rgba(148, 163, 184, 0.4);
            border-radius: 16px;
            color: #cbd5f5;
        }

        .vault-manager-empty h3 {
            margin: 0 0 8px;
            font-size: clamp(1.25rem, 2.5vw, 1.6rem);
            color: #e0f2fe;
        }

        .vault-manager-empty p {
            margin: 0 auto 24px;
            max-width: 460px;
        }

        .vault-manager-empty-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .vault-card-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }

        .vault-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 18px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            transition: border 0.2s, transform 0.2s, box-shadow 0.2s;
        }

        .vault-card:hover {
            border-color: rgba(56, 189, 248, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.35);
        }

        .vault-card h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #e0f2fe;
        }

        .vault-identity-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(56, 189, 248, 0.15);
            color: #38bdf8;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            width: fit-content;
        }

        .vault-card-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .vault-card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .vault-card-actions button {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: background 0.2s, color 0.2s, transform 0.2s;
        }

        .vault-card-actions button[data-variant="open"] {
            background: #38bdf8;
            color: #0f172a;
        }

        .vault-card-actions button[data-variant="open"]:hover {
            background: #0ea5e9;
            transform: translateY(-1px);
        }

        .vault-card-actions button[data-variant="rename"] {
            background: rgba(148, 163, 184, 0.18);
            color: #e2e8f0;
        }

        .vault-card-actions button[data-variant="rename"]:hover {
            background: rgba(148, 163, 184, 0.28);
            transform: translateY(-1px);
        }

        .vault-card-actions button[data-variant="remove"] {
            background: rgba(248, 113, 113, 0.14);
            color: #f87171;
        }

        .vault-card-actions button[data-variant="remove"]:hover {
            background: rgba(248, 113, 113, 0.24);
            transform: translateY(-1px);
        }

        .vault-card-actions button:focus-visible {
            outline: 3px solid #fbbf24;
            outline-offset: 2px;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .chart-header-status {
            background: rgba(15, 23, 42, 0.05);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .security-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 10pt;
            color: #475569;
        }

        /* Mobile responsive */
        @media (max-width: 900px) {
            .chart-header-top {
                padding: 12px 16px;
            }

            .chart-branding {
                flex-basis: 100%;
                justify-content: center;
            }

            .chart-controls {
                flex-basis: 100%;
                justify-content: center;
            }

            .action-buttons {
                width: 100%;
                justify-content: stretch;
            }

            .action-buttons .btn {
                flex: 1 1 auto;
            }
        }

        @media (max-width: 600px) {
            .chart-header-top {
                flex-direction: column;
                text-align: center;
            }

            .chart-branding {
                flex-direction: column;
                gap: 12px;
            }

            .chart-controls {
                flex-direction: column;
                width: 100%;
            }

            .language-selector,
            .action-buttons {
                width: 100%;
            }
        }
        
        .patient-demographics {
            padding: 20px 24px;
            background: #eef2ff;
        }

        .patient-summary {
            display: grid;
            grid-template-columns: minmax(240px, 280px) minmax(0, 1fr);
            gap: 24px;
            align-items: start;
        }

        .patient-profile,
        .patient-core {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
        }

        .patient-profile {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .patient-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 600;
            text-transform: uppercase;
            overflow: hidden;
            position: relative;
        }

        .patient-avatar img {
            display: none;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .patient-avatar.has-photo {
            background: #0f172a;
        }

        .patient-avatar.has-photo img {
            display: block;
        }

        .patient-avatar-initials {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .patient-overview {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .patient-display-name {
            font-size: 16pt;
            font-weight: 700;
            color: #1e293b;
        }

        .patient-display-meta {
            font-size: 10pt;
            color: #64748b;
        }

        .name-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 80px;
            gap: 10px;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .avatar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .avatar-actions .btn {
            padding: 6px 14px;
        }

        .link-button {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 10pt;
            text-decoration: underline;
            padding: 0;
        }

        .link-button:hover {
            color: #2563eb;
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px 18px;
        }

        .field-block {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-block label {
            font-size: 9.5pt;
            font-weight: 600;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .field-block input,
        .field-block select,
        .field-block textarea {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 9px 12px;
            font-family: inherit;
            font-size: 10.5pt;
            color: #1e293b;
            background: #f8fafc;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .field-block input:focus,
        .field-block select:focus,
        .field-block textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: white;
        }

        .field-block.full {
            grid-column: 1 / -1;
        }

        @media (max-width: 900px) {
            .patient-summary {
                grid-template-columns: 1fr;
            }

            .patient-avatar {
                width: 60px;
                height: 60px;
                font-size: 22px;
            }

            .name-grid {
                grid-template-columns: 1fr 1fr;
            }

            .name-grid input:last-child {
                grid-column: 1 / -1;
                max-width: 120px;
            }
        }
        
        /* Vital Signs Card */
        .vitals-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .vitals-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 12pt;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 5px;
        }
        
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .vital-item {
            text-align: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 4px;
        }
        
        .vital-label {
            font-size: 9pt;
            color: #64748b;
            margin-bottom: 2px;
        }
        
        .vital-value {
            font-size: 14pt;
            font-weight: 600;
            color: #1e293b;
        }
        
        .section {
            margin-bottom: 20px;
            page-break-inside: avoid;
            scroll-margin-top: 125px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8fafc;
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header.emergency {
            background: #fee2e2;
            border-bottom-color: #fca5a5;
        }
        
        .section-header.module {
            background: #f3f0ff;
            border-bottom-color: #ddd6fe;
        }
        
        .section-header h2 {
            font-size: 14pt;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }
        
        .section-content {
            padding: 15px;
            transition: all 0.3s;
        }
        
        .section-content.locked {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
            opacity: 0.5;
        }
        
        .field-group {
            margin-bottom: 15px;
        }
        
        .field-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .field {
            flex: 1;
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            font-weight: 600;
            font-size: 10pt;
            color: #334155;
            margin-bottom: 3px;
        }
        
        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="tel"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 10pt;
            background: white;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 5px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .info-box {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 9pt;
        }
        
        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 9pt;
        }

        .password-update-option {
            margin-bottom: 15px;
        }

        .password-update-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #1e293b;
        }

        .password-update-option p {
            margin: 6px 0 0 26px;
            color: #64748b;
            font-size: 9pt;
        }

        .password-update-fields {
            margin: 12px 0 0 26px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .password-update-fields .field {
            margin-bottom: 10px;
        }

        .password-update-note {
            font-size: 9pt;
            color: #64748b;
            margin: 12px 0 0 0;
        }

        .danger-box {
            background: #fee2e2;
            border: 1px solid #dc2626;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-size: 10pt;
            font-weight: 600;
            text-align: center;
        }
        
        .list-item {
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8fafc;
            position: relative;
        }

        .note-item {
            background: #f1f5f9;
        }

        .attachment-item {
            padding-top: 14px;
            padding-bottom: 14px;
        }

        .attachment-name {
            font-weight: 600;
            font-size: 10pt;
            color: #1e293b;
            margin-bottom: 6px;
            word-break: break-word;
        }

        .attachment-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 9pt;
            color: #475569;
            margin-bottom: 12px;
        }

        .attachment-details span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 999px;
        }

        .attachment-details .attachment-compression {
            background: #d1fae5;
            color: #047857;
        }

        .attachment-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .attachment-actions .btn {
            font-size: 9pt;
        }

        .attachment-preview-modal {
            max-width: 900px;
        }

        .attachment-preview-meta {
            font-size: 10pt;
            color: #64748b;
            margin-top: 4px;
        }

        .attachment-preview-body {
            min-height: 240px;
            max-height: 65vh;
            overflow-y: auto;
            padding: 16px;
            background: #f8fafc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attachment-preview-body img,
        .attachment-preview-body video {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
        }

        .attachment-preview-body audio {
            width: 100%;
            margin: 20px 0;
        }

        .attachment-preview-text {
            width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Fira Code', 'Consolas', 'Courier New', monospace;
            font-size: 10pt;
            line-height: 1.5;
            color: #0f172a;
        }

        .attachment-preview-error {
            margin-top: 16px;
            color: #dc2626;
            font-size: 10pt;
            text-align: center;
        }

        .attachment-preview-modal .modal-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .attachment-empty {
            font-size: 9pt;
            color: #94a3b8;
            background: #f1f5f9;
            border: 1px dashed #cbd5e1;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
        }

        .note-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 8px;
        }

        .note-meta-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 9pt;
            color: #64748b;
        }

        .note-meta-row .note-created-display {
            font-weight: 600;
            color: #334155;
        }

        .note-tag-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .note-tag-options label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #e2e8f0;
            border-radius: 999px;
            margin: 0;
            font-weight: 500;
            font-size: 9pt;
            cursor: pointer;
        }

        .note-tag-options input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        .tag-manager {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tag-manager input {
            flex: 1;
            min-width: 180px;
        }

        .tag-chip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 999px;
            font-size: 9pt;
        }

        .tag-chip button {
            background: transparent;
            border: none;
            cursor: pointer;
            color: #0ea5e9;
            font-size: 10pt;
            line-height: 1;
        }

        .tag-chip button:hover {
            color: #ef4444;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 9pt;
            cursor: pointer;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .add-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 14px;
            font-size: 9pt;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .add-btn:hover {
            background: #2563eb;
        }
        
        /* Medication Search Styles */
        .med-search-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .med-search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            font-size: 11pt;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .med-search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .med-search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            pointer-events: none;
        }
        
        .med-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .med-dropdown.active {
            display: block;
        }
        
        .med-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .med-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .med-dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .med-dropdown-item.selected {
            background-color: #3b82f6;
            color: white;
        }
        
        .drug-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .drug-details {
            font-size: 10pt;
            color: #666;
        }
        
        .med-dropdown-item.selected .drug-details {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .med-loading {
            padding: 20px;
            text-align: center;
            color: #999;
        }
        
        .med-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            font-size: 18pt;
            color: #1e293b;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .password-strength {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .strength-bar {
            flex: 1;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
        }
        
        .strength-bar.active {
            background: #22c55e;
        }
        
        .strength-bar.weak {
            background: #dc2626;
        }
        
        .strength-bar.medium {
            background: #f59e0b;
        }

        .password-requirements {
            margin-top: 10px;
            font-size: 10pt;
            color: #475569;
        }

        .password-feedback {
            margin-top: 8px;
            font-size: 10pt;
            color: #475569;
        }

        .password-feedback.success {
            color: #15803d;
        }

        .password-feedback.warning {
            color: #dc2626;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .settings-grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        
        .settings-section {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
        }

        .settings-section h4 {
            margin-bottom: 10px;
            color: #1e293b;
        }

        .settings-version {
            margin-top: 8px;
            font-size: 10pt;
            color: #475569;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: baseline;
        }

        .settings-version strong {
            color: #0f172a;
        }

        .module-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .module-info {
            flex: 1;
        }
        
        .module-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        .module-desc {
            font-size: 9pt;
            color: #64748b;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #cbd5e1;
            border-radius: 24px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        input:checked + .toggle-slider {
            background: #3b82f6;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        @media (max-width: 900px) {
            body {
                font-size: 10.5pt;
            }

            .unlock-container {
                padding: 28px 24px;
                max-width: 320px;
            }

            .welcome-screen {
                padding: 0;
            }

            .welcome-screen h1 {
                font-size: 22pt;
            }

            .welcome-actions {
                flex-direction: column;
                width: 100%;
                gap: 12px;
            }

            .welcome-actions button {
                width: 100%;
            }

            .security-bar {
                justify-content: center;
                text-align: center;
                padding: 24px var(--layout-gutter);
            }

            .site-header__brand,
            .site-header__actions {
                justify-content: center;
            }

            .action-buttons {
                justify-content: center;
                width: 100%;
                gap: 8px;
            }

            .action-buttons .btn {
                flex: 1 1 45%;
                min-width: 140px;
            }

            .save-status {
                width: 100%;
                margin: 0;
            }

            .language-selector {
                width: 100%;
                min-width: 0;
            }

            .nav-tabs {
                margin-bottom: 20px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 9pt;
            }

            .patient-demographics {
                padding: 12px 16px;
            }

            .demo-row {
                flex-direction: column;
                margin-bottom: 12px;
            }

            .demo-field {
                margin-right: 0;
                width: 100%;
            }

            .modal-content {
                margin: 40px 16px;
                padding: 20px;
                width: calc(100% - 32px);
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions button {
                width: 100%;
            }

            .settings-columns {
                grid-template-columns: 1fr;
            }

            .module-toggle {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
        }

        .totp-setup {
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .totp-qr {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            display: inline-block;
        }
        
        .backup-codes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: #fef3c7;
            border-radius: 6px;
        }
        
        .backup-code {
            font-family: monospace;
            font-size: 11pt;
            padding: 5px 10px;
            background: white;
            border-radius: 4px;
            text-align: center;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .summary-card h4 {
            color: #64748b;
            font-size: 10pt;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            color: #1e293b;
            font-size: 14pt;
            font-weight: 600;
        }

        #printArea {
            display: none;
        }

        .print-wrapper {
            padding: 40px 30px;
            color: #0f172a;
        }

        .print-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .print-header h1 {
            font-size: 24pt;
            letter-spacing: 0.08em;
        }

        .print-meta {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px 24px;
            margin-top: 12px;
            font-size: 10pt;
            color: #334155;
        }

        .print-section {
            margin-top: 25px;
        }

        .print-section h2 {
            font-size: 16pt;
            color: #1e293b;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 6px;
            margin-bottom: 12px;
        }

        .print-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .print-grid-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            min-height: 70px;
        }

        .print-label {
            display: block;
            font-size: 8.5pt;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
            margin-bottom: 6px;
        }

        .print-value {
            font-size: 11pt;
            font-weight: 600;
            color: #0f172a;
            line-height: 1.4;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .print-table th,
        .print-table td {
            border: 1px solid #cbd5e1;
            padding: 8px 10px;
            text-align: left;
            font-size: 10pt;
            vertical-align: top;
        }

        .print-table th {
            background: #e2e8f0;
            color: #1e293b;
            font-weight: 600;
        }

        .print-list {
            margin: 0;
            padding-left: 20px;
            color: #1e293b;
        }

        .print-note {
            margin-bottom: 10px;
            font-size: 10.5pt;
            line-height: 1.5;
        }

        .print-note-meta {
            font-size: 9.5pt;
            color: #475569;
            margin-bottom: 4px;
        }

        .print-note-body {
            color: #0f172a;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .export-note {
            font-size: 9pt;
            color: #64748b;
            line-height: 1.4;
        }

        @media print {
            body {
                padding: 0;
            }

            .site-header,
            .security-bar,
            .nav-tabs,
            .no-print,
            .unlock-screen,
            .modal,
            #emergencyAccessBanner {
                display: none !important;
            }

            .section-content.locked {
                display: none !important;
            }

            #mainContent,
            #welcomeScreen,
            #unlockScreen {
                display: none !important;
            }

            #printArea {
                display: block !important;
            }
        }
        
        @media (max-width: 768px) {
            .site-header {
                position: static;
                width: 100%;
            }

            body:not(:has(#mainContent[style*="display: block"])) .page-shell {
                padding-top: var(--layout-gutter);
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .field-row {
                flex-direction: column;
                gap: 0;
            }

            .nav-tabs {
                padding: 12px 0;
            }

            .tab {
                padding: 10px 15px;
                font-size: 9pt;
            }

            .demo-field {
                min-width: 100%;
            }

            .language-selector {
                width: 100%;
            }

            .language-selector select {
                width: 100%;
            }

            .site-header__actions {
                gap: 12px;
            }
        }

        @media (max-width: 600px) {
            .unlock-container {
                width: 100%;
            }

            .security-bar {
                row-gap: 16px;
            }

            .security-status {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .site-header__actions {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .site-header__brand {
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                gap: 10px;
            }

            .action-buttons {
                width: 100%;
                gap: 8px;
                justify-content: stretch;
            }

            .action-buttons .btn {
                flex: 1 1 auto;
                min-width: 0;
                width: 100%;
            }

            .language-selector {
                width: 100%;
                min-width: 0;
            }

            .main-content {
                margin-top: 10px;
            }

            .vitals-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .modal-header h2 {
                font-size: 16pt;
            }

            .modal {
                align-items: flex-start;
            }
        }

        footer {
            border-top: 1px solid #e2e8f0;
            padding: 48px 0;
            background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%);
            margin-top: 60px;
        }

        footer .page-shell {
            background: transparent;
            box-shadow: none;
        }

        .footer-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .footer-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
            transition: all 0.2s ease;
        }

        .footer-card:hover {
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
            transform: translateY(-2px);
        }

        .footer-card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .footer-card-title {
            font-size: 14pt;
            font-weight: 700;
            color: #0f172a;
            margin: 0 0 12px 0;
        }

        .footer-card-text {
            font-size: 10pt;
            color: #64748b;
            line-height: 1.6;
            margin: 0 0 12px 0;
        }

        .footer-card-text:last-child {
            margin-bottom: 0;
        }

        .footer-card-text strong {
            color: #1e293b;
            font-weight: 600;
        }

        .footer-card.highlight {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #3b82f6;
        }

        .footer-card.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .footer-card.alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #ef4444;
        }

        .footer-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #3b82f6;
            color: white;
            border-radius: 999px;
            font-size: 9pt;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .footer-badge.badge-info {
            background: #3b82f6;
        }

        .footer-badge.badge-warning {
            background: #f59e0b;
        }

        .footer-badge.badge-success {
            background: #10b981;
        }

        .footer-bottom {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .footer-bottom-left {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #64748b;
            font-size: 10pt;
        }

        .footer-bottom-links {
            display: flex;
            gap: 24px;
        }

        .footer-bottom-links a {
            color: #64748b;
            text-decoration: none;
            font-size: 10pt;
            transition: color 0.2s;
        }

        .footer-bottom-links a:hover {
            color: #3b82f6;
        }

        @media (max-width: 768px) {
            .footer-cards {
                grid-template-columns: 1fr;
            }

            .footer-bottom {
                flex-direction: column;
                text-align: center;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    <div class="sr-only" role="status" aria-live="polite" aria-atomic="true" id="status-announcements"></div>
    <div class="sr-only" role="alert" aria-live="assertive" aria-atomic="true" id="alert-announcements"></div>

    <div class="unlock-screen" id="unlockScreen" style="display: none;">
        <div class="unlock-container">
            <h2 data-i18n-key="unlock_title">ðŸ”’ Health Vault Locked</h2>
            <p data-i18n-key="unlock_subtitle">This .ehv vault file contains encrypted medical records</p>
            <div class="unlock-language">
                <label for="unlockLanguageSelect" data-i18n-key="default_language_label">Default language</label>
                <select id="unlockLanguageSelect" data-language-selector data-default-selector="true" aria-describedby="unlockLanguageHelp"></select>
                <small id="unlockLanguageHelp" data-i18n-key="default_language_hint">Use this language automatically when opening the vault.</small>
            </div>
            <input type="password" id="unlock-password" placeholder="Enter password" data-i18n-placeholder="unlock_password_placeholder" aria-required="true">
            <div id="totpField" style="display: none;">
                <input type="text" id="totp-code" placeholder="6-digit code" maxlength="6" data-i18n-placeholder="unlock_totp_placeholder">
            </div>
            <div id="recoveryKeyField" style="display: none;">
                <input type="text" id="recovery-key" placeholder="Enter recovery key" data-i18n-placeholder="unlock_recovery_placeholder" autocomplete="off" spellcheck="false">
                <p class="recovery-key-note" data-i18n-key="unlock_recovery_hint">Paste the long recovery key you saved. It unlocks without your password or 2FA.</p>
            </div>
            <div id="temporaryAccessHint" style="display: none; font-size: 9pt; color: #f97316; margin: 10px 0 0 0; text-align: left;">
            </div>
            <button id="unlockBtn" onclick="app.attemptUnlock(event)">Unlock Vault</button>
            <p style="margin-top: 15px; font-size: 9pt; color: #94a3b8;">
                This vault file (.ehv) contains your encrypted data.
                Save it after making changes.
            </p>
        </div>
    </div>

    <div id="emergencyAccessBanner" class="emergency-access-banner" style="display: none;">
        <div class="emergency-banner-content">
            <h2>ðŸš¨ EMERGENCY MEDICAL INFORMATION</h2>
            <div class="emergency-data-display" id="emergencyDataDisplay"></div>
            <button class="btn btn-primary" onclick="app?.proceedToUnlock()">
                Access Full Medical Record (Password Required)
            </button>
        </div>
    </div>

    <header class="site-header no-print" role="banner">
        <div class="security-bar">
            <div class="site-header__brand">
                <div class="logo-container">
                    <img src="https://storage.googleapis.com/intelechia-content/ehr%20vault.png" alt="EHR Vault logo" loading="lazy" decoding="async">
                </div>
                <div class="site-header__title">
                    <h1>Personal Health Vault</h1>
                    <p>Your encrypted medical record hub</p>
                </div>
            </div>
        </div>
    </header>

    <div id="vaultManagerScreen" class="vault-manager-screen" aria-hidden="true">
        <div class="vault-manager-container" role="region" aria-labelledby="vaultManagerHeading">
            <div class="vault-manager-header">
                <div class="vault-manager-title">
                    <h2 id="vaultManagerHeading">Vault Manager</h2>
                    <p>Organize, label, and open your encrypted health vaults.</p>
                </div>
                <div class="vault-manager-actions">
                    <input type="search" id="vaultManagerSearch" class="vault-manager-search" placeholder="Search vaultsâ€¦" aria-label="Search vaults">
                    <button type="button" id="vaultManagerCreateBtn" class="vault-manager-button" data-variant="primary">Create New Vault</button>
                    <button type="button" id="vaultManagerImportBtn" class="vault-manager-button" data-variant="secondary">Add Existing Vault</button>
                </div>
            </div>
            <div id="vaultManagerStatus" class="vault-manager-status" aria-live="polite"></div>
            <div id="vaultManagerEmpty" class="vault-manager-empty" hidden>
                <h3>Welcome to your secure hub</h3>
                <p>Import an encrypted .ehv file you already have or create a brand-new vault for someone you care for.</p>
                <div class="vault-manager-empty-actions">
                    <button type="button" id="vaultManagerEmptyCreate" class="vault-manager-button" data-variant="primary">Create a Vault</button>
                    <button type="button" id="vaultManagerEmptyImport" class="vault-manager-button" data-variant="secondary">Import .ehv File</button>
                </div>
            </div>
            <div id="vaultManagerList" class="vault-card-grid" aria-live="polite" aria-label="Saved vaults"></div>
        </div>
    </div>

    <input type="file" id="vaultManagerFileInput" accept=".ehv" style="display: none;">

    <!-- Accessibility Controls -->
    <div class="a11y-controls" id="a11yControls" role="region" aria-label="Accessibility settings">
        <button class="a11y-toggle" id="a11yToggle" aria-expanded="false" aria-controls="a11yPanel">
            <img src="https://img.icons8.com/?size=1200&id=1DPWUoZCriuY&format=png" alt="">
            <span class="sr-only">Accessibility Settings</span>
        </button>

        <div class="a11y-panel" id="a11yPanel" hidden>
            <h3 class="a11y-panel-title">Accessibility Settings</h3>

            <!-- Font Size Controls -->
            <div class="a11y-section">
                <label class="a11y-label">
                    <span>Text Size</span>
                    <span class="a11y-current" id="fontSizeDisplay">100%</span>
                </label>
                <div class="a11y-button-group" role="group" aria-label="Font size controls">
                    <button class="a11y-btn" id="fontDecrease" aria-label="Decrease font size">A-</button>
                    <button class="a11y-btn" id="fontReset" aria-label="Reset font size">A</button>
                    <button class="a11y-btn" id="fontIncrease" aria-label="Increase font size">A+</button>
                </div>
            </div>

            <!-- High Contrast Toggle -->
            <div class="a11y-section">
                <label class="a11y-checkbox">
                    <input type="checkbox" id="highContrastToggle" aria-describedby="highContrastDesc">
                    <span>High Contrast Mode</span>
                </label>
                <p class="a11y-description" id="highContrastDesc">Increases color contrast for better readability</p>
            </div>

            <!-- Reduced Motion -->
            <div class="a11y-section">
                <label class="a11y-checkbox">
                    <input type="checkbox" id="reducedMotionToggle" aria-describedby="reducedMotionDesc">
                    <span>Reduce Motion</span>
                </label>
                <p class="a11y-description" id="reducedMotionDesc">Minimizes animations and transitions</p>
            </div>

            <!-- Focus Indicators -->
            <div class="a11y-section">
                <label class="a11y-checkbox">
                    <input type="checkbox" id="focusIndicatorsToggle" aria-describedby="focusDesc" checked>
                    <span>Enhanced Focus Indicators</span>
                </label>
                <p class="a11y-description" id="focusDesc">Shows clear outlines around interactive elements</p>
            </div>

            <!-- Link Underlines -->
            <div class="a11y-section">
                <label class="a11y-checkbox">
                    <input type="checkbox" id="linkUnderlineToggle" aria-describedby="linkDesc">
                    <span>Underline All Links</span>
                </label>
                <p class="a11y-description" id="linkDesc">Makes links easier to identify</p>
            </div>
        </div>
    </div>

    <!-- Welcome Screen (shown for new files) -->
    <div class="welcome-screen" id="welcomeScreen" style="display: none;">
        <div id="landingRoot"></div>
        <input type="file" id="vaultFileInput" accept=".ehv" />
    </div>

    <main class="page-shell" id="main-content" role="main">
        <nav class="nav-tabs no-print" id="navTabs" role="tablist" aria-label="Medical record sections" aria-orientation="horizontal" style="display: none;">
            <div class="tab active" data-section="demographics" data-i18n-key="nav_demographics">ðŸ“‹ Demographics</div>
            <div class="tab" data-section="emergency" data-i18n-key="nav_emergency">ðŸ†˜ Emergency</div>
            <div class="tab" data-section="medications" data-i18n-key="nav_medications">ðŸ’Š Medications</div>
            <div class="tab" data-section="history" data-i18n-key="nav_history">ðŸ©º History</div>
            <div class="tab" data-section="vitals" data-i18n-key="nav_vitals">â¤ï¸ Vitals</div>
            <div class="tab" data-section="immunizations" data-i18n-key="nav_immunizations">ðŸ’‰ Vaccines</div>
            <div class="tab" data-section="labs" data-i18n-key="nav_labs">ðŸ”¬ Lab Results</div>
            <div class="tab" data-section="providers" data-i18n-key="nav_providers">ðŸ‘©â€âš•ï¸ Providers</div>
            <div class="tab" data-section="insurance" data-i18n-key="nav_insurance">ðŸ¥ Insurance</div>
            <div class="tab" data-section="notes" data-i18n-key="nav_notes">ðŸ“ Notes</div>
            <div class="tab" data-section="attachments" data-i18n-key="nav_attachments">ðŸ“Ž Attachments</div>
            <!-- Module tabs added dynamically -->
        </nav>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="settingsModalTitle" data-i18n-key="settings_title">âš™ï¸ Settings &amp; Modules</h3>
                <p class="settings-version">
                    <strong>Version:</strong>
                    <span id="appVersion">2024.04.07.1200</span>
                    <span>Schema: <span id="schemaVersionDisplay">v2.0.0</span></span>
                    <span>(Last updated: <span id="appLastUpdated">Apr 07, 2024 12:00 UTC</span>)</span>
                </p>
                <!-- Update the version number and timestamp above to reflect the latest deployment each time changes are pushed. -->
            </div>
            <div class="modal-body">
                <div class="offline-download">
                    <p><strong data-i18n-key="offline_download_title">Want to use this 100% offline?</strong></p>
                    <button type="button" class="offline-download-trigger" data-i18n-key="offline_download_cta">Download the offline bundle</button>
                    <p data-i18n-key="offline_download_subtext">We'll package everything for youâ€”just open index.html in any browser, no internet needed.</p>
                    <p class="offline-download-status" aria-live="polite"></p>
                </div>
                <div class="settings-grid">
                    <div class="settings-section">
                        <h4 data-i18n-key="optional_modules_heading">Optional Modules</h4>
                        <p style="font-size: 9pt; color: #64748b; margin-bottom: 15px;" data-i18n-key="optional_modules_subtitle">
                            Enable specialized tracking modules as needed
                        </p>
                        
                        <div class="module-toggle">
                            <div class="module-info">
                                <div class="module-name" data-i18n-key="module_identity_name">Extended Identity</div>
                                <div class="module-desc" data-i18n-key="module_identity_desc">Pronouns, chosen names, context-specific usage</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="module-identity">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="module-toggle">
                            <div class="module-info">
                                <div class="module-name" data-i18n-key="module_gac_name">Gender Affirming Care</div>
                                <div class="module-desc" data-i18n-key="module_gac_desc">HRT tracking, surgeries, specialized providers</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="module-gac">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="module-toggle">
                            <div class="module-info">
                                <div class="module-name" data-i18n-key="module_mental_name">Mental Health</div>
                                <div class="module-desc" data-i18n-key="module_mental_desc">Mood tracking, therapy notes, crisis resources</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="module-mental">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="module-toggle">
                            <div class="module-info">
                                <div class="module-name" data-i18n-key="module_chronic_name">Chronic Disease</div>
                                <div class="module-desc" data-i18n-key="module_chronic_desc">Diabetes, hypertension, pain management</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="module-chronic">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section" id="totpSettings">
                        <h4 data-i18n-key="totp_status_title">ðŸ” Two-Factor Authentication Status</h4>
                        <p style="font-size: 9pt; color: #64748b; margin-bottom: 15px;" data-i18n-key="totp_status_subtitle">
                            Enhanced security using time-based codes
                        </p>
                        <div id="totpStatus" style="padding: 15px; background: #f8fafc; border-radius: 6px;">
                            <!-- Status will be updated dynamically -->
                        </div>
                    </div>

                    <div class="settings-section" id="recoveryKeySettings">
                        <h4 data-i18n-key="recovery_key_title">ðŸ›Ÿ Emergency Recovery Key</h4>
                        <p style="font-size: 9pt; color: #64748b; margin-bottom: 15px;" data-i18n-key="recovery_key_subtitle">
                            Generate a one-time backup key that can unlock your vault if you forget your password or lose 2FA.
                        </p>
                        <div id="recoveryKeyStatus" style="padding: 15px; background: #f8fafc; border-radius: 6px;">
                            <!-- Recovery key status -->
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary" id="generateRecoveryKeyBtn" data-i18n-key="recovery_key_generate">Generate recovery key</button>
                            <button class="btn btn-secondary" id="disableRecoveryKeyBtn" data-i18n-key="recovery_key_disable" style="display: none;">Remove recovery key</button>
                        </div>
                        <div class="warning-box" id="recoveryKeyDisplay" style="display: none; margin-top: 15px; text-align: left;">
                            <strong data-i18n-key="recovery_key_warning_title">Store this key securely!</strong>
                            <p style="margin: 10px 0;" data-i18n-key="recovery_key_warning">This recovery key can unlock your vault by itself. Copy it to an offline password manager or secure storage and keep it private.</p>
                            <code id="recoveryKeyValue" class="recovery-key-value"></code>
                            <p class="recovery-key-note" style="margin-top: 12px;" data-i18n-key="recovery_key_save_hint">Download a new .ehv file after saving so this recovery key is included.</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4 data-i18n-key="emergency_access_title">Emergency Access (No Password Required)</h4>
                        <p style="font-size: 9pt; color: #64748b; margin-bottom: 15px;" data-i18n-key="emergency_access_subtitle">
                            Select information visible to anyone who opens this file, even without the password.
                            Useful for first responders or emergency situations.
                        </p>

                        <div class="checkbox-item">
                            <input type="checkbox" id="emergency-enabled" class="form-data" data-field="emergencyAccessEnabled">
                            <label for="emergency-enabled"><strong data-i18n-key="emergency_enable">Enable Emergency Access</strong></label>
                        </div>

                        <div id="emergencyOptions" style="margin-left: 20px; margin-top: 10px; display: none;">
                            <div class="checkbox-item">
                                <input type="checkbox" id="emergency-blood" class="form-data" data-field="showBloodType">
                                <label for="emergency-blood" data-i18n-key="emergency_blood">Blood Type</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="emergency-allergies" class="form-data" data-field="showCriticalAllergies">
                                <label for="emergency-allergies" data-i18n-key="emergency_allergies">Critical Allergies</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="emergency-contacts" class="form-data" data-field="showEmergencyContacts">
                                <label for="emergency-contacts" data-i18n-key="emergency_contacts">Emergency Contacts</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="emergency-conditions" class="form-data" data-field="showCriticalConditions">
                                <label for="emergency-conditions" data-i18n-key="emergency_conditions">Critical Medical Conditions</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="emergency-directive" class="form-data" data-field="showAdvanceDirective">
                                <label for="emergency-directive" data-i18n-key="emergency_directive">Advance Directive Status</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="emergency-medications" class="form-data" data-field="showCriticalMedications">
                                <label for="emergency-medications" data-i18n-key="emergency_medications">Critical Medications</label>
                            </div>
                        </div>

                        <div class="warning-box" style="margin-top: 15px;">
                            <strong>Privacy Notice:</strong> Emergency access data is stored in plain text (NOT encrypted)
                            so it can be read without a password. Only enable this if you're comfortable with anyone
                            who has this file seeing the selected information.
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app?.closeSettings()" data-i18n-key="settings_cancel">Cancel</button>
                <button class="btn btn-primary" onclick="app?.saveSettings()" data-i18n-key="settings_save">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- TOTP Setup Modal -->
    <div class="modal" id="totpModal" role="dialog" aria-modal="true" aria-labelledby="totpModalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="totpModalTitle" data-i18n-key="totp_setup_title">ðŸ” Setup Two-Factor Authentication</h3>
            </div>
            <div class="modal-body">
                <div class="totp-setup">
                    <p data-i18n-key="totp_scan_prompt">Scan this QR code with your authenticator app:</p>
                    <div class="totp-qr" id="totpQR"></div>
                    <p style="margin-top: 10px;" data-i18n-key="totp_manual_prompt">Or enter this secret manually:</p>
                    <code id="totpSecret" style="font-size: 12pt; background: #f0f0f0; padding: 8px; border-radius: 4px;"></code>

                    <div style="margin-top: 20px;">
                        <label data-i18n-key="totp_verify_label">Verify code from your app:</label>
                        <input type="text" id="verifyTOTP" placeholder="000000" maxlength="6" style="width: 150px; text-align: center; font-size: 14pt;">
                    </div>

                    <div class="warning-box" style="margin-top: 20px;">
                        <strong data-i18n-key="totp_backup">Backup Codes (Save These!)</strong>
                        <div class="backup-codes" id="backupCodes"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app?.cancelTOTP()" data-i18n-key="totp_cancel">Cancel</button>
                <button class="btn btn-primary" onclick="app?.verifyTOTP()" data-i18n-key="totp_verify">Verify &amp; Enable</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="passwordModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" data-i18n-key="password_modal_title">Set Encryption Password</h3>
            </div>
            <div class="modal-body">
                <div class="field">
                    <label data-i18n-key="password_label">Password</label>
                    <input type="password" id="modalPassword" placeholder="Enter password" data-i18n-placeholder="unlock_password_placeholder">
                    <div class="password-strength" id="passwordStrength" style="display: none;">
                        <div class="strength-bar" id="strength1"></div>
                        <div class="strength-bar" id="strength2"></div>
                        <div class="strength-bar" id="strength3"></div>
                        <div class="strength-bar" id="strength4"></div>
                    </div>
                    <div id="passwordRequirements" class="password-requirements"></div>
                    <div id="passwordFeedback" class="password-feedback" role="status" aria-live="polite"></div>
                </div>
                <div class="field" id="confirmPasswordField">
                    <label data-i18n-key="confirm_password_label">Confirm Password</label>
                    <input type="password" id="modalConfirmPassword" placeholder="Confirm password" data-i18n-placeholder="confirm_password_placeholder">
                </div>
                <div class="warning-box">
                    <strong data-i18n-key="important_notice">Important:</strong> <span data-i18n-key="vault_notice">This vault file (.ehv) will contain your encrypted data.
                    Always download and save the updated .ehv file after making changes.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modalCancel" data-i18n-key="modal_cancel">Cancel</button>
                <button class="btn btn-primary" id="modalSubmit" data-i18n-key="modal_continue">Continue</button>
            </div>
        </div>
    </div>

    <!-- Password Update Modal -->
    <div class="modal" id="passwordUpdateModal" role="dialog" aria-modal="true" aria-labelledby="passwordUpdateTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="passwordUpdateTitle" data-i18n-key="save_vault_title">Save Vault</h3>
            </div>
            <div class="modal-body">
                <div class="password-update-option">
                    <label>
                        <input type="radio" name="passwordUpdateChoice" value="keep" checked>
                        <span data-i18n-key="keep_password_option">Keep current password</span>
                    </label>
                    <p data-i18n-key="keep_password_desc">
                        Your vault will be encrypted with the password you unlocked it with.
                    </p>
                </div>
                <div class="password-update-option">
                    <label>
                        <input type="radio" name="passwordUpdateChoice" value="change">
                        <span data-i18n-key="change_password_option">Set a new password before saving</span>
                    </label>
                    <div class="password-update-fields" id="passwordUpdateFields" style="display: none;">
                        <div class="field">
                            <label data-i18n-key="new_password_label">New Password</label>
                            <input type="password" id="updateNewPassword" placeholder="Enter new password" data-i18n-placeholder="new_password_label">
                        </div>
                        <div class="field">
                            <label data-i18n-key="confirm_new_password_label">Confirm New Password</label>
                            <input type="password" id="updateConfirmPassword" placeholder="Confirm new password" data-i18n-placeholder="confirm_new_password_label">
                        </div>
                    </div>
                </div>
                <p class="password-update-note" id="passwordUpdate2FANote" style="display: none;" data-i18n-key="two_fa_note">
                    Two-factor authentication stays connectedâ€”your existing authenticator codes will continue to work after changing your password.
                </p>
                <div class="password-update-option" id="temporaryAccessSection" style="margin-top: 20px; display: none;">
                    <h4 style="margin-bottom: 8px;">Temporary TOTP-Only Access</h4>
                    <p style="font-size: 9pt; color: #64748b; margin-bottom: 12px;">
                        Allow a trusted person to unlock this vault using only a current authenticator code for a limited time. They will not need the password while access is active.
                    </p>
                    <div class="warning-box" id="existingTemporaryAccess" style="display: none; margin-bottom: 12px;">
                        <strong id="temporaryAccessSummary"></strong>
                        <button type="button" class="btn btn-secondary" id="revokeTemporaryAccess" style="margin-top: 10px;">Revoke temporary access</button>
                    </div>
                    <label class="checkbox-item" style="align-items: flex-start; gap: 10px;">
                        <input type="checkbox" id="enableTemporaryAccess">
                        <div>
                            <strong>Enable new temporary access</strong>
                            <div style="font-size: 9pt; color: #64748b;">Requires a current code from your authenticator app.</div>
                        </div>
                    </label>
                    <div id="temporaryAccessOptions" style="display: none; margin: 12px 0 0 26px; flex-direction: column; gap: 12px;">
                        <div class="field">
                            <label>Access duration</label>
                            <select id="temporaryAccessDuration">
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="45" selected>45 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Authenticator code</label>
                            <input type="text" id="temporaryAccessCode" placeholder="000000" maxlength="6" inputmode="numeric" autocomplete="one-time-code">
                            <p style="font-size: 9pt; color: #f97316; margin-top: 6px;">
                                Share this code and the new .ehv file. The recipient can unlock without the password until the timer expires.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="passwordUpdateCancel" data-i18n-key="modal_cancel">Cancel</button>
                <button class="btn btn-primary" id="passwordUpdateSubmit" data-i18n-key="save_vault_submit">Save Vault</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="exportModalTitle" data-i18n-key="export_title">ðŸ“„ Export &amp; Share</h3>
            </div>
            <div class="modal-body">
                <p data-i18n-key="export_prompt">Select how you'd like to share or archive this record.</p>
                <div class="export-options">
                    <button class="btn btn-primary" id="printSummaryBtn" data-i18n-key="print_summary_button">ðŸ–¨ï¸ Printable Care Summary</button>
                </div>
                <p class="export-note" data-i18n-key="export_note">
                    The printable summary reformats your record into an easy-to-read care handoff that can be printed or saved as a PDF for sharing.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="exportCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent" style="display: none;">
        <!-- Medical Chart Header -->
        <div class="chart-header" id="demographics-section">
            <div class="chart-header-top">
                <div class="chart-branding">
                    <img src="https://storage.googleapis.com/intelechia-content/ehr%20vault.png" alt="EHR Vault logo" style="height: 32px;">
                    <div class="chart-title-group">
                        <h1>PATIENT HEALTH RECORD</h1>
                        <div class="chart-header-info">
                            <span id="lastUpdatedHeader">Last Updated: Never</span>
                        </div>
                    </div>
                </div>

                <div class="chart-controls">
                    <div class="language-selector">
                        <label for="languageSelect" data-i18n-key="language_label">Language</label>
                        <select id="languageSelect" data-language-selector aria-label="Language"></select>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" id="settingsBtn" data-i18n-key="settings_button">âš™ï¸ Settings</button>
                        <button class="btn btn-lock" id="lockBtn" style="display: none;" data-i18n-key="unlock_action">ðŸ”“ Lock</button>
                        <button class="btn btn-secondary" id="exportBtn" data-i18n-key="export_button">Export/Print</button>
                        <button class="btn btn-save" id="saveBtn" data-i18n-key="save_button_create">Create Encrypted Vault</button>
                    </div>
                </div>
            </div>

            <div class="chart-header-status">
                <div class="security-status">
                    <div class="status-icon"></div>
                    <span id="securityText" data-i18n-key="always_encrypted">Always Encrypted</span>
                    <span id="lockTimer" aria-live="polite">Session: --:--</span>
                </div>
                <div class="save-status never-saved" id="saveStatus" data-i18n-key="not_initialized">âš ï¸ Not Initialized - Create Your Vault</div>
            </div>

            <!-- Patient demographics content continues here... -->
            <div class="patient-demographics">
                <div class="patient-summary">
                    <div class="patient-profile">
                        <div class="patient-avatar" id="patientAvatar">
                            <img id="patientAvatarImage" alt="Patient photo" />
                            <span id="patientAvatarInitials" class="patient-avatar-initials">ðŸ‘¤</span>
                        </div>
                        <input type="hidden" class="form-data" data-field="profilePhoto" id="profilePhotoData" />
                        <div class="avatar-actions">
                            <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" />
                            <button type="button" class="btn btn-secondary" id="uploadPhotoBtn">Upload Photo</button>
                            <button type="button" class="link-button" id="removePhotoBtn" style="display: none;">Remove Photo</button>
                        </div>
                        <div class="patient-overview">
                            <div class="patient-display-name" id="patientDisplayName">Enter patient name</div>
                            <div class="patient-display-meta" id="patientDisplayMeta">Add DOB, sex, and MRN for quick reference.</div>
                        </div>
                        <div class="field-block">
                            <label>Patient Name</label>
                            <div class="name-grid">
                                <input type="text" class="form-data" data-field="lastName" placeholder="Last name"/>
                                <input type="text" class="form-data" data-field="firstName" placeholder="First name"/>
                                <input type="text" class="form-data" data-field="middleInitial" placeholder="MI"/>
                            </div>
                        </div>
                        <div class="contact-grid">
                            <div class="field-block">
                                <label>Primary Phone</label>
                                <input type="tel" class="form-data" data-field="phone" placeholder="(555) 000-0000"/>
                            </div>
                            <div class="field-block">
                                <label>Email</label>
                                <input type="email" class="form-data" data-field="email" placeholder="email@example.com"/>
                            </div>
                        </div>
                    </div>
                    <div class="patient-core">
                        <div class="patient-info-grid">
                            <div class="field-block">
                                <label>Medical Record #</label>
                                <input type="text" class="form-data" data-field="mrn" placeholder="MR-2025-00000"/>
                            </div>
                            <div class="field-block">
                                <label>Date of Birth</label>
                                <input type="date" class="form-data" data-field="dateOfBirth"/>
                            </div>
                            <div class="field-block">
                                <label>Biological Sex</label>
                                <select class="form-data" data-field="biologicalSex">
                                    <option value="">Select...</option>
                                    <option>Female</option>
                                    <option>Male</option>
                                    <option>Intersex</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div class="field-block">
                                <label>Social Security #</label>
                                <input type="text" class="form-data" data-field="ssn" placeholder="XXX-XX-XXXX"/>
                            </div>
                            <div class="field-block full">
                                <label>Home Address</label>
                                <input type="text" class="form-data" data-field="address" placeholder="Street address, City, State ZIP"/>
                            </div>
                        </div>
                        <div class="field-row" id="corePronounRow" style="display: none;">
                            <div class="field">
                                <label>Chosen Name (Daily Use)</label>
                                <input type="text" class="form-data" data-field="chosenName" placeholder="Preferred name for day-to-day use" />
                            </div>
                            <div class="field">
                                <label>Pronouns</label>
                                <input type="text" class="form-data" data-field="pronouns" placeholder="she/her, they/them, he/him" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vital Signs Card -->
        <div class="vitals-card">
            <div class="vitals-header">VITAL SIGNS (Most Recent)</div>
            <div class="vitals-grid">
                <div class="vital-item">
                    <div class="vital-label">Blood Pressure</div>
                    <input type="text" class="form-data vital-value" data-field="lastBP" placeholder="120/80" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Pulse</div>
                    <input type="number" class="form-data vital-value" data-field="lastPulse" placeholder="72" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Temp (Â°F)</div>
                    <input type="text" class="form-data vital-value" data-field="lastTemp" placeholder="98.6" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Resp Rate</div>
                    <input type="number" class="form-data vital-value" data-field="lastResp" placeholder="16" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">O2 Sat (%)</div>
                    <input type="number" class="form-data vital-value" data-field="lastO2" placeholder="98" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Weight</div>
                    <input type="text" class="form-data vital-value" data-field="weight" placeholder="150 lbs" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">Height</div>
                    <input type="text" class="form-data vital-value" data-field="height" placeholder="5'8&quot;" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
                <div class="vital-item">
                    <div class="vital-label">BMI</div>
                    <input type="text" class="form-data vital-value" data-field="bmi" placeholder="22.5" style="border: none; background: transparent; text-align: center; width: 100%;">
                </div>
            </div>
        </div>

        <!-- Emergency Information Section -->
        <div class="section" id="emergency-section">
            <div class="section-header emergency">
                <h2>ðŸ†˜ Emergency Information</h2>
            </div>
            <div class="section-content">
                <div class="danger-box">
                    <strong>âš ï¸ CRITICAL MEDICAL INFORMATION</strong><br>
                    Blood Type: <input type="text" class="form-data" data-field="bloodType" style="display: inline; width: 80px;" placeholder="O+" />
                    Allergies: <input type="text" class="form-data" data-field="criticalAllergies" style="display: inline; width: 200px;" placeholder="Penicillin, Peanuts" />
                </div>
                
                <h3>Emergency Contacts</h3>
                <div id="emergency-contacts-container"></div>
                <button class="add-btn no-print" id="addEmergencyBtn">+ Add Emergency Contact</button>
                
                <h3>Critical Medical Conditions</h3>
                <div class="field">
                    <textarea rows="3" class="form-data" data-field="criticalConditions" placeholder="Diabetes Type 1, Epilepsy, Heart Condition..."></textarea>
                </div>
                
                <h3>Do NOT Give These Medications</h3>
                <div class="field">
                    <textarea rows="2" class="form-data" data-field="medicationContraindications" placeholder="NSAIDs (kidney disease), Aspirin (bleeding disorder)..."></textarea>
                </div>
                
                <div class="grid-2">
                    <div class="field">
                        <label>Preferred Hospital</label>
                        <input type="text" class="form-data" data-field="preferredHospital" />
                    </div>
                    <div class="field">
                        <label>Medical Power of Attorney</label>
                        <input type="text" class="form-data" data-field="medicalPOA" />
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="field">
                        <label>Advance Directive</label>
                        <select class="form-data" data-field="advanceDirective">
                            <option value="">Not Specified</option>
                            <option>Full Code</option>
                            <option>DNR</option>
                            <option>DNI</option>
                            <option>Limited Intervention</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Organ Donor</label>
                        <select class="form-data" data-field="organDonor">
                            <option value="">Not Specified</option>
                            <option>Yes</option>
                            <option>No</option>
                            <option>Family Decision</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medications Section with FDA Search -->
        <div class="section" id="medications-section">
            <div class="section-header">
                <h2>ðŸ’Š Medications & Allergies</h2>
            </div>
            
            <div class="section-content">
                <h3>Current Medications</h3>
                <div id="medications-container"></div>
                <button class="add-btn no-print" id="addMedicationBtn">+ Add Medication</button>
                
                <h3>Allergies & Reactions</h3>
                <div class="field">
                    <label>Medication Allergies</label>
                    <textarea rows="3" class="form-data" data-field="medicationAllergies" placeholder="Penicillin - rash, Sulfa - anaphylaxis..."></textarea>
                </div>
                <div class="field">
                    <label>Food Allergies</label>
                    <textarea rows="2" class="form-data" data-field="foodAllergies" placeholder="Peanuts, Shellfish, Dairy..."></textarea>
                </div>
                <div class="field">
                    <label>Environmental Allergies</label>
                    <textarea rows="2" class="form-data" data-field="environmentalAllergies" placeholder="Pollen, Dust, Pet dander..."></textarea>
                </div>
            </div>
        </div>

        <!-- Medical History Section -->
        <div class="section" id="history-section">
            <div class="section-header">
                <h2>ðŸ©º Medical History</h2>
            </div>
            <div class="section-content">
                <h3>Current Conditions</h3>
                <div id="conditions-container"></div>
                <button class="add-btn no-print" id="addConditionBtn">+ Add Condition</button>
                
                <h3>Past Surgeries</h3>
                <div id="surgeries-container"></div>
                <button class="add-btn no-print" id="addSurgeryBtn">+ Add Surgery</button>
                
                <h3>Family History</h3>
                <div class="field">
                    <textarea rows="4" class="form-data" data-field="familyHistory" placeholder="Mother: Diabetes Type 2, Hypertension&#10;Father: Heart Disease&#10;Siblings: ..."></textarea>
                </div>
                
                <h3>Social History</h3>
                <div class="grid-3">
                    <div class="field">
                        <label>Smoking Status</label>
                        <select class="form-data" data-field="smokingStatus">
                            <option value="">Select...</option>
                            <option>Never</option>
                            <option>Former</option>
                            <option>Current</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Alcohol Use</label>
                        <select class="form-data" data-field="alcoholUse">
                            <option value="">Select...</option>
                            <option>None</option>
                            <option>Occasional</option>
                            <option>Moderate</option>
                            <option>Heavy</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Exercise</label>
                        <select class="form-data" data-field="exerciseFrequency">
                            <option value="">Select...</option>
                            <option>None</option>
                            <option>1-2 times/week</option>
                            <option>3-4 times/week</option>
                            <option>5+ times/week</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vitals Section -->
        <div class="section" id="vitals-section">
            <div class="section-header">
                <h2>â¤ï¸ Vital Signs History</h2>
            </div>
            <div class="section-content">
                <div id="vitals-history-container"></div>
                <button class="add-btn no-print" id="addVitalBtn">+ Add Vital Signs</button>
            </div>
        </div>

        <!-- Immunizations Section -->
        <div class="section" id="immunizations-section">
            <div class="section-header">
                <h2>ðŸ’‰ Immunizations</h2>
            </div>
            <div class="section-content">
                <h3>COVID-19 Vaccines</h3>
                <div id="covid-vaccines-container"></div>
                <button class="add-btn no-print" id="addCovidVaccineBtn">+ Add COVID Vaccine</button>
                
                <h3>Standard Vaccines</h3>
                <div class="grid-2">
                    <div class="field">
                        <label>Flu Shot (Last)</label>
                        <input type="date" class="form-data" data-field="lastFluShot" />
                    </div>
                    <div class="field">
                        <label>Tetanus (Tdap)</label>
                        <input type="date" class="form-data" data-field="lastTetanus" />
                    </div>
                </div>
                
                <h3>Other Vaccines</h3>
                <div id="vaccines-container"></div>
                <button class="add-btn no-print" id="addVaccineBtn">+ Add Vaccine</button>
            </div>
        </div>

        <!-- Lab Results Section -->
        <div class="section" id="labs-section">
            <div class="section-header">
                <h2>ðŸ”¬ Lab Results</h2>
            </div>
            <div class="section-content">
                <div id="labs-container"></div>
                <button class="add-btn no-print" id="addLabBtn">+ Add Lab Result</button>
            </div>
        </div>

        <!-- Healthcare Providers Section -->
        <div class="section" id="providers-section">
            <div class="section-header">
                <h2>ðŸ‘©â€âš•ï¸ Healthcare Providers</h2>
            </div>
            <div class="section-content">
                <h3>Primary Care Provider</h3>
                <div class="grid-3">
                    <div class="field">
                        <label>Provider Name</label>
                        <input type="text" class="form-data" data-field="pcpName" />
                    </div>
                    <div class="field">
                        <label>Phone</label>
                        <input type="tel" class="form-data" data-field="pcpPhone" />
                    </div>
                    <div class="field">
                        <label>Last Visit</label>
                        <input type="date" class="form-data" data-field="pcpLastVisit" />
                    </div>
                </div>
                
                <h3>Specialists</h3>
                <div id="providers-container"></div>
                <button class="add-btn no-print" id="addProviderBtn">+ Add Provider</button>
            </div>
        </div>

        <!-- Insurance Section -->
        <div class="section" id="insurance-section">
            <div class="section-header">
                <h2>ðŸ¥ Insurance Information</h2>
            </div>
            
            <div class="section-content">
                <h3>Primary Insurance</h3>
                <div class="grid-3">
                    <div class="field">
                        <label>Insurance Company</label>
                        <input type="text" class="form-data" data-field="insuranceCompany" />
                    </div>
                    <div class="field">
                        <label>Member ID</label>
                        <input type="text" class="form-data" data-field="memberId" />
                    </div>
                    <div class="field">
                        <label>Group Number</label>
                        <input type="text" class="form-data" data-field="groupNumber" />
                    </div>
                </div>
                
                <div class="grid-3">
                    <div class="field">
                        <label>Policy Holder</label>
                        <input type="text" class="form-data" data-field="policyHolder" />
                    </div>
                    <div class="field">
                        <label>Relationship</label>
                        <select class="form-data" data-field="policyRelationship">
                            <option value="">Select...</option>
                            <option>Self</option>
                            <option>Spouse</option>
                            <option>Child</option>
                            <option>Parent</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Insurance Phone</label>
                        <input type="tel" class="form-data" data-field="insurancePhone" />
                    </div>
                </div>
                
                <h4>Coverage Details</h4>
                <div class="grid-3">
                    <div class="field">
                        <label>Deductible</label>
                        <input type="text" class="form-data" data-field="deductible" placeholder="$1,500" />
                    </div>
                    <div class="field">
                        <label>Out-of-Pocket Max</label>
                        <input type="text" class="form-data" data-field="oopMax" placeholder="$6,000" />
                    </div>
                    <div class="field">
                        <label>Copay (Primary)</label>
                        <input type="text" class="form-data" data-field="coPayPrimary" placeholder="$25" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="section" id="notes-section">
            <div class="section-header">
                <h2>ðŸ“ Health Notes & Journal</h2>
            </div>
            <div class="section-content">
                <div class="field">
                    <label>Available Note Tags</label>
                    <p style="font-size: 9pt; color: #64748b; margin-bottom: 8px;">Create custom tags to organize notes across your care team. Tags can be reused for gender-affirming care notes and general health entries.</p>
                    <div class="tag-manager">
                        <input type="text" id="noteTagInput" placeholder="Create a new tag and press Enter" />
                        <button class="add-btn no-print" type="button" id="addNoteTagBtn">+ Add Tag</button>
                    </div>
                    <div class="tag-chip-list" id="noteTagList"></div>
                    <input type="hidden" class="form-data" data-field="noteTagLibrary" id="noteTagStorage" value="[]" />
                    <datalist id="noteProviderOptions"></datalist>
                </div>
                <div id="notes-container"></div>
                <button class="add-btn no-print" id="addNoteBtn">+ Add Note</button>
            </div>
        </div>

        <div class="section" id="attachments-section">
            <div class="section-header">
                <h2>ðŸ“Ž Encrypted Attachments</h2>
            </div>
            <div class="section-content">
                <div class="info-box">
                    Securely store lab reports, imaging files, referrals, and other supporting documents directly inside your encrypted vault file.
                </div>
                <div id="attachments-container"></div>
                <button class="add-btn no-print" id="addAttachmentBtn">+ Add Attachment</button>
                <input type="file" id="attachmentFileInput" accept="*/*" multiple style="display: none;" />
                <input type="hidden" class="form-data" data-field="attachments" id="attachmentStorage" value="[]" />
            </div>
        </div>

        <div class="modal" id="attachmentPreviewModal" role="dialog" aria-modal="true" aria-labelledby="attachmentPreviewTitle" aria-hidden="true">
            <div class="modal-content attachment-preview-modal">
                <div class="modal-header">
                    <div>
                        <h3 id="attachmentPreviewTitle">Attachment Preview</h3>
                        <div class="attachment-preview-meta" id="attachmentPreviewMeta"></div>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="attachment-preview-body" id="attachmentPreviewContent"></div>
                    <div class="attachment-preview-error" id="attachmentPreviewError" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="attachmentPreviewClose">Close</button>
                    <button class="btn btn-primary" id="attachmentPreviewDownload">Download</button>
                </div>
            </div>
        </div>

        <!-- Extended Identity Module (Hidden by default) -->
        <div class="section module-section" id="identity-section" style="display: none;">
            <div class="section-header module">
                <h2>ðŸ‘¤ Extended Identity Management</h2>
            </div>
            <div class="section-content">
                <div class="info-box">
                    This section helps manage name and pronoun usage across different contexts.
                </div>
                
                <div class="field-row">
                    <div class="field">
                        <label>Chosen Name (Daily Use)</label>
                        <input type="text" class="form-data" data-field="chosenName" />
                    </div>
                    <div class="field">
                        <label>Pronouns</label>
                        <input type="text" class="form-data" data-field="pronouns" placeholder="she/her, they/them, he/him" />
                    </div>
                </div>
                
                <h3>Context-Specific Usage</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="different-contexts" class="form-data" data-field="differentContexts">
                    <label for="different-contexts">I use different names/pronouns in different situations</label>
                </div>
                
                <div id="contextFields" style="display: none; margin-top: 15px;">
                    <div class="field">
                        <label>Situations requiring legal name:</label>
                        <textarea rows="2" class="form-data" data-field="legalNameSituations"></textarea>
                    </div>
                    <div class="field">
                        <label>Safe to use chosen name with:</label>
                        <textarea rows="2" class="form-data" data-field="safeForChosenName"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gender Affirming Care Module (Hidden by default) -->
        <div class="section module-section" id="gac-section" style="display: none;">
            <div class="section-header module">
                <h2 data-i18n-key="gac_section_title">ðŸ³ï¸â€âš§ï¸ Gender Affirming Care</h2>
            </div>
            <div class="section-content">
                <h3 data-i18n-key="gac_hormone_heading">Hormone Therapy</h3>
                <div class="grid-2">
                    <div class="field">
                        <label data-i18n-key="hrt_status_label">HRT Status</label>
                        <select class="form-data" data-field="hrtStatus">
                            <option value="" data-i18n-key="option_select_placeholder">Select...</option>
                            <option data-i18n-key="hrt_status_option_not_started">Not Started</option>
                            <option data-i18n-key="hrt_status_option_active">Active</option>
                            <option data-i18n-key="hrt_status_option_paused">Paused</option>
                            <option data-i18n-key="hrt_status_option_discontinued">Discontinued</option>
                        </select>
                    </div>
                    <div class="field">
                        <label data-i18n-key="hrt_start_date_label">HRT Start Date</label>
                        <input type="date" class="form-data" data-field="hrtStartDate" />
                    </div>
                </div>
                
                <div class="field">
                    <label data-i18n-key="current_hormone_regimen_label">Current Hormone Regimen</label>
                    <textarea rows="3" class="form-data" data-field="hormoneRegimen"></textarea>
                </div>
                
                <h3 data-i18n-key="gac_procedures_heading">Gender-Affirming Procedures</h3>
                <div id="gac-procedures-container"></div>
                <button class="add-btn no-print" id="addGACProcedureBtn" data-i18n-key="add_procedure_button">+ Add Procedure</button>

                <h3 data-i18n-key="gac_notes_heading">Gender-Affirming Care Notes</h3>
                <div class="info-box">
                    <p data-i18n-key="gac_notes_info_line1">Track care plans, provider feedback, goals, and milestones that are specific to gender-affirming care.</p>
                    <p data-i18n-key="gac_notes_info_line2">Each note supports optional event dates, provider tagging, and reusable tags for quick filtering.</p>
                </div>
                <div id="gac-notes-container"></div>
                <button class="add-btn no-print" id="addGACNoteBtn" data-i18n-key="add_gac_note_button">+ Add GAC Note</button>
            </div>
        </div>

        <!-- Mental Health Module (Hidden by default) -->
        <div class="section module-section" id="mental-section" style="display: none;">
            <div class="section-header module">
                <h2 data-i18n-key="mental_section_title">ðŸ§  Mental Health</h2>
            </div>
            
            <div class="section-content">
                <h3 data-i18n-key="mental_current_heading">Current Mental Health</h3>
                <div class="field">
                    <label data-i18n-key="mental_diagnoses_label">Diagnoses</label>
                    <textarea rows="2" class="form-data" data-field="mentalDiagnoses"></textarea>
                </div>

                <div class="grid-2">
                    <div class="field">
                        <label data-i18n-key="therapist_label">Therapist/Counselor</label>
                        <input type="text" class="form-data" data-field="therapist" />
                    </div>
                    <div class="field">
                        <label data-i18n-key="psychiatrist_label">Psychiatrist</label>
                        <input type="text" class="form-data" data-field="psychiatrist" />
                    </div>
                </div>

                <h3 data-i18n-key="mental_crisis_heading">Crisis Resources</h3>
                <div class="field">
                    <label data-i18n-key="crisis_contacts_label">Crisis Contacts</label>
                    <textarea rows="3" class="form-data" data-field="crisisContacts" data-i18n-placeholder="crisis_contacts_placeholder" placeholder="988 Suicide &amp; Crisis Lifeline&#10;Crisis text line: Text HOME to 741741"></textarea>
                </div>

                <div class="field">
                    <label data-i18n-key="safety_plan_label">Safety Plan</label>
                    <textarea rows="4" class="form-data" data-field="safetyPlan"></textarea>
                </div>
            </div>
        </div>

        <!-- Chronic Disease Module (Hidden by default) -->
        <div class="section module-section" id="chronic-section" style="display: none;">
            <div class="section-header module">
                <h2 data-i18n-key="chronic_section_title">ðŸ“Š Chronic Disease Management</h2>
            </div>
            <div class="section-content">
                <h3 data-i18n-key="diabetes_management_heading">Diabetes Management</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="has-diabetes" class="form-data" data-field="hasDiabetes">
                    <label for="has-diabetes" data-i18n-key="have_diabetes_label">I have diabetes</label>
                </div>

                <div id="diabetesFields" style="display: none; margin-top: 15px;">
                    <div class="grid-3">
                        <div class="field">
                            <label data-i18n-key="diabetes_type_label">Type</label>
                            <select class="form-data" data-field="diabetesType">
                                <option value="" data-i18n-key="option_select_placeholder">Select...</option>
                                <option data-i18n-key="diabetes_type_option_1">Type 1</option>
                                <option data-i18n-key="diabetes_type_option_2">Type 2</option>
                                <option data-i18n-key="diabetes_type_option_gestational">Gestational</option>
                                <option data-i18n-key="diabetes_type_option_other">Other</option>
                            </select>
                        </div>
                        <div class="field">
                            <label data-i18n-key="last_a1c_label">Last A1C</label>
                            <input type="text" class="form-data" data-field="lastA1c" placeholder="7.2" />
                        </div>
                        <div class="field">
                            <label data-i18n-key="a1c_date_label">A1C Date</label>
                            <input type="date" class="form-data" data-field="a1cDate" />
                        </div>
                    </div>
                </div>

                <h3 data-i18n-key="blood_pressure_management_heading">Blood Pressure Management</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="has-hypertension" class="form-data" data-field="hasHypertension">
                    <label for="has-hypertension" data-i18n-key="have_hypertension_label">I have hypertension</label>
                </div>

                <div id="hypertensionFields" style="display: none; margin-top: 15px;">
                    <div class="field">
                        <label data-i18n-key="target_bp_label">Target Blood Pressure</label>
                        <input type="text" class="form-data" data-field="targetBP" placeholder="< 130/80" />
                    </div>
                </div>
            </div>
        </div>

    <div class="info-box" style="margin-top: 30px;">
        <strong data-i18n-key="important_notice">Important:</strong> <span data-i18n-key="final_info_line1">This vault file (.ehv) contains all your encrypted medical data.</span>
        <span data-i18n-key="final_info_line2">After making changes, click "Download Updated Vault (.ehv)" to save the new file.</span>
        <span data-i18n-key="final_info_line3">Replace your old file with the new one. Keep backups in secure locations.</span>
    </div>
    </div>

    <div id="printArea"></div>

    </main>

    <!-- Embedded Data Script (Added by save function) -->
    <script id="embedded-vault-data" type="application/json">
    </script>

    <!-- Embedded QR Code Generator (no external dependencies) -->
    <script>
        // Minimal QR Code generator implementation - Same as before
        var QRCode;
        (function(){
            function QR8bitByte(data){this.mode=4;this.data=data;}
            QR8bitByte.prototype={getLength:function(){return this.data.length;},write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8);}}};
            function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[];}
            QRCodeModel.prototype={addData:function(data){var newData=new QR8bitByte(data);this.dataList.push(newData);this.dataCache=null;},isDark:function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col){throw new Error(row+","+col);}return this.modules[row][col];},getModuleCount:function(){return this.moduleCount;},make:function(){this.makeImpl(false,this.getBestMaskPattern());},makeImpl:function(test,maskPattern){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++){this.modules[row][col]=null;}}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.setupTypeInfo(test,maskPattern);if(this.typeNumber>=7){this.setupTypeNumber(test);}if(this.dataCache==null){this.dataCache=QRCodeModel.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);}this.mapData(this.dataCache,maskPattern);},setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)){this.modules[row+r][col+c]=true;}else{this.modules[row+r][col+c]=false;}}}},getBestMaskPattern:function(){var minLostPoint=0;var pattern=0;for(var i=0;i<8;i++){this.makeImpl(true,i);var lostPoint=QRUtil.getLostPoint(this);if(i==0||minLostPoint>lostPoint){minLostPoint=lostPoint;pattern=i;}}return pattern;},setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++){if(this.modules[r][6]!=null){continue;}this.modules[r][6]=(r%2==0);}for(var c=8;c<this.moduleCount-8;c++){if(this.modules[6][c]!=null){continue;}this.modules[6][c]=(c%2==0);}},setupPositionAdjustPattern:function(){var pos=QRUtil.getPatternPosition(this.typeNumber);for(var i=0;i<pos.length;i++){for(var j=0;j<pos.length;j++){var row=pos[i];var col=pos[j];if(this.modules[row][col]!=null){continue;}for(var r=-2;r<=2;r++){for(var c=-2;c<=2;c++){if(r==-2||r==2||c==-2||c==2||(r==0&&c==0)){this.modules[row+r][col+c]=true;}else{this.modules[row+r][col+c]=false;}}}}}},setupTypeNumber:function(test){var bits=QRUtil.getBCHTypeNumber(this.typeNumber);for(var i=0;i<18;i++){var mod=(!test&&((bits>>i)&1)==1);this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=mod;}for(var i=0;i<18;i++){var mod=(!test&&((bits>>i)&1)==1);this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=mod;}},setupTypeInfo:function(test,maskPattern){var data=(this.errorCorrectLevel<<3)|maskPattern;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var mod=(!test&&((bits>>i)&1)==1);if(i<6){this.modules[i][8]=mod;}else if(i<8){this.modules[i+1][8]=mod;}else{this.modules[this.moduleCount-15+i][8]=mod;}}for(var i=0;i<15;i++){var mod=(!test&&((bits>>i)&1)==1);if(i<8){this.modules[8][this.moduleCount-i-1]=mod;}else if(i<9){this.modules[8][15-i-1+1]=mod;}else{this.modules[8][15-i-1]=mod;}}this.modules[this.moduleCount-8][8]=(!test);},mapData:function(data,maskPattern){var inc=-1;var row=this.moduleCount-1;var bitIndex=7;var byteIndex=0;for(var col=this.moduleCount-1;col>0;col-=2){if(col==6)col--;while(true){for(var c=0;c<2;c++){if(this.modules[row][col-c]==null){var dark=false;if(byteIndex<data.length){dark=(((data[byteIndex]>>>bitIndex)&1)==1);}var mask=QRUtil.getMask(maskPattern,row,col-c);if(mask){dark=!dark;}this.modules[row][col-c]=dark;bitIndex--;if(bitIndex==-1){byteIndex++;bitIndex=7;}}}row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break;}}}}};QRCodeModel.PAD0=0xEC;QRCodeModel.PAD1=0x11;QRCodeModel.createData=function(typeNumber,errorCorrectLevel,dataList){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel);var buffer=new QRBitBuffer();for(var i=0;i<dataList.length;i++){var data=dataList[i];buffer.put(data.mode,4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.mode,typeNumber));data.write(buffer);}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i++){totalDataCount+=rsBlocks[i].dataCount;}if(buffer.getLengthInBits()>totalDataCount*8){throw new Error("code length overflow. ("+buffer.getLengthInBits()+">"+totalDataCount*8+")");}if(buffer.getLengthInBits()+4<=totalDataCount*8){buffer.put(0,4);}while(buffer.getLengthInBits()%8!=0){buffer.putBit(false);}while(true){if(buffer.getLengthInBits()>=totalDataCount*8){break;}buffer.put(QRCodeModel.PAD0,8);if(buffer.getLengthInBits()>=totalDataCount*8){break;}buffer.put(QRCodeModel.PAD1,8);}return QRCodeModel.createBytes(buffer,rsBlocks);};QRCodeModel.createBytes=function(buffer,rsBlocks){var offset=0;var maxDcCount=0;var maxEcCount=0;var dcdata=new Array(rsBlocks.length);var ecdata=new Array(rsBlocks.length);for(var r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount;var ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount);maxEcCount=Math.max(maxEcCount,ecCount);dcdata[r]=new Array(dcCount);for(var i=0;i<dcdata[r].length;i++){dcdata[r][i]=0xff&buffer.buffer[i+offset];}offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);var rawPoly=new QRPolynomial(dcdata[r],rsPoly.getLength()-1);var modPoly=rawPoly.mod(rsPoly);ecdata[r]=new Array(rsPoly.getLength()-1);for(var i=0;i<ecdata[r].length;i++){var modIndex=i+modPoly.getLength()-ecdata[r].length;ecdata[r][i]=(modIndex>=0)?modPoly.get(modIndex):0;}}var totalCodeCount=0;for(var i=0;i<rsBlocks.length;i++){totalCodeCount+=rsBlocks[i].totalCount;}var data=new Array(totalCodeCount);var index=0;for(var i=0;i<maxDcCount;i++){for(var r=0;r<rsBlocks.length;r++){if(i<dcdata[r].length){data[index++]=dcdata[r][i];}}}for(var i=0;i<maxEcCount;i++){for(var r=0;r<rsBlocks.length;r++){if(i<ecdata[r].length){data[index++]=ecdata[r][i];}}}return data;};var QRMode={MODE_NUMBER:1<<0,MODE_ALPHA_NUM:1<<1,MODE_8BIT_BYTE:1<<2,MODE_KANJI:1<<3};var QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1<<0),G18:(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1<<0),G15_MASK:(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1),getBCHTypeInfo:function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0){d^=(QRUtil.G15<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)));}return((data<<10)|d)^QRUtil.G15_MASK;},getBCHTypeNumber:function(data){var d=data<<12;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0){d^=(QRUtil.G18<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)));}return(data<<12)|d;},getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit;},getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber-1];},getMask:function(maskPattern,i,j){switch(maskPattern){case QRMaskPattern.PATTERN000:return(i+j)%2==0;case QRMaskPattern.PATTERN001:return i%2==0;case QRMaskPattern.PATTERN010:return j%3==0;case QRMaskPattern.PATTERN011:return(i+j)%3==0;case QRMaskPattern.PATTERN100:return(Math.floor(i/2)+Math.floor(j/3))%2==0;case QRMaskPattern.PATTERN101:return(i*j)%2+(i*j)%3==0;case QRMaskPattern.PATTERN110:return((i*j)%2+(i*j)%3)%2==0;case QRMaskPattern.PATTERN111:return((i*j)%3+(i+j)%2)%2==0;default:throw new Error("bad maskPattern:"+maskPattern);}},getErrorCorrectPolynomial:function(errorCorrectLength){var a=new QRPolynomial([1],0);for(var i=0;i<errorCorrectLength;i++){a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));}return a;},getLengthInBits:function(mode,type){if(1<=type&&type<10){switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:return 8;case QRMode.MODE_KANJI:return 8;default:throw new Error("mode:"+mode);}}else if(type<27){switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw new Error("mode:"+mode);}}else if(type<41){switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw new Error("mode:"+mode);}}else{throw new Error("type:"+type);}},getLostPoint:function(qrCode){var moduleCount=qrCode.getModuleCount();var lostPoint=0;for(var row=0;row<moduleCount;row++){for(var col=0;col<moduleCount;col++){var sameCount=0;var dark=qrCode.isDark(row,col);for(var r=-1;r<=1;r++){if(row+r<0||moduleCount<=row+r){continue;}for(var c=-1;c<=1;c++){if(col+c<0||moduleCount<=col+c){continue;}if(r==0&&c==0){continue;}if(dark==qrCode.isDark(row+r,col+c)){sameCount++;}}}if(sameCount>5){lostPoint+=(3+sameCount-5);}}}for(var row=0;row<moduleCount-1;row++){for(var col=0;col<moduleCount-1;col++){var count=0;if(qrCode.isDark(row,col))count++;if(qrCode.isDark(row+1,col))count++;if(qrCode.isDark(row,col+1))count++;if(qrCode.isDark(row+1,col+1))count++;if(count==0||count==4){lostPoint+=3;}}}for(var row=0;row<moduleCount;row++){for(var col=0;col<moduleCount-6;col++){if(qrCode.isDark(row,col)&&!qrCode.isDark(row,col+1)&&qrCode.isDark(row,col+2)&&qrCode.isDark(row,col+3)&&qrCode.isDark(row,col+4)&&!qrCode.isDark(row,col+5)&&qrCode.isDark(row,col+6)){lostPoint+=40;}}}for(var col=0;col<moduleCount;col++){for(var row=0;row<moduleCount-6;row++){if(qrCode.isDark(row,col)&&!qrCode.isDark(row+1,col)&&qrCode.isDark(row+2,col)&&qrCode.isDark(row+3,col)&&qrCode.isDark(row+4,col)&&!qrCode.isDark(row+5,col)&&qrCode.isDark(row+6,col)){lostPoint+=40;}}}var darkCount=0;for(var col=0;col<moduleCount;col++){for(var row=0;row<moduleCount;row++){if(qrCode.isDark(row,col)){darkCount++;}}}var ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5;lostPoint+=ratio*10;return lostPoint;}};var QRMath={glog:function(n){if(n<1){throw new Error("glog("+n+")");}return QRMath.LOG_TABLE[n];},gexp:function(n){while(n<0){n+=255;}while(n>=256){n-=255;}return QRMath.EXP_TABLE[n];},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};for(var i=0;i<8;i++){QRMath.EXP_TABLE[i]=1<<i;}for(var i=8;i<256;i++){QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];}for(var i=0;i<255;i++){QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;}function QRPolynomial(num,shift){if(num.length==undefined){throw new Error(num.length+"/"+shift);}var offset=0;while(offset<num.length&&num[offset]==0){offset++;}this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++){this.num[i]=num[i+offset];}}QRPolynomial.prototype={get:function(index){return this.num[index];},getLength:function(){return this.num.length;},multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++){for(var j=0;j<e.getLength();j++){num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));}}return new QRPolynomial(num,0);},mod:function(e){if(this.getLength()-e.getLength()<0){return this;}var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++){num[i]=this.get(i);}for(var i=0;i<e.getLength();i++){num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);}return new QRPolynomial(num,0).mod(e);}};function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}QRRSBlock.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){var rsBlock=QRRSBlock.getRsBlockTable(typeNumber,errorCorrectLevel);if(rsBlock==undefined){throw new Error("bad rs block @ typeNumber:"+typeNumber+"/errorCorrectLevel:"+errorCorrectLevel);}var length=rsBlock.length/3;var list=[];for(var i=0;i<length;i++){var count=rsBlock[i*3+0];var totalCount=rsBlock[i*3+1];var dataCount=rsBlock[i*3+2];for(var j=0;j<count;j++){list.push(new QRRSBlock(totalCount,dataCount));}}return list;};QRRSBlock.getRsBlockTable=function(typeNumber,errorCorrectLevel){switch(errorCorrectLevel){case QRErrorCorrectLevel.L:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+0];case QRErrorCorrectLevel.M:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+1];case QRErrorCorrectLevel.Q:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+2];case QRErrorCorrectLevel.H:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+3];default:return undefined;}};function QRBitBuffer(){this.buffer=[];this.length=0;}QRBitBuffer.prototype={get:function(index){var bufIndex=Math.floor(index/8);return((this.buffer[bufIndex]>>>(7-index%8))&1)==1;},put:function(num,length){for(var i=0;i<length;i++){this.putBit(((num>>>(length-i-1))&1)==1);}},getLengthInBits:function(){return this.length;},putBit:function(bit){var bufIndex=Math.floor(this.length/8);if(this.buffer.length<=bufIndex){this.buffer.push(0);}if(bit){this.buffer[bufIndex]|=(0x80>>>(this.length%8));}this.length++;}};var QRCodeLimitLength=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]];
            function _isSupportCanvas(){return typeof CanvasRenderingContext2D!="undefined";}
            function _getTypeNumber(sText,nCorrectLevel){var nType=1;var length=_getUTF8Length(sText);for(var i=0,len=QRCodeLimitLength.length;i<=len;i++){var nLimit=0;switch(nCorrectLevel){case QRErrorCorrectLevel.L:nLimit=QRCodeLimitLength[i][0];break;case QRErrorCorrectLevel.M:nLimit=QRCodeLimitLength[i][1];break;case QRErrorCorrectLevel.Q:nLimit=QRCodeLimitLength[i][2];break;case QRErrorCorrectLevel.H:nLimit=QRCodeLimitLength[i][3];break;}if(length<=nLimit){break;}else{nType++;}}if(nType>QRCodeLimitLength.length){throw new Error("Too long data");}return nType;}
            function _getUTF8Length(sText){var replacedText=encodeURI(sText).toString().replace(/\%[0-9a-fA-F]{2}/g,'a');return replacedText.length+(replacedText.length!=sText?3:0);}
            QRCode=function(el,vOption){this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRErrorCorrectLevel.H};if(typeof vOption==='string'){vOption={text:vOption};}if(vOption){for(var i in vOption){this._htOption[i]=vOption[i];}}if(typeof el=="string"){el=document.getElementById(el);}if(this._htOption.useSVG){Drawing=svgDrawer;}this._el=el;this._oQRCode=null;this._oDrawing=new Drawing(this._el,this._htOption);if(this._htOption.text){this.makeCode(this._htOption.text);}};
            QRCode.prototype.makeCode=function(sText){this._oQRCode=new QRCodeModel(_getTypeNumber(sText,this._htOption.correctLevel),this._htOption.correctLevel);this._oQRCode.addData(sText);this._oQRCode.make();this._el.title=sText;this._oDrawing.draw(this._oQRCode);this.makeImage();};
            QRCode.prototype.makeImage=function(){if(typeof this._oDrawing.makeImage=="function"&&(!this._android||this._android>=3)){this._oDrawing.makeImage();}};
            QRCode.prototype.clear=function(){this._oDrawing.clear();};
            QRCode.CorrectLevel=QRErrorCorrectLevel;
            function Drawing(el,htOption){this._el=el;this._htOption=htOption;}
            Drawing.prototype.draw=function(oQRCode){var _htOption=this._htOption;var nCount=oQRCode.getModuleCount();var nWidth=Math.floor(_htOption.width/nCount);var nHeight=Math.floor(_htOption.height/nCount);this.clear();var aHTML=['<table style="border:0;border-collapse:collapse;">'];for(var row=0;row<nCount;row++){aHTML.push('<tr>');for(var col=0;col<nCount;col++){aHTML.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:'+nWidth+'px;height:'+nHeight+'px;background-color:'+(oQRCode.isDark(row,col)?_htOption.colorDark:_htOption.colorLight)+';"></td>');}aHTML.push('</tr>');}aHTML.push('</table>');this._el.innerHTML=aHTML.join('');var elTable=this._el.childNodes[0];var nLeftMarginTable=(_htOption.width-elTable.offsetWidth)/2;var nTopMarginTable=(_htOption.height-elTable.offsetHeight)/2;if(nLeftMarginTable>0&&nTopMarginTable>0){elTable.style.margin=nTopMarginTable+"px "+nLeftMarginTable+"px";}};
            Drawing.prototype.clear=function(){this._el.innerHTML='';};
        })();
        
        // TOTP implementation for authenticator apps
        class TOTP {
            static base32ToHex(base32) {
                const base32chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
                let bits = "";
                let hex = "";
                
                for(let i = 0; i < base32.length; i++) {
                    const val = base32chars.indexOf(base32.charAt(i).toUpperCase());
                    if(val === -1) continue;
                    bits += val.toString(2).padStart(5, '0');
                }
                
                for(let i = 0; i + 4 <= bits.length; i += 4) {
                    const chunk = bits.substr(i, 4);
                    hex += parseInt(chunk, 2).toString(16);
                }
                
                return hex;
            }
            
            static async generateTOTP(secret, timeStep = 30) {
                const hexSecret = TOTP.base32ToHex(secret);
                const counter = Math.floor(Date.now() / 1000 / timeStep);
                const counterHex = counter.toString(16).padStart(16, '0');
                
                // Convert hex to bytes
                const secretBytes = new Uint8Array(hexSecret.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                const counterBytes = new Uint8Array(counterHex.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                
                // Import key for HMAC
                const key = await crypto.subtle.importKey(
                    'raw',
                    secretBytes,
                    { name: 'HMAC', hash: 'SHA-1' },
                    false,
                    ['sign']
                );
                
                // Generate HMAC
                const signature = await crypto.subtle.sign('HMAC', key, counterBytes);
                const signatureArray = new Uint8Array(signature);
                
                // Dynamic truncation
                const offset = signatureArray[signatureArray.length - 1] & 0xf;
                const code = (
                    ((signatureArray[offset] & 0x7f) << 24) |
                    ((signatureArray[offset + 1] & 0xff) << 16) |
                    ((signatureArray[offset + 2] & 0xff) << 8) |
                    (signatureArray[offset + 3] & 0xff)
                ) % 1000000;
                
                return code.toString().padStart(6, '0');
            }
            
            static async verifyTOTP(secret, code, window = 1) {
                const currentCode = await TOTP.generateTOTP(secret);
                if(currentCode === code) return true;
                
                // Check previous and next time windows
                for(let i = 1; i <= window; i++) {
                    const prevCode = await TOTP.generateTOTP(secret, 30, -i);
                    const nextCode = await TOTP.generateTOTP(secret, 30, i);
                    if(prevCode === code || nextCode === code) return true;
                }
                
                return false;
            }
        }
        
        // QR Code wrapper (no external dependencies)
        const QRGenerator = {
            _renderIntoContainer(tempContainer, target) {
                const qrElement = tempContainer.querySelector('canvas, img, table');

                target.innerHTML = '';
                target.removeAttribute('title');

                if (qrElement) {
                    qrElement.removeAttribute('title');
                    target.appendChild(qrElement);
                }
            },

            generate: function(data, container, size = { width: 256, height: 256 }) {
                if (!container) return;

                const tempContainer = document.createElement('div');

                new QRCode(tempContainer, {
                    text: typeof data === 'object' ? JSON.stringify(data) : data,
                    width: size.width,
                    height: size.height,
                    correctLevel: QRCode.CorrectLevel.L
                });

                this._renderIntoContainer(tempContainer, container);
            },

            generateOTPAuth: function(secret, label, issuer, container) {
                if (!container) return;

                const uri = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(label)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}`;

                try {
                    const tempContainer = document.createElement('div');

                    new QRCode(tempContainer, {
                        text: uri,
                        width: 256,
                        height: 256,
                        correctLevel: QRCode.CorrectLevel.M
                    });

                    this._renderIntoContainer(tempContainer, container);
                } catch (e) {
                    console.error('TOTP QR generation failed:', e);
                }
            }
        };
    </script>

    <!-- Main Application Script -->
    <script>
        // Medication API Search Module
        const MedicationSearch = {
            searchTimeout: null,
            selectedIndex: -1,
            searchResults: [],
            
            async searchMedications(query, dropdown) {
                try {
                    // Using OpenFDA API - searching in the drug labels endpoint
                    const url = `https://api.fda.gov/drug/label.json?search=openfda.brand_name:"${query}"+OR+openfda.generic_name:"${query}"&limit=20`;
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            dropdown.innerHTML = '<div class="med-dropdown-item">No medications found - Type manually</div>';
                            return;
                        }
                        throw new Error('API request failed');
                    }
                    
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        this.displayResults(data.results, dropdown);
                    } else {
                        dropdown.innerHTML = '<div class="med-dropdown-item">No medications found - Type manually</div>';
                    }
                } catch (error) {
                    console.error('Error searching medications:', error);
                    
                    // Try a simpler search as fallback
                    try {
                        const fallbackUrl = `https://api.fda.gov/drug/label.json?search=${encodeURIComponent(query)}&limit=15`;
                        const fallbackResponse = await fetch(fallbackUrl);
                        
                        if (fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            if (fallbackData.results && fallbackData.results.length > 0) {
                                this.displayResults(fallbackData.results, dropdown);
                                return;
                            }
                        }
                    } catch (fallbackError) {
                        console.error('Fallback search also failed:', fallbackError);
                    }
                    
                    dropdown.innerHTML = '<div class="med-dropdown-item">Offline mode - Type medication manually</div>';
                }
            },
            
            displayResults(results, dropdown) {
                this.searchResults = [];
                dropdown.innerHTML = '';
                this.selectedIndex = -1;
                
                // Create a Set to avoid duplicates
                const seen = new Set();
                
                results.forEach((result) => {
                    if (result.openfda) {
                        const brandNames = result.openfda.brand_name || [];
                        const genericNames = result.openfda.generic_name || [];
                        const manufacturer = result.openfda.manufacturer_name ? result.openfda.manufacturer_name[0] : 'Unknown';
                        const routes = result.openfda.route || ['Oral'];
                        const dosageForms = result.openfda.dosage_form || ['Tablet'];
                        
                        // Process brand names
                        brandNames.forEach(brandName => {
                            const key = brandName.toLowerCase();
                            if (!seen.has(key)) {
                                seen.add(key);
                                const medication = {
                                    brandName: brandName,
                                    genericName: genericNames[0] || 'N/A',
                                    manufacturer: manufacturer,
                                    route: routes[0],
                                    dosageForm: dosageForms[0],
                                    isBrand: true
                                };
                                this.searchResults.push(medication);
                            }
                        });
                        
                        // Process generic names
                        genericNames.forEach(genericName => {
                            const key = genericName.toLowerCase();
                            if (!seen.has(key)) {
                                seen.add(key);
                                const medication = {
                                    brandName: brandNames[0] || genericName,
                                    genericName: genericName,
                                    manufacturer: manufacturer,
                                    route: routes[0],
                                    dosageForm: dosageForms[0],
                                    isBrand: false
                                };
                                this.searchResults.push(medication);
                            }
                        });
                    }
                });
                
                // Limit to 10 results for better UX
                this.searchResults = this.searchResults.slice(0, 10);
                
                this.searchResults.forEach((medication, index) => {
                    const item = document.createElement('div');
                    item.className = 'med-dropdown-item';
                    item.dataset.index = index;
                    
                    item.innerHTML = `
                        <div class="drug-name">
                            ${medication.brandName}
                        </div>
                        <div class="drug-details">
                            ${medication.genericName !== medication.brandName ? `Generic: ${medication.genericName}<br>` : ''}
                            ${medication.dosageForm} â€¢ ${medication.route}
                        </div>
                    `;
                    
                    dropdown.appendChild(item);
                });
                
                if (this.searchResults.length === 0) {
                    dropdown.innerHTML = '<div class="med-dropdown-item">No medications found - Type manually</div>';
                }
            }
        };
        
        // Application metadata
        const APP_VERSION = '2024.04.07.1200';
        const APP_LAST_UPDATED = '2024-04-07T12:00:00Z';
        const DEFAULT_SCHEMA_VERSION = '1.0.0';
        const VAULT_REGISTRY_STORAGE_KEY = 'healthVault.registry.v1';

        class FocusTrap {
            constructor(element) {
                this.element = element;
                this.focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
                this.handleKeyDown = this.handleKeyDown.bind(this);
                this.addedTabIndex = false;
            }

            getFocusableElements() {
                if (!(this.element instanceof HTMLElement)) {
                    return [];
                }

                return Array.from(this.element.querySelectorAll(this.focusableSelector)).filter((el) => {
                    if (!(el instanceof HTMLElement)) {
                        return false;
                    }

                    const isDisabled = el.hasAttribute('disabled') || el.getAttribute('aria-disabled') === 'true';
                    const isHidden = el.getAttribute('aria-hidden') === 'true' || (el.offsetParent === null && el.getClientRects().length === 0);
                    return !isDisabled && !isHidden;
                });
            }

            activate() {
                if (!(this.element instanceof HTMLElement)) {
                    return;
                }

                const focusable = this.getFocusableElements();
                this.firstFocusableElement = focusable[0] || this.element;
                this.lastFocusableElement = focusable[focusable.length - 1] || this.element;

                this.element.addEventListener('keydown', this.handleKeyDown);

                const initialTarget = focusable[0] || this.element;
                if (initialTarget && typeof initialTarget.focus === 'function') {
                    if (initialTarget === this.element && !this.element.hasAttribute('tabindex')) {
                        this.element.setAttribute('tabindex', '-1');
                        this.addedTabIndex = true;
                    } else {
                        this.addedTabIndex = false;
                    }
                    initialTarget.focus();
                }
            }

            deactivate() {
                if (!(this.element instanceof HTMLElement)) {
                    return;
                }

                this.element.removeEventListener('keydown', this.handleKeyDown);

                if (this.addedTabIndex) {
                    this.element.removeAttribute('tabindex');
                    this.addedTabIndex = false;
                }
            }

            handleKeyDown(event) {
                if (event.key !== 'Tab') {
                    return;
                }

                const focusable = this.getFocusableElements();
                if (!focusable.length) {
                    event.preventDefault();
                    if (this.element instanceof HTMLElement) {
                        this.element.focus();
                    }
                    return;
                }

                const first = focusable[0];
                const last = focusable[focusable.length - 1];

                if (event.shiftKey) {
                    if (document.activeElement === first || !focusable.includes(document.activeElement)) {
                        last.focus();
                        event.preventDefault();
                    }
                } else if (document.activeElement === last) {
                    first.focus();
                    event.preventDefault();
                }
            }
        }

        const modalAccessibility = {
            traps: new Map(),
            previousFocus: new Map()
        };

        const modalObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                const modal = mutation.target;
                if (!(modal instanceof HTMLElement)) {
                    return;
                }

                if (modal.classList.contains('active')) {
                    activateModalAccessibility(modal);
                } else {
                    deactivateModalAccessibility(modal);
                }
            });
        });

        function activateModalAccessibility(modal) {
            if (!(modal instanceof HTMLElement)) {
                return;
            }

            modal.setAttribute('aria-hidden', 'false');

            let trap = modalAccessibility.traps.get(modal);
            if (!trap) {
                trap = new FocusTrap(modal);
                modalAccessibility.traps.set(modal, trap);
            }

            const activeElement = document.activeElement;
            if (activeElement instanceof HTMLElement && !modal.contains(activeElement)) {
                modalAccessibility.previousFocus.set(modal, activeElement);
            }

            trap.activate();
        }

        function deactivateModalAccessibility(modal) {
            if (!(modal instanceof HTMLElement)) {
                return;
            }

            modal.setAttribute('aria-hidden', 'true');

            const trap = modalAccessibility.traps.get(modal);
            if (trap) {
                trap.deactivate();
            }

            const previous = modalAccessibility.previousFocus.get(modal);
            if (previous && typeof previous.focus === 'function') {
                previous.focus();
            }

            modalAccessibility.previousFocus.delete(modal);
        }

        function setupModalAccessibility() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach((modal) => {
                if (!(modal instanceof HTMLElement)) {
                    return;
                }

                if (!modal.hasAttribute('aria-hidden')) {
                    modal.setAttribute('aria-hidden', modal.classList.contains('active') ? 'false' : 'true');
                }

                if (!modal.dataset.a11yObserved) {
                    modalObserver.observe(modal, { attributes: true, attributeFilter: ['class'] });
                    modal.dataset.a11yObserved = 'true';
                }
            });
        }

        class AccessibilityManager {
            constructor() {
                this.fontScale = 100;
                this.settings = {
                    highContrast: false,
                    reducedMotion: false,
                    enhancedFocus: true,
                    underlineLinks: false
                };
                this.hasPersistedSettings = false;
                this.handleDocumentClick = this.handleDocumentClick.bind(this);
                this.handleDocumentKeydown = this.handleDocumentKeydown.bind(this);
                this.init();
            }

            init() {
                this.loadSettings();
                this.setupEventListeners();
                this.applySettings();
                this.updateFontSize();
                this.checkSystemPreferences();
            }

            setupEventListeners() {
                const toggle = document.getElementById('a11yToggle');
                const panel = document.getElementById('a11yPanel');

                if (toggle && panel) {
                    toggle.addEventListener('click', () => {
                        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                        const nextState = !isExpanded;
                        toggle.setAttribute('aria-expanded', String(nextState));
                        panel.hidden = !nextState;

                        if (!nextState) {
                            panel.setAttribute('aria-hidden', 'true');
                        } else {
                            panel.removeAttribute('aria-hidden');
                        }
                    });
                }

                const increaseBtn = document.getElementById('fontIncrease');
                const decreaseBtn = document.getElementById('fontDecrease');
                const resetBtn = document.getElementById('fontReset');

                increaseBtn?.addEventListener('click', (event) => {
                    event.preventDefault();
                    this.changeFontSize(10);
                });

                decreaseBtn?.addEventListener('click', (event) => {
                    event.preventDefault();
                    this.changeFontSize(-10);
                });

                resetBtn?.addEventListener('click', (event) => {
                    event.preventDefault();
                    this.resetFontSize();
                });

                document.getElementById('highContrastToggle')?.addEventListener('change', (event) => {
                    const target = event.target;
                    if (!(target instanceof HTMLInputElement)) {
                        return;
                    }
                    this.settings.highContrast = target.checked;
                    this.applySettings();
                    this.saveSettings();
                });

                document.getElementById('reducedMotionToggle')?.addEventListener('change', (event) => {
                    const target = event.target;
                    if (!(target instanceof HTMLInputElement)) {
                        return;
                    }
                    this.settings.reducedMotion = target.checked;
                    this.applySettings();
                    this.saveSettings();
                });

                document.getElementById('focusIndicatorsToggle')?.addEventListener('change', (event) => {
                    const target = event.target;
                    if (!(target instanceof HTMLInputElement)) {
                        return;
                    }
                    this.settings.enhancedFocus = target.checked;
                    this.applySettings();
                    this.saveSettings();
                });

                document.getElementById('linkUnderlineToggle')?.addEventListener('change', (event) => {
                    const target = event.target;
                    if (!(target instanceof HTMLInputElement)) {
                        return;
                    }
                    this.settings.underlineLinks = target.checked;
                    this.applySettings();
                    this.saveSettings();
                });

                document.addEventListener('click', this.handleDocumentClick);
                document.addEventListener('keydown', this.handleDocumentKeydown);
            }

            handleDocumentClick(event) {
                const controls = document.getElementById('a11yControls');
                const panel = document.getElementById('a11yPanel');
                const toggle = document.getElementById('a11yToggle');

                if (!controls || !panel || !toggle || panel.hidden) {
                    return;
                }

                if (controls.contains(event.target)) {
                    return;
                }

                panel.hidden = true;
                toggle.setAttribute('aria-expanded', 'false');
                panel.setAttribute('aria-hidden', 'true');
            }

            handleDocumentKeydown(event) {
                if (event.key !== 'Escape') {
                    return;
                }

                const panel = document.getElementById('a11yPanel');
                const toggle = document.getElementById('a11yToggle');

                if (panel && toggle && !panel.hidden) {
                    panel.hidden = true;
                    panel.setAttribute('aria-hidden', 'true');
                    toggle.setAttribute('aria-expanded', 'false');
                    toggle.focus();
                }
            }

            changeFontSize(delta) {
                const newScale = Math.max(80, Math.min(150, this.fontScale + delta));
                if (newScale === this.fontScale) {
                    return;
                }

                this.fontScale = newScale;
                this.updateFontSize();
                this.saveSettings();
                this.announceChange(`Font size ${this.fontScale}%`);
            }

            resetFontSize() {
                this.fontScale = 100;
                this.updateFontSize();
                this.saveSettings();
                this.announceChange('Font size reset to 100%');
            }

            updateFontSize() {
                const html = document.documentElement;
                const existingScaleClasses = Array.from(html.classList).filter((cls) => cls.startsWith('font-scale-'));
                existingScaleClasses.forEach((cls) => html.classList.remove(cls));

                html.classList.add(`font-scale-${this.fontScale}`);

                const display = document.getElementById('fontSizeDisplay');
                if (display) {
                    display.textContent = `${this.fontScale}%`;
                }
            }

            applySettings() {
                const html = document.documentElement;

                html.classList.toggle('high-contrast', this.settings.highContrast);
                html.classList.toggle('reduced-motion', this.settings.reducedMotion);
                html.classList.toggle('enhanced-focus', this.settings.enhancedFocus);
                html.classList.toggle('underline-links', this.settings.underlineLinks);

                const highContrastToggle = document.getElementById('highContrastToggle');
                const reducedMotionToggle = document.getElementById('reducedMotionToggle');
                const focusToggle = document.getElementById('focusIndicatorsToggle');
                const linkToggle = document.getElementById('linkUnderlineToggle');

                if (highContrastToggle instanceof HTMLInputElement) {
                    highContrastToggle.checked = this.settings.highContrast;
                }
                if (reducedMotionToggle instanceof HTMLInputElement) {
                    reducedMotionToggle.checked = this.settings.reducedMotion;
                }
                if (focusToggle instanceof HTMLInputElement) {
                    focusToggle.checked = this.settings.enhancedFocus;
                }
                if (linkToggle instanceof HTMLInputElement) {
                    linkToggle.checked = this.settings.underlineLinks;
                }
            }

            checkSystemPreferences() {
                if (typeof window === 'undefined' || typeof window.matchMedia !== 'function') {
                    return;
                }

                const reducedMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
                const contrastQuery = window.matchMedia('(prefers-contrast: high)');

                if (!this.hasPersistedSettings && reducedMotionQuery.matches) {
                    this.settings.reducedMotion = true;
                    this.applySettings();
                }

                if (!this.hasPersistedSettings && contrastQuery.matches) {
                    this.settings.highContrast = true;
                    this.applySettings();
                }

                const reducedMotionListener = (event) => {
                    if (!this.hasPersistedSettings) {
                        this.settings.reducedMotion = event.matches;
                        this.applySettings();
                    }
                };

                const contrastListener = (event) => {
                    if (!this.hasPersistedSettings) {
                        this.settings.highContrast = event.matches;
                        this.applySettings();
                    }
                };

                if (typeof reducedMotionQuery.addEventListener === 'function') {
                    reducedMotionQuery.addEventListener('change', reducedMotionListener);
                } else if (typeof reducedMotionQuery.addListener === 'function') {
                    reducedMotionQuery.addListener(reducedMotionListener);
                }

                if (typeof contrastQuery.addEventListener === 'function') {
                    contrastQuery.addEventListener('change', contrastListener);
                } else if (typeof contrastQuery.addListener === 'function') {
                    contrastQuery.addListener(contrastListener);
                }
            }

            saveSettings() {
                const data = {
                    fontScale: this.fontScale,
                    settings: this.settings
                };

                try {
                    localStorage.setItem('a11y-settings', JSON.stringify(data));
                    this.hasPersistedSettings = true;
                } catch (error) {
                    console.warn('Could not save accessibility settings', error);
                }
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem('a11y-settings');
                    if (!saved) {
                        return;
                    }

                    const data = JSON.parse(saved);
                    if (data && typeof data === 'object') {
                        if (typeof data.fontScale === 'number') {
                            this.fontScale = data.fontScale;
                        }
                        if (data.settings && typeof data.settings === 'object') {
                            this.settings = { ...this.settings, ...data.settings };
                        }
                        this.hasPersistedSettings = true;
                    }
                } catch (error) {
                    console.warn('Could not load accessibility settings', error);
                }
            }

            announceChange(message) {
                let liveRegion = document.getElementById('a11y-live-region');
                if (!liveRegion) {
                    liveRegion = document.createElement('div');
                    liveRegion.id = 'a11y-live-region';
                    liveRegion.className = 'sr-only';
                    liveRegion.setAttribute('aria-live', 'polite');
                    liveRegion.setAttribute('aria-atomic', 'true');
                    document.body.appendChild(liveRegion);
                }

                liveRegion.textContent = message;

                window.setTimeout(() => {
                    liveRegion.textContent = '';
                }, 1000);
            }
        }

        function announce(message, priority = 'polite') {
            const regionId = priority === 'assertive' ? 'alert-announcements' : 'status-announcements';
            const region = document.getElementById(regionId);
            if (!region) {
                return;
            }

            region.textContent = '';
            window.setTimeout(() => {
                region.textContent = message;
            }, 100);
        }

        function initializeGlobalAccessibility() {
            if (typeof window === 'undefined') {
                return;
            }

            setupModalAccessibility();

            if (!window.a11yManager || !(window.a11yManager instanceof AccessibilityManager)) {
                window.a11yManager = new AccessibilityManager();
            } else {
                window.a11yManager.applySettings();
                window.a11yManager.updateFontSize();
            }
        }

        if (typeof document !== 'undefined') {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeGlobalAccessibility);
            } else {
                initializeGlobalAccessibility();
            }
        }

        class LocalizationManager {
            constructor() {
                this.translations = {};
                this.availableLanguages = [];
                this.languageSelectors = [];
                this.currentLanguage = 'en';
                this.fallbackLanguage = 'en';
                this.allowedLanguages = ['en', 'es'];
            }

            async init() {
                await this.loadTranslations();
                this.languageSelectors = Array.from(document.querySelectorAll('[data-language-selector]'));
                if (!this.availableLanguages.includes(this.currentLanguage)) {
                    this.currentLanguage = this.fallbackLanguage;
                }
                this.populateSelectors();
                this.applyTranslations();

                this.languageSelectors.forEach(select => {
                    select.addEventListener('change', event => {
                        this.setLanguage(event.target.value, { persist: true });
                    });
                });
            }

            async loadTranslations() {
                try {
                    const response = await fetch('translations.json', { cache: 'no-store' });
                    if (!response.ok) {
                        throw new Error(`Failed to load translations: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data && typeof data === 'object') {
                        this.translations = this.transformTranslations(data);
                    }
                } catch (error) {
                    console.error('[Localization] Unable to load translations.json', error);
                    this.translations = { en: {} };
                }

                if (!this.translations || typeof this.translations !== 'object') {
                    this.translations = { en: {} };
                }

                if (Array.isArray(this.allowedLanguages) && this.allowedLanguages.length) {
                    this.translations = Object.fromEntries(
                        Object.entries(this.translations)
                            .filter(([lang]) => this.allowedLanguages.includes(lang))
                    );
                }

                if (!this.translations.en) {
                    this.translations.en = {};
                }

                this.availableLanguages = Object.keys(this.translations);
                if (this.availableLanguages.length === 0) {
                    this.availableLanguages = ['en'];
                }

                this.fallbackLanguage = this.translations.en ? 'en' : this.availableLanguages[0];

                const stored = this.safeGet('preferredLanguage');
                const browser = this.detectBrowserLanguage();
                const defaultLang = this.availableLanguages.includes(stored)
                    ? stored
                    : (browser && this.availableLanguages.includes(browser) ? browser : this.fallbackLanguage);

                this.currentLanguage = defaultLang;
                document.documentElement.setAttribute('lang', this.currentLanguage);
                this.safeSet('preferredLanguage', this.currentLanguage);
            }

            populateSelectors() {
                if (!this.languageSelectors.length) {
                    return;
                }

                let collator;
                try {
                    collator = new Intl.Collator(this.currentLanguage, { sensitivity: 'base' });
                } catch (error) {
                    collator = new Intl.Collator('en', { sensitivity: 'base' });
                }

                const sortedLanguages = [...this.availableLanguages].sort((a, b) =>
                    collator.compare(this.getLanguageName(a), this.getLanguageName(b))
                );

                const optionsHtml = sortedLanguages
                    .map(code => `<option value="${code}">${this.getLanguageName(code)}</option>`)
                    .join('');

                this.languageSelectors.forEach(select => {
                    const previous = select.value;
                    select.innerHTML = optionsHtml;
                    select.value = this.availableLanguages.includes(previous) ? previous : this.currentLanguage;
                });
            }

            transformTranslations(raw) {
                if (!raw || typeof raw !== 'object' || Array.isArray(raw)) {
                    return { en: {} };
                }

                const allowedLanguageSet = Array.isArray(this.allowedLanguages) && this.allowedLanguages.length
                    ? new Set(this.allowedLanguages)
                    : null;

                if (raw.en && typeof raw.en === 'object' && !Array.isArray(raw.en)) {
                    if (!allowedLanguageSet) {
                        return raw;
                    }
                    const filtered = {};
                    const languages = Object.keys(raw).filter(lang => allowedLanguageSet.has(lang));
                    if (!languages.length) {
                        return { en: raw.en };
                    }
                    languages.forEach(lang => {
                        filtered[lang] = raw[lang] || {};
                    });
                    if (!filtered.en) {
                        filtered.en = {};
                    }
                    return filtered;
                }

                const languageKeyPattern = /^[a-z]{2,3}(?:-[A-Za-z]{2,4})?$/;
                const languageSet = new Set();

                const collectLanguages = (node) => {
                    if (!node || typeof node !== 'object' || Array.isArray(node)) {
                        return;
                    }
                    const keys = Object.keys(node);
                    if (!keys.length) {
                        return;
                    }
                    const isLanguageMap = keys.every(key => languageKeyPattern.test(key))
                        && Object.values(node).every(value => typeof value === 'string' || typeof value === 'number' || value === null);
                    if (isLanguageMap) {
                        keys.forEach(key => languageSet.add(key));
                        return;
                    }
                    keys.forEach(key => collectLanguages(node[key]));
                };

                collectLanguages(raw);

                if (!languageSet.size) {
                    return { en: {} };
                }

                const filteredLanguages = allowedLanguageSet
                    ? Array.from(languageSet).filter(lang => allowedLanguageSet.has(lang))
                    : Array.from(languageSet);

                if (!filteredLanguages.length) {
                    return { en: {} };
                }

                const filteredLanguageSet = new Set(filteredLanguages);
                const result = {};
                filteredLanguages.forEach(lang => {
                    result[lang] = {};
                });

                const assignTranslations = (node, path = []) => {
                    if (!node || typeof node !== 'object' || Array.isArray(node)) {
                        return;
                    }
                    const keys = Object.keys(node);
                    if (!keys.length) {
                        return;
                    }
                    const isLanguageMap = keys.every(key => languageSet.has(key))
                        && Object.values(node).every(value => typeof value === 'string' || typeof value === 'number' || value === null);
                    if (isLanguageMap) {
                        const translationKey = path[path.length - 1];
                        if (!translationKey) {
                            return;
                        }
                        keys
                            .filter(lang => filteredLanguageSet.has(lang))
                            .forEach(lang => {
                                if (!result[lang]) {
                                    result[lang] = {};
                                }
                                result[lang][translationKey] = node[lang];
                            });
                        return;
                    }
                    keys.forEach(key => assignTranslations(node[key], [...path, key]));
                };

                assignTranslations(raw);

                return result;
            }

            detectBrowserLanguage() {
                const languages = Array.isArray(navigator.languages) && navigator.languages.length
                    ? navigator.languages
                    : [navigator.language];
                if (!languages) {
                    return null;
                }
                const normalized = languages
                    .map(code => (code || '').toLowerCase())
                    .map(code => code.split('-')[0]);
                return normalized.find(code => this.availableLanguages.includes(code)) || null;
            }

            getLanguageName(code) {
                const lookup = {
                    ar: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                    en: 'English',
                    es: 'EspaÃ±ol',
                    fil: 'Filipino',
                    fr: 'FranÃ§ais',
                    ht: 'KreyÃ²l Ayisyen',
                    kmr: 'KurdÃ®',
                    ko: 'í•œêµ­ì–´',
                    my: 'á€™á€¼á€”á€ºá€™á€¬',
                    'pt-BR': 'PortuguÃªs (Brasil)',
                    ru: 'Ð ÑƒÑÑÐºÐ¸Ð¹',
                    so: 'Soomaaliga',
                    vi: 'Tiáº¿ng Viá»‡t',
                    'zh-Hans': 'ç®€ä½“ä¸­æ–‡',
                };

                if (lookup[code]) {
                    return lookup[code];
                }

                try {
                    const display = new Intl.DisplayNames([this.currentLanguage, 'en'], { type: 'language' });
                    return display.of(code) || code;
                } catch (error) {
                    return code;
                }
            }

            setLanguage(language, { persist = true } = {}) {
                if (!this.translations[language]) {
                    language = this.fallbackLanguage;
                }

                this.currentLanguage = language;
                document.documentElement.setAttribute('lang', language);

                if (persist) {
                    this.safeSet('preferredLanguage', language);
                }

                this.updateSelectors();
                this.applyTranslations();
            }

            updateSelectors() {
                if (!this.languageSelectors.length) {
                    return;
                }

                this.languageSelectors.forEach(select => {
                    if (select.value !== this.currentLanguage) {
                        select.value = this.currentLanguage;
                    }
                });
            }

            applyTranslations() {
                const active = this.translations[this.currentLanguage] || {};
                const fallback = this.translations[this.fallbackLanguage] || {};

                document.querySelectorAll('[data-i18n-key]').forEach(element => {
                    const key = element.getAttribute('data-i18n-key');
                    if (!key) {
                        return;
                    }
                    const prefix = element.dataset.i18nPrefix || '';
                    const suffix = element.dataset.i18nSuffix || '';
                    const translation = active[key] ?? fallback[key];
                    if (translation === undefined) {
                        return;
                    }
                    if (element.dataset.i18nHtml === 'true') {
                        element.innerHTML = `${prefix}${translation}${suffix}`;
                    } else {
                        element.textContent = `${prefix}${translation}${suffix}`;
                    }
                });

                document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    if (!key) {
                        return;
                    }
                    const translation = active[key] ?? fallback[key];
                    if (translation !== undefined) {
                        element.setAttribute('placeholder', translation);
                    }
                });

                document.title = this.t('app_title', document.title);

                if (window.offlineBundleManager?.refresh) {
                    window.offlineBundleManager.refresh();
                }
            }

            t(key, fallback) {
                if (!key) {
                    return fallback ?? '';
                }
                return this.translations[this.currentLanguage]?.[key]
                    ?? this.translations[this.fallbackLanguage]?.[key]
                    ?? fallback
                    ?? key;
            }

            safeGet(key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('[Localization] Unable to read localStorage', error);
                    return null;
                }
            }

            safeSet(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (error) {
                    console.warn('[Localization] Unable to persist preference', error);
                }
            }
        }

        if (typeof window !== 'undefined') {
            window.translate = function translate(key, fallback) {
                const localization = window.localization;
                if (localization && typeof localization.t === 'function') {
                    return localization.t(key, fallback);
                }
                return fallback ?? key;
            };
        }

        class SchemaManager {
            constructor(currentVersion, migrations = []) {
                this.currentVersion = this.normalizeVersion(currentVersion);
                this.migrations = Array.isArray(migrations) ? migrations.slice() : [];
            }

            normalizeVersion(version) {
                if (!version && version !== 0) {
                    return DEFAULT_SCHEMA_VERSION;
                }

                const raw = String(version).trim();
                if (!raw) {
                    return DEFAULT_SCHEMA_VERSION;
                }

                const parts = raw.split('.').map(part => {
                    const parsed = parseInt(part, 10);
                    return Number.isNaN(parsed) ? 0 : parsed;
                });

                while (parts.length < 3) {
                    parts.push(0);
                }

                return parts.slice(0, 3).join('.');
            }

            compareVersions(a, b) {
                const aParts = this.normalizeVersion(a).split('.').map(num => parseInt(num, 10));
                const bParts = this.normalizeVersion(b).split('.').map(num => parseInt(num, 10));

                for (let i = 0; i < Math.max(aParts.length, bParts.length); i += 1) {
                    const aVal = aParts[i] ?? 0;
                    const bVal = bParts[i] ?? 0;

                    if (aVal > bVal) {
                        return 1;
                    }

                    if (aVal < bVal) {
                        return -1;
                    }
                }

                return 0;
            }

            migrate(data = {}, startingVersion) {
                const initialVersion = this.normalizeVersion(startingVersion || data.schemaVersion || data.__schemaVersion);
                let workingData = { ...data };
                let versionPointer = initialVersion;
                const appliedMigrations = [];
                const visited = new Set();

                if (this.compareVersions(versionPointer, this.currentVersion) > 0) {
                    return {
                        data: workingData,
                        version: versionPointer,
                        appliedMigrations,
                        needsResave: false,
                        newerThanApp: true
                    };
                }

                while (this.compareVersions(versionPointer, this.currentVersion) < 0) {
                    if (visited.has(versionPointer)) {
                        break;
                    }

                    const migration = this.migrations.find(step => this.normalizeVersion(step.from) === versionPointer);

                    if (!migration) {
                        break;
                    }

                    visited.add(versionPointer);
                    const migrated = typeof migration.migrate === 'function'
                        ? migration.migrate({ ...workingData })
                        : workingData;

                    workingData = { ...migrated };
                    const targetVersion = this.normalizeVersion(migration.to || this.currentVersion);

                    appliedMigrations.push({
                        from: versionPointer,
                        to: targetVersion,
                        description: migration.description || ''
                    });

                    versionPointer = targetVersion;
                }

                const isCurrent = this.compareVersions(versionPointer, this.currentVersion) === 0;
                const needsResave = appliedMigrations.length > 0 || !isCurrent;
                const resolvedVersion = isCurrent ? this.currentVersion : versionPointer;

                workingData.schemaVersion = resolvedVersion;

                return {
                    data: workingData,
                    version: resolvedVersion,
                    appliedMigrations,
                    needsResave,
                    newerThanApp: false
                };
            }
        }

        const schemaManager = new SchemaManager('2.0.0', [
            {
                from: '1.0.0',
                to: '2.0.0',
                description: 'Normalize chosen name and pronoun fields.',
                migrate(payload) {
                    const next = { ...payload };

                    if (next.preferredName && !next.chosenName) {
                        next.chosenName = next.preferredName;
                    }

                    if (next.preferredPronouns && !next.pronouns) {
                        next.pronouns = next.preferredPronouns;
                    }

                    return next;
                }
            }
        ]);

        class FieldRegistry {
            constructor(definitions = []) {
                this.definitions = new Map();
                this.aliasIndex = new Map();

                definitions.forEach(definition => this.register(definition));
            }

            register(definition) {
                if (!definition || !definition.key) {
                    return;
                }

                const canonical = definition.key;
                const aliases = Array.isArray(definition.aliases) ? definition.aliases : [];

                this.definitions.set(canonical, {
                    key: canonical,
                    label: definition.label || '',
                    type: definition.type || 'text',
                    aliases: Array.from(new Set(aliases))
                });

                this.aliasIndex.set(canonical, canonical);
                aliases.forEach(alias => this.aliasIndex.set(alias, canonical));
            }

            resolve(field) {
                if (!field) {
                    return field;
                }

                return this.aliasIndex.get(field) || field;
            }

            getAllKeys(field) {
                const canonical = this.resolve(field);
                const definition = this.definitions.get(canonical);

                if (!definition) {
                    return [field];
                }

                return [canonical, ...definition.aliases];
            }

            assignValue(target, field, value) {
                if (!target || !field) {
                    return;
                }

                const canonical = this.resolve(field);
                target[canonical] = value;
            }

            getValue(source, field) {
                if (!source || typeof source !== 'object' || !field) {
                    return undefined;
                }

                if (Object.prototype.hasOwnProperty.call(source, field)) {
                    return source[field];
                }

                const canonical = this.resolve(field);

                if (Object.prototype.hasOwnProperty.call(source, canonical)) {
                    return source[canonical];
                }

                const definition = this.definitions.get(canonical);

                if (!definition) {
                    return undefined;
                }

                for (const alias of definition.aliases) {
                    if (Object.prototype.hasOwnProperty.call(source, alias)) {
                        return source[alias];
                    }
                }

                return undefined;
            }

            normalizeIncomingData(source) {
                if (!source || typeof source !== 'object') {
                    return {};
                }

                const normalized = { ...source };

                for (const [alias, canonical] of this.aliasIndex.entries()) {
                    if (alias === canonical) {
                        continue;
                    }

                    if (Object.prototype.hasOwnProperty.call(source, alias)
                        && !Object.prototype.hasOwnProperty.call(normalized, canonical)) {
                        normalized[canonical] = source[alias];
                    }
                }

                return normalized;
            }
        }

        const fieldRegistry = new FieldRegistry([
            { key: 'firstName', label: 'First Name', aliases: ['givenName'] },
            { key: 'lastName', label: 'Last Name', aliases: ['surname'] },
            { key: 'middleInitial', label: 'Middle Initial', aliases: ['middleNameInitial'] },
            { key: 'chosenName', label: 'Chosen Name', aliases: ['preferredName'] },
            { key: 'pronouns', label: 'Pronouns', aliases: ['preferredPronouns'] },
            { key: 'profilePhoto', label: 'Profile Photo' },
            { key: 'mrn', label: 'Medical Record Number' },
            { key: 'biologicalSex', label: 'Biological Sex', aliases: ['sexAtBirth'] },
            { key: 'dateOfBirth', label: 'Date of Birth', aliases: ['dob'] },
            { key: 'bloodType', label: 'Blood Type' },
            { key: 'criticalAllergies', label: 'Critical Allergies' },
            { key: 'criticalConditions', label: 'Critical Conditions' },
            { key: 'advanceDirective', label: 'Advance Directive' },
            { key: 'medicationContraindications', label: 'Medication Contraindications' },
            { key: 'emergencyAccessEnabled', label: 'Emergency Access Enabled', aliases: ['enableEmergencyAccess'] }
        ]);

        // NOTE: Update APP_VERSION and APP_LAST_UPDATED to match the latest deployment timestamp whenever changes are pushed.

        // Main Application Class
        class HealthVaultApp {
            constructor() {
                // Vault identity word lists - expanded for 1M+ combinations
                this.adjectives = [
                    'gentle', 'crystal', 'golden', 'silver', 'cosmic', 'serene',
                    'mystic', 'eternal', 'tranquil', 'radiant', 'peaceful', 'stellar',
                    'azure', 'crimson', 'emerald', 'violet', 'ancient', 'sacred',
                    'bright', 'calm', 'noble', 'pure', 'wise', 'brave',
                    'swift', 'clear', 'grand', 'royal', 'proud', 'bold',
                    'vivid', 'prime', 'keen', 'fair', 'true', 'warm',
                    'amber', 'jade', 'ruby', 'pearl', 'opal', 'coral',
                    'lunar', 'solar', 'astral', 'primal', 'vital', 'nexus',
                    'alpha', 'omega', 'zenith', 'vertex', 'apex', 'prime',
                    'quantum', 'cyber', 'echo', 'nova', 'flux', 'spark'
                ];
                
                this.nouns = [
                    'mountain', 'ocean', 'forest', 'valley', 'sunrise', 'cascade', 
                    'meadow', 'horizon', 'sanctuary', 'constellation', 'lighthouse', 'glacier',
                    'phoenix', 'compass', 'harbor', 'garden', 'bridge', 'fountain',
                    'river', 'summit', 'canyon', 'prairie', 'tundra', 'reef',
                    'temple', 'citadel', 'beacon', 'atlas', 'nexus', 'prism',
                    'shield', 'guardian', 'sentinel', 'keeper', 'watcher', 'guide',
                    'storm', 'thunder', 'lightning', 'aurora', 'comet', 'nebula',
                    'spirit', 'essence', 'cipher', 'enigma', 'oracle', 'rune',
                    'dragon', 'griffin', 'falcon', 'eagle', 'wolf', 'lion',
                    'crystal', 'diamond', 'sapphire', 'element', 'force', 'wave'
                ];
                
                // Generate initial vault identity
                this.vaultIdentity = this.generateVaultName();
                
                // Check for embedded data
                this.checkInitialization();
                
                // Initialize state
                this.hasUnsavedChanges = false;
                this.sessionPassword = null;
                this.currentTOTPSecret = null;
                this.totpSetupContext = null;
                this.requires2FA = false;
                this.temporaryAccess = null;
                this.recoveryAccess = null;
                this.pendingTemporaryAccessRemoval = false;
                this.isLocked = false;
                this.modules = {
                    identity: false,
                    gac: false,
                    mental: false,
                    chronic: false
                };
                this.noteTags = [];
                this.sectionLocks = {};
                this.emergencyAccessConfig = null;
                this.schemaVersion = schemaManager.currentVersion;
                this.pendingSchemaNotice = null;
                this.attachments = [];
                this.currentPreviewAttachmentId = null;
                this.activePreviewObjectUrl = null;

                this.commonPasswords = [
                    'password', 'Password1', 'password123', '12345678', '123456789',
                    'qwerty', 'abc123', 'letmein', 'welcome', 'iloveyou',
                    'monkey', 'dragon', 'baseball', 'football', 'shadow'
                ];
                this.hasBenchmarkedKDF = false;
                
                this.lockTimeoutMs = 45 * 60 * 1000;
                this.lockTimerInterval = null;
                this.lockTimerExpiresAt = null;
                this._lastActivityUpdate = 0;
                this._lockTimeoutHandled = false;

                // Application version metadata
                this.version = APP_VERSION;
                this.lastUpdated = APP_LAST_UPDATED;
                this.applyVersionMetadata();

                // Initialize
                this.init();
                this.updateLockTimerDisplay();
                this.scheduleKDFBenchmark();
            }
            
            generateVaultName() {
                const adj = this.adjectives[Math.floor(Math.random() * this.adjectives.length)];
                const noun = this.nouns[Math.floor(Math.random() * this.nouns.length)];
                const num = Math.floor(Math.random() * 1000);
                return `${adj}-${noun}-${num}`;
            }
            
            checkInitialization() {
                const embeddedData = document.getElementById('embedded-vault-data');
                const dataContent = embeddedData?.textContent?.trim();

                const emergencyBanner = document.getElementById('emergencyAccessBanner');
                const emergencyDisplay = document.getElementById('emergencyDataDisplay');

                if (emergencyBanner) {
                    emergencyBanner.style.display = 'none';
                }

                if (emergencyDisplay) {
                    emergencyDisplay.innerHTML = '';
                }

                if (dataContent && dataContent !== '') {
                    try {
                        let vaultData = JSON.parse(dataContent);

                        if (vaultData.compressed && vaultData.data) {
                            const pakoInstance = this.getCompressionLibrary();

                            if (pakoInstance && typeof pakoInstance.inflate === 'function') {
                                try {
                                    const binary = atob(vaultData.data);
                                    const bytes = new Uint8Array(binary.length);
                                    for (let i = 0; i < binary.length; i++) {
                                        bytes[i] = binary.charCodeAt(i);
                                    }

                                    const decompressed = pakoInstance.inflate(bytes, { to: 'string' });
                                    vaultData = JSON.parse(decompressed);
                                } catch (error) {
                                    console.error('Failed to decompress vault data', error);
                                    throw new Error('Unable to decompress vault file. File may be corrupted.');
                                }
                            } else {
                                throw new Error('Compression library not available. Cannot open compressed vault.');
                            }
                        }
                        this.isInitialized = vaultData.initialized;
                        this.encryptedData = vaultData.data;
                        this.savedModules = vaultData.modules;
                        this.requires2FA = vaultData.requires2FA || false;
                        this.vaultIdentity = vaultData.vaultIdentity;
                        this.lastSaved = vaultData.savedDate;
                        this.emergencyAccessConfig = vaultData.emergencyAccess || null;
                        this.temporaryAccess = vaultData.temporaryAccess || null;
                        this.recoveryAccess = vaultData.recoveryAccess || null;
                        this.pendingTemporaryAccessRemoval = false;
                        this.version = vaultData.appVersion || this.version || APP_VERSION;

                        const embeddedSchemaVersion = vaultData.schemaVersion || vaultData.version;
                        if (embeddedSchemaVersion) {
                            this.schemaVersion = schemaManager.normalizeVersion(embeddedSchemaVersion);
                        }

                        this.applyVersionMetadata();

                        // Update unlock screen with vault info
                        const unlockScreen = document.getElementById('unlockScreen');
                        const unlockContainer = unlockScreen.querySelector('.unlock-container');

                        const tempAccessExpiry = this.getTemporaryAccessExpiry();
                        const formattedExpiry = tempAccessExpiry ? this.escapeHTML(tempAccessExpiry.toLocaleString()) : '';
                        const tempAccessNotice = this.temporaryAccess
                            ? this.isTemporaryAccessActive() && tempAccessExpiry
                                ? `<p style="margin: 10px 0 0 0; color: #f97316; font-size: 9pt;">Temporary TOTP-only access active until ${formattedExpiry}.</p>`
                                : '<p style="margin: 10px 0 0 0; color: #f97316; font-size: 9pt;">Temporary TOTP-only access has expired. Save a new vault to remove or renew it.</p>'
                            : '';

                        const vaultInfoHTML = `
                            <div class="vault-identity-block" style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                                <h3 style="margin: 0; color: #3b82f6; font-size: 16pt;">ðŸ”· ${this.vaultIdentity}</h3>
                                <p style="margin: 5px 0 0 0; color: #64748b; font-size: 9pt;">
                                    Last saved: ${this.lastSaved ? new Date(this.lastSaved).toLocaleString() : 'Unknown'}
                                </p>
                                ${tempAccessNotice}
                            </div>
                        `;

                        const existingVaultInfo = unlockContainer.querySelector('.vault-identity-block');
                        if (existingVaultInfo) {
                            existingVaultInfo.outerHTML = vaultInfoHTML;
                        } else {
                            unlockContainer.querySelector('h2').insertAdjacentHTML('afterend', vaultInfoHTML);
                        }

                        // Show unlock screen
                        document.getElementById('welcomeScreen').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'none';
                        document.getElementById('navTabs').style.display = 'none';
                        unlockScreen.style.display = 'flex';
                        window.vaultManager?.hide();

                        if (this.requires2FA) {
                            document.getElementById('totpField').style.display = 'block';
                        } else {
                            document.getElementById('totpField').style.display = 'none';
                        }

                        this.updateTemporaryAccessHint();
                        this.updateRecoveryFieldVisibility();

                        if (this.emergencyAccessConfig && this.emergencyAccessConfig.enabled) {
                            this.showEmergencyAccess(this.emergencyAccessConfig.data || {});
                        }
                    } catch (e) {
                        this.isInitialized = false;
                    }
                } else {
                    this.isInitialized = false;
                    // Show welcome screen
                    document.getElementById('welcomeScreen').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                    document.getElementById('unlockScreen').style.display = 'none';
                    document.getElementById('navTabs').style.display = 'none';
                    window.vaultManager?.show();
                    this.emergencyAccessConfig = null;
                    this.temporaryAccess = null;
                    this.recoveryAccess = null;
                    this.pendingTemporaryAccessRemoval = false;
                    this.updateTemporaryAccessHint();
                    this.updateRecoveryFieldVisibility();
                    this.version = APP_VERSION;
                    this.schemaVersion = schemaManager.currentVersion;
                    this.applyVersionMetadata();
                }
            }

            showEmergencyAccess(emergencyData = {}) {
                const banner = document.getElementById('emergencyAccessBanner');
                const display = document.getElementById('emergencyDataDisplay');
                const unlockScreen = document.getElementById('unlockScreen');
                const welcomeScreen = document.getElementById('welcomeScreen');
                const navTabs = document.getElementById('navTabs');

                if (!banner || !display) {
                    return;
                }

                let html = '';
                const formatMultiline = (value) => this.escapeHTML(value).replace(/\r?\n/g, '<br>');

                if (emergencyData.bloodType) {
                    html += `
                        <div class="emergency-data-item">
                            <strong>BLOOD TYPE</strong>
                            <div style="font-size: 20pt; font-weight: bold;">${this.escapeHTML(emergencyData.bloodType)}</div>
                        </div>
                    `;
                }

                if (emergencyData.criticalAllergies) {
                    html += `
                        <div class="emergency-data-item">
                            <strong>CRITICAL ALLERGIES</strong>
                            <div>${formatMultiline(emergencyData.criticalAllergies)}</div>
                        </div>
                    `;
                }

                if (emergencyData.criticalConditions) {
                    html += `
                        <div class="emergency-data-item">
                            <strong>CRITICAL CONDITIONS</strong>
                            <div>${formatMultiline(emergencyData.criticalConditions)}</div>
                        </div>
                    `;
                }

                if (emergencyData.advanceDirective) {
                    html += `
                        <div class="emergency-data-item">
                            <strong>ADVANCE DIRECTIVE</strong>
                            <div>${formatMultiline(emergencyData.advanceDirective)}</div>
                        </div>
                    `;
                }

                if (emergencyData.medications) {
                    html += `
                        <div class="emergency-data-item">
                            <strong>CRITICAL MEDICATIONS</strong>
                            <div>${formatMultiline(emergencyData.medications)}</div>
                        </div>
                    `;
                }

                if (emergencyData.contacts && emergencyData.contacts.length > 0) {
                    html += '<div class="emergency-data-item"><strong>EMERGENCY CONTACTS</strong>';
                    emergencyData.contacts.forEach(contact => {
                        html += `
                            <div class="emergency-contact-card">
                                <div style="font-weight: bold;">${this.escapeHTML(contact.name)}</div>
                                ${contact.relationship ? `<div>${this.escapeHTML(contact.relationship)}</div>` : ''}
                                <div style="font-size: 14pt; color: #dc2626; margin-top: 5px;">
                                    ${this.escapeHTML(contact.phone)}
                                </div>
                                ${contact.altPhone ? `<div>${this.escapeHTML(contact.altPhone)}</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                display.innerHTML = html || '<p>No emergency information configured.</p>';
                banner.style.display = 'flex';

                if (unlockScreen) {
                    unlockScreen.style.display = 'none';
                }

                if (welcomeScreen) {
                    welcomeScreen.style.display = 'none';
                }

                if (navTabs) {
                    navTabs.style.display = 'none';
                }
            }

            proceedToUnlock() {
                const banner = document.getElementById('emergencyAccessBanner');
                const unlockScreen = document.getElementById('unlockScreen');

                if (banner) {
                    banner.style.display = 'none';
                }

                if (unlockScreen) {
                    unlockScreen.style.display = 'flex';
                }

                const navTabs = document.getElementById('navTabs');
                if (navTabs) {
                    navTabs.style.display = 'none';
                }

                if (this.requires2FA) {
                    document.getElementById('totpField').style.display = 'block';
                } else {
                    document.getElementById('totpField').style.display = 'none';
                }

                this.updateRecoveryFieldVisibility();

                document.getElementById('unlock-password')?.focus();
            }
            
            init() {
                this.setupEventListeners();
                this.updateSaveStatus();

                // Clear any cached data while preserving localization preference and vault registry
                const preservedValues = this.getLocalStoragePreservationMap();

                try {
                    localStorage.clear();
                } catch (error) {
                    console.warn('Unable to clear localStorage', error);
                }

                this.restorePreservedLocalStorage(preservedValues);

                try {
                    sessionStorage.clear();
                } catch (error) {
                    console.warn('Unable to clear sessionStorage', error);
                }
            }

            scheduleKDFBenchmark() {
                if (this.hasBenchmarkedKDF) {
                    return;
                }

                this.hasBenchmarkedKDF = true;

                setTimeout(() => {
                    this.benchmarkKDF().catch((error) => {
                        console.warn('KDF benchmark failed', error);
                    });
                }, 1000);
            }

            async benchmarkKDF() {
                const webCrypto = window.crypto || globalThis.crypto;

                if (!webCrypto?.subtle) {
                    return;
                }

                const encoder = new TextEncoder();
                const salt = webCrypto.getRandomValues(new Uint8Array(16));
                const password = 'benchmark';

                const keyMaterial = await webCrypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );

                const start = performance.now();
                await webCrypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt,
                        iterations: 600000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );
                const elapsed = performance.now() - start;

                console.log(`KDF takes ${elapsed.toFixed(0)}ms on this device`);

                if (elapsed > 5000) {
                    alert('Password processing may take a few seconds on this device');
                }
            }

            applyVersionMetadata() {
                const versionEl = document.getElementById('appVersion');
                if (versionEl && this.version) {
                    versionEl.textContent = this.version;
                }

                const schemaEl = document.getElementById('schemaVersionDisplay');
                if (schemaEl) {
                    const displayVersion = this.schemaVersion || schemaManager.currentVersion;
                    schemaEl.textContent = `v${schemaManager.normalizeVersion(displayVersion)}`;
                }

                const updatedEl = document.getElementById('appLastUpdated');
                if (!updatedEl) {
                    return;
                }

                if (!this.lastUpdated) {
                    updatedEl.textContent = 'â€”';
                    return;
                }

                const parsedDate = new Date(this.lastUpdated);
                if (!Number.isNaN(parsedDate.getTime())) {
                    updatedEl.textContent = parsedDate.toLocaleString(undefined, {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        timeZone: 'UTC',
                        timeZoneName: 'short'
                    });
                } else {
                    updatedEl.textContent = this.lastUpdated;
                }
            }

            setupEventListeners() {
                // Main buttons
                document.getElementById('saveBtn').addEventListener('click', () => this.saveVault());
                document.getElementById('settingsBtn').addEventListener('click', () => this.openSettings());
                document.getElementById('exportBtn').addEventListener('click', () => this.openExportOptions());
                document.getElementById('lockBtn')?.addEventListener('click', () => this.toggleLock());
                document.getElementById('openVaultBtn')?.addEventListener('click', () => this.promptVaultImport());
                document.getElementById('vaultFileInput')?.addEventListener('change', (event) => this.handleVaultFileSelect(event));
                document.getElementById('uploadPhotoBtn')?.addEventListener('click', () => this.promptProfilePhoto());
                document.getElementById('removePhotoBtn')?.addEventListener('click', () => this.removeProfilePhoto());
                document.getElementById('generateRecoveryKeyBtn')?.addEventListener('click', () => this.handleGenerateRecoveryKey());
                document.getElementById('disableRecoveryKeyBtn')?.addEventListener('click', () => this.handleDisableRecoveryKey());

                const profilePhotoInput = document.getElementById('profilePhotoInput');
                if (profilePhotoInput) {
                    profilePhotoInput.addEventListener('change', (event) => this.handleProfilePhotoSelect(event));
                }

                document.getElementById('printSummaryBtn')?.addEventListener('click', () => {
                    this.closeExportOptions();
                    this.printSummary();
                });

                document.getElementById('exportCloseBtn')?.addEventListener('click', () => this.closeExportOptions());
                
                // Navigation
                document.querySelectorAll('.tab').forEach((tab) => {
                    tab.addEventListener('click', (event) => this.navigateToSection(event));
                });

                this.initializeTabAccessibility();
                
                // Module toggles
                ['identity', 'gac', 'mental', 'chronic'].forEach(module => {
                    const toggle = document.getElementById(`module-${module}`);
                    if (toggle) {
                        toggle.addEventListener('change', () => this.toggleModule(module));
                    }
                });

                const emergencyEnabledToggle = document.getElementById('emergency-enabled');
                if (emergencyEnabledToggle) {
                    emergencyEnabledToggle.addEventListener('change', () => this.updateEmergencySettingsVisibility());
                }

                // Add buttons
                document.getElementById('addEmergencyBtn')?.addEventListener('click', () => this.addEmergencyContact());
                document.getElementById('addMedicationBtn')?.addEventListener('click', () => this.addMedication());
                document.getElementById('addConditionBtn')?.addEventListener('click', () => this.addCondition());
                document.getElementById('addSurgeryBtn')?.addEventListener('click', () => this.addSurgery());
                document.getElementById('addProviderBtn')?.addEventListener('click', () => this.addProvider());
                document.getElementById('addNoteBtn')?.addEventListener('click', () => this.addNote());
                document.getElementById('addGACNoteBtn')?.addEventListener('click', () => this.addGACNote());
                document.getElementById('addVitalBtn')?.addEventListener('click', () => this.addVitalSign());
                document.getElementById('addLabBtn')?.addEventListener('click', () => this.addLabResult());
                document.getElementById('addCovidVaccineBtn')?.addEventListener('click', () => this.addCovidVaccine());
                document.getElementById('addVaccineBtn')?.addEventListener('click', () => this.addVaccine());
                document.getElementById('addAttachmentBtn')?.addEventListener('click', () => this.promptAttachmentUpload());

                document.getElementById('addNoteTagBtn')?.addEventListener('click', () => this.handleAddNoteTag());
                const noteTagInput = document.getElementById('noteTagInput');
                if (noteTagInput) {
                    noteTagInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.handleAddNoteTag();
                        }
                    });
                }

                const tagList = document.getElementById('noteTagList');
                if (tagList) {
                    tagList.addEventListener('click', (e) => {
                        const button = e.target.closest('button[data-tag-remove]');
                        if (button) {
                            e.preventDefault();
                            this.removeNoteTag(button.dataset.tagRemove);
                        }
                    });
                }

                document.getElementById('providers-container')?.addEventListener('input', () => this.refreshProviderOptions());

                const attachmentFileInput = document.getElementById('attachmentFileInput');
                if (attachmentFileInput) {
                    attachmentFileInput.addEventListener('change', (event) => this.handleAttachmentSelect(event));
                }

                const attachmentsContainer = document.getElementById('attachments-container');
                if (attachmentsContainer) {
                    attachmentsContainer.addEventListener('click', (event) => {
                        const viewBtn = event.target.closest('button[data-attachment-view]');
                        if (viewBtn) {
                            event.preventDefault();
                            this.viewAttachment(viewBtn.dataset.attachmentView);
                            return;
                        }

                        const downloadBtn = event.target.closest('button[data-attachment-download]');
                        if (downloadBtn) {
                            event.preventDefault();
                            this.downloadAttachment(downloadBtn.dataset.attachmentDownload);
                            return;
                        }

                        const removeBtn = event.target.closest('button[data-attachment-remove]');
                        if (removeBtn) {
                            event.preventDefault();
                            this.removeAttachment(removeBtn.dataset.attachmentRemove);
                        }
                    });
                }

                const attachmentPreviewClose = document.getElementById('attachmentPreviewClose');
                if (attachmentPreviewClose) {
                    attachmentPreviewClose.addEventListener('click', (event) => {
                        event.preventDefault();
                        this.closeAttachmentPreview();
                    });
                }

                const attachmentPreviewDownload = document.getElementById('attachmentPreviewDownload');
                if (attachmentPreviewDownload) {
                    attachmentPreviewDownload.addEventListener('click', (event) => {
                        event.preventDefault();
                        if (this.currentPreviewAttachmentId) {
                            this.downloadAttachment(this.currentPreviewAttachmentId);
                        }
                    });
                }

                const attachmentPreviewModal = document.getElementById('attachmentPreviewModal');
                if (attachmentPreviewModal) {
                    attachmentPreviewModal.addEventListener('click', (event) => {
                        if (event.target === attachmentPreviewModal) {
                            this.closeAttachmentPreview();
                        }
                    });
                }

                // Track changes
                const identityFields = new Set(
                    ['firstName', 'lastName', 'middleInitial', 'mrn', 'biologicalSex', 'dateOfBirth']
                        .map(key => fieldRegistry.resolve(key))
                );

                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('form-data')) {
                        this.markAsChanged();

                        const fieldName = fieldRegistry.resolve(e.target.dataset.field);
                        if (identityFields.has(fieldName)) {
                            this.updatePatientSummaryDisplay();
                        }
                    }
                });

                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('form-data')) {
                        const fieldName = fieldRegistry.resolve(e.target.dataset.field);
                        if (identityFields.has(fieldName)) {
                            this.updatePatientSummaryDisplay();
                        }
                    }
                });
                
                // Password modal
                document.getElementById('modalSubmit').addEventListener('click', () => this.handlePasswordSubmit());
                document.getElementById('modalCancel').addEventListener('click', () => this.closePasswordModal());
                document.getElementById('passwordUpdateSubmit')?.addEventListener('click', () => this.handlePasswordUpdateSubmit());
                document.getElementById('passwordUpdateCancel')?.addEventListener('click', () => this.closePasswordUpdateModal());
                document.querySelectorAll('input[name="passwordUpdateChoice"]').forEach((input) => {
                    input.addEventListener('change', (event) => {
                        this.togglePasswordUpdateMode(event.target.value);
                    });
                });
                this.initializePasswordGuidance();
                const tempAccessToggle = document.getElementById('enableTemporaryAccess');
                if (tempAccessToggle) {
                    tempAccessToggle.addEventListener('change', (event) => this.handleTemporaryAccessToggle(event));
                }
                const revokeTempAccess = document.getElementById('revokeTemporaryAccess');
                if (revokeTempAccess) {
                    revokeTempAccess.addEventListener('click', (event) => {
                        event.preventDefault();
                        this.handleRevokeTemporaryAccess();
                    });
                }
                ['updateNewPassword', 'updateConfirmPassword'].forEach((id) => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                this.handlePasswordUpdateSubmit();
                            }
                        });
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        this.saveVault();
                    }
                });

                this.syncFieldInputs('pronouns');
                this.syncFieldInputs('chosenName');
                this.updateEmergencySettingsVisibility();
                this.updatePatientSummaryDisplay();
                this.initializeExistingNotes();
                this.restoreNoteTagsFromStorage();
                this.refreshProviderOptions();
                this.refreshAllNoteTagSelectors();
                this.restoreAttachmentsFromStorage();

                ['click', 'mousemove', 'touchstart'].forEach((eventName) => {
                    document.addEventListener(eventName, () => this.handleUserActivity(), { passive: true });
                });
                document.addEventListener('keydown', () => this.handleUserActivity());
            }

            promptVaultImport() {
                if (window.vaultManager instanceof VaultManager) {
                    window.vaultManager.show();
                    window.vaultManager.beginImportFlow();
                    return;
                }

                const fileInput = document.getElementById('vaultFileInput');
                if (!(fileInput instanceof HTMLInputElement)) {
                    return;
                }

                fileInput.value = '';
                fileInput.click();
            }

            async handleVaultFileSelect(event) {
                const input = event?.target;
                if (!(input instanceof HTMLInputElement)) {
                    return;
                }

                const [file] = input.files || [];
                if (!file) {
                    return;
                }

                const fileName = typeof file.name === 'string' ? file.name.toLowerCase() : '';
                if (!fileName.endsWith('.ehv')) {
                    alert('Please select a .ehv vault file created by this application.');
                    input.value = '';
                    return;
                }

                try {
                    const fileText = await file.text();
                    await this.importVaultFromVaultFile(file, fileText);
                } catch (error) {
                    console.error('Failed to import vault file', error);
                    const message = error instanceof Error
                        ? error.message
                        : 'Unable to import the selected file. Please choose a valid .ehv encrypted vault.';
                    alert(message);
                } finally {
                    input.value = '';
                }
            }

            async importVaultFromVaultFile(file, fileContent) {
                if (typeof fileContent !== 'string') {
                    throw new Error('Invalid file content.');
                }

                if (typeof DOMParser === 'undefined') {
                    throw new Error('This browser does not support opening encrypted vault files.');
                }

                const fileName = typeof file?.name === 'string' ? file.name.toLowerCase() : '';
                if (fileName && !fileName.endsWith('.ehv')) {
                    throw new Error('The selected file is not a supported .ehv vault file.');
                }

                const parser = new DOMParser();
                const parsedDocument = parser.parseFromString(fileContent, 'text/html');

                if (parsedDocument.querySelector('parsererror')) {
                    throw new Error('The selected .ehv file could not be read as a valid vault document.');
                }

                const embeddedScript = parsedDocument.getElementById('embedded-vault-data');
                if (!embeddedScript) {
                    throw new Error('The selected file does not contain any vault data to import.');
                }

                const embeddedText = embeddedScript.textContent?.trim();
                if (!embeddedText) {
                    throw new Error('The selected file does not contain encrypted vault data.');
                }

                let parsedVault;
                try {
                    parsedVault = JSON.parse(embeddedText);
                } catch (error) {
                    throw new Error('The selected file contains unreadable encrypted vault data.');
                }

                if (parsedVault.compressed && parsedVault.data) {
                    const pakoInstance = this.getCompressionLibrary();

                    if (pakoInstance && typeof pakoInstance.inflate === 'function') {
                        try {
                            const binary = atob(parsedVault.data);
                            const bytes = new Uint8Array(binary.length);
                            for (let i = 0; i < binary.length; i++) {
                                bytes[i] = binary.charCodeAt(i);
                            }

                            const decompressed = pakoInstance.inflate(bytes, { to: 'string' });
                            parsedVault = JSON.parse(decompressed);
                        } catch (error) {
                            throw new Error('Failed to decompress imported vault data.');
                        }
                    } else {
                        throw new Error('Compression library unavailable. Cannot import compressed vault.');
                    }
                }

                if (!parsedVault || typeof parsedVault !== 'object' || !parsedVault.data) {
                    throw new Error('The selected file does not contain encrypted vault data.');
                }

                const targetScript = document.getElementById('embedded-vault-data');
                if (!(targetScript instanceof HTMLScriptElement)) {
                    throw new Error('Unable to prepare the application for the imported vault.');
                }

                const previousContent = targetScript.textContent;

                try {
                    this.stopLockCountdown();
                    this.clearSessionData();
                    this.updateLockTimerDisplay();
                    this.clearUnlockFields();

                    targetScript.textContent = embeddedText;

                    this.checkInitialization();

                    if (!this.encryptedData) {
                        throw new Error('No encrypted vault payload was detected in the selected file.');
                    }

                    this.sessionPassword = null;
                    this.totpSecret = null;
                    this.currentTOTPSecret = null;
                    this.hasUnsavedChanges = false;
                    this.isLocked = true;
                    this.pendingSchemaNotice = null;
                    this.updateLockTimerDisplay();

                    const passwordInput = document.getElementById('unlock-password');
                    if (passwordInput instanceof HTMLInputElement) {
                        passwordInput.value = '';
                        passwordInput.focus();
                    }

                    const totpInput = document.getElementById('totp-code');
                    if (totpInput instanceof HTMLInputElement) {
                        totpInput.value = '';
                    }

                    const lockBtn = document.getElementById('lockBtn');
                    if (lockBtn) {
                        lockBtn.style.display = 'none';
                        lockBtn.setAttribute('data-i18n-key', 'unlock_action');
                        lockBtn.textContent = window.localization?.t('unlock_action', 'ðŸ”“ Lock');
                    }

                    this.updateSaveStatus();
                } catch (error) {
                    targetScript.textContent = previousContent || '';
                    try {
                        this.checkInitialization();
                    } catch (restoreError) {
                        console.error('Failed to restore previous vault after import error', restoreError);
                    }
                    throw error;
                }
            }

            startSetup() {
                const identityHTML = `
                    <div id="vaultIdentityBlock" style="margin: 20px 0; padding: 20px; background: #eff6ff; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; color: #1e293b;">Your Vault Identity</h3>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <h2 id="vaultName" style="color: #3b82f6; margin: 0;">ðŸ”· ${this.vaultIdentity}</h2>
                            <button onclick="app.regenerateVaultName()" style="padding: 8px 12px; background: #e0e7ff; border: none; border-radius: 6px; cursor: pointer; font-size: 16pt;" aria-label="Generate a new vault identity">ðŸŽ²</button>
                        </div>
                        <p style="margin: 10px 0 0 0; color: #64748b; font-size: 9pt;">
                            This unique name identifies your vault across all saves.<br>
                            Write it down to recognize your vault in the future.
                        </p>
                    </div>
                `;

                window.vaultManager?.hide();
                document.getElementById('welcomeScreen').style.display = 'none';

                this.recoveryAccess = null;
                this.updateRecoveryFieldVisibility();

                const modal = document.getElementById('passwordModal');
                modal.classList.add('active');
                document.getElementById('modalTitle').textContent = 'Create Your Health Vault';

                const modalBody = modal.querySelector('.modal-body');
                const firstField = modalBody.querySelector('.field');
                if (!document.getElementById('vaultIdentityBlock')) {
                    firstField.insertAdjacentHTML('beforebegin', identityHTML);
                } else {
                    document.getElementById('vaultName').innerHTML = `ðŸ”· ${this.vaultIdentity}`;
                }

                const moduleSelectionHTML = `
                    <div id="setupModuleSelection" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0;">Enable Optional Modules</h4>
                        <p style="margin: 0 0 12px 0; font-size: 9pt; color: #64748b;">
                            Choose any specialized sections to include from the start. You can adjust these later in Settings.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label class="checkbox-item" style="align-items: flex-start; gap: 10px;">
                                <input type="checkbox" id="setup-module-identity">
                                <span>
                                    <strong data-i18n-key="module_identity_name">Extended Identity</strong><br>
                                    <span style="font-size: 9pt; color: #64748b;" data-i18n-key="module_identity_desc">Pronouns, chosen names, context-specific usage</span>
                                </span>
                            </label>
                            <label class="checkbox-item" style="align-items: flex-start; gap: 10px;">
                                <input type="checkbox" id="setup-module-gac">
                                <span>
                                    <strong data-i18n-key="module_gac_name">Gender Affirming Care</strong><br>
                                    <span style="font-size: 9pt; color: #64748b;" data-i18n-key="module_gac_desc">HRT tracking, surgeries, specialized providers</span>
                                </span>
                            </label>
                            <label class="checkbox-item" style="align-items: flex-start; gap: 10px;">
                                <input type="checkbox" id="setup-module-mental">
                                <span>
                                    <strong data-i18n-key="module_mental_name">Mental Health</strong><br>
                                    <span style="font-size: 9pt; color: #64748b;" data-i18n-key="module_mental_desc">Mood tracking, therapy notes, crisis resources</span>
                                </span>
                            </label>
                            <label class="checkbox-item" style="align-items: flex-start; gap: 10px;">
                                <input type="checkbox" id="setup-module-chronic">
                                <span>
                                    <strong data-i18n-key="module_chronic_name">Chronic Disease</strong><br>
                                    <span style="font-size: 9pt; color: #64748b;" data-i18n-key="module_chronic_desc">Diabetes, hypertension, pain management</span>
                                </span>
                            </label>
                        </div>
                    </div>
                `;

                const twoFAHTML = `
                    <div id="setupTwoFAOption" style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 6px;">
                        <div class="checkbox-item">
                            <input type="checkbox" id="enable2FA">
                            <label for="enable2FA"><strong>Enable Two-Factor Authentication (Optional)</strong></label>
                        </div>
                        <p style="margin: 10px 0 0 20px; font-size: 9pt; color: #64748b;">
                            <strong>Optional security enhancement:</strong> Adds an extra layer using an authenticator app.<br>
                            You can skip this and use password-only protection if you prefer.<br>
                            If enabled, you'll need both password AND 6-digit code to unlock.
                        </p>
                    </div>
                `;

                const confirmField = document.getElementById('confirmPasswordField');
                if (!document.getElementById('setupModuleSelection')) {
                    confirmField.insertAdjacentHTML('afterend', moduleSelectionHTML);
                    window.localization?.applyTranslations();
                }

                ['identity', 'gac', 'mental', 'chronic'].forEach(module => {
                    const setupToggle = document.getElementById(`setup-module-${module}`);
                    if (setupToggle) {
                        setupToggle.checked = this.modules[module];
                    }
                });

                if (!document.getElementById('setupTwoFAOption')) {
                    const insertAfter = document.getElementById('setupModuleSelection') || confirmField;
                    insertAfter.insertAdjacentHTML('afterend', twoFAHTML);
                }

                window.localization?.applyTranslations();
                this.initializePasswordGuidance();
            }

            applySetupModuleSelections() {
                const moduleKeys = ['identity', 'gac', 'mental', 'chronic'];
                let selectionsFound = false;

                moduleKeys.forEach((module) => {
                    const setupToggle = document.getElementById(`setup-module-${module}`);
                    if (setupToggle) {
                        selectionsFound = true;
                        const isChecked = setupToggle.checked;
                        this.modules[module] = isChecked;

                        const settingsToggle = document.getElementById(`module-${module}`);
                        if (settingsToggle) {
                            settingsToggle.checked = isChecked;
                        }
                    }
                });

                if (selectionsFound) {
                    this.updateModuleVisibility();
                }
            }

            syncFieldInputs(fieldName) {
                const canonical = fieldRegistry.resolve(fieldName);
                const keys = Array.from(new Set(fieldRegistry.getAllKeys(canonical)));
                const selector = keys
                    .map(key => `.form-data[data-field="${key}"]`)
                    .join(',');

                if (!selector) {
                    return;
                }

                const inputs = Array.from(document.querySelectorAll(selector));

                if (inputs.length < 2) {
                    return;
                }

                inputs.forEach((input) => {
                    input.addEventListener('input', (event) => {
                        const { value } = event.target;
                        inputs.forEach((other) => {
                            if (other !== event.target && other.value !== value) {
                                other.value = value;
                            }
                        });
                    });
                });
            }

            regenerateVaultName() {
                this.vaultIdentity = this.generateVaultName();
                document.getElementById('vaultName').innerHTML = `ðŸ”· ${this.vaultIdentity}`;
            }
            
            async attemptUnlock(event) {
                const passwordField = document.getElementById('unlock-password');
                const totpFieldInput = document.getElementById('totp-code');
                const recoveryFieldInput = document.getElementById('recovery-key');

                const enteredPassword = passwordField?.value || '';
                const totpCode = totpFieldInput?.value?.trim() || '';
                const recoveryKey = recoveryFieldInput?.value?.trim() || '';

                let password = enteredPassword;
                let usedTemporaryAccess = false;
                let usedRecoveryKey = false;

                const unlockBtn = (event?.target instanceof HTMLElement)
                    ? event.target
                    : document.getElementById('unlockBtn');
                const originalLabel = unlockBtn?.textContent;
                let spinner = null;

                if (!password && totpCode) {
                    try {
                        password = await this.tryUnlockWithTemporaryAccess(totpCode);
                        usedTemporaryAccess = true;
                    } catch (error) {
                        alert(error.message);
                        return;
                    }
                }

                if (!password && recoveryKey) {
                    try {
                        password = await this.tryUnlockWithRecoveryKey(recoveryKey);
                        usedRecoveryKey = true;
                    } catch (error) {
                        alert(error.message);
                        return;
                    }
                }

                if (!password) {
                    alert('Please enter your password');
                    return;
                }

                if (this.requires2FA && !usedTemporaryAccess && !usedRecoveryKey && !totpCode) {
                    alert('Please enter your 6-digit authentication code');
                    return;
                }

                if (unlockBtn && !unlockBtn.dataset.busy) {
                    unlockBtn.disabled = true;
                    unlockBtn.dataset.busy = 'true';
                    if (unlockBtn instanceof HTMLButtonElement) {
                        unlockBtn.textContent = 'Decrypting...';
                    }

                    spinner = document.createElement('div');
                    spinner.className = 'spinner';
                    unlockBtn.parentElement?.appendChild(spinner);
                }

                try {
                    const decrypted = await this.crypto.decrypt(this.encryptedData, password);
                    const { codeHash, codeSignature, ...decryptedPayload } = decrypted || {};

                    try {
                        await this.verifyVaultIntegrity({ codeHash, codeSignature }, password);
                    } catch (integrityError) {
                        if (integrityError?.message === 'TAMPERING_DETECTED') {
                            this.showTamperingAlert();
                            this.clearUnlockFields();
                            return;
                        }
                        throw integrityError;
                    }

                    if (this.requires2FA && !usedTemporaryAccess && !usedRecoveryKey && decryptedPayload.totpSecret) {
                        const isValidTOTP = await TOTP.verifyTOTP(decryptedPayload.totpSecret, totpCode);

                        if (!isValidTOTP) {
                            alert('Invalid authentication code. Please check your authenticator app for the current code.');
                            return;
                        }
                    }

                    const incomingSchemaVersion = decryptedPayload.schemaVersion
                        || decryptedPayload.__schemaVersion
                        || this.schemaVersion;

                    const migrationResult = schemaManager.migrate(decryptedPayload, incomingSchemaVersion);
                    const normalizedData = fieldRegistry.normalizeIncomingData(migrationResult.data);

                    this.sessionPassword = password;
                    this.totpSecret = normalizedData.totpSecret;
                    this.schemaVersion = migrationResult.version;
                    this.pendingSchemaNotice = migrationResult;

                    this.loadFormData(normalizedData);
                    this.modules = this.savedModules || this.modules;

                    this.updateModuleVisibility();
                    this.isInitialized = true;
                    this.clearUnlockFields();
                    this.applyVersionMetadata();
                    this.unlock();

                    const needsResave = Boolean(migrationResult?.needsResave);
                    const isNewerSchema = Boolean(migrationResult?.newerThanApp);

                    if (needsResave) {
                        this.hasUnsavedChanges = true;
                        this.updateSaveStatus();

                        const migrationLines = (migrationResult.appliedMigrations || []).map(step => {
                            if (step.description) {
                                return `â€¢ ${step.description} (${step.from} â†’ ${step.to})`;
                            }
                            return `â€¢ Schema upgraded from ${step.from} to ${step.to}`;
                        });

                        const noticeLines = [
                            'ðŸ”„ Your vault data was upgraded to the latest schema.',
                            'Please download a new encrypted vault file to capture these changes.'
                        ];

                        if (migrationLines.length > 0) {
                            noticeLines.push('', ...migrationLines);
                        }

                        alert(noticeLines.join('\n'));
                    } else {
                        this.hasUnsavedChanges = false;
                        this.updateSaveStatus();
                        this.pendingSchemaNotice = null;
                    }

                    if (isNewerSchema) {
                        alert(
                            'âš ï¸ This vault was created with a newer schema than this release can fully interpret.\n\n'
                            + 'Review the data carefully and consider updating the application when possible.'
                        );
                    }
                } catch (error) {
                    if (error?.message === 'TAMPERING_DETECTED') {
                        this.showTamperingAlert();
                        this.clearUnlockFields();
                        return;
                    }

                    if (usedTemporaryAccess) {
                        alert('Unable to unlock with the provided temporary access code. It may have expired or been entered incorrectly.');
                        return;
                    }

                    if (usedRecoveryKey) {
                        alert('Unable to unlock with the provided recovery key. Make sure you entered it exactly as saved.');
                        return;
                    }

                    if (this.requires2FA) {
                        alert('Invalid password or authentication code.\n\nMake sure you are using the current 6-digit code from your authenticator app.');
                    } else {
                        alert('Incorrect password');
                    }
                } finally {
                    if (spinner?.parentElement) {
                        spinner.parentElement.removeChild(spinner);
                    }

                    if (unlockBtn) {
                        unlockBtn.disabled = false;
                        delete unlockBtn.dataset.busy;
                        if (unlockBtn instanceof HTMLButtonElement && originalLabel !== undefined) {
                            unlockBtn.textContent = originalLabel;
                        }
                    }
                }
            }
            
            navigateToSection(event) {
                const rawTarget = event.currentTarget instanceof HTMLElement
                    ? event.currentTarget
                    : event.target instanceof HTMLElement
                        ? event.target.closest('.tab')
                        : null;

                if (!(rawTarget instanceof HTMLElement)) {
                    return;
                }

                const sectionId = rawTarget.dataset.section;
                if (!sectionId) {
                    return;
                }

                const section = document.getElementById(`${sectionId}-section`);
                if (!section) {
                    return;
                }

                const tabs = Array.from(document.querySelectorAll('.nav-tabs .tab'));
                tabs.forEach((tab) => {
                    if (!(tab instanceof HTMLElement)) {
                        return;
                    }
                    tab.classList.remove('active');
                    tab.setAttribute('aria-selected', 'false');
                    tab.setAttribute('tabindex', '-1');
                });

                rawTarget.classList.add('active');
                rawTarget.setAttribute('aria-selected', 'true');
                rawTarget.setAttribute('tabindex', '0');

                section.scrollIntoView({ behavior: 'smooth', block: 'start' });

                const label = rawTarget.textContent ? rawTarget.textContent.trim() : '';
                if (label) {
                    announce(`${label} section selected`);
                }
            }

            initializeTabAccessibility() {
                const tabs = Array.from(document.querySelectorAll('.nav-tabs .tab'));
                if (!tabs.length) {
                    return;
                }

                const activeTab = tabs.find((tab) => tab instanceof HTMLElement && tab.classList.contains('active'));

                tabs.forEach((tab, index) => {
                    if (!(tab instanceof HTMLElement)) {
                        return;
                    }

                    tab.setAttribute('role', 'tab');
                    const sectionId = tab.dataset.section;
                    if (sectionId) {
                        tab.setAttribute('aria-controls', `${sectionId}-section`);
                    }

                    const isActive = tab.classList.contains('active') || (!activeTab && index === 0);
                    tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
                    tab.setAttribute('tabindex', isActive ? '0' : '-1');

                    if (!tab.dataset.a11yInitialized) {
                        tab.addEventListener('keydown', (keyboardEvent) => this.handleTabKeydown(keyboardEvent));
                        tab.dataset.a11yInitialized = 'true';
                    }
                });
            }

            handleTabKeydown(event) {
                const tabs = Array.from(document.querySelectorAll('.nav-tabs .tab'));
                const currentIndex = tabs.indexOf(event.currentTarget);

                if (!tabs.length || currentIndex === -1) {
                    return;
                }

                let newIndex = null;

                switch (event.key) {
                    case 'ArrowRight':
                        newIndex = (currentIndex + 1) % tabs.length;
                        break;
                    case 'ArrowLeft':
                        newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                        break;
                    case 'Home':
                        newIndex = 0;
                        break;
                    case 'End':
                        newIndex = tabs.length - 1;
                        break;
                    default:
                        break;
                }

                if (newIndex === null) {
                    return;
                }

                const nextTab = tabs[newIndex];
                if (nextTab instanceof HTMLElement) {
                    event.preventDefault();
                    nextTab.focus();
                    nextTab.click();
                }
            }

            toggleModule(moduleName) {
                this.modules[moduleName] = document.getElementById(`module-${moduleName}`).checked;
                this.updateModuleVisibility();
                this.markAsChanged();
            }
            
            updateModuleVisibility() {
                const identitySection = document.getElementById('identity-section');
                const gacSection = document.getElementById('gac-section');
                const mentalSection = document.getElementById('mental-section');
                const chronicSection = document.getElementById('chronic-section');
                const corePronounRow = document.getElementById('corePronounRow');

                identitySection.style.display = this.modules.identity ? 'block' : 'none';
                gacSection.style.display = this.modules.gac ? 'block' : 'none';
                mentalSection.style.display = this.modules.mental ? 'block' : 'none';
                chronicSection.style.display = this.modules.chronic ? 'block' : 'none';

                if (corePronounRow) {
                    corePronounRow.style.display = this.modules.gac ? 'flex' : 'none';
                }

                if (this.modules.identity || this.modules.gac) {
                    const emergencySection = document.getElementById('emergency-section');

                    if (this.modules.identity && identitySection) {
                        emergencySection.after(identitySection);
                    }
                    
                    if (this.modules.gac && gacSection) {
                        if (this.modules.identity && identitySection) {
                            identitySection.after(gacSection);
                        } else {
                            emergencySection.after(gacSection);
                        }
                    }
                }
                
                this.updateNavigationTabs();
            }
            
            updateNavigationTabs() {
                const navTabs = document.getElementById('navTabs');
                const existingModuleTabs = navTabs.querySelectorAll('.module-tab');
                existingModuleTabs.forEach(tab => tab.remove());
                
                const demographicsTab = navTabs.querySelector('[data-section="demographics"]');

                if (this.modules.identity) {
                    const identityTab = document.createElement('div');
                    identityTab.className = 'tab module-tab';
                    identityTab.setAttribute('data-section', 'identity');
                    identityTab.setAttribute('data-i18n-key', 'module_identity_tab');
                    identityTab.textContent = (window.localization?.t('module_identity_tab', 'ðŸ‘¤ Identity'));
                    demographicsTab.after(identityTab);
                }

                if (this.modules.gac) {
                    const gacTab = document.createElement('div');
                    gacTab.className = 'tab module-tab';
                    gacTab.setAttribute('data-section', 'gac');
                    gacTab.setAttribute('data-i18n-key', 'module_gac_tab');
                    gacTab.textContent = (window.localization?.t('module_gac_tab', 'ðŸ³ï¸â€âš§ï¸ GAC'));
                    const insertAfter = this.modules.identity ?
                        navTabs.querySelector('[data-section="identity"]') :
                        demographicsTab;
                    insertAfter.after(gacTab);
                }

                if (this.modules.mental) {
                    const mentalTab = document.createElement('div');
                    mentalTab.className = 'tab module-tab';
                    mentalTab.setAttribute('data-section', 'mental');
                    mentalTab.setAttribute('data-i18n-key', 'module_mental_tab');
                    mentalTab.textContent = (window.localization?.t('module_mental_tab', 'ðŸ§  Mental Health'));
                    navTabs.appendChild(mentalTab);
                }
                if (this.modules.chronic) {
                    const chronicTab = document.createElement('div');
                    chronicTab.className = 'tab module-tab';
                    chronicTab.setAttribute('data-section', 'chronic');
                    chronicTab.setAttribute('data-i18n-key', 'module_chronic_tab');
                    chronicTab.textContent = (window.localization?.t('module_chronic_tab', 'ðŸ“Š Chronic'));
                    navTabs.appendChild(chronicTab);
                }

                navTabs.querySelectorAll('.module-tab').forEach((tab) => {
                    tab.addEventListener('click', (event) => this.navigateToSection(event));
                });

                this.initializeTabAccessibility();

                window.localization?.applyTranslations();
            }
            
            markAsChanged() {
                this.hasUnsavedChanges = true;
                this.updateSaveStatus();
            }
            
            updateSaveStatus() {
                const statusEl = document.getElementById('saveStatus');
                const saveBtn = document.getElementById('saveBtn');

                const translateText = window.translate
                    || ((key, fallback) => window.localization?.t(key, fallback) ?? fallback ?? key);

                if (!this.isInitialized) {
                    statusEl.className = 'save-status never-saved';
                    statusEl.setAttribute('data-i18n-key', 'status_not_initialized');
                    statusEl.textContent = translateText('status_not_initialized', 'âš ï¸ Not Initialized - Create Your Vault');
                    saveBtn.className = 'btn btn-save';
                    saveBtn.setAttribute('data-i18n-key', 'action_create_vault');
                    saveBtn.textContent = translateText('action_create_vault', 'Create Encrypted Vault');
                } else if (this.hasUnsavedChanges) {
                    statusEl.className = 'save-status unsaved';
                    statusEl.setAttribute('data-i18n-key', 'status_unsaved');
                    statusEl.textContent = translateText('status_unsaved', 'âš ï¸ Unsaved Changes - Download Updated Vault (.ehv)');
                    saveBtn.className = 'btn btn-save';
                    saveBtn.setAttribute('data-i18n-key', 'action_download_updated');
                    saveBtn.textContent = translateText('action_download_updated', 'Download Updated Vault (.ehv)');
                } else {
                    statusEl.className = 'save-status saved';
                    statusEl.setAttribute('data-i18n-key', 'status_saved');
                    statusEl.textContent = translateText('status_saved', 'âœ“ Data Encrypted in This Vault (.ehv)');
                    saveBtn.className = 'btn btn-save saved';
                    saveBtn.setAttribute('data-i18n-key', 'action_download_current');
                    saveBtn.textContent = translateText('action_download_current', 'Download Current Vault (.ehv)');
                }

                window.localization?.applyTranslations();
            }
            
            async saveVault() {
                if (!this.sessionPassword) {
                    this.showPasswordModal();
                } else {
                    this.showPasswordUpdateModal();
                }
            }
            
            showPasswordModal() {
                const modal = document.getElementById('passwordModal');
                modal.classList.add('active');
                document.getElementById('modalPassword').focus();
                this.updatePasswordRequirementsDisplay();
                this.handlePasswordInputChange();
            }
            
            closePasswordModal() {
                document.getElementById('passwordModal').classList.remove('active');
                document.getElementById('modalPassword').value = '';
                document.getElementById('modalConfirmPassword').value = '';
                this.resetStrengthBars();
                this.clearPasswordFeedback();
            }

            showPasswordUpdateModal() {
                const modal = document.getElementById('passwordUpdateModal');
                if (!modal) {
                    return;
                }

                modal.classList.add('active');

                const keepOption = document.querySelector('input[name="passwordUpdateChoice"][value="keep"]');
                const changeOption = document.querySelector('input[name="passwordUpdateChoice"][value="change"]');
                const newPasswordInput = document.getElementById('updateNewPassword');
                const confirmPasswordInput = document.getElementById('updateConfirmPassword');

                if (keepOption) {
                    keepOption.checked = true;
                }

                if (changeOption) {
                    changeOption.checked = false;
                }

                if (newPasswordInput) {
                    newPasswordInput.value = '';
                }

                if (confirmPasswordInput) {
                    confirmPasswordInput.value = '';
                }

                this.togglePasswordUpdateMode('keep');

                const note = document.getElementById('passwordUpdate2FANote');
                if (note) {
                    note.style.display = this.requires2FA ? 'block' : 'none';
                }

                this.prepareTemporaryAccessModalSection();
            }

            closePasswordUpdateModal() {
                const modal = document.getElementById('passwordUpdateModal');
                if (!modal) {
                    return;
                }

                modal.classList.remove('active');
                this.togglePasswordUpdateMode('keep');
                this.pendingTemporaryAccessRemoval = false;

                const toggle = document.getElementById('enableTemporaryAccess');
                if (toggle) {
                    toggle.checked = false;
                }

                const options = document.getElementById('temporaryAccessOptions');
                if (options) {
                    options.style.display = 'none';
                }
            }

            togglePasswordUpdateMode(mode) {
                const fields = document.getElementById('passwordUpdateFields');
                const newPasswordInput = document.getElementById('updateNewPassword');
                const confirmPasswordInput = document.getElementById('updateConfirmPassword');

                if (!fields) {
                    return;
                }

                if (mode === 'change') {
                    fields.style.display = 'block';
                    if (newPasswordInput) {
                        newPasswordInput.focus();
                    }
                } else {
                    fields.style.display = 'none';
                    if (newPasswordInput) {
                        newPasswordInput.value = '';
                    }
                    if (confirmPasswordInput) {
                        confirmPasswordInput.value = '';
                    }
                }
            }

            isTemporaryAccessActive() {
                if (!this.temporaryAccess || !this.temporaryAccess.expiresAt) {
                    return false;
                }

                const expires = Date.parse(this.temporaryAccess.expiresAt);
                if (Number.isNaN(expires)) {
                    return false;
                }

                return expires > Date.now();
            }

            getTemporaryAccessExpiry() {
                if (!this.temporaryAccess || !this.temporaryAccess.expiresAt) {
                    return null;
                }

                const expiry = new Date(this.temporaryAccess.expiresAt);
                if (Number.isNaN(expiry.getTime())) {
                    return null;
                }

                return expiry;
            }

            updateTemporaryAccessHint() {
                const hint = document.getElementById('temporaryAccessHint');

                if (!hint) {
                    return;
                }

                if (this.temporaryAccess) {
                    const expiry = this.getTemporaryAccessExpiry();

                    if (this.isTemporaryAccessActive() && expiry) {
                        hint.style.display = 'block';
                        hint.textContent = `Temporary TOTP-only access is active until ${expiry.toLocaleString()}. Enter the code provided to you above to unlock without the password.`;
                    } else {
                        hint.style.display = 'block';
                        hint.textContent = 'Temporary TOTP-only access has expired. Save a new vault to remove or renew it.';
                    }
                } else {
                    hint.style.display = 'none';
                    hint.textContent = '';
                }
            }

            prepareTemporaryAccessModalSection() {
                const section = document.getElementById('temporaryAccessSection');

                if (!section) {
                    return;
                }

                const toggle = document.getElementById('enableTemporaryAccess');
                const options = document.getElementById('temporaryAccessOptions');
                const codeInput = document.getElementById('temporaryAccessCode');
                const durationSelect = document.getElementById('temporaryAccessDuration');
                const existingBox = document.getElementById('existingTemporaryAccess');
                const summary = document.getElementById('temporaryAccessSummary');

                this.pendingTemporaryAccessRemoval = false;

                if (!this.requires2FA || !this.totpSecret) {
                    section.style.display = 'none';
                    if (toggle) {
                        toggle.checked = false;
                    }
                    if (options) {
                        options.style.display = 'none';
                    }
                    return;
                }

                section.style.display = 'block';

                if (toggle) {
                    toggle.checked = false;
                }

                if (options) {
                    options.style.display = 'none';
                }

                if (codeInput) {
                    codeInput.value = '';
                }

                if (durationSelect) {
                    durationSelect.value = '45';
                }

                if (existingBox) {
                    if (this.temporaryAccess) {
                        existingBox.style.display = 'block';
                        if (summary) {
                            if (this.isTemporaryAccessActive()) {
                                const expiry = this.getTemporaryAccessExpiry();
                                summary.textContent = expiry
                                    ? `Temporary access active until ${expiry.toLocaleString()}.`
                                    : 'Temporary access is active.';
                            } else {
                                summary.textContent = 'Temporary access has expired. Save to remove or create a new one.';
                            }
                        }
                    } else {
                        existingBox.style.display = 'none';
                        if (summary) {
                            summary.textContent = '';
                        }
                    }
                }
            }

            handleTemporaryAccessToggle(event) {
                const options = document.getElementById('temporaryAccessOptions');
                const existingBox = document.getElementById('existingTemporaryAccess');

                if (options) {
                    options.style.display = event?.target?.checked ? 'flex' : 'none';
                }

                if (event?.target?.checked) {
                    this.pendingTemporaryAccessRemoval = false;
                    if (existingBox && this.temporaryAccess) {
                        existingBox.style.display = 'none';
                    }
                } else if (existingBox && this.temporaryAccess) {
                    existingBox.style.display = 'block';
                }
            }

            handleRevokeTemporaryAccess() {
                if (!this.temporaryAccess) {
                    alert('No temporary TOTP-only access is currently active.');
                    return;
                }

                this.pendingTemporaryAccessRemoval = true;

                const summary = document.getElementById('temporaryAccessSummary');
                if (summary) {
                    summary.textContent = 'Temporary access will be revoked after you save a new vault file.';
                }

                const existingBox = document.getElementById('existingTemporaryAccess');
                if (existingBox) {
                    existingBox.style.display = 'block';
                }

                const toggle = document.getElementById('enableTemporaryAccess');
                if (toggle) {
                    toggle.checked = false;
                }

                const options = document.getElementById('temporaryAccessOptions');
                if (options) {
                    options.style.display = 'none';
                }

                alert('Temporary access will be revoked after you download and share the newly saved vault.');

                this.markAsChanged();
            }

            async createTemporaryAccess(password, code, durationMinutes) {
                if (!this.totpSecret) {
                    throw new Error('Enable two-factor authentication before configuring temporary access.');
                }

                if (!/^\d{6}$/.test(code)) {
                    throw new Error('Enter a 6-digit authenticator code.');
                }

                const isValid = await TOTP.verifyTOTP(this.totpSecret, code);

                if (!isValid) {
                    throw new Error('Authenticator code invalid or expired. Enter the current code from your app.');
                }

                const minutes = Math.max(1, Math.floor(Number(durationMinutes) || 45));

                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const iterations = 250000;
                const encoder = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(code),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );

                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt,
                        iterations,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );

                const encryptedPassword = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    encoder.encode(password)
                );

                return {
                    version: 1,
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + minutes * 60 * 1000).toISOString(),
                    durationMinutes: minutes,
                    salt: Array.from(salt),
                    iv: Array.from(iv),
                    encryptedPassword: Array.from(new Uint8Array(encryptedPassword)),
                    iterations
                };
            }

            async prepareTemporaryAccessForSave(password) {
                const toggle = document.getElementById('enableTemporaryAccess');
                const wantsTemporaryAccess = Boolean(toggle?.checked);
                const result = { temporaryAccess: undefined, clearTemporaryAccess: false };

                if (!this.requires2FA) {
                    if (this.pendingTemporaryAccessRemoval || this.temporaryAccess) {
                        result.clearTemporaryAccess = Boolean(this.pendingTemporaryAccessRemoval || this.temporaryAccess);
                    }
                    return result;
                }

                if (wantsTemporaryAccess) {
                    const codeInput = document.getElementById('temporaryAccessCode');
                    const code = codeInput?.value?.trim() || '';
                    const durationSelect = document.getElementById('temporaryAccessDuration');
                    const parsedDuration = parseInt(durationSelect?.value || '45', 10);
                    const duration = Number.isNaN(parsedDuration) ? 45 : parsedDuration;

                    if (!/^\d{6}$/.test(code)) {
                        alert('Enter the 6-digit code from your authenticator app to grant temporary access.');
                        return null;
                    }

                    try {
                        const config = await this.createTemporaryAccess(password, code, duration);
                        result.temporaryAccess = config;
                        result.clearTemporaryAccess = false;
                    } catch (error) {
                        alert(error.message || 'Unable to enable temporary access. Try again with a fresh code.');
                        return null;
                    }
                } else if (this.pendingTemporaryAccessRemoval) {
                    result.clearTemporaryAccess = true;
                }

                if (!wantsTemporaryAccess && !this.pendingTemporaryAccessRemoval && this.temporaryAccess && !this.isTemporaryAccessActive()) {
                    result.clearTemporaryAccess = true;
                }

                return result;
            }

            async tryUnlockWithTemporaryAccess(code) {
                if (!this.temporaryAccess) {
                    throw new Error('Temporary access is not enabled for this vault.');
                }

                if (!/^\d{6}$/.test(code)) {
                    throw new Error('Enter the 6-digit temporary code provided to you.');
                }

                if (!this.isTemporaryAccessActive()) {
                    throw new Error('This temporary access code has expired. Ask the vault owner for a new code.');
                }

                const { salt: saltArray, iv: ivArray, encryptedPassword: cipherArray } = this.temporaryAccess;

                if (!Array.isArray(saltArray) || !Array.isArray(ivArray) || !Array.isArray(cipherArray)) {
                    throw new Error('Temporary access data is unavailable. Ask the vault owner for a new code.');
                }

                const encoder = new TextEncoder();
                const salt = new Uint8Array(saltArray);
                const iv = new Uint8Array(ivArray);
                const encryptedPassword = new Uint8Array(cipherArray);
                const iterations = this.temporaryAccess.iterations || 250000;

                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(code),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );

                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt,
                        iterations,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['decrypt']
                );

                try {
                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv },
                        key,
                        encryptedPassword
                    );

                    const decoder = new TextDecoder();
                    return decoder.decode(decrypted);
                } catch (error) {
                    throw new Error('Incorrect temporary access code.');
                }
            }

            normalizeRecoveryKey(input) {
                if (!input) {
                    return '';
                }

                return input.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
            }

            formatRecoveryKey(rawKey) {
                if (!rawKey) {
                    return '';
                }

                return rawKey.match(/.{1,4}/g)?.join('-') || rawKey;
            }

            generateRecoveryKey() {
                const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                const bytes = crypto.getRandomValues(new Uint8Array(32));
                let key = '';

                for (let i = 0; i < bytes.length; i++) {
                    key += alphabet[bytes[i] % alphabet.length];
                }

                return key;
            }

            bufferToBase64(buffer) {
                return btoa(String.fromCharCode(...new Uint8Array(buffer)));
            }

            async computeRecoveryFingerprint(recoveryKey) {
                if (!recoveryKey) {
                    return '';
                }

                const encoder = new TextEncoder();
                const digest = await crypto.subtle.digest('SHA-256', encoder.encode(recoveryKey));
                return this.bufferToBase64(digest);
            }

            async createRecoveryAccess(password, recoveryKey) {
                if (!password || !recoveryKey) {
                    throw new Error('Missing recovery key requirements.');
                }

                const encoder = new TextEncoder();
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const iterations = 600000;

                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(recoveryKey),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );

                const derivedKey = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt,
                        iterations,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );

                const encryptedPassword = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    derivedKey,
                    encoder.encode(password)
                );

                const fingerprint = await this.computeRecoveryFingerprint(recoveryKey);

                return {
                    version: 1,
                    createdAt: new Date().toISOString(),
                    salt: Array.from(salt),
                    iv: Array.from(iv),
                    encryptedPassword: Array.from(new Uint8Array(encryptedPassword)),
                    iterations,
                    fingerprint
                };
            }

            async tryUnlockWithRecoveryKey(recoveryKey) {
                if (!this.recoveryAccess) {
                    throw new Error('Recovery key is not enabled for this vault.');
                }

                const normalizedKey = this.normalizeRecoveryKey(recoveryKey);

                if (normalizedKey.length < 24) {
                    throw new Error('Enter the full recovery key exactly as provided.');
                }

                const fingerprint = await this.computeRecoveryFingerprint(normalizedKey);
                if (this.recoveryAccess.fingerprint && fingerprint !== this.recoveryAccess.fingerprint) {
                    throw new Error('Incorrect recovery key.');
                }

                const encoder = new TextEncoder();
                const saltArray = this.recoveryAccess.salt;
                const ivArray = this.recoveryAccess.iv;
                const encryptedArray = this.recoveryAccess.encryptedPassword;

                if (!Array.isArray(saltArray) || !Array.isArray(ivArray) || !Array.isArray(encryptedArray)) {
                    throw new Error('Recovery key data is missing. Generate a new recovery key.');
                }

                const salt = new Uint8Array(saltArray);
                const iv = new Uint8Array(ivArray);
                const encryptedPassword = new Uint8Array(encryptedArray);
                const iterations = this.recoveryAccess.iterations || 600000;

                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(normalizedKey),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );

                const derivedKey = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt,
                        iterations,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['decrypt']
                );

                try {
                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv },
                        derivedKey,
                        encryptedPassword
                    );

                    const decoder = new TextDecoder();
                    return decoder.decode(decrypted);
                } catch (error) {
                    throw new Error('Unable to unlock with that recovery key. Double-check the key you saved.');
                }
            }

            updateRecoveryFieldVisibility() {
                const field = document.getElementById('recoveryKeyField');
                const input = document.getElementById('recovery-key');

                if (!field) {
                    return;
                }

                if (this.recoveryAccess) {
                    field.style.display = 'block';
                } else {
                    field.style.display = 'none';
                    if (input instanceof HTMLInputElement) {
                        input.value = '';
                    }
                }
            }

            renderRecoveryKeyStatus() {
                const statusEl = document.getElementById('recoveryKeyStatus');
                const display = document.getElementById('recoveryKeyDisplay');
                const generateBtn = document.getElementById('generateRecoveryKeyBtn');
                const disableBtn = document.getElementById('disableRecoveryKeyBtn');

                if (!statusEl) {
                    return;
                }

                if (display) {
                    display.style.display = 'none';
                }

                if (this.recoveryAccess) {
                    const createdAt = this.recoveryAccess.createdAt
                        ? new Date(this.recoveryAccess.createdAt).toLocaleString()
                        : '';

                    statusEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20pt;">âœ…</span>
                            <div>
                                <strong>${window.localization?.t('recovery_key_status_enabled', 'Recovery key enabled')}</strong><br>
                                <span style="font-size: 9pt; color: #64748b;">
                                    ${createdAt
                                        ? window.localization?.t('recovery_key_last_generated', 'Generated on {{date}}').replace('{{date}}', createdAt)
                                        : window.localization?.t('recovery_key_ready', 'A recovery key is configured for this vault.')}
                                </span>
                            </div>
                        </div>
                    `;

                    if (generateBtn) {
                        generateBtn.setAttribute('data-i18n-key', 'recovery_key_regenerate');
                        generateBtn.textContent = window.localization?.t('recovery_key_regenerate', 'Regenerate recovery key');
                    }

                    if (disableBtn) {
                        disableBtn.style.display = 'inline-block';
                    }
                } else {
                    statusEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20pt;">ðŸ›¡ï¸</span>
                            <div>
                                <strong>${window.localization?.t('recovery_key_status_disabled', 'No recovery key configured')}</strong><br>
                                <span style="font-size: 9pt; color: #64748b;">
                                    ${window.localization?.t('recovery_key_status_hint', 'Generate a recovery key so you can unlock the vault if you forget the password.')}
                                </span>
                            </div>
                        </div>
                    `;

                    if (generateBtn) {
                        generateBtn.setAttribute('data-i18n-key', 'recovery_key_generate');
                        generateBtn.textContent = window.localization?.t('recovery_key_generate', 'Generate recovery key');
                    }

                    if (disableBtn) {
                        disableBtn.style.display = 'none';
                    }
                }

                this.updateRecoveryFieldVisibility();
            }

            showRecoveryKey(formattedKey) {
                const display = document.getElementById('recoveryKeyDisplay');
                const valueEl = document.getElementById('recoveryKeyValue');

                if (!display || !valueEl) {
                    return;
                }

                valueEl.textContent = formattedKey;
                display.style.display = 'block';
                display.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            async handleGenerateRecoveryKey() {
                if (!this.sessionPassword) {
                    alert('Unlock the vault before generating a recovery key.');
                    return;
                }

                if (this.recoveryAccess) {
                    const confirmed = window.confirm('Generating a new recovery key will replace the existing one. Continue?');
                    if (!confirmed) {
                        return;
                    }
                }

                try {
                    const rawKey = this.generateRecoveryKey();
                    const formattedKey = this.formatRecoveryKey(rawKey);
                    const normalizedKey = this.normalizeRecoveryKey(rawKey);
                    const recoveryAccess = await this.createRecoveryAccess(this.sessionPassword, normalizedKey);

                    this.recoveryAccess = recoveryAccess;
                    this.renderRecoveryKeyStatus();
                    this.showRecoveryKey(formattedKey);
                    this.hasUnsavedChanges = true;
                    this.updateSaveStatus();

                    alert('âœ… Recovery key generated!\n\nCopy the key shown and store it in a secure location.\nDownload a new .ehv file after saving so this backup is preserved.');
                } catch (error) {
                    console.error('Failed to generate recovery key', error);
                    alert('Unable to generate recovery key. Try again.');
                }
            }

            handleDisableRecoveryKey() {
                if (!this.recoveryAccess) {
                    alert('No recovery key is currently configured.');
                    return;
                }

                const confirmed = window.confirm('Remove the recovery key? You will no longer be able to unlock with it.');
                if (!confirmed) {
                    return;
                }

                this.recoveryAccess = null;
                const display = document.getElementById('recoveryKeyDisplay');
                if (display) {
                    display.style.display = 'none';
                }

                this.renderRecoveryKeyStatus();
                this.hasUnsavedChanges = true;
                this.updateSaveStatus();

                alert('Recovery key removed. Save and download a new vault file to finalize this change.');
            }

            initializePasswordGuidance() {
                const passwordInput = document.getElementById('modalPassword');
                if (passwordInput && !passwordInput.dataset.guidanceBound) {
                    passwordInput.addEventListener('input', () => this.handlePasswordInputChange());
                    passwordInput.addEventListener('focus', () => this.handlePasswordInputChange());
                    passwordInput.dataset.guidanceBound = 'true';
                }

                const enable2FA = document.getElementById('enable2FA');
                if (enable2FA && !enable2FA.dataset.guidanceBound) {
                    enable2FA.addEventListener('change', () => {
                        this.updatePasswordRequirementsDisplay();
                        this.handlePasswordInputChange();
                    });
                    enable2FA.dataset.guidanceBound = 'true';
                }

                this.updatePasswordRequirementsDisplay();
                this.handlePasswordInputChange();
            }

            updatePasswordRequirementsDisplay() {
                const requirementsDisplay = document.getElementById('passwordRequirements');
                if (!requirementsDisplay) {
                    return;
                }

                const has2FA = Boolean(document.getElementById('enable2FA')?.checked);

                if (has2FA) {
                    requirementsDisplay.innerHTML = `
                        <div class="info-box">
                            âœ… <strong>2FA Enabled</strong> - Standard password requirements:
                            <ul>
                                <li>At least 12 characters</li>
                                <li>Mix of uppercase, lowercase, and numbers</li>
                            </ul>
                        </div>
                    `;
                } else {
                    requirementsDisplay.innerHTML = `
                        <div class="warning-box">
                            âš ï¸ <strong>No 2FA</strong> - Strong password required:
                            <ul>
                                <li>At least 16 characters</li>
                                <li>Uppercase, lowercase, numbers, and special characters</li>
                                <li>Must not be a common password</li>
                                <li>High entropy (random characters preferred)</li>
                            </ul>
                            <p style="margin-top: 10px;">
                                <strong>Recommendation:</strong> Enable 2FA for easier password requirements
                            </p>
                        </div>
                    `;
                }
            }

            handlePasswordInputChange() {
                const passwordInput = document.getElementById('modalPassword');
                if (!passwordInput) {
                    return;
                }

                const password = passwordInput.value || '';
                const has2FA = Boolean(document.getElementById('enable2FA')?.checked);

                if (!password) {
                    this.resetStrengthBars();
                    this.clearPasswordFeedback();
                    return;
                }

                const validation = this.validatePasswordRequirements(password, has2FA);
                const strength = this.calculatePasswordStrength(password, has2FA);
                this.updateStrengthBars(strength);

                if (validation.valid) {
                    this.showPasswordFeedback('âœ“ Password meets requirements', 'success');
                } else {
                    this.showPasswordFeedback(validation.message, 'warning');
                }
            }

            updateStrengthBars(strength) {
                const container = document.getElementById('passwordStrength');
                const bars = [
                    document.getElementById('strength1'),
                    document.getElementById('strength2'),
                    document.getElementById('strength3'),
                    document.getElementById('strength4')
                ];

                if (!container || bars.some(bar => !bar)) {
                    return;
                }

                if (!strength || Number.isNaN(strength.score)) {
                    container.style.display = 'none';
                    bars.forEach((bar) => {
                        bar.classList.remove('active', 'weak', 'medium');
                    });
                    return;
                }

                container.style.display = 'flex';

                const activeBars = Math.max(1, Math.min(4, Math.ceil((strength.score / 100) * 4)));

                bars.forEach((bar, index) => {
                    bar.classList.remove('active', 'weak', 'medium');
                    if (index < activeBars) {
                        bar.classList.add('active');
                        if (strength.level === 'weak') {
                            bar.classList.add('weak');
                        } else if (strength.level === 'medium') {
                            bar.classList.add('medium');
                        }
                    }
                });
            }

            resetStrengthBars() {
                const container = document.getElementById('passwordStrength');
                const bars = [
                    document.getElementById('strength1'),
                    document.getElementById('strength2'),
                    document.getElementById('strength3'),
                    document.getElementById('strength4')
                ];

                if (container) {
                    container.style.display = 'none';
                }

                bars.forEach((bar) => {
                    if (bar) {
                        bar.classList.remove('active', 'weak', 'medium');
                    }
                });
            }

            showPasswordFeedback(message, type = 'info') {
                const feedback = document.getElementById('passwordFeedback');
                if (!feedback) {
                    return;
                }

                feedback.textContent = message;
                feedback.classList.remove('success', 'warning');

                if (type === 'success') {
                    feedback.classList.add('success');
                } else if (type === 'warning') {
                    feedback.classList.add('warning');
                }
            }

            clearPasswordFeedback() {
                const feedback = document.getElementById('passwordFeedback');
                if (!feedback) {
                    return;
                }

                feedback.textContent = '';
                feedback.classList.remove('success', 'warning');
            }

            validatePasswordRequirements(password, has2FA) {
                const requirements = {
                    minLength: has2FA ? 12 : 16,
                    requireUpper: true,
                    requireLower: true,
                    requireNumber: true,
                    requireSpecial: !has2FA,
                    requireNotCommon: !has2FA,
                    minEntropy: has2FA ? 50 : 60
                };

                if ((password || '').length < requirements.minLength) {
                    return {
                        valid: false,
                        message: has2FA
                            ? `Password must be at least ${requirements.minLength} characters`
                            : `Without 2FA, password must be at least ${requirements.minLength} characters for security`
                    };
                }

                const checks = {
                    hasUpper: /[A-Z]/.test(password),
                    hasLower: /[a-z]/.test(password),
                    hasNumber: /[0-9]/.test(password),
                    hasSpecial: /[!@#$%^&*(),.?":{}|<>\[\];'`~\\/+-=]/.test(password)
                };

                const missing = [];
                if (requirements.requireUpper && !checks.hasUpper) missing.push('uppercase letter');
                if (requirements.requireLower && !checks.hasLower) missing.push('lowercase letter');
                if (requirements.requireNumber && !checks.hasNumber) missing.push('number');
                if (requirements.requireSpecial && !checks.hasSpecial) missing.push('special character (!@#$%^&*)');

                if (missing.length > 0) {
                    return {
                        valid: false,
                        message: `Password must include: ${missing.join(', ')}`
                    };
                }

                if (requirements.requireNotCommon && this.isCommonPassword(password)) {
                    return {
                        valid: false,
                        message: 'This password is too common. Please choose a unique password.'
                    };
                }

                const entropy = this.calculateEntropy(password);
                if (entropy < requirements.minEntropy) {
                    return {
                        valid: false,
                        message: 'Password entropy is too low. Use a more random combination of characters.'
                    };
                }

                return { valid: true };
            }

            calculatePasswordStrength(password, has2FA) {
                if (!password) {
                    return { score: 0, level: 'weak' };
                }

                const checks = {
                    length: password.length >= (has2FA ? 12 : 16),
                    upper: /[A-Z]/.test(password),
                    lower: /[a-z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[!@#$%^&*(),.?":{}|<>\[\];'`~\\/+-=]/.test(password),
                    notCommon: !this.isCommonPassword(password),
                    entropy: this.calculateEntropy(password) > (has2FA ? 50 : 60)
                };

                const requiredChecks = has2FA
                    ? ['length', 'upper', 'lower', 'number']
                    : ['length', 'upper', 'lower', 'number', 'special', 'notCommon', 'entropy'];

                const passed = requiredChecks.filter(check => checks[check]).length;
                const total = requiredChecks.length;
                const score = (passed / total) * 100;

                let level = 'weak';
                if (passed === total) {
                    level = 'strong';
                } else if (passed > total / 2) {
                    level = 'medium';
                }

                return { score, level };
            }

            isCommonPassword(password) {
                if (!password) {
                    return false;
                }

                const normalized = password.toLowerCase();
                return this.commonPasswords.some(common => normalized.includes(common.toLowerCase()));
            }

            calculateEntropy(password) {
                if (!password) {
                    return 0;
                }

                const uniqueChars = new Set(password);
                const charsetSize = Math.max(uniqueChars.size, 1);
                return password.length * Math.log2(charsetSize);
            }

            getApplicationHTML() {
                const clone = document.documentElement.cloneNode(true);
                const dataScript = clone.querySelector('#embedded-vault-data');
                if (dataScript) {
                    dataScript.textContent = '';
                }

                return '<!DOCTYPE html>\n' + clone.outerHTML;
            }

            extractCriticalCode(html) {
                const scriptMatches = html.match(/<script[^>]*>([\s\S]*?)<\/script>/gi) || [];
                return scriptMatches
                    .filter(script => !/\ssrc\s*=/.test(script))
                    .map(script => script.replace(/<\/?script[^>]*>/gi, ''))
                    .join('\n');
            }

            async hashCode(htmlContent) {
                const criticalSections = this.extractCriticalCode(htmlContent);
                const encoder = new TextEncoder();
                const webCrypto = window.crypto || globalThis.crypto;

                if (!webCrypto?.subtle) {
                    return '';
                }

                const hashBuffer = await webCrypto.subtle.digest(
                    'SHA-256',
                    encoder.encode(criticalSections || htmlContent)
                );

                return btoa(String.fromCharCode(...new Uint8Array(hashBuffer)));
            }

            async deriveHMACKey(password) {
                const encoder = new TextEncoder();
                const webCrypto = window.crypto || globalThis.crypto;

                if (!webCrypto?.subtle) {
                    console.warn('WebCrypto is unavailable for integrity verification.');
                    return null;
                }

                const keyMaterial = await webCrypto.subtle.importKey(
                    'raw',
                    encoder.encode(`${password}:HMAC_KEY`),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );

                return await webCrypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: encoder.encode('HealthVault-HMAC-v1'),
                        iterations: 600000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'HMAC', hash: 'SHA-256', length: 256 },
                    false,
                    ['sign', 'verify']
                );
            }

            async createHMAC(key, data) {
                const encoder = new TextEncoder();
                const webCrypto = window.crypto || globalThis.crypto;

                if (!webCrypto?.subtle) {
                    console.warn('WebCrypto is unavailable for integrity verification.');
                    return '';
                }

                const signature = await webCrypto.subtle.sign(
                    'HMAC',
                    key,
                    encoder.encode(data)
                );

                return btoa(String.fromCharCode(...new Uint8Array(signature)));
            }

            async verifyVaultIntegrity(integrity, password) {
                if (!integrity) {
                    return;
                }

                const { codeHash, codeSignature } = integrity;
                if (!codeHash && !codeSignature) {
                    return;
                }

                const htmlContent = this.getApplicationHTML();

                if (codeHash) {
                    const currentHash = await this.hashCode(htmlContent);
                    if (currentHash !== codeHash) {
                        throw new Error('TAMPERING_DETECTED');
                    }
                }

                if (codeSignature) {
                    const hmacKey = await this.deriveHMACKey(password);
                    if (hmacKey) {
                        const expectedSignature = await this.createHMAC(hmacKey, htmlContent);
                        if (expectedSignature && expectedSignature !== codeSignature) {
                            throw new Error('TAMPERING_DETECTED');
                        }
                    }
                }
            }

            showTamperingAlert() {
                if (document.getElementById('tamperingAlertModal')) {
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.id = 'tamperingAlertModal';
                modal.innerHTML = `
                    <div class="modal-content" style="border: 3px solid #dc2626; max-width: 480px;">
                        <div class="modal-header">
                            <h3 style="color: #dc2626;">âš ï¸ SECURITY WARNING</h3>
                        </div>
                        <div class="modal-body">
                            <div class="danger-box">
                                <strong>This vault file has been modified!</strong>
                            </div>
                            <p>The application code has been altered since this vault was last saved.</p>
                            <p><strong>This could indicate:</strong></p>
                            <ul>
                                <li>Malicious tampering</li>
                                <li>An attempt to steal your password</li>
                                <li>A corrupted or damaged file</li>
                            </ul>
                            <p><strong>Do not proceed unless you understand why this happened.</strong></p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="window.location.reload()">
                                Close Without Unlocking
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            async handlePasswordSubmit() {
                const password = document.getElementById('modalPassword').value;
                const confirmPassword = document.getElementById('modalConfirmPassword').value;
                const enable2FA = document.getElementById('enable2FA')?.checked;

                if (!password) {
                    alert('Please enter a password');
                    return;
                }

                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }

                const validation = this.validatePasswordRequirements(password, Boolean(enable2FA));
                if (!validation.valid) {
                    this.showPasswordFeedback(validation.message, 'warning');
                    alert(validation.message);
                    return;
                }

                this.sessionPassword = password;
                this.applySetupModuleSelections();
                this.closePasswordModal();

                if (enable2FA) {
                    this.requires2FA = true;
                    this.totpSetupContext = 'initial';
                    this.setupTOTP();
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('navTabs').style.display = 'block';

                    const lockBtn = document.getElementById('lockBtn');
                    if (lockBtn) {
                        lockBtn.style.display = 'inline-block';
                        lockBtn.setAttribute('data-i18n-key', 'unlock_action');
                        lockBtn.textContent = window.localization?.t('unlock_action', 'ðŸ”“ Lock');
                    }

                    this.isInitialized = true;
                    this.hasUnsavedChanges = true;
                    this.updateSaveStatus();

                    this._lockTimeoutHandled = false;
                    this._lastActivityUpdate = Date.now();
                    this.startLockCountdown();
                    this.updateLockTimerDisplay();

                    alert(`âœ… Vault created!\n\n` +
                          `Your vault "${this.vaultIdentity}" is ready to use.\n\n` +
                          `â€¢ Enter your medical information\n` +
                          `â€¢ Click "Download Encrypted Vault" when ready to save\n` +
                          `â€¢ Keep your password safe - there's no recovery without it`);
                }
            }

            async handlePasswordUpdateSubmit() {
                const selectedOption = document.querySelector('input[name="passwordUpdateChoice"]:checked');
                const choice = selectedOption ? selectedOption.value : 'keep';

                if (choice === 'keep' && !this.sessionPassword) {
                    this.closePasswordUpdateModal();
                    this.showPasswordModal();
                    return;
                }

                let passwordToUse = this.sessionPassword;

                if (choice === 'change') {
                    const newPassword = document.getElementById('updateNewPassword')?.value || '';
                    const confirmPassword = document.getElementById('updateConfirmPassword')?.value || '';

                    if (!newPassword) {
                        alert('Please enter a new password');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        alert('New passwords do not match');
                        return;
                    }

                    const validation = this.validatePasswordRequirements(newPassword, this.requires2FA);
                    if (!validation.valid) {
                        alert(validation.message);
                        return;
                    }

                    passwordToUse = newPassword;
                }

                const temporaryAccessOptions = await this.prepareTemporaryAccessForSave(passwordToUse);

                if (temporaryAccessOptions === null) {
                    return;
                }

                this.closePasswordUpdateModal();

                if (choice === 'change') {
                    this.sessionPassword = passwordToUse;
                }

                await this.performSave(passwordToUse, temporaryAccessOptions);
            }

            async performSave(password, options = {}) {
                this.version = APP_VERSION;
                this.schemaVersion = schemaManager.currentVersion;
                this.applyVersionMetadata();

                const formData = this.collectFormData();
                const emergencyAccess = this.collectEmergencyData(formData);
                const timestamp = new Date().toLocaleString();

                document.getElementById('lastUpdatedHeader').textContent = `Last Updated: ${timestamp}`;
                formData.lastUpdated = timestamp;

                try {
                    const htmlContent = this.getApplicationHTML();
                    const codeHash = await this.hashCode(htmlContent);
                    const hmacKey = await this.deriveHMACKey(password);
                    const codeSignature = await this.createHMAC(hmacKey, htmlContent);

                    formData.codeHash = codeHash;
                    formData.codeSignature = codeSignature;
                } catch (error) {
                    console.warn('Unable to generate integrity metadata', error);
                }

                const encrypted = await this.crypto.encrypt(formData, password);

                const htmlDoc = document.documentElement.cloneNode(true);

                const existingData = htmlDoc.querySelector('#embedded-vault-data');
                if (existingData) {
                    existingData.textContent = '';
                }
                
                const dataScript = htmlDoc.querySelector('#embedded-vault-data');

                if (options?.temporaryAccess) {
                    this.temporaryAccess = options.temporaryAccess;
                } else if (options?.clearTemporaryAccess) {
                    this.temporaryAccess = null;
                }

                const vaultData = {
                    initialized: true,
                    encrypted: true,
                    version: schemaManager.currentVersion,
                    schemaVersion: schemaManager.currentVersion,
                    appVersion: APP_VERSION,
                    savedDate: new Date().toISOString(),
                    data: encrypted,
                    modules: this.modules,
                    requires2FA: this.requires2FA,
                    vaultIdentity: this.vaultIdentity,
                    emergencyAccess: emergencyAccess,
                    temporaryAccess: this.temporaryAccess || null,
                    recoveryAccess: this.recoveryAccess || null
                };

                const vaultJSON = JSON.stringify(vaultData);
                const pakoInstance = this.getCompressionLibrary();

                if (pakoInstance && typeof pakoInstance.deflate === 'function') {
                    try {
                        const compressed = pakoInstance.deflate(vaultJSON, { level: 9 });
                        const binary = String.fromCharCode(...compressed);
                        const base64 = btoa(binary);

                        dataScript.textContent = JSON.stringify({
                            compressed: true,
                            data: base64
                        });
                    } catch (error) {
                        console.warn('Vault compression failed, storing uncompressed', error);
                        dataScript.textContent = JSON.stringify(vaultData);
                    }
                } else {
                    dataScript.textContent = JSON.stringify(vaultData);
                }

                this.emergencyAccessConfig = emergencyAccess;
                this.pendingTemporaryAccessRemoval = false;

                const htmlString = '<!DOCTYPE html>\n' + htmlDoc.outerHTML;
                
                const blob = new Blob([htmlString], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `health_vault_${this.vaultIdentity}_${new Date().toISOString().split('T')[0]}.ehv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.hasUnsavedChanges = false;
                this.isInitialized = true;
                this.updateSaveStatus();
                this.pendingSchemaNotice = null;
                this.updateTemporaryAccessHint();

                if (document.getElementById('totpStatus')) {
                    this.renderTOTPStatus();
                }

                const isFirstSave = !this.hasShownSaveInstructions;
                this.hasShownSaveInstructions = true;
                
                if (isFirstSave) {
                    alert('âœ… Your health vault has been saved!\n\n' +
                          'ðŸ“ IMPORTANT INSTRUCTIONS:\n' +
                          '1. The downloaded .ehv file contains all your encrypted data\n' +
                          '2. Store this file in a safe location\n' +
                          '3. Make backups on different devices or cloud storage\n' +
                          '4. You can open this file in any web browser\n\n' +
                          'ðŸ” Remember:\n' +
                          'â€¢ Your password is NOT recoverable if lost\n' +
                          'â€¢ Each save creates a new file - replace the old one\n' +
                          'â€¢ The vault file works completely offline');
                } else {
                    alert('âœ… Vault updated and downloaded!\n\n' +
                          'Replace your previous .ehv vault file with this new version.');
                }
            }
            
            getFieldValue(fieldName, options = {}) {
                const { trim = false, includeEmpty = false } = options;
                const keys = Array.from(new Set(fieldRegistry.getAllKeys(fieldName)));

                for (const key of keys) {
                    const element = document.querySelector(`.form-data[data-field="${key}"]`);
                    if (!element) {
                        continue;
                    }

                    if (element.type === 'checkbox') {
                        return element.checked;
                    }

                    let value = element.value;
                    if (typeof value === 'string' && trim) {
                        value = value.trim();
                    }

                    if (!includeEmpty && typeof value === 'string' && value === '') {
                        continue;
                    }

                    if (value !== undefined && value !== null) {
                        return value;
                    }
                }

                if (trim || includeEmpty) {
                    return '';
                }

                return undefined;
            }

            collectFormData() {
                const formData = {};
                const inputs = document.querySelectorAll('.form-data');

                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (!field) {
                        return;
                    }

                    const value = input.type === 'checkbox' ? input.checked : input.value;
                    fieldRegistry.assignValue(formData, field, value);
                });

                if (this.requires2FA && this.totpSecret) {
                    formData.totpSecret = this.totpSecret;
                }

                formData.schemaVersion = schemaManager.currentVersion;
                formData.appVersion = APP_VERSION;

                return formData;
            }

            collectEmergencyData(formData) {
                if (!formData || !formData.emergencyAccessEnabled) {
                    return null;
                }

                const emergencyData = {};
                const trimValue = (value) => typeof value === 'string' ? value.trim() : value;

                if (formData.showBloodType) {
                    const bloodType = trimValue(formData.bloodType);
                    if (bloodType) {
                        emergencyData.bloodType = bloodType;
                    }
                }

                if (formData.showCriticalAllergies) {
                    const allergies = trimValue(formData.criticalAllergies);
                    if (allergies) {
                        emergencyData.criticalAllergies = allergies;
                    }
                }

                if (formData.showCriticalConditions) {
                    const conditions = trimValue(formData.criticalConditions);
                    if (conditions) {
                        emergencyData.criticalConditions = conditions;
                    }
                }

                if (formData.showAdvanceDirective) {
                    const directive = trimValue(formData.advanceDirective);
                    if (directive) {
                        emergencyData.advanceDirective = directive;
                    }
                }

                if (formData.showCriticalMedications) {
                    const medications = trimValue(formData.medicationContraindications);
                    if (medications) {
                        emergencyData.medications = medications;
                    }
                }

                if (formData.showEmergencyContacts) {
                    const contacts = this.collectListData('emergency-contacts-container')
                        .map(contact => ({
                            name: trimValue(contact.name || ''),
                            relationship: trimValue(contact.relationship || ''),
                            phone: trimValue(contact.phone || ''),
                            altPhone: trimValue(contact.altPhone || '')
                        }))
                        .filter(contact => contact.name && contact.phone);

                    if (contacts.length > 0) {
                        emergencyData.contacts = contacts;
                    }
                }

                return { enabled: true, data: emergencyData };
            }

            loadFormData(data) {
                const normalizedData = fieldRegistry.normalizeIncomingData(data);
                const inputs = document.querySelectorAll('.form-data');

                inputs.forEach(input => {
                    const field = input.dataset.field;
                    const value = fieldRegistry.getValue(normalizedData, field);

                    if (value === undefined) {
                        return;
                    }

                    if (input.type === 'checkbox') {
                        input.checked = Boolean(value);
                    } else {
                        input.value = value;
                    }
                });

                this.updateEmergencySettingsVisibility();

                document.getElementById('lastUpdatedHeader').textContent = `Last Updated: ${normalizedData.lastUpdated || 'Never'}`;
                this.updatePatientSummaryDisplay();
                this.restoreNoteTagsFromStorage();
                this.initializeExistingNotes();
                this.refreshProviderOptions();
                this.refreshAllNoteTagSelectors();
                this.restoreAttachmentsFromStorage(normalizedData.attachments);
            }

            calculateAge(dobString) {
                if (!dobString) return null;

                const dob = new Date(`${dobString}T00:00:00`);
                if (Number.isNaN(dob.getTime())) {
                    return null;
                }

                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }

                return age >= 0 ? age : null;
            }

            updatePatientSummaryDisplay() {
                const nameEl = document.getElementById('patientDisplayName');
                const metaEl = document.getElementById('patientDisplayMeta');

                if (!nameEl || !metaEl) {
                    return;
                }

                const firstName = this.getFieldValue('firstName', { trim: true }) || '';
                const lastName = this.getFieldValue('lastName', { trim: true }) || '';
                const middleInitial = this.getFieldValue('middleInitial', { trim: true }) || '';
                const mrn = this.getFieldValue('mrn', { trim: true }) || '';
                const dob = this.getFieldValue('dateOfBirth', { trim: true }) || '';
                const sex = this.getFieldValue('biologicalSex', { trim: true, includeEmpty: true }) || '';

                const displayNameParts = [];
                if (firstName) displayNameParts.push(firstName);
                if (middleInitial) displayNameParts.push(`${middleInitial.replace(/\./g, '')}.`);
                if (lastName) displayNameParts.push(lastName);

                const displayName = displayNameParts.join(' ').trim();
                nameEl.textContent = displayName || 'Enter patient name';

                const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.trim().toUpperCase();

                const metaParts = [];
                if (dob) {
                    const dobDate = new Date(`${dob}T00:00:00`);
                    if (!Number.isNaN(dobDate.getTime())) {
                        const formattedDOB = dobDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                        const age = this.calculateAge(dob);
                        metaParts.push(`DOB ${formattedDOB}${age !== null ? ` (${age} yrs)` : ''}`);
                    }
                }

                if (sex) {
                    metaParts.push(sex);
                }

                if (mrn) {
                    metaParts.push(`MRN ${mrn}`);
                }

                metaEl.textContent = metaParts.length ? metaParts.join(' â€¢ ') : 'Add DOB, sex, and MRN for quick reference.';
                this.renderPatientAvatar(initials);
            }

            renderPatientAvatar(initials = '') {
                const avatarEl = document.getElementById('patientAvatar');
                const avatarImage = document.getElementById('patientAvatarImage');
                const avatarInitials = document.getElementById('patientAvatarInitials');
                const removeBtn = document.getElementById('removePhotoBtn');
                const storedPhoto = this.getFieldValue('profilePhoto', { includeEmpty: true }) || '';
                const hasPhoto = typeof storedPhoto === 'string' && storedPhoto.trim() !== '';

                if (!avatarEl || !avatarImage || !avatarInitials) {
                    if (removeBtn) {
                        removeBtn.style.display = hasPhoto ? 'inline' : 'none';
                    }
                    return;
                }

                if (hasPhoto) {
                    avatarEl.classList.add('has-photo');
                    avatarImage.src = storedPhoto;
                    avatarImage.style.display = 'block';
                    avatarImage.setAttribute('aria-hidden', 'false');
                    avatarInitials.textContent = '';
                    avatarInitials.style.display = 'none';
                    if (removeBtn) {
                        removeBtn.style.display = 'inline';
                    }
                } else {
                    avatarEl.classList.remove('has-photo');
                    avatarImage.removeAttribute('src');
                    avatarImage.style.display = 'none';
                    avatarImage.setAttribute('aria-hidden', 'true');
                    avatarInitials.textContent = initials || 'ðŸ‘¤';
                    avatarInitials.style.display = 'flex';
                    if (removeBtn) {
                        removeBtn.style.display = 'none';
                    }
                }
            }

            promptProfilePhoto() {
                const input = document.getElementById('profilePhotoInput');
                if (input) {
                    input.click();
                }
            }

            handleProfilePhotoSelect(event) {
                const input = event?.target;
                const file = input?.files && input.files[0];

                if (!file) {
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('Please choose an image file.');
                    input.value = '';
                    return;
                }

                const maxSize = 5 * 1024 * 1024; // 5 MB
                if (file.size > maxSize) {
                    alert('Image is too large. Please choose a file under 5 MB.');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = () => {
                    const result = typeof reader.result === 'string' ? reader.result : '';
                    if (result && result.startsWith('data:image')) {
                        this.applyProfilePhotoData(result);
                    } else {
                        alert('Unable to read image data. Please try a different file.');
                    }
                    input.value = '';
                };

                reader.onerror = () => {
                    alert('Failed to load image. Please try again.');
                    input.value = '';
                };

                reader.readAsDataURL(file);
            }

            applyProfilePhotoData(dataUrl) {
                const hiddenInput = document.getElementById('profilePhotoData');
                if (!hiddenInput) {
                    return;
                }

                hiddenInput.value = dataUrl;
                this.markAsChanged();
                this.updatePatientSummaryDisplay();
            }

            removeProfilePhoto() {
                const hiddenInput = document.getElementById('profilePhotoData');
                if (!hiddenInput) {
                    return;
                }

                if (!hiddenInput.value) {
                    return;
                }

                hiddenInput.value = '';

                const fileInput = document.getElementById('profilePhotoInput');
                if (fileInput) {
                    fileInput.value = '';
                }

                this.markAsChanged();
                this.updatePatientSummaryDisplay();
            }

            updateEmergencySettingsVisibility() {
                const emergencyOptions = document.getElementById('emergencyOptions');
                const emergencyToggle = document.getElementById('emergency-enabled');

                if (!emergencyOptions || !emergencyToggle) {
                    return;
                }

                emergencyOptions.style.display = emergencyToggle.checked ? 'block' : 'none';
            }

            openSettings() {
                const modal = document.getElementById('settingsModal');
                modal.classList.add('active');
                this.applyVersionMetadata();

                document.getElementById('module-identity').checked = this.modules.identity;
                document.getElementById('module-gac').checked = this.modules.gac;
                document.getElementById('module-mental').checked = this.modules.mental;
                document.getElementById('module-chronic').checked = this.modules.chronic;

                this.renderTOTPStatus();
                this.renderRecoveryKeyStatus();

                this.updateEmergencySettingsVisibility();
            }
            
            closeSettings() {
                document.getElementById('settingsModal').classList.remove('active');
            }
            
            saveSettings() {
                this.closeSettings();
            }

            setupTOTP() {
                const secret = this.generateTOTPSecret();
                this.currentTOTPSecret = secret;
                
                const modal = document.getElementById('totpModal');
                modal.classList.add('active');
                
                document.getElementById('totpSecret').textContent = this.formatSecret(secret);
                
                const issuer = 'HealthVault';
                const label = this.vaultIdentity;
                
                const qrContainer = document.getElementById('totpQR');
                qrContainer.innerHTML = '';
                
                QRGenerator.generateOTPAuth(secret, label, issuer, qrContainer);
                
                const backupNote = `
                    <div class="warning-box">
                        <strong>âš ï¸ Important Security Notice:</strong><br>
                        Your authenticator code becomes part of your encryption key.<br>
                        You will need BOTH your password AND a valid code to unlock your vault.<br><br>
                        <strong>Make sure to:</strong><br>
                        â€¢ Save this secret in multiple authenticator apps<br>
                        â€¢ Write down the secret key shown above<br>
                        â€¢ Test that your code works before saving<br><br>
                        <strong>Compatible with:</strong> Google Authenticator, Microsoft Authenticator, Authy, 1Password, etc.
                    </div>
                `;
                document.getElementById('backupCodes').parentElement.innerHTML = backupNote;
            }

            renderTOTPStatus() {
                const statusDiv = document.getElementById('totpStatus');

                if (!statusDiv) {
                    return;
                }

                if (this.requires2FA) {
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20pt;">âœ…</span>
                            <div>
                                <strong style="color: #22c55e;">Two-Factor Authentication Enabled</strong><br>
                                <span style="font-size: 9pt; color: #64748b;">
                                    Your vault requires password + authenticator code
                                </span>
                            </div>
                        </div>
                        <p style="margin-top: 10px; font-size: 9pt; color: #94a3b8;">
                            Use your authenticator app when unlocking this vault.
                            Download a fresh vault whenever you save updates.
                        </p>
                    `;

                    if (this.temporaryAccess) {
                        const expiry = this.getTemporaryAccessExpiry();
                        const message = this.isTemporaryAccessActive() && expiry
                            ? `Temporary TOTP-only access active until ${expiry.toLocaleString()}.`
                            : 'Temporary TOTP-only access expired. Save a new vault to remove or renew it.';

                        statusDiv.insertAdjacentHTML(
                            'beforeend',
                            `<div style="margin-top: 12px; padding: 10px; background: #fff7ed; border: 1px solid #fdba74; border-radius: 6px; font-size: 9pt; color: #9a3412;">${this.escapeHTML(message)}</div>`
                        );
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20pt;">ðŸ”“</span>
                            <div>
                                <strong>Two-Factor Authentication Disabled</strong><br>
                                <span style="font-size: 9pt; color: #64748b;">
                                    Your vault is protected by password only
                                </span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-save" id="enableTOTPButton" style="margin-top: 15px;">
                            Enable Two-Factor Authentication
                        </button>
                        <p style="margin-top: 10px; font-size: 9pt; color: #94a3b8;">
                            Add authenticator codes at any time.
                            After enabling, download a new encrypted vault to lock in the change.
                        </p>
                    `;

                    const enableButton = document.getElementById('enableTOTPButton');
                    if (enableButton) {
                        enableButton.addEventListener('click', () => this.beginTOTPSetup());
                    }
                }
            }

            beginTOTPSetup() {
                this.totpSetupContext = this.isInitialized ? 'upgrade' : 'initial';
                this.setupTOTP();
            }

            generateTOTPSecret() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                let secret = '';
                for (let i = 0; i < 16; i++) {
                    secret += chars[Math.floor(Math.random() * chars.length)];
                }
                return secret;
            }
            
            formatSecret(secret) {
                return secret.match(/.{1,4}/g).join(' ');
            }
            
            async verifyTOTP() {
                const code = document.getElementById('verifyTOTP').value;
                
                if (code.length !== 6 || !/^\d{6}$/.test(code)) {
                    alert('Please enter a 6-digit code from your authenticator app');
                    return;
                }
                
                const isValid = await TOTP.verifyTOTP(this.currentTOTPSecret, code);

                if (!isValid) {
                    alert('Invalid code. Please make sure you\'ve added the secret to your authenticator app and try the current code shown.');
                    return;
                }

                this.totpSecret = this.currentTOTPSecret;
                this.requires2FA = true;

                const wasUpgrade = this.totpSetupContext === 'upgrade';
                this.totpSetupContext = null;

                document.getElementById('totpModal').classList.remove('active');
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('navTabs').style.display = 'block';
                const totpField = document.getElementById('totpField');
                if (totpField) {
                    totpField.style.display = 'block';
                }

                this.isInitialized = true;
                this.hasUnsavedChanges = true;
                this.updateSaveStatus();

                if (document.getElementById('totpStatus')) {
                    this.renderTOTPStatus();
                }

                const successMessage = wasUpgrade
                    ? 'âœ… Two-factor authentication enabled!\n\n' +
                        'Your vault now requires both your password and a 6-digit authenticator code to unlock.\n\n' +
                        'âš ï¸ Important: Download a new encrypted vault file before closing to preserve this change.'
                    : 'âœ… Two-factor authentication enabled!\n\n' +
                        `Your vault "${this.vaultIdentity}" is ready to use.\n\n` +
                        'â€¢ Enter your medical information\n' +
                        'â€¢ Click "Download Encrypted Vault" when ready to save\n' +
                        'â€¢ You\'ll need both password AND authenticator code to unlock';

                alert(successMessage);

                this.currentTOTPSecret = null;
            }

            cancelTOTP() {
                this.currentTOTPSecret = null;
                const wasUpgrade = this.totpSetupContext === 'upgrade';
                this.totpSetupContext = null;
                document.getElementById('totpModal').classList.remove('active');

                if (!this.isInitialized) {
                    this.requires2FA = false;
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('navTabs').style.display = 'block';
                    
                    this.isInitialized = true;
                    this.hasUnsavedChanges = true;
                    this.updateSaveStatus();
                    
                    alert(`âœ… Vault created without 2FA!\n\n` +
                          `Your vault "${this.vaultIdentity}" is ready to use.\n\n` +
                          `â€¢ Enter your medical information\n` +
                          `â€¢ Click "Download Encrypted Vault" when ready to save\n` +
                          `â€¢ Keep your password safe - there's no recovery without it`);
                } else if (wasUpgrade) {
                    this.requires2FA = false;
                    if (document.getElementById('totpStatus')) {
                        this.renderTOTPStatus();
                    }
                }
            }
            
            // Enhanced medication addition with search
            addMedication() {
                const container = document.getElementById('medications-container');
                const id = `med_${Date.now()}`;
                
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="field">
                            <label>Search or Type Medication Name</label>
                            <div class="med-search-container">
                                <input type="text" 
                                       class="form-data med-search-input" 
                                       data-field="${id}_name" 
                                       placeholder="Start typing medication name..."
                                       id="search_${id}" />
                                <svg class="med-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                                <div class="med-dropdown" id="dropdown_${id}"></div>
                            </div>
                        </div>
                        <div class="grid-3">
                            <div class="field">
                                <label>Dose</label>
                                <input type="text" class="form-data" data-field="${id}_dose" />
                            </div>
                            <div class="field">
                                <label>Frequency</label>
                                <input type="text" class="form-data" data-field="${id}_frequency" placeholder="e.g., Twice daily" />
                            </div>
                            <div class="field">
                                <label>Route</label>
                                <select class="form-data" data-field="${id}_route">
                                    <option>Oral</option>
                                    <option>Injection</option>
                                    <option>Topical</option>
                                    <option>Inhaled</option>
                                    <option>Sublingual</option>
                                    <option>Rectal</option>
                                    <option>IV</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid-3">
                            <div class="field">
                                <label>Prescribed For</label>
                                <input type="text" class="form-data" data-field="${id}_purpose" />
                            </div>
                            <div class="field">
                                <label>Prescriber</label>
                                <input type="text" class="form-data" data-field="${id}_prescriber" />
                            </div>
                            <div class="field">
                                <label>Pharmacy</label>
                                <input type="text" class="form-data" data-field="${id}_pharmacy" />
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
                
                // Set up medication search
                const searchInput = document.getElementById(`search_${id}`);
                const dropdown = document.getElementById(`dropdown_${id}`);
                
                searchInput.addEventListener('input', function() {
                    clearTimeout(MedicationSearch.searchTimeout);
                    const query = this.value.trim();
                    
                    if (query.length < 2) {
                        dropdown.classList.remove('active');
                        return;
                    }
                    
                    dropdown.innerHTML = '<div class="med-loading"><div class="med-spinner"></div>Searching...</div>';
                    dropdown.classList.add('active');
                    
                    MedicationSearch.searchTimeout = setTimeout(() => {
                        MedicationSearch.searchMedications(query, dropdown);
                    }, 300);
                });
                
                // Handle selection
                dropdown.addEventListener('click', function(e) {
                    const item = e.target.closest('.med-dropdown-item');
                    if (item && item.dataset.index) {
                        const med = MedicationSearch.searchResults[parseInt(item.dataset.index)];
                        searchInput.value = med.brandName;
                        dropdown.classList.remove('active');
                        app.markAsChanged();
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest(`#search_${id}`) && !e.target.closest(`#dropdown_${id}`)) {
                        dropdown.classList.remove('active');
                    }
                });
            }
            
            // Other add methods
            addEmergencyContact() {
                const container = document.getElementById('emergency-contacts-container');
                const id = `contact_${Date.now()}`;
                
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="grid-2">
                            <div class="field">
                                <label>Contact Name</label>
                                <input type="text" class="form-data" data-field="${id}_name" />
                            </div>
                            <div class="field">
                                <label>Relationship</label>
                                <input type="text" class="form-data" data-field="${id}_relationship" />
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="field">
                                <label>Phone</label>
                                <input type="tel" class="form-data" data-field="${id}_phone" />
                            </div>
                            <div class="field">
                                <label>Alternate Phone</label>
                                <input type="tel" class="form-data" data-field="${id}_altPhone" />
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
            }
            
            addVitalSign() {
                const container = document.getElementById('vitals-history-container');
                const id = `vital_${Date.now()}`;
                
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="grid-3">
                            <div class="field">
                                <label>Date</label>
                                <input type="date" class="form-data" data-field="${id}_date" />
                            </div>
                            <div class="field">
                                <label>Blood Pressure</label>
                                <input type="text" class="form-data" data-field="${id}_bp" placeholder="120/80" />
                            </div>
                            <div class="field">
                                <label>Pulse</label>
                                <input type="number" class="form-data" data-field="${id}_pulse" />
                            </div>
                        </div>
                        <div class="grid-3">
                            <div class="field">
                                <label>Temperature</label>
                                <input type="text" class="form-data" data-field="${id}_temp" placeholder="98.6" />
                            </div>
                            <div class="field">
                                <label>O2 Sat</label>
                                <input type="number" class="form-data" data-field="${id}_o2" placeholder="98" />
                            </div>
                            <div class="field">
                                <label>Weight</label>
                                <input type="text" class="form-data" data-field="${id}_weight" />
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
            }
            
            addLabResult() {
                const container = document.getElementById('labs-container');
                const id = `lab_${Date.now()}`;
                
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="grid-3">
                            <div class="field">
                                <label>Test Name</label>
                                <input type="text" class="form-data" data-field="${id}_test" />
                            </div>
                            <div class="field">
                                <label>Date</label>
                                <input type="date" class="form-data" data-field="${id}_date" />
                            </div>
                            <div class="field">
                                <label>Result</label>
                                <input type="text" class="form-data" data-field="${id}_result" />
                            </div>
                        </div>
                        <div class="field">
                            <label>Normal Range</label>
                            <input type="text" class="form-data" data-field="${id}_range" placeholder="e.g., 4.5-11.0" />
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
            }
            
            addCondition() { this.addGenericItem('conditions-container', 'condition', 'Enter condition (e.g., Type 2 Diabetes - 2023)'); }
            addSurgery() { this.addGenericItem('surgeries-container', 'surgery', 'Enter surgery (e.g., Appendectomy - 2020)'); }
            addProvider() {
                const id = this.addGenericItem('providers-container', 'provider', 'Enter provider (Name, Specialty, Phone)');
                this.refreshProviderOptions();
                return id;
            }
            addNote(existingData = null) { return this.createDetailedNote('notes-container', 'note', existingData); }
            addGACNote(existingData = null) { return this.createDetailedNote('gac-notes-container', 'gacnote', existingData); }
            addCovidVaccine() { this.addGenericItem('covid-vaccines-container', 'covid', 'Enter vaccine (e.g., Pfizer Booster - 10/2024)'); }
            addVaccine() { this.addGenericItem('vaccines-container', 'vaccine', 'Enter vaccine (e.g., Shingles - 05/2024)'); }

            createDetailedNote(containerId, prefix, existingData = null) {
                const container = document.getElementById(containerId);
                if (!container) return null;

                const id = `${prefix}_${Date.now()}`;
                const createdAt = existingData?.createdAt || new Date().toISOString();
                const provider = existingData?.provider || '';
                const eventDate = existingData?.eventDate || '';
                const noteText = existingData?.note || existingData?.value || '';
                const selectedTags = this.parseNoteTags(existingData?.tags);
                const hiddenTagValue = this.stringifyNoteTags(selectedTags);

                const html = `
                    <div class="list-item note-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="note-header">
                            <div class="field">
                                <label>Provider</label>
                                <input type="text" class="form-data note-provider" data-field="${id}_provider"
                                       list="noteProviderOptions"
                                       placeholder="Select or type provider"
                                       value="${this.escapeHTML(provider)}" />
                            </div>
                            <div class="field">
                                <label>Event Date (optional)</label>
                                <input type="date" class="form-data" data-field="${id}_eventDate" value="${this.escapeHTML(eventDate)}" />
                            </div>
                        </div>
                        <div class="note-meta-row">
                            <span>Created <span class="note-created-display"></span></span>
                        </div>
                        <div class="field">
                            <label>Note Details</label>
                            <textarea rows="4" class="form-data" data-field="${id}_note">${this.escapeHTML(noteText)}</textarea>
                        </div>
                        <div class="field">
                            <label>Tags</label>
                            <div class="note-tag-options" data-note-id="${id}"></div>
                            <input type="hidden" class="form-data" data-field="${id}_tags" value='${this.escapeHTML(hiddenTagValue)}' />
                        </div>
                        <input type="hidden" class="form-data" data-field="${id}_createdAt" value="${this.escapeHTML(createdAt)}" />
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
                const noteEl = container.querySelector(`[data-item-id="${id}"]`);
                this.initializeNoteElement(noteEl);
                this.markAsChanged();
                return id;
            }

            initializeNoteElement(noteEl) {
                if (!noteEl) return;

                const createdInput = noteEl.querySelector('[data-field$="_createdAt"]');
                if (createdInput) {
                    if (!createdInput.value) {
                        createdInput.value = new Date().toISOString();
                    }
                    const displayEl = noteEl.querySelector('.note-created-display');
                    if (displayEl) {
                        displayEl.textContent = this.formatDateTime(createdInput.value);
                    }
                }

                this.renderTagCheckboxesForNote(noteEl);
            }

            renderTagCheckboxesForNote(noteEl) {
                if (!noteEl) return;
                const optionsContainer = noteEl.querySelector('.note-tag-options');
                const hiddenInput = noteEl.querySelector('[data-field$="_tags"]');
                if (!optionsContainer || !hiddenInput) return;

                const availableTags = Array.isArray(this.noteTags) ? [...this.noteTags] : [];
                let selected = this.parseNoteTags(hiddenInput.value);
                if (availableTags.length === 0) {
                    hiddenInput.value = this.stringifyNoteTags([]);
                    optionsContainer.innerHTML = '<span style="font-size: 9pt; color: #94a3b8;">Add tags to categorize your notes.</span>';
                    return;
                }

                selected = selected.filter(tag => availableTags.includes(tag));
                hiddenInput.value = this.stringifyNoteTags(selected);

                optionsContainer.innerHTML = availableTags.map(tag => {
                    const checkboxId = `${noteEl.dataset.itemId}_${tag.replace(/[^a-z0-9]+/gi, '_').toLowerCase()}`;
                    const isChecked = selected.includes(tag) ? 'checked' : '';
                    return `
                        <label for="${checkboxId}">
                            <input type="checkbox" id="${checkboxId}" value="${this.escapeHTML(tag)}" ${isChecked}>
                            ${this.escapeHTML(tag)}
                        </label>
                    `;
                }).join('');

                optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', () => this.updateNoteTagHiddenInput(noteEl));
                });
            }

            updateNoteTagHiddenInput(noteEl) {
                if (!noteEl) return;
                const hiddenInput = noteEl.querySelector('[data-field$="_tags"]');
                if (!hiddenInput) return;

                const selected = Array.from(noteEl.querySelectorAll('.note-tag-options input[type="checkbox"]:checked')).map(cb => cb.value);
                hiddenInput.value = this.stringifyNoteTags(selected);
                this.markAsChanged();
            }

            refreshAllNoteTagSelectors() {
                document.querySelectorAll('.note-item').forEach(noteEl => this.renderTagCheckboxesForNote(noteEl));
            }

            addGenericItem(containerId, prefix, placeholder) {
                const container = document.getElementById(containerId);
                if (!container) return null;

                const id = `${prefix}_${Date.now()}`;
                const html = `
                    <div class="list-item" data-item-id="${id}">
                        <button class="delete-btn no-print" onclick="app.removeItem('${id}')">Remove</button>
                        <div class="field">
                            <input type="text" class="form-data" data-field="${id}_value"
                                   placeholder="${placeholder || 'Enter ' + prefix + ' information'}" />
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
                this.markAsChanged();
                return id;
            }

            removeItem(id) {
                const item = document.querySelector(`[data-item-id="${id}"]`);
                if (item && confirm('Remove this item?')) {
                    const parentContainer = item.parentElement;
                    item.remove();
                    this.markAsChanged();
                    if (parentContainer?.id === 'providers-container') {
                        this.refreshProviderOptions();
                    }
                    if (parentContainer?.id === 'notes-container' || parentContainer?.id === 'gac-notes-container') {
                        this.refreshAllNoteTagSelectors();
                    }
                }
            }

            promptAttachmentUpload() {
                const fileInput = document.getElementById('attachmentFileInput');
                if (!(fileInput instanceof HTMLInputElement)) {
                    return;
                }

                fileInput.value = '';
                fileInput.click();
            }

            async handleAttachmentSelect(event) {
                const input = event?.target;
                if (!(input instanceof HTMLInputElement) || !input.files) {
                    return;
                }

                const files = Array.from(input.files);
                if (!files.length) {
                    return;
                }

                const failures = [];

                for (const file of files) {
                    try {
                        const result = await this.readFileAsBase64(file);
                        const attachment = {
                            id: this.generateAttachmentId(),
                            name: typeof file.name === 'string' && file.name ? file.name : 'attachment',
                            type: typeof file.type === 'string' && file.type ? file.type : 'application/octet-stream',
                            size: typeof file.size === 'number' ? file.size : 0,
                            lastModified: typeof file.lastModified === 'number' ? file.lastModified : null,
                            addedAt: new Date().toISOString(),
                            compressed: !!result?.compressed,
                            originalSize: typeof result?.originalSize === 'number'
                                ? result.originalSize
                                : (typeof file.size === 'number' ? file.size : 0),
                            compressedSize: typeof result?.compressedSize === 'number'
                                ? result.compressedSize
                                : (Array.isArray(result?.data)
                                    ? result.data.length
                                    : (typeof result?.data === 'string'
                                        ? Math.ceil(result.data.length * 3 / 4)
                                        : (typeof file.size === 'number' ? file.size : 0))),
                            data: Array.isArray(result?.data)
                                ? result.data.slice()
                                : (typeof result?.data === 'string' ? result.data : '')
                        };
                        const hasData = Array.isArray(attachment.data)
                            ? attachment.data.length > 0
                            : (typeof attachment.data === 'string' ? attachment.data.trim() !== '' : false);
                        if (!hasData) {
                            throw new Error('Attachment data is empty');
                        }
                        this.attachments.push(attachment);
                    } catch (error) {
                        console.error('Failed to add attachment', error);
                        failures.push(file?.name || 'Unnamed file');
                    }
                }

                this.renderAttachmentList();
                this.updateAttachmentStorage();

                input.value = '';

                if (failures.length) {
                    alert(`Unable to add the following attachments: ${failures.join(', ')}`);
                }
            }

            getCompressionLibrary() {
                if (this._compressionLibrary && typeof this._compressionLibrary.deflate === 'function' && typeof this._compressionLibrary.inflate === 'function') {
                    return this._compressionLibrary;
                }

                const scopes = [
                    typeof globalThis !== 'undefined' ? globalThis : undefined,
                    typeof window !== 'undefined' ? window : undefined,
                    typeof self !== 'undefined' ? self : undefined
                ];

                for (const scope of scopes) {
                    if (scope && scope.pako && typeof scope.pako.deflate === 'function' && typeof scope.pako.inflate === 'function') {
                        this._compressionLibrary = scope.pako;
                        return this._compressionLibrary;
                    }
                }

                if (typeof pako !== 'undefined' && typeof pako.deflate === 'function' && typeof pako.inflate === 'function') {
                    this._compressionLibrary = pako;
                    return this._compressionLibrary;
                }

                return null;
            }

            readFileAsBase64(file, compress = true) {
                return new Promise((resolve, reject) => {
                    if (!(file instanceof Blob)) {
                        reject(new Error('Invalid file'));
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            const result = reader.result;
                            if (result instanceof ArrayBuffer) {
                                const bytes = new Uint8Array(result);
                                let finalBytes = bytes;
                                let isCompressed = false;

                                if (compress && bytes.length > 10240) {
                                    const pakoInstance = this.getCompressionLibrary();
                                    if (pakoInstance && typeof pakoInstance.deflate === 'function') {
                                        try {
                                            const compressed = pakoInstance.deflate(bytes, { level: 9 });
                                            if (compressed && compressed.length < bytes.length) {
                                                finalBytes = compressed;
                                                isCompressed = true;
                                            }
                                        } catch (compressionError) {
                                            console.warn('Attachment compression failed, storing uncompressed', compressionError);
                                        }
                                    }
                                }

                                resolve({
                                    data: Array.from(finalBytes),
                                    compressed: isCompressed,
                                    originalSize: bytes.length,
                                    compressedSize: finalBytes.length
                                });
                            } else if (typeof result === 'string') {
                                const base64Match = result.match(/^data:[^;]+;base64,(.*)$/);
                                const data = base64Match ? base64Match[1] : result;
                                const clean = typeof data === 'string' ? data.trim() : '';
                                let decodedBytes = new Uint8Array(0);
                                if (clean) {
                                    const binary = atob(clean);
                                    decodedBytes = new Uint8Array(binary.length);
                                    for (let i = 0; i < binary.length; i++) {
                                        decodedBytes[i] = binary.charCodeAt(i);
                                    }
                                }
                                resolve({
                                    data: Array.from(decodedBytes),
                                    compressed: false,
                                    originalSize: typeof file.size === 'number' ? file.size : 0,
                                    compressedSize: decodedBytes.length || (typeof file.size === 'number' ? file.size : 0)
                                });
                            } else {
                                reject(new Error('Unsupported file data'));
                            }
                        } catch (error) {
                            reject(error instanceof Error ? error : new Error('Failed to read file'));
                        }
                    };

                    reader.onerror = () => reject(reader.error || new Error('Failed to read file'));
                    reader.readAsArrayBuffer(file);
                });
            }

            generateAttachmentId() {
                const random = Math.random().toString(16).substring(2, 10);
                return `att_${Date.now().toString(36)}_${random}`;
            }

            renderAttachmentList() {
                const container = document.getElementById('attachments-container');
                if (!container) {
                    return;
                }

                container.innerHTML = '';

                if (!Array.isArray(this.attachments) || this.attachments.length === 0) {
                    container.innerHTML = '<div class="attachment-empty">No attachments saved yet. Add files to keep them encrypted with your vault.</div>';
                    return;
                }

                this.attachments.forEach((attachment) => {
                    const element = this.createAttachmentElement(attachment);
                    if (element) {
                        container.appendChild(element);
                    }
                });
            }

            createAttachmentElement(attachment) {
                if (!attachment || typeof attachment !== 'object') {
                    return null;
                }

                const id = attachment.id || this.generateAttachmentId();
                if (!attachment.id) {
                    attachment.id = id;
                }

                const item = document.createElement('div');
                item.className = 'list-item attachment-item';
                item.dataset.itemId = id;

                const nameEl = document.createElement('div');
                nameEl.className = 'attachment-name';
                nameEl.textContent = attachment.name || 'Attachment';
                item.appendChild(nameEl);

                const details = document.createElement('div');
                details.className = 'attachment-details';

                const sizeSpan = document.createElement('span');
                sizeSpan.textContent = this.formatFileSize(attachment.size);
                details.appendChild(sizeSpan);

                const typeSpan = document.createElement('span');
                typeSpan.textContent = attachment.type || 'application/octet-stream';
                details.appendChild(typeSpan);

                const originalSize = typeof attachment.originalSize === 'number'
                    ? attachment.originalSize
                    : (typeof attachment.size === 'number' ? attachment.size : 0);
                const compressedSize = typeof attachment.compressedSize === 'number'
                    ? attachment.compressedSize
                    : (typeof attachment.size === 'number' ? attachment.size : 0);

                if (attachment.compressed && compressedSize > 0 && originalSize > compressedSize) {
                    const savedPercentRaw = (1 - (compressedSize / originalSize)) * 100;
                    const savedPercentLabel = savedPercentRaw >= 1
                        ? `${Math.round(savedPercentRaw)}%`
                        : '<1%';

                    const compressionSpan = document.createElement('span');
                    compressionSpan.className = 'attachment-compression';
                    compressionSpan.textContent = `Compression saved ${savedPercentLabel} (${this.formatFileSize(originalSize)} â†’ ${this.formatFileSize(compressedSize)})`;
                    details.appendChild(compressionSpan);
                }

                if (attachment.addedAt) {
                    const formatted = this.formatDateTime(attachment.addedAt);
                    if (formatted && formatted !== 'â€”') {
                        const addedSpan = document.createElement('span');
                        addedSpan.textContent = `Added ${formatted}`;
                        details.appendChild(addedSpan);
                    }
                }

                item.appendChild(details);

                const actions = document.createElement('div');
                actions.className = 'attachment-actions';

                const viewBtn = document.createElement('button');
                viewBtn.type = 'button';
                viewBtn.className = 'btn btn-primary no-print';
                viewBtn.textContent = 'View';
                viewBtn.dataset.attachmentView = id;
                actions.appendChild(viewBtn);

                const downloadBtn = document.createElement('button');
                downloadBtn.type = 'button';
                downloadBtn.className = 'btn btn-secondary no-print';
                downloadBtn.textContent = 'Download';
                downloadBtn.dataset.attachmentDownload = id;
                actions.appendChild(downloadBtn);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger no-print';
                removeBtn.textContent = 'Remove';
                removeBtn.dataset.attachmentRemove = id;
                actions.appendChild(removeBtn);

                item.appendChild(actions);

                return item;
            }

            updateAttachmentStorage(options = {}) {
                const storageInput = document.getElementById('attachmentStorage');
                if (!storageInput) {
                    return;
                }

                const sanitized = Array.isArray(this.attachments)
                    ? this.attachments.map((attachment) => ({
                        id: attachment.id,
                        name: attachment.name,
                        type: attachment.type,
                        size: attachment.size,
                        compressed: !!attachment.compressed,
                        originalSize: typeof attachment.originalSize === 'number' ? attachment.originalSize : (typeof attachment.size === 'number' ? attachment.size : 0),
                        compressedSize: typeof attachment.compressedSize === 'number'
                            ? attachment.compressedSize
                            : (Array.isArray(attachment.data)
                                ? attachment.data.length
                                : (typeof attachment.data === 'string'
                                    ? Math.ceil(attachment.data.length * 3 / 4)
                                    : (typeof attachment.size === 'number' ? attachment.size : 0))),
                        lastModified: attachment.lastModified,
                        addedAt: attachment.addedAt,
                        data: Array.isArray(attachment.data)
                            ? attachment.data.slice()
                            : (typeof attachment.data === 'string' ? attachment.data : '')
                    }))
                    : [];

                storageInput.value = JSON.stringify(sanitized);
                if (!options.silent) {
                    this.markAsChanged();
                }
            }

            restoreAttachmentsFromStorage(raw = null) {
                const storageInput = document.getElementById('attachmentStorage');
                if (!storageInput) {
                    return;
                }

                let source = raw;
                if (source === null || source === undefined) {
                    source = storageInput.value;
                }

                let parsed = [];

                if (Array.isArray(source)) {
                    parsed = source;
                } else if (typeof source === 'string' && source.trim() !== '') {
                    try {
                        parsed = JSON.parse(source);
                    } catch (error) {
                        console.warn('Failed to parse stored attachments', error);
                        parsed = [];
                    }
                }

                if (!Array.isArray(parsed)) {
                    parsed = [];
                }

                const sanitized = parsed
                    .filter(item => item && typeof item === 'object' && (typeof item.data === 'string' || Array.isArray(item.data)))
                    .map(item => ({
                        id: item.id || this.generateAttachmentId(),
                        name: item.name || 'Attachment',
                        type: item.type || 'application/octet-stream',
                        size: typeof item.size === 'number' ? item.size : 0,
                        compressed: !!item.compressed,
                        originalSize: typeof item.originalSize === 'number'
                            ? item.originalSize
                            : (typeof item.size === 'number' ? item.size : 0),
                        compressedSize: typeof item.compressedSize === 'number'
                            ? item.compressedSize
                            : (Array.isArray(item.data)
                                ? item.data.length
                                : (typeof item.data === 'string'
                                    ? Math.ceil(item.data.length * 3 / 4)
                                    : (typeof item.size === 'number' ? item.size : 0))),
                        lastModified: typeof item.lastModified === 'number' ? item.lastModified : null,
                        addedAt: item.addedAt || new Date().toISOString(),
                        data: Array.isArray(item.data)
                            ? item.data.slice()
                            : (typeof item.data === 'string' ? item.data : '')
                    }));

                this.attachments = sanitized;
                this.renderAttachmentList();
                this.updateAttachmentStorage({ silent: true });
            }

            removeAttachment(id) {
                if (!id) {
                    return;
                }

                const index = Array.isArray(this.attachments)
                    ? this.attachments.findIndex(attachment => attachment.id === id)
                    : -1;

                if (index === -1) {
                    return;
                }

                if (!confirm('Remove this attachment from your vault?')) {
                    return;
                }

                this.attachments.splice(index, 1);
                this.renderAttachmentList();
                this.updateAttachmentStorage();
            }

            cleanupAttachmentPreview() {
                if (this.activePreviewObjectUrl) {
                    URL.revokeObjectURL(this.activePreviewObjectUrl);
                    this.activePreviewObjectUrl = null;
                }

                const content = document.getElementById('attachmentPreviewContent');
                if (content) {
                    content.innerHTML = '';
                }

                const errorEl = document.getElementById('attachmentPreviewError');
                if (errorEl) {
                    errorEl.textContent = '';
                    errorEl.style.display = 'none';
                }

                const metaEl = document.getElementById('attachmentPreviewMeta');
                if (metaEl) {
                    metaEl.textContent = '';
                }

                const downloadBtn = document.getElementById('attachmentPreviewDownload');
                if (downloadBtn) {
                    downloadBtn.disabled = true;
                }
            }

            closeAttachmentPreview() {
                const modal = document.getElementById('attachmentPreviewModal');
                if (modal) {
                    modal.classList.remove('active');
                }

                this.currentPreviewAttachmentId = null;
                this.cleanupAttachmentPreview();
            }

            isTextPreviewType(mimeType) {
                if (typeof mimeType !== 'string' || !mimeType) {
                    return false;
                }

                if (mimeType.startsWith('text/')) {
                    return true;
                }

                const normalized = mimeType.toLowerCase();
                return normalized.endsWith('+json')
                    || normalized.endsWith('+xml')
                    || [
                        'application/json',
                        'application/xml',
                        'application/x-yaml',
                        'application/yaml',
                        'application/javascript',
                        'application/ecmascript',
                        'application/sql'
                    ].includes(normalized);
            }

            viewAttachment(id) {
                if (!id) {
                    return;
                }

                const attachment = Array.isArray(this.attachments)
                    ? this.attachments.find(item => item.id === id)
                    : null;

                if (!attachment) {
                    alert('Attachment not found.');
                    return;
                }

                const modal = document.getElementById('attachmentPreviewModal');
                const content = document.getElementById('attachmentPreviewContent');
                const titleEl = document.getElementById('attachmentPreviewTitle');
                const metaEl = document.getElementById('attachmentPreviewMeta');
                const errorEl = document.getElementById('attachmentPreviewError');
                const downloadBtn = document.getElementById('attachmentPreviewDownload');

                if (!modal || !content || !titleEl || !metaEl || !errorEl || !downloadBtn) {
                    this.downloadAttachment(id);
                    return;
                }

                this.cleanupAttachmentPreview();

                this.currentPreviewAttachmentId = id;
                titleEl.textContent = attachment.name || 'Attachment';
                metaEl.textContent = `${this.formatFileSize(attachment.size)} â€¢ ${(attachment.type || 'application/octet-stream')}`;
                downloadBtn.disabled = false;

                const mimeType = (attachment.type || 'application/octet-stream').toLowerCase();

                try {
                    const blob = this.base64ToBlob(attachment.data, attachment.type, attachment.compressed);

                    if (mimeType.startsWith('image/')) {
                        const url = URL.createObjectURL(blob);
                        this.activePreviewObjectUrl = url;
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = attachment.name || 'Attachment preview';
                        content.appendChild(img);
                        modal.classList.add('active');
                        return;
                    }

                    if (mimeType.startsWith('video/')) {
                        const url = URL.createObjectURL(blob);
                        this.activePreviewObjectUrl = url;
                        const video = document.createElement('video');
                        video.controls = true;
                        video.src = url;
                        video.style.width = '100%';
                        video.style.maxHeight = '60vh';
                        content.appendChild(video);
                        modal.classList.add('active');
                        return;
                    }

                    if (mimeType.startsWith('audio/')) {
                        const url = URL.createObjectURL(blob);
                        this.activePreviewObjectUrl = url;
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.src = url;
                        content.appendChild(audio);
                        modal.classList.add('active');
                        return;
                    }

                    if (this.isTextPreviewType(mimeType)) {
                        const loading = document.createElement('p');
                        loading.textContent = 'Loading preview...';
                        loading.style.textAlign = 'center';
                        loading.style.color = '#64748b';
                        content.appendChild(loading);
                        modal.classList.add('active');

                        blob.text().then((text) => {
                            if (this.currentPreviewAttachmentId !== id) {
                                return;
                            }
                            content.innerHTML = '';
                            const pre = document.createElement('pre');
                            pre.className = 'attachment-preview-text';
                            pre.textContent = text;
                            content.appendChild(pre);
                        }).catch((error) => {
                            console.error('Failed to render text attachment preview', error);
                            if (this.currentPreviewAttachmentId !== id) {
                                return;
                            }
                            content.innerHTML = '';
                            errorEl.textContent = 'Unable to display this text attachment. Download to view.';
                            errorEl.style.display = 'block';
                        });

                        return;
                    }

                    errorEl.textContent = 'Preview not available for this file type. Download to view.';
                    errorEl.style.display = 'block';
                    modal.classList.add('active');
                } catch (error) {
                    console.error('Failed to preview attachment', error);
                    errorEl.textContent = 'Unable to preview this attachment. Download to view.';
                    errorEl.style.display = 'block';
                    modal.classList.add('active');
                }
            }

            downloadAttachment(id) {
                if (!id) {
                    return;
                }

                const attachment = Array.isArray(this.attachments)
                    ? this.attachments.find(item => item.id === id)
                    : null;

                if (!attachment) {
                    alert('Attachment not found.');
                    return;
                }

                try {
                    const blob = this.base64ToBlob(attachment.data, attachment.type, attachment.compressed);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = attachment.name || 'attachment';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Failed to download attachment', error);
                    alert('Unable to download this attachment. Please try again.');
                }
            }

            base64ToBlob(base64, mimeType = 'application/octet-stream', isCompressed = false) {
                let bytes;

                if (Array.isArray(base64)) {
                    if (!base64.length) {
                        throw new Error('Attachment data is empty.');
                    }
                    bytes = new Uint8Array(base64);
                } else if (typeof base64 === 'string') {
                    const clean = base64.trim();
                    if (!clean) {
                        throw new Error('Attachment data is empty.');
                    }

                    const binary = atob(clean);
                    const length = binary.length;
                    bytes = new Uint8Array(length);
                    for (let i = 0; i < length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                } else {
                    throw new Error('Invalid attachment data format.');
                }

                let finalBytes = bytes;
                if (isCompressed) {
                    const pakoInstance = this.getCompressionLibrary();
                    if (!pakoInstance || typeof pakoInstance.inflate !== 'function') {
                        throw new Error('Unable to decompress attachment: compression library unavailable.');
                    }

                    try {
                        finalBytes = pakoInstance.inflate(bytes);
                    } catch (error) {
                        console.error('Failed to decompress attachment', error);
                        throw new Error('Failed to decompress attachment data.');
                    }
                }

                return new Blob([finalBytes], { type: mimeType || 'application/octet-stream' });
            }

            initializeExistingNotes() {
                document.querySelectorAll('.note-item').forEach(noteEl => this.initializeNoteElement(noteEl));
            }

            handleAddNoteTag() {
                const input = document.getElementById('noteTagInput');
                if (!input) return;

                const value = input.value.trim();
                if (!value) return;

                const normalized = value.replace(/\s+/g, ' ').trim();
                if (!normalized) {
                    input.value = '';
                    return;
                }

                const exists = this.noteTags.some(tag => tag.toLowerCase() === normalized.toLowerCase());
                if (exists) {
                    input.value = '';
                    return;
                }

                this.noteTags.push(normalized);
                this.noteTags.sort((a, b) => a.localeCompare(b));
                input.value = '';
                this.saveNoteTagsToStorage();
                this.renderTagChips();
                this.refreshAllNoteTagSelectors();
                this.markAsChanged();
            }

            removeNoteTag(tag) {
                if (!tag) return;
                const index = this.noteTags.findIndex(existing => existing === tag);
                if (index === -1) return;

                this.noteTags.splice(index, 1);
                this.saveNoteTagsToStorage();
                this.renderTagChips();
                this.refreshAllNoteTagSelectors();
                this.markAsChanged();
            }

            renderTagChips() {
                const container = document.getElementById('noteTagList');
                if (!container) return;

                if (!this.noteTags.length) {
                    container.innerHTML = '<span style="font-size: 9pt; color: #94a3b8;">No tags yet. Add tags to organize your notes.</span>';
                    return;
                }

                container.innerHTML = this.noteTags.map(tag => `
                    <span class="tag-chip">
                        ${this.escapeHTML(tag)}
                        <button type="button" data-tag-remove="${this.escapeHTML(tag)}" aria-label="Remove tag ${this.escapeHTML(tag)}">âœ•</button>
                    </span>
                `).join('');
            }

            saveNoteTagsToStorage() {
                const storage = document.getElementById('noteTagStorage');
                if (storage) {
                    storage.value = this.stringifyNoteTags(this.noteTags);
                }
            }

            restoreNoteTagsFromStorage() {
                const storage = document.getElementById('noteTagStorage');
                if (!storage) return;

                const raw = storage.value;
                const parsed = this.parseNoteTags(raw);
                this.noteTags = Array.isArray(parsed) ? parsed.slice().sort((a, b) => a.localeCompare(b)) : [];
                storage.value = this.stringifyNoteTags(this.noteTags);
                this.renderTagChips();
                this.refreshAllNoteTagSelectors();
            }

            parseNoteTags(raw) {
                if (!raw) return [];
                if (Array.isArray(raw)) {
                    return raw.filter(Boolean);
                }

                if (typeof raw === 'string') {
                    const trimmed = raw.trim();
                    if (!trimmed) return [];

                    try {
                        const parsed = JSON.parse(trimmed);
                        if (Array.isArray(parsed)) {
                            return parsed.filter(tag => typeof tag === 'string' && tag.trim() !== '').map(tag => tag.trim());
                        }
                    } catch (err) {
                        // Fall back to splitting by commas or newlines
                    }

                    return trimmed
                        .split(/\r?\n|,/)
                        .map(tag => tag.trim())
                        .filter(Boolean);
                }

                return [];
            }

            stringifyNoteTags(tags) {
                if (!Array.isArray(tags)) return '[]';
                const unique = [];
                tags.forEach(tag => {
                    if (typeof tag !== 'string') return;
                    const normalized = tag.trim();
                    if (!normalized) return;
                    if (!unique.some(existing => existing.toLowerCase() === normalized.toLowerCase())) {
                        unique.push(normalized);
                    }
                });
                return JSON.stringify(unique);
            }

            refreshProviderOptions() {
                const datalist = document.getElementById('noteProviderOptions');
                if (!datalist) return;

                const providers = this.getProviderNames();
                datalist.innerHTML = providers.map(name => `<option value="${this.escapeHTML(name)}"></option>`).join('');
            }

            getProviderNames() {
                const providerInputs = document.querySelectorAll('#providers-container .form-data');
                const names = new Set();
                providerInputs.forEach(input => {
                    const value = input.value?.trim();
                    if (value) {
                        names.add(value);
                    }
                });
                return Array.from(names).sort((a, b) => a.localeCompare(b));
            }

            normalizeNoteRecord(raw) {
                const record = raw && typeof raw === 'object' ? raw : {};
                const text = typeof record.note === 'string' ? record.note : (typeof record.value === 'string' ? record.value : '');
                const provider = typeof record.provider === 'string' ? record.provider : '';
                const eventDate = typeof record.eventDate === 'string' ? record.eventDate : '';
                const createdAt = typeof record.createdAt === 'string' ? record.createdAt : '';
                const tags = this.parseNoteTags(record.tags);

                return {
                    note: text,
                    provider,
                    eventDate,
                    createdAt,
                    tags
                };
            }

            noteHasContent(note) {
                if (!note) return false;
                const textPresent = typeof note.note === 'string' && note.note.trim() !== '';
                return textPresent || Boolean(note.provider || note.eventDate || (note.tags && note.tags.length));
            }

            buildNotePrintBlock(note) {
                const metaParts = [];
                if (note.provider) {
                    metaParts.push(`Provider: ${this.escapeHTML(note.provider)}`);
                }

                const formattedEvent = this.formatDate(note.eventDate);
                if (formattedEvent !== 'â€”') {
                    metaParts.push(`Event Date: ${formattedEvent}`);
                }

                const formattedCreated = this.formatDateTime(note.createdAt);
                if (formattedCreated !== 'â€”') {
                    metaParts.push(`Created: ${formattedCreated}`);
                }

                if (note.tags && note.tags.length) {
                    const tagText = note.tags.map(tag => this.escapeHTML(tag)).join(', ');
                    if (tagText) {
                        metaParts.push(`Tags: ${tagText}`);
                    }
                }

                const metaHtml = metaParts.length ? `<div class="print-note-meta"><strong>${metaParts.join(' â€¢ ')}</strong></div>` : '';
                const bodyHtml = `<div class="print-note-body">${this.formatTextBlock(note.note)}</div>`;
                return `<div class="print-note">${metaHtml}${bodyHtml}</div>`;
            }
            
            exportPDF() {
                this.openExportOptions();
            }

            openExportOptions() {
                document.getElementById('exportModal')?.classList.add('active');
            }

            closeExportOptions() {
                document.getElementById('exportModal')?.classList.remove('active');
            }

            printSummary() {
                const printArea = document.getElementById('printArea');
                if (!printArea) {
                    window.print();
                    return;
                }

                this.buildPrintSummary(printArea);

                requestAnimationFrame(() => {
                    window.print();
                });

                const cleanup = () => {
                    printArea.innerHTML = '';
                    window.removeEventListener('afterprint', cleanup);
                };

                window.addEventListener('afterprint', cleanup, { once: true });
            }

            buildPrintSummary(printArea) {
                const formData = this.collectFormData();
                const lastUpdatedText = document.getElementById('lastUpdatedHeader')?.textContent?.replace('Last Updated: ', '') || 'Never';
                const fullNameParts = [formData.firstName, formData.middleInitial, formData.lastName].filter(Boolean);
                const fullName = fullNameParts.length ? fullNameParts.join(' ') : 'â€”';

                const overviewGrid = this.buildKeyValueGrid([
                    { label: 'Date of Birth', value: this.formatDate(formData.dateOfBirth) },
                    { label: 'Medical Record #', value: this.formatValue(formData.mrn) },
                    { label: 'Sex Assigned at Birth', value: this.formatValue(formData.biologicalSex) },
                    { label: 'Phone', value: this.formatValue(formData.phone) },
                    { label: 'Email', value: this.formatValue(formData.email) },
                    { label: 'Address', allowHTML: true, value: this.formatTextBlock(formData.address) }
                ]);

                const emergencyGrid = this.buildKeyValueGrid([
                    { label: 'Blood Type', value: this.formatValue(formData.bloodType) },
                    { label: 'Advance Directive', value: this.formatValue(formData.advanceDirective) },
                    { label: 'Organ Donor', value: this.formatValue(formData.organDonor) },
                    { label: 'Critical Allergies', allowHTML: true, value: this.formatTextBlock(formData.criticalAllergies) },
                    { label: 'Critical Conditions', allowHTML: true, value: this.formatTextBlock(formData.criticalConditions) },
                    { label: 'Medication Contraindications', allowHTML: true, value: this.formatTextBlock(formData.medicationContraindications) },
                    { label: 'Preferred Hospital', value: this.formatValue(formData.preferredHospital) },
                    { label: 'Medical Power of Attorney', value: this.formatValue(formData.medicalPOA) }
                ]);

                const latestVitalsGrid = this.buildKeyValueGrid([
                    { label: 'Blood Pressure', value: this.formatValue(formData.lastBP) },
                    { label: 'Pulse', value: this.formatValue(formData.lastPulse) },
                    { label: 'Temperature', value: this.formatValue(formData.lastTemp) },
                    { label: 'Respirations', value: this.formatValue(formData.lastResp) },
                    { label: 'Oâ‚‚ Saturation', value: this.formatValue(formData.lastO2) },
                    { label: 'Weight', value: this.formatValue(formData.weight) },
                    { label: 'Height', value: this.formatValue(formData.height) },
                    { label: 'BMI', value: this.formatValue(formData.bmi) }
                ]);

                const emergencyContacts = this.collectListData('emergency-contacts-container');
                const medications = this.collectListData('medications-container');
                const vitalsHistory = this.collectListData('vitals-history-container');
                const labs = this.collectListData('labs-container');
                const conditions = this.collectListData('conditions-container').map(item => item.value).filter(Boolean);
                const surgeries = this.collectListData('surgeries-container').map(item => item.value).filter(Boolean);
                const providers = this.collectListData('providers-container').map(item => item.value).filter(Boolean);
                const noteEntries = this.collectListData('notes-container');
                const gacNoteEntries = this.collectListData('gac-notes-container');
                const notes = noteEntries.map(entry => this.normalizeNoteRecord(entry)).filter(note => this.noteHasContent(note));
                const gacNotes = gacNoteEntries.map(entry => this.normalizeNoteRecord(entry)).filter(note => this.noteHasContent(note));
                const covidVaccines = this.collectListData('covid-vaccines-container').map(item => item.value).filter(Boolean);
                const otherVaccines = this.collectListData('vaccines-container').map(item => item.value).filter(Boolean);

                const medicationRows = medications
                    .filter(med => Object.values(med).some(value => value))
                    .map(med => ({
                        name: this.formatValue(med.name),
                        instructions: [med.dose, med.frequency, med.route].filter(Boolean).map(v => this.escapeHTML(v)).join('<br>') || 'â€”',
                        indication: this.formatValue(med.purpose),
                        prescriber: this.formatValue(med.prescriber),
                        pharmacy: this.formatValue(med.pharmacy)
                    }));

                const emergencyContactRows = emergencyContacts
                    .filter(contact => Object.values(contact).some(value => value))
                    .map(contact => ({
                        name: this.formatValue(contact.name),
                        relationship: this.formatValue(contact.relationship),
                        phones: [contact.phone, contact.altPhone].filter(Boolean).map(v => this.escapeHTML(v)).join('<br>') || 'â€”'
                    }));

                const vitalRows = vitalsHistory
                    .filter(vital => Object.values(vital).some(value => value))
                    .map(vital => ({
                        date: this.formatDate(vital.date),
                        bp: this.formatValue(vital.bp),
                        pulse: this.formatValue(vital.pulse),
                        temp: this.formatValue(vital.temp),
                        o2: this.formatValue(vital.o2),
                        weight: this.formatValue(vital.weight)
                    }));

                const labRows = labs
                    .filter(lab => Object.values(lab).some(value => value))
                    .map(lab => ({
                        test: this.formatValue(lab.test),
                        date: this.formatDate(lab.date),
                        result: this.formatValue(lab.result),
                        range: this.formatValue(lab.range)
                    }));

                const medicationAllergies = this.splitToList(formData.medicationAllergies);
                const foodAllergies = this.splitToList(formData.foodAllergies);
                const environmentalAllergies = this.splitToList(formData.environmentalAllergies);

                const allergySectionParts = [];
                if (medicationAllergies.length) {
                    allergySectionParts.push(`<div class="print-note"><strong>Medication:</strong><ul class="print-list">${medicationAllergies.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>`);
                }
                if (foodAllergies.length) {
                    allergySectionParts.push(`<div class="print-note"><strong>Food:</strong><ul class="print-list">${foodAllergies.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>`);
                }
                if (environmentalAllergies.length) {
                    allergySectionParts.push(`<div class="print-note"><strong>Environmental:</strong><ul class="print-list">${environmentalAllergies.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>`);
                }

                if (!allergySectionParts.length) {
                    allergySectionParts.push('<p class="print-note">â€”</p>');
                }

                const socialHistory = this.buildKeyValueGrid([
                    { label: 'Smoking Status', value: this.formatValue(formData.smokingStatus) },
                    { label: 'Alcohol Use', value: this.formatValue(formData.alcoholUse) },
                    { label: 'Exercise Frequency', value: this.formatValue(formData.exerciseFrequency) }
                ]);

                const providerGrid = this.buildKeyValueGrid([
                    { label: 'Primary Care Provider', value: this.formatValue(formData.pcpName) },
                    { label: 'PCP Phone', value: this.formatValue(formData.pcpPhone) },
                    { label: 'Last Visit', value: this.formatDate(formData.pcpLastVisit) }
                ]);

                const insuranceGrid = this.buildKeyValueGrid([
                    { label: 'Insurance Company', value: this.formatValue(formData.insuranceCompany) },
                    { label: 'Member ID', value: this.formatValue(formData.memberId) },
                    { label: 'Group Number', value: this.formatValue(formData.groupNumber) },
                    { label: 'Policy Holder', value: this.formatValue(formData.policyHolder) },
                    { label: 'Relationship', value: this.formatValue(formData.policyRelationship) },
                    { label: 'Insurance Phone', value: this.formatValue(formData.insurancePhone) },
                    { label: 'Deductible', value: this.formatValue(formData.deductible) },
                    { label: 'Out-of-Pocket Max', value: this.formatValue(formData.oopMax) },
                    { label: 'Primary Care Copay', value: this.formatValue(formData.coPayPrimary) }
                ]);

                const vaccineLists = [];
                if (formData.lastFluShot) {
                    vaccineLists.push(`<div class="print-grid-item"><span class="print-label">Flu Shot</span><span class="print-value">${this.formatDate(formData.lastFluShot)}</span></div>`);
                }
                if (formData.lastTetanus) {
                    vaccineLists.push(`<div class="print-grid-item"><span class="print-label">Tetanus (Tdap)</span><span class="print-value">${this.formatDate(formData.lastTetanus)}</span></div>`);
                }

                const covidList = covidVaccines.length ? `<div class="print-note"><strong>COVID-19:</strong><ul class="print-list">${covidVaccines.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>` : '';
                const otherVaccineList = otherVaccines.length ? `<div class="print-note"><strong>Other Vaccines:</strong><ul class="print-list">${otherVaccines.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul></div>` : '';

                const html = `
                    <div class="print-wrapper">
                        <div class="print-header">
                            <h1>Patient Care Summary</h1>
                            <div class="print-meta">
                                <span><strong>Patient:</strong> ${this.escapeHTML(fullName)}</span>
                                <span><strong>Date of Birth:</strong> ${this.formatDate(formData.dateOfBirth)}</span>
                                <span><strong>Last Updated:</strong> ${this.escapeHTML(lastUpdatedText)}</span>
                            </div>
                        </div>
                        <section class="print-section">
                            <h2>Patient Overview</h2>
                            ${overviewGrid}
                        </section>
                        <section class="print-section">
                            <h2>Emergency Readiness</h2>
                            ${emergencyGrid}
                        </section>
                        <section class="print-section">
                            <h2>Latest Vital Snapshot</h2>
                            ${latestVitalsGrid}
                        </section>
                        ${this.buildTableSection('Emergency Contacts', [
                            { key: 'name', label: 'Name' },
                            { key: 'relationship', label: 'Relationship' },
                            { key: 'phones', label: 'Phone(s)', allowHTML: true }
                        ], emergencyContactRows)}
                        ${this.buildTableSection('Current Medications', [
                            { key: 'name', label: 'Medication' },
                            { key: 'instructions', label: 'Instructions', allowHTML: true },
                            { key: 'indication', label: 'Indication' },
                            { key: 'prescriber', label: 'Prescriber' },
                            { key: 'pharmacy', label: 'Pharmacy' }
                        ], medicationRows)}
                        <section class="print-section">
                            <h2>Allergies</h2>
                            ${allergySectionParts.join('')}
                        </section>
                        ${this.buildListSection('Medical Conditions', conditions)}
                        ${this.buildListSection('Surgical History', surgeries)}
                        <section class="print-section">
                            <h2>Family &amp; Social History</h2>
                            <div class="print-grid">
                                <div class="print-grid-item">
                                    <span class="print-label">Family History</span>
                                    <span class="print-value">${this.formatTextBlock(formData.familyHistory)}</span>
                                </div>
                            </div>
                            ${socialHistory}
                        </section>
                        ${this.buildTableSection('Vital Signs Trend', [
                            { key: 'date', label: 'Date' },
                            { key: 'bp', label: 'Blood Pressure' },
                            { key: 'pulse', label: 'Pulse' },
                            { key: 'temp', label: 'Temperature' },
                            { key: 'o2', label: 'Oâ‚‚ Saturation' },
                            { key: 'weight', label: 'Weight' }
                        ], vitalRows)}
                        ${this.buildTableSection('Laboratory Results', [
                            { key: 'test', label: 'Test' },
                            { key: 'date', label: 'Date' },
                            { key: 'result', label: 'Result' },
                            { key: 'range', label: 'Reference Range' }
                        ], labRows)}
                        <section class="print-section">
                            <h2>Care Team</h2>
                            ${providerGrid}
                            ${providers.length ? `<ul class="print-list">${providers.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}</ul>` : '<p class="print-note">â€”</p>'}
                        </section>
                        <section class="print-section">
                            <h2>Insurance Coverage</h2>
                            ${insuranceGrid}
                        </section>
                        <section class="print-section">
                            <h2>Immunizations</h2>
                            ${vaccineLists.length ? `<div class="print-grid">${vaccineLists.join('')}</div>` : ''}
                            ${covidList || otherVaccineList || '<p class="print-note">â€”</p>'}
                        </section>
                        <section class="print-section">
                            <h2>Care Notes</h2>
                            ${notes.length ? notes.map(note => this.buildNotePrintBlock(note)).join('') : '<p class="print-note">â€”</p>'}
                        </section>
                        ${(this.modules?.gac || gacNotes.length) ? `
                        <section class="print-section">
                            <h2>Gender-Affirming Care Notes</h2>
                            ${gacNotes.length ? gacNotes.map(note => this.buildNotePrintBlock(note)).join('') : '<p class="print-note">â€”</p>'}
                        </section>` : ''}
                    </div>
                `;

                printArea.innerHTML = html;
            }

            buildKeyValueGrid(pairs = []) {
                if (!pairs.length) {
                    return '<p class="print-note">â€”</p>';
                }

                return `
                    <div class="print-grid">
                        ${pairs.map(pair => {
                            const value = pair.allowHTML ? (pair.value || 'â€”') : this.formatValue(pair.value);
                            return `
                                <div class="print-grid-item">
                                    <span class="print-label">${this.escapeHTML(pair.label)}</span>
                                    <span class="print-value">${value}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            buildTableSection(title, columns, rows = []) {
                if (!rows.length) {
                    return '';
                }

                const header = columns.map(col => `<th>${this.escapeHTML(col.label)}</th>`).join('');
                const body = rows.map(row => `<tr>${columns.map(col => {
                    const value = col.allowHTML ? (row[col.key] || 'â€”') : this.formatValue(row[col.key]);
                    return `<td>${value}</td>`;
                }).join('')}</tr>`).join('');

                return `
                    <section class="print-section">
                        <h2>${this.escapeHTML(title)}</h2>
                        <table class="print-table">
                            <thead><tr>${header}</tr></thead>
                            <tbody>${body}</tbody>
                        </table>
                    </section>
                `;
            }

            buildListSection(title, items = []) {
                if (!items.length) {
                    return `
                        <section class="print-section">
                            <h2>${this.escapeHTML(title)}</h2>
                            <p class="print-note">â€”</p>
                        </section>
                    `;
                }

                return `
                    <section class="print-section">
                        <h2>${this.escapeHTML(title)}</h2>
                        <ul class="print-list">
                            ${items.map(item => `<li>${this.escapeHTML(item)}</li>`).join('')}
                        </ul>
                    </section>
                `;
            }

            collectListData(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return [];

                return Array.from(container.querySelectorAll('.list-item')).map(item => {
                    const entry = {};
                    item.querySelectorAll('.form-data').forEach(input => {
                        const fieldKey = input.dataset.field || '';
                        const key = fieldKey.includes('_') ? fieldKey.substring(fieldKey.lastIndexOf('_') + 1) : fieldKey;
                        const value = input.type === 'checkbox' ? input.checked : input.value;
                        entry[key] = value;
                    });
                    return entry;
                });
            }

            formatFileSize(bytes) {
                const size = typeof bytes === 'number' && Number.isFinite(bytes) && bytes >= 0 ? bytes : 0;

                if (size === 0) {
                    return '0 B';
                }

                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                const exponent = Math.min(Math.floor(Math.log(size) / Math.log(1024)), units.length - 1);
                const value = size / Math.pow(1024, exponent);

                return `${value.toFixed(exponent === 0 ? 0 : 1)} ${units[exponent]}`;
            }

            formatValue(value) {
                if (value === undefined || value === null || value === '') {
                    return 'â€”';
                }

                if (typeof value === 'boolean') {
                    return value ? 'Yes' : 'No';
                }

                return this.escapeHTML(value);
            }

            formatDate(value) {
                if (!value) return 'â€”';
                const date = new Date(value);
                if (!isNaN(date)) {
                    return this.escapeHTML(date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }));
                }

                return this.escapeHTML(value);
            }

            formatDateTime(value) {
                if (!value) return 'â€”';
                const date = new Date(value);
                if (!isNaN(date)) {
                    return this.escapeHTML(date.toLocaleString(undefined, {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                    }));
                }

                return this.escapeHTML(value);
            }

            formatTextBlock(value) {
                if (!value) return 'â€”';
                return this.escapeHTML(value).replace(/\n/g, '<br>');
            }

            splitToList(text) {
                if (!text) return [];
                return text
                    .split(/\r?\n|,/)
                    .map(item => item.trim())
                    .filter(Boolean);
            }

            escapeHTML(value) {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            generateFHIRBundle() {
                const formData = this.collectFormData();
                const patientId = this.generateFHIRId('patient');
                const patientReference = `urn:uuid:${patientId}`;

                const bundle = {
                    resourceType: 'Bundle',
                    type: 'collection',
                    timestamp: new Date().toISOString(),
                    entry: []
                };

                const patientResource = {
                    resourceType: 'Patient',
                    id: patientId,
                    identifier: [],
                    name: [],
                    telecom: [],
                    address: [],
                    communication: []
                };

                const name = {
                    use: 'official',
                    family: formData.lastName || undefined,
                    given: [formData.firstName, formData.middleInitial].filter(Boolean)
                };

                if (name.family || name.given.length) {
                    patientResource.name.push(name);
                }

                if (formData.mrn) {
                    patientResource.identifier.push({
                        system: 'urn:healthvault:mrn',
                        value: formData.mrn
                    });
                }

                if (formData.ssn) {
                    patientResource.identifier.push({
                        system: 'http://hl7.org/fhir/sid/us-ssn',
                        value: formData.ssn
                    });
                }

                if (formData.phone) {
                    patientResource.telecom.push({ system: 'phone', value: formData.phone, use: 'mobile' });
                }

                if (formData.email) {
                    patientResource.telecom.push({ system: 'email', value: formData.email, use: 'home' });
                }

                if (formData.address) {
                    patientResource.address.push({
                        text: formData.address
                    });
                }

                if (formData.primaryLanguage) {
                    patientResource.communication.push({
                        language: { text: formData.primaryLanguage }
                    });
                }

                if (formData.biologicalSex) {
                    const genderMap = {
                        Female: 'female',
                        Male: 'male',
                        Intersex: 'other',
                        Other: 'other'
                    };
                    patientResource.gender = genderMap[formData.biologicalSex] || 'unknown';
                }

                if (formData.dateOfBirth) {
                    patientResource.birthDate = formData.dateOfBirth;
                }

                bundle.entry.push({
                    fullUrl: patientReference,
                    resource: patientResource
                });

                const emergencyContacts = this.collectListData('emergency-contacts-container');
                emergencyContacts.forEach(contact => {
                    if (!contact.name) return;
                    const relatedId = this.generateFHIRId('related-person');
                    const relatedResource = {
                        resourceType: 'RelatedPerson',
                        id: relatedId,
                        patient: { reference: patientReference },
                        relationship: contact.relationship ? [{ text: contact.relationship }] : undefined,
                        name: [{ text: contact.name }],
                        telecom: []
                    };

                    if (contact.phone) {
                        relatedResource.telecom.push({ system: 'phone', value: contact.phone, use: 'mobile' });
                    }

                    if (contact.altPhone) {
                        relatedResource.telecom.push({ system: 'phone', value: contact.altPhone, use: 'home' });
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${relatedId}`,
                        resource: relatedResource
                    });
                });

                const conditionTexts = [
                    ...this.collectListData('conditions-container').map(item => item.value).filter(Boolean),
                    ...this.splitToList(formData.criticalConditions)
                ];

                conditionTexts.forEach(text => {
                    const conditionId = this.generateFHIRId('condition');
                    bundle.entry.push({
                        fullUrl: `urn:uuid:${conditionId}`,
                        resource: {
                            resourceType: 'Condition',
                            id: conditionId,
                            clinicalStatus: {
                                coding: [{ system: 'http://terminology.hl7.org/CodeSystem/condition-clinical', code: 'active' }]
                            },
                            code: { text },
                            subject: { reference: patientReference }
                        }
                    });
                });

                const surgeries = this.collectListData('surgeries-container').map(item => item.value).filter(Boolean);
                surgeries.forEach(text => {
                    const procedureId = this.generateFHIRId('procedure');
                    bundle.entry.push({
                        fullUrl: `urn:uuid:${procedureId}`,
                        resource: {
                            resourceType: 'Procedure',
                            id: procedureId,
                            status: 'completed',
                            code: { text },
                            subject: { reference: patientReference }
                        }
                    });
                });

                const medications = this.collectListData('medications-container');
                medications.forEach(med => {
                    if (!med.name) return;
                    const medId = this.generateFHIRId('medicationstatement');
                    const dosageText = [med.dose, med.frequency, med.route].filter(Boolean).join(', ');

                    const resource = {
                        resourceType: 'MedicationStatement',
                        id: medId,
                        status: 'active',
                        subject: { reference: patientReference },
                        medicationCodeableConcept: { text: med.name },
                        dosage: []
                    };

                    if (dosageText) {
                        resource.dosage.push({ text: dosageText });
                    }

                    if (med.purpose) {
                        resource.reasonReference = [{ display: med.purpose }];
                    }

                    if (med.prescriber) {
                        resource.informationSource = { display: med.prescriber };
                    }

                    if (med.pharmacy) {
                        resource.note = [{ text: `Dispensed at: ${med.pharmacy}` }];
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${medId}`,
                        resource
                    });
                });

                const allergyCategories = [
                    { items: this.splitToList(formData.medicationAllergies), category: 'medication', criticality: 'low' },
                    { items: this.splitToList(formData.foodAllergies), category: 'food', criticality: 'low' },
                    { items: this.splitToList(formData.environmentalAllergies), category: 'environment', criticality: 'low' },
                    { items: this.splitToList(formData.criticalAllergies), category: 'medication', criticality: 'high' }
                ];

                allergyCategories.forEach(group => {
                    group.items.forEach(entry => {
                        const [substance, reaction] = entry.split(/[-â€“:]/).map(part => part.trim());
                        if (!substance) return;
                        const allergyId = this.generateFHIRId('allergy');
                        const resource = {
                            resourceType: 'AllergyIntolerance',
                            id: allergyId,
                            clinicalStatus: {
                                coding: [{ system: 'http://terminology.hl7.org/CodeSystem/allergyintolerance-clinical', code: 'active' }]
                            },
                            verificationStatus: {
                                coding: [{ system: 'http://terminology.hl7.org/CodeSystem/allergyintolerance-verification', code: 'confirmed' }]
                            },
                            category: [group.category],
                            criticality: group.criticality === 'high' ? 'high' : 'low',
                            code: { text: substance },
                            patient: { reference: patientReference }
                        };

                        if (reaction) {
                            resource.reaction = [{ description: reaction }];
                        }

                        bundle.entry.push({
                            fullUrl: `urn:uuid:${allergyId}`,
                            resource
                        });
                    });
                });

                const vitals = this.collectListData('vitals-history-container');
                vitals.forEach(vital => {
                    const hasData = ['bp', 'pulse', 'temp', 'o2', 'weight'].some(key => vital[key]);
                    if (!hasData && !vital.date) return;

                    const observationId = this.generateFHIRId('observation');
                    const resource = {
                        resourceType: 'Observation',
                        id: observationId,
                        status: 'final',
                        category: [{
                            coding: [{ system: 'http://terminology.hl7.org/CodeSystem/observation-category', code: 'vital-signs', display: 'Vital Signs' }]
                        }],
                        code: { text: 'Vital signs panel' },
                        subject: { reference: patientReference },
                        component: []
                    };

                    if (vital.date) {
                        resource.effectiveDateTime = vital.date;
                    }

                    if (vital.bp) {
                        resource.component.push({ code: { text: 'Blood Pressure' }, valueString: vital.bp });
                    }
                    if (vital.pulse) {
                        resource.component.push({ code: { text: 'Pulse' }, valueString: `${vital.pulse} bpm` });
                    }
                    if (vital.temp) {
                        resource.component.push({ code: { text: 'Temperature' }, valueString: vital.temp });
                    }
                    if (vital.o2) {
                        resource.component.push({ code: { text: 'Oxygen Saturation' }, valueString: `${vital.o2}%` });
                    }
                    if (vital.weight) {
                        resource.component.push({ code: { text: 'Weight' }, valueString: vital.weight });
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${observationId}`,
                        resource
                    });
                });

                const labs = this.collectListData('labs-container');
                labs.forEach(lab => {
                    if (!lab.test) return;
                    const labId = this.generateFHIRId('observation');
                    const resource = {
                        resourceType: 'Observation',
                        id: labId,
                        status: 'final',
                        category: [{
                            coding: [{ system: 'http://terminology.hl7.org/CodeSystem/observation-category', code: 'laboratory', display: 'Laboratory' }]
                        }],
                        code: { text: lab.test },
                        subject: { reference: patientReference }
                    };

                    if (lab.date) {
                        resource.effectiveDateTime = lab.date;
                    }

                    if (lab.result) {
                        resource.valueString = lab.result;
                    }

                    if (lab.range) {
                        resource.referenceRange = [{ text: lab.range }];
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${labId}`,
                        resource
                    });
                });

                const immunizations = [
                    formData.lastFluShot ? { code: 'Influenza', date: formData.lastFluShot } : null,
                    formData.lastTetanus ? { code: 'Tetanus (Tdap)', date: formData.lastTetanus } : null
                ].filter(Boolean);

                const covidVaccines = this.collectListData('covid-vaccines-container').map(item => item.value).filter(Boolean);
                covidVaccines.forEach(text => {
                    immunizations.push({ code: text });
                });

                const otherVaccines = this.collectListData('vaccines-container').map(item => item.value).filter(Boolean);
                otherVaccines.forEach(text => {
                    immunizations.push({ code: text });
                });

                immunizations.forEach(vaccine => {
                    const immId = this.generateFHIRId('immunization');
                    const resource = {
                        resourceType: 'Immunization',
                        id: immId,
                        status: 'completed',
                        vaccineCode: { text: vaccine.code },
                        patient: { reference: patientReference }
                    };

                    if (vaccine.date) {
                        resource.occurrenceDateTime = vaccine.date;
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${immId}`,
                        resource
                    });
                });

                if (formData.insuranceCompany || formData.memberId) {
                    const coverageId = this.generateFHIRId('coverage');
                    const resource = {
                        resourceType: 'Coverage',
                        id: coverageId,
                        status: 'active',
                        beneficiary: { reference: patientReference },
                        payor: formData.insuranceCompany ? [{ display: formData.insuranceCompany }] : undefined,
                        subscriberId: formData.memberId || undefined,
                        class: []
                    };

                    if (formData.groupNumber) {
                        resource.class.push({ type: { text: 'Group' }, value: formData.groupNumber });
                    }

                    if (formData.policyHolder) {
                        resource.policyHolder = { display: formData.policyHolder };
                    }

                    if (formData.policyRelationship) {
                        resource.relationship = { text: formData.policyRelationship };
                    }

                    bundle.entry.push({
                        fullUrl: `urn:uuid:${coverageId}`,
                        resource
                    });
                }

                return bundle;
            }

            generateFHIRId(prefix) {
                if (window.crypto?.randomUUID) {
                    return `${prefix}-${window.crypto.randomUUID()}`;
                }

                return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            }
            
            toggleLock() {
                if (this.isLocked) {
                    this.focusUnlockField();
                    return;
                }

                this.lock();
            }

            lock() {
                this.isLocked = true;
                this.stopLockCountdown();
                this._lastActivityUpdate = 0;

                const lockBtn = document.getElementById('lockBtn');
                if (lockBtn) {
                    lockBtn.style.display = 'none';
                    lockBtn.setAttribute('data-i18n-key', 'unlock_action');
                    lockBtn.textContent = window.localization?.t('unlock_action', 'ðŸ”“ Lock');
                }

                const emergencyBanner = document.getElementById('emergencyAccessBanner');
                if (emergencyBanner) {
                    emergencyBanner.style.display = 'none';
                }

                this.clearSessionData();

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.style.display = 'none';
                }

                const navTabs = document.getElementById('navTabs');
                if (navTabs) {
                    navTabs.style.display = 'none';
                }

                const welcomeScreen = document.getElementById('welcomeScreen');
                if (welcomeScreen) {
                    welcomeScreen.style.display = 'none';
                }

                const unlockScreen = document.getElementById('unlockScreen');
                if (unlockScreen) {
                    unlockScreen.style.display = 'flex';
                }

                if (this.emergencyAccessConfig && this.emergencyAccessConfig.enabled) {
                    this.showEmergencyAccess(this.emergencyAccessConfig.data || {});
                } else {
                    const totpField = document.getElementById('totpField');
                    if (totpField) {
                        totpField.style.display = this.requires2FA ? 'block' : 'none';
                    }
                }

                this.clearUnlockFields();
                this.updateRecoveryFieldVisibility();
                this.updateTemporaryAccessHint();
                this.updateLockTimerDisplay();
                this.focusUnlockField();
            }

            unlock() {
                this.isLocked = false;
                this._lockTimeoutHandled = false;
                this._lastActivityUpdate = Date.now();

                const lockBtn = document.getElementById('lockBtn');
                if (lockBtn) {
                    lockBtn.style.display = 'inline-block';
                    lockBtn.setAttribute('data-i18n-key', 'unlock_action');
                    lockBtn.textContent = window.localization?.t('unlock_action', 'ðŸ”“ Lock');
                }

                const emergencyBanner = document.getElementById('emergencyAccessBanner');
                if (emergencyBanner) {
                    emergencyBanner.style.display = 'none';
                }

                const unlockScreen = document.getElementById('unlockScreen');
                if (unlockScreen) {
                    unlockScreen.style.display = 'none';
                }

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.style.display = 'block';
                }

                const navTabs = document.getElementById('navTabs');
                if (navTabs) {
                    navTabs.style.display = 'block';
                }

                this.startLockCountdown();
                this.updateLockTimerDisplay();
            }

            focusUnlockField() {
                const passwordField = document.getElementById('unlock-password');
                if (passwordField instanceof HTMLInputElement) {
                    passwordField.focus();
                }
            }

            clearUnlockFields() {
                const passwordField = document.getElementById('unlock-password');
                if (passwordField instanceof HTMLInputElement) {
                    passwordField.value = '';
                }

                const totpFieldInput = document.getElementById('totp-code');
                if (totpFieldInput instanceof HTMLInputElement) {
                    totpFieldInput.value = '';
                }

                const recoveryFieldInput = document.getElementById('recovery-key');
                if (recoveryFieldInput instanceof HTMLInputElement) {
                    recoveryFieldInput.value = '';
                }
            }

            startLockCountdown() {
                if (this.isLocked || !this.sessionPassword) {
                    this.lockTimerExpiresAt = null;
                    this.updateLockTimerDisplay();
                    return;
                }

                this.stopLockCountdown();
                this.lockTimerExpiresAt = Date.now() + this.lockTimeoutMs;
                this._lockTimeoutHandled = false;
                this._lastActivityUpdate = Date.now();
                this.updateLockTimerDisplay();
                this.lockTimerInterval = window.setInterval(() => this.updateLockTimerDisplay(), 1000);
            }

            resetLockCountdown() {
                if (this.isLocked || !this.sessionPassword) {
                    return;
                }

                if (!this.lockTimerInterval) {
                    this.startLockCountdown();
                    return;
                }

                this.lockTimerExpiresAt = Date.now() + this.lockTimeoutMs;
                this._lockTimeoutHandled = false;
                this._lastActivityUpdate = Date.now();
                this.updateLockTimerDisplay();
            }

            stopLockCountdown() {
                if (this.lockTimerInterval) {
                    window.clearInterval(this.lockTimerInterval);
                    this.lockTimerInterval = null;
                }
                this.lockTimerExpiresAt = null;
            }

            updateLockTimerDisplay() {
                const timerEl = document.getElementById('lockTimer');
                if (!timerEl) {
                    return;
                }

                if (this.isLocked) {
                    timerEl.textContent = 'Session locked';
                    timerEl.classList.add('locked');
                    return;
                }

                timerEl.classList.remove('locked');

                if (!this.lockTimerExpiresAt) {
                    timerEl.textContent = 'Session: --:--';
                    return;
                }

                const remainingMs = this.lockTimerExpiresAt - Date.now();
                if (remainingMs <= 0) {
                    timerEl.textContent = 'Session: 00:00';
                    this.handleLockTimeout();
                    return;
                }

                const totalSeconds = Math.ceil(remainingMs / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                timerEl.textContent = `Session: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            handleLockTimeout() {
                if (this._lockTimeoutHandled || this.isLocked) {
                    return;
                }

                this._lockTimeoutHandled = true;
                this.lock();
                alert('Your session timed out after 45 minutes. All data has been cleared for security. Please unlock the vault again.');
            }

            handleUserActivity() {
                if (this.isLocked || !this.sessionPassword || !this.lockTimerInterval) {
                    return;
                }

                const now = Date.now();
                if (this._lastActivityUpdate && (now - this._lastActivityUpdate) < 1000) {
                    return;
                }

                this._lastActivityUpdate = now;
                this.resetLockCountdown();
            }

            clearSessionData() {
                this.sessionPassword = null;
                this.totpSecret = null;
                this.currentTOTPSecret = null;
                this.pendingTemporaryAccessRemoval = false;
                this.pendingSchemaNotice = null;
                this.emergencyAccessConfig = null;
                this.hasUnsavedChanges = false;
                this.isInitialized = false;
                this._lastActivityUpdate = 0;

                this.clearFormInputs();
                if (typeof this.updateModuleVisibility === 'function') {
                    this.updateModuleVisibility();
                }
                this.updateEmergencySettingsVisibility();
                this.updatePatientSummaryDisplay();

                this.noteTags = [];
                this.saveNoteTagsToStorage();
                this.renderTagChips();
                this.refreshAllNoteTagSelectors();

                document.querySelectorAll('.note-created-display').forEach((element) => {
                    element.textContent = '';
                });

                const noteTagInput = document.getElementById('noteTagInput');
                if (noteTagInput instanceof HTMLInputElement) {
                    noteTagInput.value = '';
                }

                this.closeAttachmentPreview();
                this.attachments = [];
                this.renderAttachmentList();
                this.updateAttachmentStorage({ silent: true });

                const attachmentStorage = document.getElementById('attachmentStorage');
                if (attachmentStorage instanceof HTMLInputElement) {
                    attachmentStorage.value = '[]';
                }

                const lastUpdatedHeader = document.getElementById('lastUpdatedHeader');
                if (lastUpdatedHeader) {
                    lastUpdatedHeader.textContent = 'Last Updated: Never';
                }

                this.updateSaveStatus();
                this.clearBrowserStorage();
                document.querySelectorAll('.modal.active').forEach((modal) => modal.classList.remove('active'));
                this.updateTemporaryAccessHint();
            }

            clearFormInputs() {
                const inputs = document.querySelectorAll('.form-data');
                inputs.forEach((element) => {
                    if (element instanceof HTMLInputElement) {
                        if (element.type === 'checkbox' || element.type === 'radio') {
                            element.checked = false;
                        } else {
                            element.value = '';
                        }
                    } else if (element instanceof HTMLSelectElement) {
                        if (element.multiple) {
                            Array.from(element.options).forEach((option) => { option.selected = false; });
                        } else if (element.options.length > 0) {
                            element.selectedIndex = 0;
                        } else {
                            element.value = '';
                        }
                    } else if (element instanceof HTMLTextAreaElement) {
                        element.value = '';
                    } else if ('value' in element) {
                        element.value = '';
                    }
                });
            }

            getLocalStoragePreservationMap() {
                const preserved = new Map();
                const keysToPreserve = ['preferredLanguage'];

                if (typeof VAULT_REGISTRY_STORAGE_KEY === 'string' && VAULT_REGISTRY_STORAGE_KEY.length > 0) {
                    keysToPreserve.push(VAULT_REGISTRY_STORAGE_KEY);
                }

                keysToPreserve.forEach((key) => {
                    if (!key) {
                        return;
                    }

                    try {
                        const value = localStorage.getItem(key);
                        if (value !== null) {
                            preserved.set(key, value);
                        }
                    } catch (error) {
                        console.warn(`Unable to read ${key} from localStorage`, error);
                    }
                });

                return preserved;
            }

            restorePreservedLocalStorage(preservedValues) {
                if (!(preservedValues instanceof Map) || preservedValues.size === 0) {
                    return;
                }

                preservedValues.forEach((value, key) => {
                    try {
                        localStorage.setItem(key, value);
                    } catch (error) {
                        console.warn(`Unable to restore ${key} in localStorage`, error);
                    }
                });
            }

            clearBrowserStorage() {
                const preservedValues = this.getLocalStoragePreservationMap();

                try {
                    localStorage.clear();
                } catch (error) {
                    console.warn('Unable to clear localStorage', error);
                }

                this.restorePreservedLocalStorage(preservedValues);

                try {
                    sessionStorage.clear();
                } catch (error) {
                    console.warn('Unable to clear sessionStorage', error);
                }
            }
            
            // Crypto utilities
            crypto = {
                async deriveKey(password, salt) {
                    const encoder = new TextEncoder();
                    const keyMaterial = await crypto.subtle.importKey(
                        'raw',
                        encoder.encode(password),
                        'PBKDF2',
                        false,
                        ['deriveBits', 'deriveKey']
                    );
                    
                    return await crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: salt,
                            iterations: 600000,
                            hash: 'SHA-256'
                        },
                        keyMaterial,
                        { name: 'AES-GCM', length: 256 },
                        true,
                        ['encrypt', 'decrypt']
                    );
                },
                
                async encrypt(data, password) {
                    const encoder = new TextEncoder();
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const key = await this.deriveKey(password, salt);

                    const encrypted = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        encoder.encode(JSON.stringify(data))
                    );

                    const arrayToBase64 = (arr) => {
                        let binary = '';
                        arr.forEach(byte => {
                            binary += String.fromCharCode(byte);
                        });
                        return btoa(binary);
                    };

                    return {
                        salt: arrayToBase64(salt),
                        iv: arrayToBase64(iv),
                        data: arrayToBase64(new Uint8Array(encrypted))
                    };
                },

                async decrypt(encryptedData, password) {
                    const base64ToArray = (b64) => {
                        const binary = atob(b64);
                        const arr = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) {
                            arr[i] = binary.charCodeAt(i);
                        }
                        return arr;
                    };

                    const salt = base64ToArray(encryptedData.salt);
                    const iv = base64ToArray(encryptedData.iv);
                    const data = base64ToArray(encryptedData.data);
                    const key = await this.deriveKey(password, salt);

                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        data
                    );
                    
                    const decoder = new TextDecoder();
                    return JSON.parse(decoder.decode(decrypted));
                }
            };
        }
        
        class VaultManager {
            constructor(app) {
                this.app = app;
                this.registry = this.loadRegistry();
                this.ensureRegistryShape();

                this.root = document.getElementById('vaultManagerScreen');
                this.listElement = document.getElementById('vaultManagerList');
                this.emptyElement = document.getElementById('vaultManagerEmpty');
                this.statusElement = document.getElementById('vaultManagerStatus');
                this.searchInput = document.getElementById('vaultManagerSearch');
                this.fileInput = document.getElementById('vaultManagerFileInput');

                this.pendingAction = null;
                this.searchTerm = '';

                this.attachEventListeners();
                this.render();
            }

            attachEventListeners() {
                if (this.searchInput) {
                    this.searchInput.addEventListener('input', (event) => {
                        const value = event?.target?.value ?? '';
                        this.searchTerm = value.toString().toLowerCase();
                        this.render();
                    });
                }

                if (this.fileInput) {
                    this.fileInput.addEventListener('change', (event) => {
                        this.handleFileInputChange(event);
                    });
                }

                const importButton = document.getElementById('vaultManagerImportBtn');
                if (importButton) {
                    importButton.addEventListener('click', () => this.beginImportFlow());
                }

                const createButton = document.getElementById('vaultManagerCreateBtn');
                if (createButton) {
                    createButton.addEventListener('click', () => this.beginCreateFlow());
                }

                const emptyCreateButton = document.getElementById('vaultManagerEmptyCreate');
                if (emptyCreateButton) {
                    emptyCreateButton.addEventListener('click', () => this.beginCreateFlow());
                }

                const emptyImportButton = document.getElementById('vaultManagerEmptyImport');
                if (emptyImportButton) {
                    emptyImportButton.addEventListener('click', () => this.beginImportFlow());
                }
            }

            loadRegistry() {
                if (typeof localStorage === 'undefined') {
                    return { vaults: [], folders: [] };
                }

                try {
                    const raw = localStorage.getItem(VAULT_REGISTRY_STORAGE_KEY);
                    if (!raw) {
                        return { vaults: [], folders: [] };
                    }

                    const parsed = JSON.parse(raw);
                    const vaults = Array.isArray(parsed?.vaults) ? parsed.vaults : [];
                    const folders = Array.isArray(parsed?.folders) ? parsed.folders : [];
                    return { vaults, folders };
                } catch (error) {
                    console.warn('[VaultManager] Unable to load registry', error);
                    return { vaults: [], folders: [] };
                }
            }

            ensureRegistryShape() {
                if (!this.registry || typeof this.registry !== 'object') {
                    this.registry = { vaults: [], folders: [] };
                }

                if (!Array.isArray(this.registry.vaults)) {
                    this.registry.vaults = [];
                }

                if (!Array.isArray(this.registry.folders)) {
                    this.registry.folders = [];
                }
            }

            saveRegistry() {
                this.ensureRegistryShape();

                if (typeof localStorage === 'undefined') {
                    return;
                }

                try {
                    localStorage.setItem(
                        VAULT_REGISTRY_STORAGE_KEY,
                        JSON.stringify({
                            vaults: this.registry.vaults,
                            folders: this.registry.folders
                        })
                    );
                } catch (error) {
                    console.warn('[VaultManager] Unable to save registry', error);
                    this.updateStatus('We could not save your vault list in this browser.', true);
                }
            }

            beginCreateFlow() {
                this.hide();
                window.requestAnimationFrame(() => {
                    this.app?.startSetup?.();
                });
            }

            beginImportFlow() {
                this.pendingAction = { type: 'import' };
                this.updateStatus('Choose an encrypted .ehv file to add to your dashboard.');

                if (this.fileInput) {
                    this.fileInput.value = '';
                    this.fileInput.click();
                }
            }

            openVault(vaultId) {
                const vault = this.registry.vaults.find((entry) => entry.id === vaultId);
                this.pendingAction = { type: 'open', vaultId };

                if (vault?.fileName) {
                    this.updateStatus(`Select the file "${vault.fileName}" to open this vault.`);
                } else {
                    this.updateStatus('Choose the encrypted .ehv file for this vault.');
                }

                if (this.fileInput) {
                    this.fileInput.value = '';
                    this.fileInput.click();
                }
            }

            async handleFileInputChange(event) {
                const input = event?.target;
                if (!(input instanceof HTMLInputElement)) {
                    return;
                }

                const [file] = input.files || [];
                input.value = '';

                if (!file) {
                    return;
                }

                const action = this.pendingAction;
                this.pendingAction = null;

                if (!action) {
                    return;
                }

                if (action.type === 'import') {
                    await this.registerVaultFromFile(file);
                } else if (action.type === 'open' && action.vaultId) {
                    await this.openVaultWithFile(action.vaultId, file);
                }
            }

            async registerVaultFromFile(file) {
                try {
                    const fileContent = await file.text();
                    const metadata = this.parseVaultMetadata(fileContent);
                    const nowIso = new Date().toISOString();
                    const fallbackName = this.deriveNameFromFile(file.name);
                    const existingIndex = this.registry.vaults.findIndex((entry) => (
                        entry.vaultIdentity && metadata.vaultIdentity
                            ? entry.vaultIdentity === metadata.vaultIdentity
                            : entry.fileName === file.name
                    ));

                    const baseEntry = {
                        id: this.generateId(),
                        vaultIdentity: metadata.vaultIdentity || fallbackName,
                        displayName: metadata.vaultIdentity || fallbackName || 'Encrypted Vault',
                        fileName: file.name,
                        lastOpened: null,
                        lastModified: metadata.savedDate || this.toISOStringOrNull(file.lastModified),
                        savedDate: metadata.savedDate || null,
                        lastKnownSize: typeof file.size === 'number' ? file.size : null,
                        requires2FA: Boolean(metadata.requires2FA),
                        schemaVersion: metadata.schemaVersion || null,
                        appVersion: metadata.appVersion || null,
                        folder: 'Uncategorized',
                        favorite: false,
                        notes: '',
                        tags: [],
                        addedAt: nowIso
                    };

                    if (existingIndex >= 0) {
                        const previous = this.registry.vaults[existingIndex] || {};
                        const updatedEntry = {
                            ...previous,
                            ...baseEntry,
                            id: previous.id || baseEntry.id,
                            displayName: previous.displayName || baseEntry.displayName,
                            folder: previous.folder || baseEntry.folder,
                            favorite: Boolean(previous.favorite),
                            notes: previous.notes || '',
                            tags: Array.isArray(previous.tags) ? previous.tags : [],
                            addedAt: previous.addedAt || nowIso,
                            lastOpened: previous.lastOpened || null
                        };

                        this.registry.vaults[existingIndex] = updatedEntry;
                        this.updateStatus('Vault details updated from the selected file.');
                    } else {
                        this.registry.vaults.push(baseEntry);
                        this.updateStatus('Vault added to your dashboard.');
                    }

                    this.saveRegistry();
                    this.render();
                } catch (error) {
                    console.error('[VaultManager] Failed to add vault', error);
                    const message = error instanceof Error ? error.message : 'Unable to add that vault file.';
                    this.updateStatus(message, true);
                }
            }

            async openVaultWithFile(vaultId, file) {
                const entry = this.registry.vaults.find((item) => item.id === vaultId);

                if (!entry) {
                    this.updateStatus('That vault could not be found.', true);
                    return;
                }

                try {
                    const fileContent = await file.text();
                    const metadata = this.parseVaultMetadata(fileContent);

                    await this.app?.importVaultFromVaultFile?.(file, fileContent);

                    const nowIso = new Date().toISOString();
                    entry.lastOpened = nowIso;
                    entry.fileName = file.name || entry.fileName;
                    entry.lastKnownSize = typeof file.size === 'number' ? file.size : entry.lastKnownSize || null;
                    entry.lastModified = metadata.savedDate || this.toISOStringOrNull(file.lastModified) || entry.lastModified || null;
                    entry.savedDate = metadata.savedDate || entry.savedDate || null;
                    entry.requires2FA = Boolean(metadata.requires2FA);
                    entry.schemaVersion = metadata.schemaVersion || entry.schemaVersion || null;
                    entry.appVersion = metadata.appVersion || entry.appVersion || null;

                    if (metadata.vaultIdentity && !entry.vaultIdentity) {
                        entry.vaultIdentity = metadata.vaultIdentity;
                    }

                    if (!entry.displayName || entry.displayName === entry.vaultIdentity) {
                        entry.displayName = metadata.vaultIdentity || entry.displayName || this.deriveNameFromFile(file.name);
                    }

                    this.saveRegistry();
                    this.render();
                    this.hide();
                } catch (error) {
                    console.error('[VaultManager] Failed to open vault', error);
                    const message = error instanceof Error ? error.message : 'Unable to open that vault file.';
                    this.updateStatus(message, true);
                }
            }

            renameVault(vaultId) {
                const entry = this.registry.vaults.find((item) => item.id === vaultId);
                if (!entry) {
                    return;
                }

                const currentName = entry.displayName || entry.vaultIdentity || 'Encrypted Vault';
                const response = window.prompt('Name this vault', currentName);

                if (typeof response !== 'string') {
                    return;
                }

                const trimmed = response.trim();
                if (!trimmed) {
                    return;
                }

                entry.displayName = trimmed;
                this.saveRegistry();
                this.render();
                this.updateStatus('Vault name updated.');
            }

            removeVault(vaultId) {
                const index = this.registry.vaults.findIndex((item) => item.id === vaultId);
                if (index === -1) {
                    return;
                }

                const entry = this.registry.vaults[index];
                const confirmation = window.confirm('Remove this vault from your dashboard? The .ehv file will not be deleted.');

                if (!confirmation) {
                    return;
                }

                this.registry.vaults.splice(index, 1);
                this.saveRegistry();
                this.render();

                const name = entry?.displayName || entry?.vaultIdentity || 'Vault';
                this.updateStatus(`${name} removed from the dashboard.`);
            }

            parseVaultMetadata(fileContent) {
                if (typeof DOMParser === 'undefined') {
                    throw new Error('This browser cannot read vault files.');
                }

                if (typeof fileContent !== 'string' || fileContent.trim() === '') {
                    throw new Error('The selected file does not contain vault data.');
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(fileContent, 'text/html');

                if (doc.querySelector('parsererror')) {
                    throw new Error('The selected file is not a valid vault document.');
                }

                const embedded = doc.getElementById('embedded-vault-data');
                const raw = embedded?.textContent?.trim();

                if (!raw) {
                    throw new Error('No encrypted vault payload was found in the selected file.');
                }

                let payload;
                try {
                    payload = JSON.parse(raw);
                } catch (error) {
                    throw new Error('The vault metadata could not be parsed.');
                }

                if (payload?.compressed && payload?.data) {
                    const compression = this.app?.getCompressionLibrary?.();
                    if (compression?.inflate) {
                        try {
                            const binary = atob(payload.data);
                            const bytes = new Uint8Array(binary.length);
                            for (let i = 0; i < binary.length; i++) {
                                bytes[i] = binary.charCodeAt(i);
                            }
                            const decompressed = compression.inflate(bytes, { to: 'string' });
                            payload = JSON.parse(decompressed);
                        } catch (error) {
                            throw new Error('Failed to decompress the selected vault file.');
                        }
                    } else {
                        throw new Error('Compression support is not available to read this vault.');
                    }
                }

                if (!payload || typeof payload !== 'object') {
                    throw new Error('The vault metadata could not be parsed.');
                }

                return {
                    vaultIdentity: payload.vaultIdentity || null,
                    savedDate: payload.savedDate || null,
                    requires2FA: Boolean(payload.requires2FA),
                    schemaVersion: payload.schemaVersion || payload.version || null,
                    appVersion: payload.appVersion || null
                };
            }

            deriveNameFromFile(fileName) {
                if (typeof fileName !== 'string' || !fileName) {
                    return 'Encrypted Vault';
                }

                return fileName.replace(/\.ehv$/i, '').trim() || 'Encrypted Vault';
            }

            generateId() {
                if (window.crypto?.randomUUID) {
                    return window.crypto.randomUUID();
                }

                return `vault-${Date.now()}-${Math.floor(Math.random() * 100000)}`;
            }

            toISOStringOrNull(value) {
                if (typeof value !== 'number') {
                    return null;
                }

                const date = new Date(value);
                return Number.isNaN(date.getTime()) ? null : date.toISOString();
            }

            formatTimestamp(value, fallback = 'Never') {
                if (!value) {
                    return fallback;
                }

                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return fallback;
                }

                return date.toLocaleString();
            }

            formatFileSize(bytes) {
                if (typeof bytes !== 'number' || Number.isNaN(bytes) || bytes <= 0) {
                    return '';
                }

                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
                const value = bytes / (1024 ** exponent);
                const formatted = exponent === 0 ? value.toFixed(0) : value.toFixed(1);
                return `${formatted} ${units[exponent]}`;
            }

            parseTime(value) {
                if (!value) {
                    return 0;
                }

                const timestamp = Date.parse(value);
                return Number.isNaN(timestamp) ? 0 : timestamp;
            }

            getFilteredVaults() {
                this.ensureRegistryShape();
                const vaults = [...this.registry.vaults];
                const term = this.searchTerm.trim();

                const filtered = term
                    ? vaults.filter((vault) => {
                        const haystacks = [
                            vault.displayName,
                            vault.vaultIdentity,
                            vault.notes,
                            ...(Array.isArray(vault.tags) ? vault.tags : [])
                        ].filter(Boolean).map((value) => value.toString().toLowerCase());
                        const searchTerm = term.toLowerCase();
                        return haystacks.some((value) => value.includes(searchTerm));
                    })
                    : vaults;

                filtered.sort((a, b) => {
                    const aTime = this.parseTime(a.lastOpened);
                    const bTime = this.parseTime(b.lastOpened);

                    if (aTime !== bTime) {
                        return bTime - aTime;
                    }

                    const aName = (a.displayName || a.vaultIdentity || '').toString().toLowerCase();
                    const bName = (b.displayName || b.vaultIdentity || '').toString().toLowerCase();
                    return aName.localeCompare(bName);
                });

                return filtered;
            }

            setEmptyState(isEmpty) {
                if (this.emptyElement) {
                    this.emptyElement.hidden = !isEmpty;
                }

                if (this.listElement) {
                    this.listElement.style.display = isEmpty ? 'none' : 'grid';
                }
            }

            render() {
                if (!this.listElement) {
                    return;
                }

                const vaults = this.getFilteredVaults();
                this.listElement.innerHTML = '';

                this.setEmptyState(vaults.length === 0);

                vaults.forEach((vault) => {
                    const card = document.createElement('article');
                    card.className = 'vault-card';
                    card.dataset.vaultId = vault.id;

                    const title = document.createElement('h3');
                    title.textContent = vault.displayName || vault.vaultIdentity || 'Encrypted Vault';
                    card.appendChild(title);

                    if (vault.vaultIdentity) {
                        const identity = document.createElement('span');
                        identity.className = 'vault-identity-pill';
                        identity.textContent = `ðŸ”· ${vault.vaultIdentity}`;
                        card.appendChild(identity);
                    }

                    const meta = document.createElement('div');
                    meta.className = 'vault-card-meta';
                    meta.appendChild(this.buildMetaRow('Last opened', this.formatTimestamp(vault.lastOpened, 'Never')));
                    meta.appendChild(this.buildMetaRow('Last saved', this.formatTimestamp(vault.lastModified || vault.savedDate, 'Unknown')));

                    if (vault.fileName) {
                        const sizeText = this.formatFileSize(vault.lastKnownSize);
                        const fileRow = `${vault.fileName}${sizeText ? ` â€¢ ${sizeText}` : ''}`;
                        meta.appendChild(this.buildMetaRow('File', fileRow));
                    }

                    meta.appendChild(this.buildMetaRow('Security', vault.requires2FA ? 'Password + authenticator code' : 'Password only'));
                    card.appendChild(meta);

                    const actions = document.createElement('div');
                    actions.className = 'vault-card-actions';

                    const openButton = document.createElement('button');
                    openButton.type = 'button';
                    openButton.dataset.variant = 'open';
                    openButton.textContent = 'Open Vault';
                    openButton.addEventListener('click', () => this.openVault(vault.id));
                    actions.appendChild(openButton);

                    const renameButton = document.createElement('button');
                    renameButton.type = 'button';
                    renameButton.dataset.variant = 'rename';
                    renameButton.textContent = 'Rename';
                    renameButton.addEventListener('click', () => this.renameVault(vault.id));
                    actions.appendChild(renameButton);

                    const removeButton = document.createElement('button');
                    removeButton.type = 'button';
                    removeButton.dataset.variant = 'remove';
                    removeButton.textContent = 'Remove';
                    removeButton.addEventListener('click', () => this.removeVault(vault.id));
                    actions.appendChild(removeButton);

                    card.appendChild(actions);
                    this.listElement.appendChild(card);
                });
            }

            buildMetaRow(label, value) {
                const row = document.createElement('div');
                row.textContent = `${label}: ${value}`;
                return row;
            }

            updateStatus(message = '', isError = false) {
                if (!this.statusElement) {
                    return;
                }

                const text = typeof message === 'string' ? message.trim() : '';

                if (text) {
                    this.statusElement.textContent = text;
                    this.statusElement.classList.add('is-visible');
                    this.statusElement.classList.toggle('is-error', Boolean(isError));
                } else {
                    this.statusElement.textContent = '';
                    this.statusElement.classList.remove('is-visible');
                    this.statusElement.classList.remove('is-error');
                }
            }

            show(message = '') {
                if (this.root) {
                    this.root.style.display = 'block';
                    this.root.setAttribute('aria-hidden', 'false');
                }

                if (message) {
                    this.updateStatus(message);
                } else {
                    this.updateStatus('');
                }

                this.render();
            }

            hide() {
                if (this.root) {
                    this.root.style.display = 'none';
                    this.root.setAttribute('aria-hidden', 'true');
                }

                this.updateStatus('');
            }

            syncWithApp() {
                if (this.app?.encryptedData) {
                    this.hide();
                } else {
                    this.show();
                }
            }
        }

        const offlineBundleManager = (() => {
            const ZIP_FILENAME = 'personal-health-vault-offline.zip';
            const resolveAssetSources = (asset) => {
                if (Array.isArray(asset.sources) && asset.sources.length) {
                    return asset.sources;
                }

                if (asset.path === 'index.html') {
                    const currentUrl = new URL(window.location.href);
                    const sources = [];

                    const ensureSource = (value) => {
                        if (!value) return;
                        const normalized = value.toString();
                        if (!sources.includes(normalized)) {
                            sources.push(normalized);
                        }
                    };

                    ensureSource(currentUrl.href);

                    if (!currentUrl.pathname.endsWith('/')) {
                        const withoutQuery = new URL(currentUrl.href);
                        withoutQuery.search = '';
                        withoutQuery.hash = '';
                        ensureSource(withoutQuery.href);
                    }

                    ensureSource(new URL('index.html', currentUrl).href);
                    ensureSource(new URL('./', currentUrl).href);

                    return sources;
                }

                return [asset.path];
            };

            const ASSETS = [
                { path: 'index.html', type: 'text' }
            ];

            const getButtons = () => Array.from(document.querySelectorAll('.offline-download-trigger'));
            const getStatusElements = () => Array.from(document.querySelectorAll('.offline-download-status'));
            let currentStatus = { key: null, fallback: '', isError: false };

            const translate = (key, fallback) => {
                if (window.localization?.t) {
                    return window.localization.t(key, fallback);
                }
                return fallback;
            };

            const applyStatus = () => {
                const { key, fallback, isError } = currentStatus;
                const message = key ? translate(key, fallback) : '';
                getStatusElements().forEach(element => {
                    element.textContent = message;
                    element.style.display = message ? 'block' : 'none';
                    element.classList.toggle('error', Boolean(isError));
                });
            };

            const updateStatus = (key, fallback, isError = false) => {
                currentStatus = { key, fallback, isError };
                applyStatus();
            };

            const setBusyState = (isBusy) => {
                getButtons().forEach(button => {
                    button.disabled = isBusy;
                });
            };

            const fetchAsset = async (asset) => {
                const sources = resolveAssetSources(asset);
                let lastError = null;

                for (const source of sources) {
                    try {
                        const response = await fetch(source, {
                            cache: 'no-store',
                            credentials: 'same-origin'
                        });

                        if (!response.ok) {
                            throw new Error(`Failed to fetch ${asset.path} from ${source}: ${response.status}`);
                        }

                        if (asset.type === 'binary') {
                            return new Uint8Array(await response.arrayBuffer());
                        }

                        return await response.text();
                    } catch (error) {
                        lastError = error;
                        console.warn('[Offline Bundle] Failed source', source, error);
                    }
                }

                throw lastError ?? new Error(`Unable to fetch ${asset.path}`);
            };

            const buildZip = async () => {
                if (!window.JSZip) {
                    throw new Error('JSZip is unavailable');
                }

                const zip = new JSZip();

                await Promise.all(ASSETS.map(async asset => {
                    const content = await fetchAsset(asset);
                    zip.file(asset.path, content);
                }));

                return await zip.generateAsync({ type: 'blob' });
            };

            const triggerDownload = (blob) => {
                const url = URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.download = ZIP_FILENAME;
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
                setTimeout(() => URL.revokeObjectURL(url), 2000);
            };

            const handleDownload = async (event) => {
                event?.preventDefault?.();

                if (handleDownload.isRunning) {
                    return;
                }

                if (!window.JSZip) {
                    updateStatus('offline_download_error', "We couldn't prepare the offline bundle. Please try again.", true);
                    return;
                }

                try {
                    handleDownload.isRunning = true;
                    setBusyState(true);
                    updateStatus('offline_download_preparing', 'Preparing your offline bundleâ€¦');

                    const archive = await buildZip();
                    triggerDownload(archive);

                    updateStatus('offline_download_ready', 'Offline bundle ready! Check your downloads folder.');
                } catch (error) {
                    console.error('[Offline Bundle] Failed to create archive', error);
                    updateStatus('offline_download_error', "We couldn't prepare the offline bundle. Please try again.", true);
                } finally {
                    handleDownload.isRunning = false;
                    setBusyState(false);
                }
            };

            const attachListeners = () => {
                getButtons().forEach(button => {
                    button.addEventListener('click', handleDownload);
                });
            };

            const init = () => {
                attachListeners();
                applyStatus();
            };

            const refresh = () => {
                applyStatus();
            };

            return { init, updateStatus, refresh };
        })();
        if (typeof window !== 'undefined') {
            window.offlineBundleManager = offlineBundleManager;
        }

        // Initialize localization and app
        const localization = new LocalizationManager();
        window.localization = localization;

        localization.init()
            .catch(error => {
                console.error('[Localization] Initialization error', error);
            })
            .finally(() => {
                window.app = new HealthVaultApp();
                window.vaultManager = new VaultManager(window.app);
                window.vaultManager.syncWithApp();
            });

        offlineBundleManager.init();
    </script>

    <script type="module">
        import React, { useEffect, useState } from 'https://esm.sh/react@18';
        import { createRoot } from 'https://esm.sh/react-dom@18/client';
        import { Shield, Lock, HardDrive, WifiOff, Download, FolderOpen, ChevronRight, CheckCircle2, FileText, Clock, Globe } from 'https://esm.sh/lucide-react@0.294.0';

        function HealthVaultLanding() {
            const [hoveredFeature, setHoveredFeature] = useState(null);

            const features = [
                {
                    icon: React.createElement(Lock, { className: 'w-6 h-6' }),
                    title: 'Military-Grade Encryption',
                    description: 'Your data is encrypted with your password using AES-256 encryption'
                },
                {
                    icon: React.createElement(HardDrive, { className: 'w-6 h-6' }),
                    title: 'All-in-One Vault',
                    description: 'Everything stored in a single .ehv file - no separate databases or files'
                },
                {
                    icon: React.createElement(WifiOff, { className: 'w-6 h-6' }),
                    title: '100% Offline Capable',
                    description: 'Works completely offline. Your data never leaves your device'
                },
                {
                    icon: React.createElement(Shield, { className: 'w-6 h-6' }),
                    title: 'Zero-Knowledge System',
                    description: "We can't access your data - only you have the encryption key"
                }
            ];

            const benefits = [
                'Complete privacy and control',
                'Cross-platform compatibility',
                'Instant backup & restore',
                'No subscription fees',
                'Open-source transparency'
            ];

            useEffect(() => {
                const openButtons = Array.from(document.querySelectorAll('[data-action="open-vault"]'));
                const handleOpen = (event) => {
                    event.preventDefault();
                    if (window.app?.promptVaultImport) {
                        window.app.promptVaultImport();
                    } else {
                        document.getElementById('vaultFileInput')?.click();
                    }
                };

                openButtons.forEach(button => button.addEventListener('click', handleOpen));

                window.offlineBundleManager?.init?.();
                window.offlineBundleManager?.refresh?.();

                return () => {
                    openButtons.forEach(button => button.removeEventListener('click', handleOpen));
                };
            }, []);

            const handleCreateVault = () => {
                if (window.app?.startSetup) {
                    window.app.startSetup();
                }
            };

            return (
                React.createElement('div', {
                    className: 'min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white flex flex-col',
                    style: { width: '100vw', margin: 0, padding: 0 }
                },
                    React.createElement('header', { className: 'fixed top-0 left-0 right-0 z-50 backdrop-blur-md bg-slate-900/50 border-b border-white/10' },
                        React.createElement('div', { className: 'container mx-auto px-6 py-4 flex items-center justify-between' },
                            React.createElement('div', { className: 'flex items-center gap-3' },
                                React.createElement('div', { className: 'bg-gradient-to-br from-cyan-400 to-blue-500 p-2 rounded-lg' },
                                    React.createElement(Shield, { className: 'w-6 h-6 text-white' })
                                ),
                                React.createElement('span', { className: 'text-xl font-bold' }, 'HealthVault')
                            ),
                            React.createElement('div', { className: 'flex items-center gap-4' },
                                React.createElement('button', { className: 'px-4 py-2 text-sm hover:text-cyan-400 transition-colors' }, 'Documentation'),
                                React.createElement('button', { id: 'openVaultBtn', className: 'px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition-all backdrop-blur-sm', 'data-action': 'open-vault' }, 'Open Vault')
                            )
                        )
                    ),
                    React.createElement('main', { className: 'flex-1 pt-24 pb-16 px-6' },
                        React.createElement('div', { className: 'container mx-auto max-w-6xl' },
                            React.createElement('div', { className: 'text-center mb-10' },
                                React.createElement('div', { className: 'inline-flex items-center gap-2 px-3 py-1.5 bg-cyan-500/10 border border-cyan-400/20 rounded-full text-cyan-200 text-xs mb-5 backdrop-blur-sm' },
                                    React.createElement(CheckCircle2, { className: 'w-4 h-4' }),
                                    React.createElement('span', null, 'Always Encrypted â€¢ Zero Knowledge â€¢ Open Source')
                                ),
                                React.createElement('h1', { className: 'text-5xl md:text-6xl font-bold mb-5 bg-gradient-to-r from-cyan-300 to-blue-300 bg-clip-text text-transparent leading-tight' },
                                    'Your Health Records,',
                                    React.createElement('br', null),
                                    React.createElement('span', { className: 'text-white' }, 'Completely Private')
                                ),
                                React.createElement('p', { className: 'text-base text-slate-300 max-w-2xl mx-auto mb-6 leading-relaxed' },
                                    'Take control of your medical data with a self-contained, encrypted health vault that works 100% offline. ',
                                    'No cloud. No tracking. Just you and your records.'
                                ),
                                React.createElement('div', { className: 'bg-blue-500/10 border border-blue-400/30 rounded-xl p-4 max-w-2xl mx-auto mb-10 text-left' },
                                    React.createElement('div', { className: 'flex gap-3' },
                                        React.createElement(Shield, { className: 'w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5' }),
                                        React.createElement('div', { className: 'text-sm text-blue-200' },
                                            React.createElement('strong', { className: 'text-blue-300' }, 'Personal Health Record Tool:'),
                                            ' This application is for your individual use only. ',
                                            'Your data is stored exclusively on your device and never transmitted to any servers. ',
                                            'This is not an electronic health record (EHR) system and is not subject to HIPAA regulations.'
                                        )
                                    )
                                ),
                                React.createElement('div', { className: 'flex flex-col sm:flex-row gap-4 justify-center' },
                                    React.createElement('button', {
                                        className: 'group px-7 py-4 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 rounded-xl font-semibold text-base transition-all shadow-md shadow-cyan-500/30 hover:shadow-lg hover:shadow-cyan-500/30 flex items-center justify-center gap-2',
                                        onClick: handleCreateVault
                                    },
                                        'Create Your Vault',
                                        React.createElement(ChevronRight, { className: 'w-5 h-5 group-hover:translate-x-1 transition-transform' })
                                    ),
                                    React.createElement('button', { className: 'px-7 py-4 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-xl font-semibold text-base transition-all border border-white/20 flex items-center justify-center gap-2', 'data-action': 'open-vault' },
                                        React.createElement(FolderOpen, { className: 'w-5 h-5' }),
                                        'Load Your Vault'
                                    )
                                )
                            ),
                        )
                    ),
                    React.createElement('section', { className: 'py-16 px-6' },
                        React.createElement('div', { className: 'container mx-auto max-w-6xl' },
                            React.createElement('div', { className: 'text-center mb-14' },
                                React.createElement('h2', { className: 'text-3xl md:text-4xl font-bold mb-3' },
                                    'Built for ',
                                    React.createElement('span', { className: 'bg-gradient-to-r from-cyan-300 to-blue-300 bg-clip-text text-transparent' }, 'Privacy')
                                ),
                                React.createElement('p', { className: 'text-slate-400 text-base' }, 'Enterprise-grade security without the enterprise complexity')
                            ),
                            React.createElement('div', { className: 'grid md:grid-cols-2 gap-6 mb-12' },
                                features.map((feature, index) => (
                                    React.createElement('div', {
                                        key: feature.title,
                                        onMouseEnter: () => setHoveredFeature(index),
                                        onMouseLeave: () => setHoveredFeature(null),
                                        className: `bg-white/5 backdrop-blur-sm border rounded-2xl p-8 transition-all duration-300 ${
                                            hoveredFeature === index
                                                ? 'border-cyan-400/50 bg-white/10 shadow-lg shadow-cyan-500/10'
                                                : 'border-white/10 hover:border-white/20'
                                        }`
                                    },
                                        React.createElement('div', { className: 'w-14 h-14 bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-xl flex items-center justify-center mb-4 text-cyan-400' },
                                            feature.icon
                                        ),
                                        React.createElement('h3', { className: 'text-lg font-semibold mb-2' }, feature.title),
                                        React.createElement('p', { className: 'text-base text-slate-400 leading-relaxed' }, feature.description)
                                    )
                                ))
                            )
                        )
                    ),
                    React.createElement('section', { className: 'py-16 px-6 bg-gradient-to-b from-transparent to-slate-900/50' },
                        React.createElement('div', { className: 'container mx-auto max-w-6xl' },
                            React.createElement('div', { className: 'bg-white/5 backdrop-blur-md border border-white/10 rounded-3xl p-12' },
                                React.createElement('div', { className: 'grid md:grid-cols-2 gap-12 items-center' },
                                    React.createElement('div', null,
                                        React.createElement('h2', { className: 'text-3xl md:text-4xl font-bold mb-5' },
                                            'Everything you need.',
                                            React.createElement('br', null),
                                            React.createElement('span', { className: 'text-cyan-400' }, "Nothing you don't.")
                                        ),
                                        React.createElement('p', { className: 'text-base text-slate-300 leading-relaxed mb-8' },
                                            'Store medical records, test results, prescriptions, and health notes in one secure location. ',
                                            'Access them anywhere, anytime - even without an internet connection.'
                                        ),
                                        React.createElement('div', { className: 'space-y-3 mb-8' },
                                            benefits.map(benefit => (
                                                React.createElement('div', { key: benefit, className: 'flex items-center gap-3' },
                                                    React.createElement('div', { className: 'w-6 h-6 bg-cyan-500/20 rounded-full flex items-center justify-center flex-shrink-0' },
                                                        React.createElement(CheckCircle2, { className: 'w-4 h-4 text-cyan-400' })
                                                    ),
                                                    React.createElement('span', { className: 'text-base text-slate-300' }, benefit)
                                                )
                                            ))
                                        ),
                                        React.createElement('div', { className: 'bg-slate-800/50 border border-slate-700 rounded-lg p-4 text-xs text-slate-400' },
                                            React.createElement('strong', { className: 'text-slate-300' }, 'Privacy Notice:'),
                                            ' This is a personal health record (PHR) tool designed for individual use. ',
                                            'All data is encrypted and stored only on your device. We do not operate servers, collect data, or transmit your information anywhere. ',
                                            'You remain the sole custodian of your encrypted health information.'
                                        )
                                    ),
                                    React.createElement('div', { className: 'space-y-4' },
                                        React.createElement('div', { className: 'bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-cyan-400/20 rounded-2xl p-6' },
                                            React.createElement(FileText, { className: 'w-8 h-8 text-cyan-400 mb-3' }),
                                            React.createElement('h4', { className: 'font-semibold mb-2' }, 'Single File Architecture'),
                                            React.createElement('p', { className: 'text-sm text-slate-400' }, 'One .ehv file contains your entire health vault. Easy to backup, transfer, or store securely.')
                                        ),
                                        React.createElement('div', { className: 'bg-gradient-to-br from-purple-500/10 to-pink-500/10 border border-purple-400/20 rounded-2xl p-6' },
                                            React.createElement(Clock, { className: 'w-8 h-8 text-purple-400 mb-3' }),
                                            React.createElement('h4', { className: 'font-semibold mb-2' }, 'Instant Access'),
                                            React.createElement('p', { className: 'text-sm text-slate-400' }, 'Open your vault in any modern browser. No installation, no setup, no waiting.')
                                        ),
                                        React.createElement('div', { className: 'bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border border-blue-400/20 rounded-2xl p-6' },
                                            React.createElement(Globe, { className: 'w-8 h-8 text-blue-400 mb-3' }),
                                            React.createElement('h4', { className: 'font-semibold mb-2' }, 'Offline First'),
                                            React.createElement('p', { className: 'text-sm text-slate-400' }, 'Download the offline bundle and use HealthVault without any internet connection.')
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    React.createElement('footer', { className: 'no-print', role: 'contentinfo' },
                        React.createElement('div', { className: 'page-shell' },
                            React.createElement('div', { className: 'footer-cards' },
                                React.createElement('div', { className: 'footer-card' },
                                    React.createElement('div', { className: 'footer-card-icon' }, 'ðŸ¥'),
                                    React.createElement('h3', { className: 'footer-card-title' }, 'Personal Health Record Tool'),
                                    React.createElement('div', { className: 'footer-badge badge-info' }, 'Not an EHR System'),
                                    React.createElement('p', { className: 'footer-card-text' },
                                        'HealthVault is a personal health record (PHR) application designed for individual use. This is NOT an electronic health record (EHR) system operated by healthcare providers.'
                                    )
                                ),
                                React.createElement('div', { className: 'footer-card' },
                                    React.createElement('div', { className: 'footer-card-icon' }, 'âš–ï¸'),
                                    React.createElement('h3', { className: 'footer-card-title' }, 'Regulatory Scope'),
                                    React.createElement('div', { className: 'footer-badge badge-info' }, 'Not Subject to HIPAA'),
                                    React.createElement('p', { className: 'footer-card-text' },
                                        'This application is not subject to HIPAA regulations because it is not operated by a covered entity or business associate. You, the individual user, maintain complete control over your data.'
                                    )
                                ),
                                React.createElement('div', { className: 'footer-card highlight' },
                                    React.createElement('div', { className: 'footer-card-icon' }, 'ðŸ”’'),
                                    React.createElement('h3', { className: 'footer-card-title' }, 'Zero Data Collection'),
                                    React.createElement('div', { className: 'footer-badge badge-success' }, '100% Private'),
                                    React.createElement('p', { className: 'footer-card-text' },
                                        React.createElement('strong', null, 'We never see your data.'),
                                        ' No servers, no databases, no cloud storage. Your encrypted health vault (.ehv) is stored exclusively on your device.'
                                    )
                                ),
                                React.createElement('div', { className: 'footer-card warning' },
                                    React.createElement('div', { className: 'footer-card-icon' }, 'ðŸ”‘'),
                                    React.createElement('h3', { className: 'footer-card-title' }, 'Your Responsibility'),
                                    React.createElement('div', { className: 'footer-badge badge-warning' }, 'Important'),
                                    React.createElement('p', { className: 'footer-card-text' },
                                        'As the sole custodian of your health data, you are responsible for keeping your encrypted vault file secure, backing it up appropriately, and protecting your password.'
                                    ),
                                    React.createElement('p', { className: 'footer-card-text' },
                                        React.createElement('strong', null, 'We cannot recover lost passwords or data.')
                                    )
                                ),
                                React.createElement('div', { className: 'footer-card alert' },
                                    React.createElement('div', { className: 'footer-card-icon' }, 'âš•ï¸'),
                                    React.createElement('h3', { className: 'footer-card-title' }, 'Medical Disclaimer'),
                                    React.createElement('div', { className: 'footer-badge badge-warning' }, 'Not Medical Advice'),
                                    React.createElement('p', { className: 'footer-card-text' },
                                        'This tool is for personal record-keeping only and does not provide medical advice, diagnosis, or treatment. Always consult qualified healthcare professionals for medical decisions.'
                                    )
                                ),
                                React.createElement('div', { className: 'footer-card' },
                                    React.createElement('div', { className: 'footer-card-icon' }, 'ðŸ›¡ï¸'),
                                    React.createElement('h3', { className: 'footer-card-title' }, 'Privacy Implementation'),
                                    React.createElement('div', { className: 'footer-badge badge-success' }, 'Best Practices'),
                                    React.createElement('p', { className: 'footer-card-text' },
                                        'While this application is not subject to HIPAA, we implement strong encryption and security best practices to protect your sensitive health information.'
                                    ),
                                    React.createElement('p', { className: 'footer-card-text' },
                                        'State privacy laws may also apply depending on your location.'
                                    )
                                )
                            ),
                            React.createElement('div', { className: 'footer-bottom' },
                                React.createElement('div', { className: 'footer-bottom-left' },
                                    React.createElement('span', { style: { fontSize: '20px' } }, 'ðŸ”’'),
                                    React.createElement('span', null, 'Â© 2025 HealthVault - Your data, your control')
                                ),
                                React.createElement('div', { className: 'footer-bottom-links' },
                                    React.createElement('a', { href: '#' }, 'Privacy Policy'),
                                    React.createElement('a', { href: '#' }, 'Documentation'),
                                    React.createElement('a', { href: '#' }, 'GitHub')
                                )
                            )
                        )
                    )
                )
            );
        }

        const rootElement = document.getElementById('landingRoot');
        if (rootElement) {
            const root = createRoot(rootElement);
            root.render(React.createElement(HealthVaultLanding));
        }
    </script>
</body>
</html>
